(window.webpackJsonp=window.webpackJsonp||[]).push([[12],{499:function(s,t){s.exports="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAhUAAACXCAIAAAAtYT7TAAAAAXNSR0IArs4c6QAAAJBlWElmTU0AKgAAAAgABgEGAAMAAAABAAIAAAESAAMAAAABAAEAAAEaAAUAAAABAAAAVgEbAAUAAAABAAAAXgEoAAMAAAABAAIAAIdpAAQAAAABAAAAZgAAAAAAAABkAAAAAQAAAGQAAAABAAOgAQADAAAAAQABAACgAgAEAAAAAQAAAhWgAwAEAAAAAQAAAJcAAAAAZHVBCgAAAAlwSFlzAAAPYQAAD2EBqD+naQAAAgtpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IlhNUCBDb3JlIDUuNC4wIj4KICAgPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4KICAgICAgPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIKICAgICAgICAgICAgeG1sbnM6dGlmZj0iaHR0cDovL25zLmFkb2JlLmNvbS90aWZmLzEuMC8iPgogICAgICAgICA8dGlmZjpPcmllbnRhdGlvbj4xPC90aWZmOk9yaWVudGF0aW9uPgogICAgICAgICA8dGlmZjpQaG90b21ldHJpY0ludGVycHJldGF0aW9uPjI8L3RpZmY6UGhvdG9tZXRyaWNJbnRlcnByZXRhdGlvbj4KICAgICAgICAgPHRpZmY6UmVzb2x1dGlvblVuaXQ+MjwvdGlmZjpSZXNvbHV0aW9uVW5pdD4KICAgICAgICAgPHRpZmY6Q29tcHJlc3Npb24+NTwvdGlmZjpDb21wcmVzc2lvbj4KICAgICAgPC9yZGY6RGVzY3JpcHRpb24+CiAgIDwvcmRmOlJERj4KPC94OnhtcG1ldGE+Cs+OiooAABNVSURBVHgB7d19bFVlnsDxp9yWtgLlRYqDbTcYoFhgJzooFwjdUE2BTCI3LKul3e7suG4UFMYJIVqm/mGclGUWZHajuyEhdTBVSmUhA9GZuqViwkB7YXyZjWuhhbpCC2qF8lJsS9/213vxejk95d577u3lvHxPGjjnOc/znOf5PA/9cd7uTRgYGFAsCCCAAAIIRCgwKsL8ZEcAAQQQQGBQgPjBPEAAAQQQMCJA/DCiRhkEEEAAAeIHcwABBBBAwIgA8cOIGmUQQAABBIgfzAEEEEAAASMCxA8japRBAAEEECB+MAcQQAABBIwIED+MqFEGAQQQQID4wRxAAAEEEDAiQPwwokYZBBBAAAHiB3MAAQQQQMCIAPHDiBplEEAAAQQSwyeoqqravXt3+PnJqStQVFRUUFCgu8u6icyNmIydLedGTGSoxJwCEcQPCR5HvEdy3Dnm7IklWtXgbZB22i9+yNzwHjzotsQYmLWRXl/D7Dc3zOpNu2IgEEH8kKNJ8Cg7UBaDwzq1ilJPqV27LsHjgF37Fpd+eeJyFA6CQAwFuP8RQ0yqQgABBBwkQPxw0GDTVQQQQCCGAsSPGGJSFQIIIOAgAeKHgwabriKAAAIxFCB+xBCTqhBAAAEHCRA/HDTYdBUBBBCIoQDxI4aYVIUAAgg4SID44aDBpqsIIIBADAWIHzHEpCoEEEDAQQLEDwcNNl1FAAEEYigQ2eeXxPDA0VR1o+vGpa8vSQ2JSYmT7508XFXXr16/1n5N9ianJk+cMnG4bKTbW+C8UseV+lypdKWmKTVfqfH27jC9QyBeApaMH3/6/Z9+XfhrIUpKSdp/Yf/YCWN1uX7z5G+O7D8iu9w/dW95b4tuHhJtLFCl1EalWm7tYZpSTyslH0M24dZ0thBAIFIBS16/GhgY8Pezp6vng6oPdPt85eKVunfr/LsSEhJ085BoV4E+pV5QarUveLiUmqfUPyu1SqkpSl1VaptSP1XqO7t2nn4hEC8BS8aPYJzqXdXBm4H12t21vTd6A5tWXOns7LRis83Q5s1KbfW1Y4VScqHzz0rtVOq/lDqr1L/40uV/FmvN0FDagICVBSwcP1xJrqTkpIb6hrMn5deCdvnj7/4oSSljU7Q7TL/d2tq6ZcuW7Ozsffv2mb6xZmygBIxXfe0qVGq/UmlBbUxWqsT3I2nv+M5FgnayigACkQlYOH6kTUpbtGKRdLf6Te0pyOm/nD79yenRqaMfKXgkMo87l7urq2vPnj35+flZWVmlpaVNTU13ri3WPrJcnroi98Z8pyBy8Wro8pxSMu+7lHp/6D5SEEAgbAELxw/p4/KfL5c/aypq+vv7g7vsv6iVuzJ3zPgxwenmXK+vr1+zZk16enphYeHhw4fl7o6mO+ZstmlbVeNr2RNKZQzTxExf8Lih1N8Nk4FkBBAIR8Da8ePhZQ9P/NHEb1u//XONXOK+ufT29B56+5Bs+KPL98mm+9t/nWr69OkLFy4sLy/v6OiQJvb1ya1flqgE/Cdug2emwy9ydiI/PFYxvBB7EAgtYMnndwPdcrlcS/9hadXWKjnhmL9svj+9/g/1V9quTM6c/JNHf3K8Wh79N9ciEUKuU0nAqK2tlQfD/Kcavb06t/q3b9++d+9ec7V+mNZ4vV55u8IMS5vv4pW0ZNqtralQ6sNbU2RrsVJPDkkkAQEEwhSwdvyQTi77x2USP+SNkI7LHf4XQap/N3g7ZNnPlo0aZe2zqzCHkGzBAvJ4rn/RzOyjSr3x/a7A3/IYOPEjoMEKApEKaP6VRVr8zue/b859sx6ederEKXkRZMUzK9q/aZfzD2mWxJU73zi9Fsg502rfItevKioqdu7c2dzcnJiYOPQUZMOGDcXFxXp1mC7N4/GogwfN0Kxp8nEDSnUrdVqppUENWq3U3KDNcqU+DdpkFQEEDAjY4X/o/vsc/nvm8tpHX0/fnEVzsrKzDHDEs0hGRkZJScmZM2fq6uqeeuqpsWPHytElusSzDfY7lvDl+Ho1+J+IoGWJUuuCfu4J2sUqAggYE7BD/Hhk9SM3XwQ5ddb/2ofJ75xrhmrBggU7duxoa2urrKzMy8uTmyJcedMQRbS5xJe7UqkzwxS7qJR3mF0kI4BA+AJ2iB+BF0Fef/715v9pltc+8grywicwSc6UlBS5rFVTU3Pu3LmysrKZM2eapGGWa8ZLSsmHZfb6zjZ03+B/UanLlusVDUbAfAJ2iB+i6j/hOPH+CVkffO0jzQKvfQw3GfzXtRobG1etkk9sYolY4G6lXvEVkucocpVqCKrga6VWKiU3P1gQQCB6AZvED3kRZNLUSX4Oa128us0Qpqam3mYvu24jILc6/k2p0Up9pNRspeRux6NKzVBqqlK/VypTqX+6TWF2IYBAeAIWjh/y+VeBPspt5/zifNlMz0qX1z4C6f4VV+IPOTW72LSrwPNKHVNqiVJyKvqNUvIpzXI7RCLKY0p9rNTLvm5b/ulDuw4e/bKIgCX/BT1a+Kj8aITX/Osa+dEkPvvqs/KjSWTTIQLyse2H5ZV+3yWsU77zDzkXkdfO/cvN7wD4fpO/EUAgUgFLxo9IO0l+JwvIuae8+SE/LAggEFsBC1+/ii0EtSGAAAIIRCRA/IiIi8wIIIAAAjcFiB9MBQQQQAABIwLEDyNqlEEAAQQQIH4wBxBAAAEEjAgQP4yoUQYBBBBAgPjBHEAAAQQQMCJA/DCiRhkEEEAAAeIHcwABBBBAwIgA8cOIGmUQQAABBCL7/JIGb0OppxQ1wwICmOuWzxS34SLfyOSxYbfi1yUBdMfvaBwJgRgIRBA/ioqKYnDAkayir08+K8/UXwErwcP8jAaGyJadMuAQTREJHjBGA0jZ+AskDAzY53NI9+7dK4KPP/54/B05IgIIIOA0AVvFj+XLl8v4VVfL986xIIAAAgiMrIB94seFCxfkm19Fq7W1depU+aI5FgQQQACBERSwz/NXb731VoJvkZURBKNqBBBAAAGfgH3OP7Kzs5uamiSCzJgxo7GxkfFFAAEEEBhRAZucf5w4cUKCh0jJ4wCyIpsjqkblCCCAAAI2iR+7du1KTLz5LLKsyCZDiwACCCAwogJ2uH7V3d2dnp5+7dq1gNS4cePa2tqSk5MDKawggAACCMRWwA7nHwcPHgwOHgIkm5IYWylqQwABBBAIFrBD/CgvL3e5XMG9kk1JDE5hHQEEEEAgtgKWv37lf+1j6Fv08iAWL4LEdq5QGwIIIBAsYPnzD/9rH8Fd8q9L/OBFkKEspCCAAAKxErD8+UdOTs7Jkyd1Oe6///6GhgbdXSQigAACCEQpEMHn70Z5pJEo3tnZuXHjxkDNr732mqyvX78+kCIZUlNTA5usIIAAAgjESsDy5x/BEB7P4DdQHDhwIDiRdQQQQACBkRCw/P2PkUChTgQQQACBkALEj5BEZEAAAQQQ0BEgfuigkIQAAgggEFKA+BGSiAwIIIAAAjoCxA8dFJIQQAABBEIKED9CEpEBAQQQQEBHgPihg0ISAggggEBIAeJHSCIyIIAAAgjoCBA/dFBIQgABBBAIKUD8CElEBgQQQAABHQHihw4KSQgggAACIQWIHyGJyIAAAgggoCNA/NBBIQkBBBBAIKQA8SMkERkQQAABBHQEiB86KCQhgAACCIQUIH6EJCIDAggggICOAPFDB4UkBBBAAIGQAsSPkERkQAABBBDQESB+6KCQhAACCCAQUoD4EZKIDAgggAACOgLEDx0UkhBAAAEEQgokDAwMhMzkz1BVVbV79+4wM9+RbF6vV47rdrvvyNHDPGhRUVFBQUGYma2Szfxzw/ySra2t0siMjAzzN9WcLQQwJuMS0S+oxPAPKcHDe8TrzjHvb+fJqZMTVIL6Nvw+xTunt2EwwtkvfgzODW+t250Zb1AbHa+lpeXy5a6MjA4b9SmuXQEwem6vt0UqCf8XVATxQ+qV4HGg7ED0rXRsDZ5Sj137LsHjwIFCu/YuDv3yeCrlXy+GhqkBNEwXKCiGgfVwVrj/EY4SeRBAAAEEtALED60I2wgggAAC4QgQP8JRIg8CCCCAgFaA+KEVYRsBBBBAIBwB4kc4SuRBAAEEENAKED+0ImwjgAACCIQjQPwIR4k8CCCAAAJaAeKHVoRtBBBAAIFwBIgf4SiRBwEEEEBAK0D80IqwjQACCCAQjkBkn18STo3xzNPS1tLX16c5YsrolHsm3aNJZNOxAufPXz1+vPXzz9vS08dMmzZh/vyM8eNTHKthoOMAGkDTFLGrobXjh3ut+/zF85qhks2xKWMXzlm4be22H0//8dC9pDhEoKrqs40b/7ul5Wpwf9PSkp9+el5pae6ECanB6awPFQBwqEmkKfY2tHb88I/lmJQx8uNfv9Fz4/L1yx1dHTUf1cx7el7df9Y9NOuhSIec/FYX6Ovr37Tp0Natx6QjLlfCAw/86MEHp7a3dx45cvabb65v23bs6NGzhw797K67Rlu9pyPUfgCjh3WCoR3iR2lx6aa/3xQY72vfXdt9aPcvX/9lV0/X+n9fLyEksMtaK52dnamp/B/ZyKBt3nzEHzxWrJhVUbEyLe3mBavu7t7f/rZu06baurqWtWvfe/PNlUZqd0AZAKMfZCcY2vD++bi7xj2z4plfFf9KZsDxk8e7b3RHPxXiWYN8Dc6WLVuys7P37dsXz+Pa5liXLn336quDZx6FhXP37y8IBA9JSU5OLCnJLSlZLOvvvPO/V6922abXMewIgNFjOsTQhvHDP/aL/3rwd0T/QP8XX30R/WyIQw1dXV179uzJz8/PysoqLS1tamqKw0FteQi5PHXlSndS0qitW5e6XDoz/LnnHh41KqGrq/f998/YUiDKTgEYJaAUd4ihHa5f6Q72V5e+8qdPHj9ZN4N5Euvr63ft2vX22293dHS4XC75RmFZzNM8y7WkpqZZ2vzEE3MyMtJ0G5+ZOb6r6yXZlZioE110izgqEcDoh9shhvaMH+3X2je/tVkmwZQJU0wbP+Q6VUVFxc6dO5ubmxMTE3t7e6XBQx9Hjn4qO62GpqaL0uVFi7Ju0/GkJNdt9jp8F4DRTwCHGNohfrxX/57cM/cPeU9vj7wUUn28Wp7CkpSSopLop0Jsa5AIIdepysvLa2trExIS+vv7pX5/8NAcaPv27Xv37tUkmnPT6/Wmp5vinKmt7bpcvBIledUj2Kqi4i8ffvh/wSmyvnjxXz355IOaRIdvAhj9BHCOoR3ix9HPjsqPZtRdo1zrVq77xd/+QpPOpr0Frl69+biE5tqUPLD7xhufaPou1wmJHxoTADUgBjadY2iH+JH3QJ7/brl/pEcnjZ5+73R57WNm5kwDYz/SReQOx2rfonv9KvjoGzZsKC4uDk4x7brH41HqlBmaJ6cdycmu7u6+06cvLV36Q4tWr547d+6UwHZ5+SeffnrzDlkgkRURADD6aeAcQzvEj/yH8oPf/4h++ONTQ0ZGRolv0dw/5xZINP7ywFVOTrrEhvr6lmefnR+oasmS++QnsPnuu42BdVaCBQAM1jC27hxDnj8xNkNiWWrBggU7duxoa2urrKzMy8uTmyKjRjEuxoWXLJkmhSsrPztz5pJuLRcvfuf1turuIlEEAIx+GjjEkN9T0U+V2NSQkpIil7VqamrOnTtXVlY2c6YZL77FpqsjXMtLL/3NxIkpvb3969b9obOzZ+jRXnyx5vJl3hwcCnMzBcBhacLe4RBD4kfYMyJeGf3XtRobG1etWhWvY9rqOHfffdcrr+RJl6qrT+fmvtHQ0Bbo3tdfd6xcKQ+/aW+kBzKwIgIARj8NHGJoh/sf0Q+2OWvgw68Mj8u6de6+voEXXqj56KMLs2f/x5QpY+Tm+ZdfXm5ubpdXMzMz05YunT70cSzDh7NfQQCjH1MnGFr7/CPRRfyLfp7bs4bnn19w7NhTchl6zJgk+czdDz744syZ9tGjXY89lv3xx8+8/PIS6bbmGV97QhjtFYBG5X4oZ3tDa//+/bLqyx/GijUEbhWYN+/ew4d/Lh+jLZewTp26OGPGpNmz0wNvng8MvHxrdra0AgBqRSLftrehteNH5KNJCccJyMOUc+feIz+O63mMOgxg9JB2NbT29avox5UaEEAAAQSMCRA/jLlRCgEEEHC6APHD6TOA/iOAAALGBIgfxtwohQACCDhdgPjh9BlA/xFAAAFjAsQPY26UQgABBJwuQPxw+gyg/wgggIAxAeKHMTdKIYAAAk4XIH44fQbQfwQQQMCYAPHDmBulEEAAAacLRPb5Jd4Gr6dUvqmUxaCAALpz3QYLm7uY19vi8VSau42mbp0AyreSYGh4kAA0TBcoKIZu96zAZsiVCOJHUVFRyOrIcHsBCR62ZLRlp24/lDHfm5k5NjNTas2Iec0OqRDA6AdagkdE/5YTBuT7EFgQQAABBBCIUID7HxGCkR0BBBBAwCdA/GAiIIAAAggYESB+GFGjDAIIIIAA8YM5gAACCCBgRID4YUSNMggggAACxA/mAAIIIICAEQHihxE1yiCAAAIIED+YAwgggAACRgSIH0bUKIMAAgggQPxgDiCAAAIIGBEgfhhRowwCCCCAAPGDOYAAAgggYETg/wER6P8zJV6QigAAAABJRU5ErkJggg=="},500:function(s,t,n){s.exports=n.p+"assets/img/process.20a41f34.png"},501:function(s,t,n){s.exports=n.p+"assets/img/go-diaoduqi.8e5fb71a.png"},521:function(s,t,n){"use strict";n.r(t);var a=n(20),e=Object(a.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"gmp-模型"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#gmp-模型"}},[s._v("#")]),s._v(" gmp 模型")]),s._v(" "),a("h2",{attrs:{id:"调度器"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#调度器"}},[s._v("#")]),s._v(" 调度器")]),s._v(" "),a("p",[s._v("M 被创建后会在 P 空闲队列中获取 P 进行绑定,未绑定则进入阻塞状态.P 可以和多个 M 进行绑定,同一时刻只能绑定在一个 M 上. S 全局调度器, 维护 M、P 和 G 队列,负责调度.")]),s._v(" "),a("p",[s._v("本地队列 : 每个 P 维护一个本地队列存放,当前与 P 绑定的 M 若生产 G 会放入本地队列,当本地队列满会拿出一半的本地队列中的 G 放入全局队列,如果当前 M 绑定的 P 没有可执行的 G 随机从 P 中拿去一半放入自己的队列.")]),s._v(" "),a("p",[s._v("全局队列 : 存放本地队列溢出的 G,调度过程中有 1/61 概率检查全局队列,确保全局队列中的 G 会被执行.")]),s._v(" "),a("p",[s._v("如果当前 M 执行的 G 调度 syscall 阻塞, P 会与 M 进行分离, M 负责执行阻塞的 G,P 带着队列中的 G 绑定到新的 M 中,继续执行其他 G,使得当前 G 进入阻塞也不会硬系那个 P 去执行其他 G. M 执行 G 阻塞操作返回后如果没有了 P,尝试获取新的 P 去执行,如果获取不到 P,M 就会把当前 G 放入全局队列等待调度,自己处于休眠状态.")]),s._v(" "),a("p",[a("img",{attrs:{src:n(499),alt:"GMP"}})]),s._v(" "),a("h2",{attrs:{id:"goroutine"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#goroutine"}},[s._v("#")]),s._v(" goroutine")]),s._v(" "),a("p",[s._v("可以看作是用户态的线程,用户态的线程是需要自己去调度的.go 运行时 scheduler 去完成调度.")]),s._v(" "),a("h2",{attrs:{id:"线程自旋"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#线程自旋"}},[s._v("#")]),s._v(" 线程自旋")]),s._v(" "),a("p",[s._v("相对与阻塞线程变现为循环执行指定逻辑而不进入阻塞状态,在 go 调度逻辑中为了实现高并发如果全局队列和本地队列都为空绑定 P 的 M 没有 G 可执行会进入自旋状态等待新的 G,不会进入阻塞休眠状态,减少上下文切换成本.只有绑定了 P 的 M 才会进入自旋状态.最多有 GOMAXPROCS 个自旋线程,未绑定的空闲 M 会进入休眠状态.")]),s._v(" "),a("h2",{attrs:{id:"定义"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#定义"}},[s._v("#")]),s._v(" 定义")]),s._v(" "),a("div",{staticClass:"language-go line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// src/runtime/HACKING.md")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("div",{staticClass:"language-go line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("type")]),s._v(" g "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("struct")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Stack parameters.")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// stack describes the actual stack memory: [stack.lo, stack.hi).")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// stackguard0 is the stack pointer compared in the Go stack growth prologue.")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// It is stack.lo+StackGuard normally, but can be StackPreempt to trigger a preemption.")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// stackguard1 is the stack pointer compared in the C stack growth prologue.")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// It is stack.lo+StackGuard on g0 and gsignal stacks.")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// It is ~0 on other goroutine stacks, to trigger a call to morestackc (and crash).")]),s._v("\n\tstack       stack   "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// offset known to runtime/cgo")]),s._v("\n\tstackguard0 "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("uintptr")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// offset known to liblink")]),s._v("\n\tstackguard1 "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("uintptr")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// offset known to liblink")]),s._v("\n\n\t_panic         "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("_panic "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// innermost panic - offset known to liblink")]),s._v("\n\t_defer         "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("_defer "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// innermost defer")]),s._v("\n\tm              "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("m      "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// current m; offset known to arm liblink")]),s._v("\n\tsched          gobuf\n\tsyscallsp      "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("uintptr")]),s._v("        "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// if status==Gsyscall, syscallsp = sched.sp to use during gc")]),s._v("\n\tsyscallpc      "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("uintptr")]),s._v("        "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// if status==Gsyscall, syscallpc = sched.pc to use during gc")]),s._v("\n\tstktopsp       "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("uintptr")]),s._v("        "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// expected sp at top of stack, to check in traceback")]),s._v("\n\tparam          unsafe"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Pointer "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// passed parameter on wakeup")]),s._v("\n\tatomicstatus   "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("uint32")]),s._v("\n\tstackLock      "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("uint32")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// sigprof/scang lock; TODO: fold in to atomicstatus")]),s._v("\n\tgoid           "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("int64")]),s._v("\n\tschedlink      guintptr\n\twaitsince      "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("int64")]),s._v("      "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// approx time when the g become blocked")]),s._v("\n\twaitreason     waitReason "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// if status==Gwaiting")]),s._v("\n\tpreempt        "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("bool")]),s._v("       "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// preemption signal, duplicates stackguard0 = stackpreempt")]),s._v("\n\tpaniconfault   "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("bool")]),s._v("       "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// panic (instead of crash) on unexpected fault address")]),s._v("\n\tpreemptscan    "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("bool")]),s._v("       "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// preempted g does scan for gc")]),s._v("\n\tgcscandone     "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("bool")]),s._v("       "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// g has scanned stack; protected by _Gscan bit in status")]),s._v("\n\tgcscanvalid    "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("bool")]),s._v("       "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// false at start of gc cycle, true if G has not run since last scan; TODO: remove?")]),s._v("\n\tthrowsplit     "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("bool")]),s._v("       "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// must not split stack")]),s._v("\n\traceignore     "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("int8")]),s._v("       "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// ignore race detection events")]),s._v("\n\tsysblocktraced "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("bool")]),s._v("       "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// StartTrace has emitted EvGoInSyscall about this goroutine")]),s._v("\n\tsysexitticks   "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("int64")]),s._v("      "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// cputicks when syscall has returned (for tracing)")]),s._v("\n\ttraceseq       "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("uint64")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// trace event sequencer")]),s._v("\n\ttracelastp     puintptr   "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// last P emitted an event for this goroutine")]),s._v("\n\tlockedm        muintptr\n\tsig            "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("uint32")]),s._v("\n\twritebuf       "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("byte")]),s._v("\n\tsigcode0       "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("uintptr")]),s._v("\n\tsigcode1       "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("uintptr")]),s._v("\n\tsigpc          "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("uintptr")]),s._v("\n\tgopc           "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("uintptr")]),s._v("         "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// pc of go statement that created this goroutine")]),s._v("\n\tancestors      "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("ancestorInfo "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// ancestor information goroutine(s) that created this goroutine (only used if debug.tracebackancestors)")]),s._v("\n\tstartpc        "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("uintptr")]),s._v("         "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// pc of goroutine function")]),s._v("\n\tracectx        "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("uintptr")]),s._v("\n\twaiting        "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("sudog         "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// sudog structures this g is waiting on (that have a valid elem ptr); in lock order")]),s._v("\n\tcgoCtxt        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("uintptr")]),s._v("      "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// cgo traceback context")]),s._v("\n\tlabels         unsafe"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Pointer "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// profiler labels")]),s._v("\n\ttimer          "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("timer         "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// cached timer for time.Sleep")]),s._v("\n\tselectDone     "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("uint32")]),s._v("         "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// are we participating in a select and did someone win the race?")]),s._v("\n\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Per-G GC state")]),s._v("\n\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// gcAssistBytes is this G's GC assist credit in terms of")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// bytes allocated. If this is positive, then the G has credit")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// to allocate gcAssistBytes bytes without assisting. If this")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// is negative, then the G must correct this by performing")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// scan work. We track this in bytes to make it fast to update")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// and check for debt in the malloc hot path. The assist ratio")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// determines how this corresponds to scan work debt.")]),s._v("\n\tgcAssistBytes "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("int64")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br"),a("span",{staticClass:"line-number"},[s._v("48")]),a("br"),a("span",{staticClass:"line-number"},[s._v("49")]),a("br"),a("span",{staticClass:"line-number"},[s._v("50")]),a("br"),a("span",{staticClass:"line-number"},[s._v("51")]),a("br"),a("span",{staticClass:"line-number"},[s._v("52")]),a("br"),a("span",{staticClass:"line-number"},[s._v("53")]),a("br"),a("span",{staticClass:"line-number"},[s._v("54")]),a("br"),a("span",{staticClass:"line-number"},[s._v("55")]),a("br"),a("span",{staticClass:"line-number"},[s._v("56")]),a("br"),a("span",{staticClass:"line-number"},[s._v("57")]),a("br"),a("span",{staticClass:"line-number"},[s._v("58")]),a("br"),a("span",{staticClass:"line-number"},[s._v("59")]),a("br"),a("span",{staticClass:"line-number"},[s._v("60")]),a("br"),a("span",{staticClass:"line-number"},[s._v("61")]),a("br"),a("span",{staticClass:"line-number"},[s._v("62")]),a("br"),a("span",{staticClass:"line-number"},[s._v("63")]),a("br"),a("span",{staticClass:"line-number"},[s._v("64")]),a("br")])]),a("div",{staticClass:"language-go line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("type")]),s._v(" m "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("struct")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\tg0      "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("g     "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// goroutine with scheduling stack")]),s._v("\n\tmorebuf gobuf  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// gobuf arg to morestack")]),s._v("\n\tdivmod  "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("uint32")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// div/mod denominator for arm - known to liblink")]),s._v("\n\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Fields not known to debuggers.")]),s._v("\n\tprocid        "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("uint64")]),s._v("       "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// for debuggers, but offset not hard-coded")]),s._v("\n\tgsignal       "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("g           "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// signal-handling g")]),s._v("\n\tgoSigStack    gsignalStack "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Go-allocated signal handling stack")]),s._v("\n\tsigmask       sigset       "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// storage for saved signal mask")]),s._v("\n\ttls           "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("uintptr")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// thread-local storage (for x86 extern register)")]),s._v("\n\tmstartfn      "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("func")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\tcurg          "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("g       "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// current running goroutine")]),s._v("\n\tcaughtsig     guintptr "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// goroutine running during fatal signal")]),s._v("\n\tp             puintptr "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// attached p for executing go code (nil if not executing go code)")]),s._v("\n\tnextp         puintptr\n\toldp          puintptr "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// the p that was attached before executing a syscall")]),s._v("\n\tid            "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("int64")]),s._v("\n\tmallocing     "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("int32")]),s._v("\n\tthrowing      "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("int32")]),s._v("\n\tpreemptoff    "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("string")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('// if != "", keep curg running on this m')]),s._v("\n\tlocks         "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("int32")]),s._v("\n\tdying         "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("int32")]),s._v("\n\tprofilehz     "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("int32")]),s._v("\n\tspinning      "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("bool")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// m is out of work and is actively looking for work")]),s._v("\n\tblocked       "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("bool")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// m is blocked on a note")]),s._v("\n\tnewSigstack   "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("bool")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// minit on C thread called sigaltstack")]),s._v("\n\tprintlock     "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("int8")]),s._v("\n\tincgo         "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("bool")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// m is executing a cgo call")]),s._v("\n\tfreeWait      "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("uint32")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// if == 0, safe to free g0 and delete m (atomic)")]),s._v("\n\tfastrand      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("uint32")]),s._v("\n\tneedextram    "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("bool")]),s._v("\n\ttraceback     "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("uint8")]),s._v("\n\tncgocall      "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("uint64")]),s._v("      "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// number of cgo calls in total")]),s._v("\n\tncgo          "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("int32")]),s._v("       "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// number of cgo calls currently in progress")]),s._v("\n\tcgoCallersUse "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("uint32")]),s._v("      "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// if non-zero, cgoCallers in use temporarily")]),s._v("\n\tcgoCallers    "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("cgoCallers "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// cgo traceback if crashing in cgo call")]),s._v("\n\tpark          note\n\talllink       "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("m "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// on allm")]),s._v("\n\tschedlink     muintptr\n\tmcache        "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("mcache\n\tlockedg       guintptr\n\tcreatestack   "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("32")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("uintptr")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// stack that created this thread.")]),s._v("\n\tlockedExt     "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("uint32")]),s._v("      "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// tracking for external LockOSThread")]),s._v("\n\tlockedInt     "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("uint32")]),s._v("      "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// tracking for internal lockOSThread")]),s._v("\n\tnextwaitm     muintptr    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// next m waiting for lock")]),s._v("\n\twaitunlockf   "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("func")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("g"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" unsafe"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Pointer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("bool")]),s._v("\n\twaitlock      unsafe"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Pointer\n\twaittraceev   "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("byte")]),s._v("\n\twaittraceskip "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("int")]),s._v("\n\tstartingtrace "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("bool")]),s._v("\n\tsyscalltick   "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("uint32")]),s._v("\n\tthread        "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("uintptr")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// thread handle")]),s._v("\n\tfreelink      "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("m      "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// on sched.freem")]),s._v("\n\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// these are here because they are too large to be on the stack")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// of low-level NOSPLIT functions.")]),s._v("\n\tlibcall   libcall\n\tlibcallpc "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("uintptr")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// for cpu profiler")]),s._v("\n\tlibcallsp "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("uintptr")]),s._v("\n\tlibcallg  guintptr\n\tsyscall   libcall "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// stores syscall parameters on windows")]),s._v("\n\n\tvdsoSP "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("uintptr")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// SP for traceback while in VDSO call (0 if not in call)")]),s._v("\n\tvdsoPC "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("uintptr")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// PC for traceback while in VDSO call")]),s._v("\n\n\tdlogPerM\n\n\tmOS\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br"),a("span",{staticClass:"line-number"},[s._v("48")]),a("br"),a("span",{staticClass:"line-number"},[s._v("49")]),a("br"),a("span",{staticClass:"line-number"},[s._v("50")]),a("br"),a("span",{staticClass:"line-number"},[s._v("51")]),a("br"),a("span",{staticClass:"line-number"},[s._v("52")]),a("br"),a("span",{staticClass:"line-number"},[s._v("53")]),a("br"),a("span",{staticClass:"line-number"},[s._v("54")]),a("br"),a("span",{staticClass:"line-number"},[s._v("55")]),a("br"),a("span",{staticClass:"line-number"},[s._v("56")]),a("br"),a("span",{staticClass:"line-number"},[s._v("57")]),a("br"),a("span",{staticClass:"line-number"},[s._v("58")]),a("br"),a("span",{staticClass:"line-number"},[s._v("59")]),a("br"),a("span",{staticClass:"line-number"},[s._v("60")]),a("br"),a("span",{staticClass:"line-number"},[s._v("61")]),a("br"),a("span",{staticClass:"line-number"},[s._v("62")]),a("br"),a("span",{staticClass:"line-number"},[s._v("63")]),a("br"),a("span",{staticClass:"line-number"},[s._v("64")]),a("br"),a("span",{staticClass:"line-number"},[s._v("65")]),a("br"),a("span",{staticClass:"line-number"},[s._v("66")]),a("br"),a("span",{staticClass:"line-number"},[s._v("67")]),a("br"),a("span",{staticClass:"line-number"},[s._v("68")]),a("br"),a("span",{staticClass:"line-number"},[s._v("69")]),a("br"),a("span",{staticClass:"line-number"},[s._v("70")]),a("br")])]),a("div",{staticClass:"language-go line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("type")]),s._v(" p "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("struct")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\tid          "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("int32")]),s._v("\n\tstatus      "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("uint32")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// one of pidle/prunning/...")]),s._v("\n\tlink        puintptr\n\tschedtick   "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("uint32")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// incremented on every scheduler call")]),s._v("\n\tsyscalltick "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("uint32")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// incremented on every system call")]),s._v("\n\tsysmontick  sysmontick "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// last tick observed by sysmon")]),s._v("\n\tm           muintptr   "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// back-link to associated m (nil if idle)")]),s._v("\n\tmcache      "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("mcache\n\traceprocctx "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("uintptr")]),s._v("\n\n\tdeferpool    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("_defer "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// pool of available defer structs of different sizes (see panic.go)")]),s._v("\n\tdeferpoolbuf "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("32")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("_defer\n\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Cache of goroutine ids, amortizes accesses to runtime·sched.goidgen.")]),s._v("\n\tgoidcache    "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("uint64")]),s._v("\n\tgoidcacheend "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("uint64")]),s._v("\n\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Queue of runnable goroutines. Accessed without lock.")]),s._v("\n\trunqhead "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("uint32")]),s._v("\n\trunqtail "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("uint32")]),s._v("\n\trunq     "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("256")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("guintptr\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// runnext, if non-nil, is a runnable G that was ready'd by")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// the current G and should be run next instead of what's in")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// runq if there's time remaining in the running G's time")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// slice. It will inherit the time left in the current time")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// slice. If a set of goroutines is locked in a")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// communicate-and-wait pattern, this schedules that set as a")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// unit and eliminates the (potentially large) scheduling")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// latency that otherwise arises from adding the ready'd")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// goroutines to the end of the run queue.")]),s._v("\n\trunnext guintptr\n\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Available G's (status == Gdead)")]),s._v("\n\tgFree "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("struct")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\tgList\n\t\tn "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("int32")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n\tsudogcache "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("sudog\n\tsudogbuf   "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("128")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("sudog\n\n\ttracebuf traceBufPtr\n\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// traceSweep indicates the sweep events should be traced.")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// This is used to defer the sweep start event until a span")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// has actually been swept.")]),s._v("\n\ttraceSweep "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("bool")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// traceSwept and traceReclaimed track the number of bytes")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// swept and reclaimed by sweeping in the current sweep loop.")]),s._v("\n\ttraceSwept"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" traceReclaimed "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("uintptr")]),s._v("\n\n\tpalloc persistentAlloc "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// per-P to avoid mutex")]),s._v("\n\n\t"),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("_")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("uint32")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Alignment for atomic fields below")]),s._v("\n\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Per-P GC state")]),s._v("\n\tgcAssistTime         "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("int64")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Nanoseconds in assistAlloc")]),s._v("\n\tgcFractionalMarkTime "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("int64")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Nanoseconds in fractional mark worker (atomic)")]),s._v("\n\tgcBgMarkWorker       guintptr "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// (atomic)")]),s._v("\n\tgcMarkWorkerMode     gcMarkWorkerMode\n\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// gcMarkWorkerStartTime is the nanotime() at which this mark")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// worker started.")]),s._v("\n\tgcMarkWorkerStartTime "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("int64")]),s._v("\n\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// gcw is this P's GC work buffer cache. The work buffer is")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// filled by write barriers, drained by mutator assists, and")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// disposed on certain GC state transitions.")]),s._v("\n\tgcw gcWork\n\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// wbBuf is this P's GC write barrier buffer.")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// TODO: Consider caching this in the running G.")]),s._v("\n\twbBuf wbBuf\n\n\trunSafePointFn "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("uint32")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// if 1, run sched.safePointFn at next safe point")]),s._v("\n\n\tpad cpu"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("CacheLinePad\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br"),a("span",{staticClass:"line-number"},[s._v("48")]),a("br"),a("span",{staticClass:"line-number"},[s._v("49")]),a("br"),a("span",{staticClass:"line-number"},[s._v("50")]),a("br"),a("span",{staticClass:"line-number"},[s._v("51")]),a("br"),a("span",{staticClass:"line-number"},[s._v("52")]),a("br"),a("span",{staticClass:"line-number"},[s._v("53")]),a("br"),a("span",{staticClass:"line-number"},[s._v("54")]),a("br"),a("span",{staticClass:"line-number"},[s._v("55")]),a("br"),a("span",{staticClass:"line-number"},[s._v("56")]),a("br"),a("span",{staticClass:"line-number"},[s._v("57")]),a("br"),a("span",{staticClass:"line-number"},[s._v("58")]),a("br"),a("span",{staticClass:"line-number"},[s._v("59")]),a("br"),a("span",{staticClass:"line-number"},[s._v("60")]),a("br"),a("span",{staticClass:"line-number"},[s._v("61")]),a("br"),a("span",{staticClass:"line-number"},[s._v("62")]),a("br"),a("span",{staticClass:"line-number"},[s._v("63")]),a("br"),a("span",{staticClass:"line-number"},[s._v("64")]),a("br"),a("span",{staticClass:"line-number"},[s._v("65")]),a("br"),a("span",{staticClass:"line-number"},[s._v("66")]),a("br"),a("span",{staticClass:"line-number"},[s._v("67")]),a("br"),a("span",{staticClass:"line-number"},[s._v("68")]),a("br"),a("span",{staticClass:"line-number"},[s._v("69")]),a("br"),a("span",{staticClass:"line-number"},[s._v("70")]),a("br"),a("span",{staticClass:"line-number"},[s._v("71")]),a("br"),a("span",{staticClass:"line-number"},[s._v("72")]),a("br"),a("span",{staticClass:"line-number"},[s._v("73")]),a("br"),a("span",{staticClass:"line-number"},[s._v("74")]),a("br"),a("span",{staticClass:"line-number"},[s._v("75")]),a("br"),a("span",{staticClass:"line-number"},[s._v("76")]),a("br"),a("span",{staticClass:"line-number"},[s._v("77")]),a("br"),a("span",{staticClass:"line-number"},[s._v("78")]),a("br"),a("span",{staticClass:"line-number"},[s._v("79")]),a("br"),a("span",{staticClass:"line-number"},[s._v("80")]),a("br")])]),a("h3",{attrs:{id:"抢占式调度"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#抢占式调度"}},[s._v("#")]),s._v(" 抢占式调度")]),s._v(" "),a("div",{staticClass:"language-go line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h2",{attrs:{id:"进程-线程-协程"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#进程-线程-协程"}},[s._v("#")]),s._v(" 进程 & 线程 & 协程")]),s._v(" "),a("table",[a("thead",[a("tr",[a("th"),s._v(" "),a("th",[s._v("goroutine")]),s._v(" "),a("th",[s._v("线程")]),s._v(" "),a("th",[s._v("进程")])])]),s._v(" "),a("tbody",[a("tr",[a("td",[s._v("内存占用")]),s._v(" "),a("td",[s._v("栈内存消耗 2kb,栈空间不够才扩容,http server 一个请求一个 goroutine 开销更小")]),s._v(" "),a("td",[s._v("需要 1M 的栈内存,还需要 a guard page 和其他线程栈空间隔离")]),s._v(" "),a("td")]),s._v(" "),a("tr",[a("td",[s._v("创建和销毁")]),s._v(" "),a("td",[s._v("用户级别,只需要一个结构体")]),s._v(" "),a("td",[s._v("内核级别需要和操作系统打交道,通常用线程池解决")]),s._v(" "),a("td")]),s._v(" "),a("tr",[a("td",[s._v("切换")]),s._v(" "),a("td",[s._v("只需要保存三个寄存器(PC、BP、SP),约 200ns")]),s._v(" "),a("td",[s._v("需要保存各种寄存器,约 1000-1500 纳秒")]),s._v(" "),a("td")])])]),s._v(" "),a("h3",{attrs:{id:"线程创建销毁切换"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#线程创建销毁切换"}},[s._v("#")]),s._v(" 线程创建销毁切换")]),s._v(" "),a("h3",{attrs:{id:"goroutine-创建销毁切换"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#goroutine-创建销毁切换"}},[s._v("#")]),s._v(" goroutine 创建销毁切换")]),s._v(" "),a("h2",{attrs:{id:"系统调用-库函数"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#系统调用-库函数"}},[s._v("#")]),s._v(" 系统调用 & 库函数")]),s._v(" "),a("p",[s._v("系统调用是操作系统为用提供的一系列接口,这些接口提供了系统对硬件设备的操作,库函数是对系统调用的一层封装,库函数可以包含一个系统调用,有可能有好几个系统调用,也可以没有(不涉及内核操作),库函数运行在用户态.")]),s._v(" "),a("p",[s._v("使用 ltrace 查看 SYS_开头的都是系统调用")]),s._v(" "),a("p",[s._v("write 函数是将数据写入系统缓存区")]),s._v(" "),a("p",[s._v("fsync 函数强制将缓存区数据写入磁盘")]),s._v(" "),a("h3",{attrs:{id:"go-语言中的系统调用"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#go-语言中的系统调用"}},[s._v("#")]),s._v(" go 语言中的系统调用")]),s._v(" "),a("p",[s._v("尽管 go 提供 cgo 方便调用 C 函数,但还是自己对系统调用进行了封装,")]),s._v(" "),a("div",{staticClass:"language-go line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// syscall.go")]),s._v("\nSyscall     "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 参数不超过 4 个的系统调用")]),s._v("\nSyscall6    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 参数不超过 6 个的系统调用")]),s._v("\nRawSyscall "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 区别在与有没有 runtime")]),s._v("\nRawSyscall6\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("h2",{attrs:{id:"进程线程协程"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#进程线程协程"}},[s._v("#")]),s._v(" 进程线程协程")]),s._v(" "),a("p",[s._v("创建、调度、销毁")]),s._v(" "),a("h3",{attrs:{id:"进程"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#进程"}},[s._v("#")]),s._v(" 进程")]),s._v(" "),a("p",[s._v("资源管理最小单元."),a("code",[s._v("size")]),s._v("命令可以查看编译后程序各个区域的大小.")]),s._v(" "),a("p",[a("img",{attrs:{src:n(500),alt:"process"}})]),s._v(" "),a("h3",{attrs:{id:"线程"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#线程"}},[s._v("#")]),s._v(" 线程")]),s._v(" "),a("p",[s._v("运行调度的最小单元,线程被包含在进程中,是实际运行单元,多线程共享进程中全部系统资源.但线程有自己的调用栈、寄存器、线程本地存储,线程创建开销是堆栈的建立、分配内存、上下文切换(最大开销)")]),s._v(" "),a("p",[s._v("线程并没有特定数据结构,只有"),a("code",[s._v("task")]),s._v("这一个描述进程的结构体,内核只有进程没有线程,线程调度当作进程调度,线程其实是和其他进程共享资源的轻量级进程.")]),s._v(" "),a("p",[s._v("只有一个执行上下文和调度程序的统计信息与父进程共享进程地址空间.")]),s._v(" "),a("p",[s._v("线程分用户级线程和内核级线程.")]),s._v(" "),a("p",[s._v("用户线程的创建、调度、同步、销毁都由用户空间库函数完成不需要内核参与,此线程资源消耗低.")]),s._v(" "),a("ol",[a("li",[s._v("用户线程只能参与该进程处理器资源、不能参与全局处理器资源")]),s._v(" "),a("li",[s._v("用户线程开销低")]),s._v(" "),a("li",[s._v("内核并不知道用户线程的存在")]),s._v(" "),a("li",[s._v("如果引起阻塞调用,会立即阻塞该线程所属的整个进程.")]),s._v(" "),a("li",[s._v("只有一个处理器分配给该进程,不能发挥多核优势.")])]),s._v(" "),a("p",[s._v("内核线程建立和销毁都是操作系统负责,通过系统调用完成.内核维护进程和线程上下文信息和内存切换.")]),s._v(" "),a("ol",[a("li",[s._v("参与全局资源分配,可以利用多核优势")]),s._v(" "),a("li",[s._v("被内核调度,创建、销毁、调度都由内核管理")]),s._v(" "),a("li",[s._v("内核线程阻塞时同一个进程中的线程仍能继续运行")]),s._v(" "),a("li",[s._v("线程调度开销大,几乎和进程差不多")]),s._v(" "),a("li",[s._v("线程表放在操作系统固定表空间或堆栈空间,内核线程数量是有限的")])]),s._v(" "),a("h3",{attrs:{id:"协程"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#协程"}},[s._v("#")]),s._v(" 协程")]),s._v(" "),a("p",[s._v("io 密集型服务瓶颈不在 cpu 执行速度,而在尽可能快速完成高并发多连接下数据读写.")]),s._v(" "),a("ol",[a("li",[s._v("多进程 : 频繁调度切换、资源不共享(需要额外引入进程通信机制)")]),s._v(" "),a("li",[s._v("多线程 : 高并发场景下大量 io 等待导致频繁挂起和切换、共享资源存在竞争问题")])]),s._v(" "),a("p",[s._v("线程调度 : 需要保存用户线程状态到内存,恢复另一个线程的状态到寄存器,然后更新调度器数据结构,需要用户态和内核态切换")]),s._v(" "),a("p",[s._v("协程调度 : 完全用户控制、自己的寄存器上下文和栈,调度时将寄存器上下文和栈保存到其他地方,切换回来时恢复先前保存到寄存器上下文和栈直接操作用户空间栈,没有内核切换开销.")]),s._v(" "),a("h3",{attrs:{id:"进程调度"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#进程调度"}},[s._v("#")]),s._v(" 进程调度")]),s._v(" "),a("h3",{attrs:{id:"线程调度"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#线程调度"}},[s._v("#")]),s._v(" 线程调度")]),s._v(" "),a("h2",{attrs:{id:"timer-队列"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#timer-队列"}},[s._v("#")]),s._v(" timer 队列")]),s._v(" "),a("p",[s._v("创建 timer 会自动生成 goroutine 放入 timer 队列,每一轮调度都会检计时器队列是否就绪,如果有会将其排入本地队列根据本地队列大小会有延迟,引入异步抢占,goroutine 运行 10 ms 后会被抢占,减少延迟,一个 p 上创建计时器太多会拖累处理器,当前 p 繁忙时可以由另一个 p 运行计时器.异步抢占和工作窃取出现延迟可能性很小.")]),s._v(" "),a("h2",{attrs:{id:"g-的-9-种状态"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#g-的-9-种状态"}},[s._v("#")]),s._v(" G 的 9 种状态")]),s._v(" "),a("div",{staticClass:"language-go line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// runtime/runtime2.go")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// defined constants")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// G status")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Beyond indicating the general state of a G, the G status")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// acts like a lock on the goroutine's stack (and hence its")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// ability to execute user code).")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// If you add to this list, add to the list")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('// of "okay during garbage collection" status')]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// in mgcmark.go too.")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// TODO(austin): The _Gscan bit could be much lighter-weight.")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// For example, we could choose not to run _Gscanrunnable")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// goroutines found in the run queue, rather than CAS-looping")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// until they become _Grunnable. And transitions like")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// _Gscanwaiting -> _Gscanrunnable are actually okay because")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// they don't affect stack ownership.")]),s._v("\n\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// _Gidle means this goroutine was just allocated and has not")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// yet been initialized.")]),s._v("\n\t_Gidle "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("iota")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 0")]),s._v("\n\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// _Grunnable means this goroutine is on a run queue. It is")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// not currently executing user code. The stack is not owned.")]),s._v("\n\t_Grunnable "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 1")]),s._v("\n\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// _Grunning means this goroutine may execute user code. The")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// stack is owned by this goroutine. It is not on a run queue.")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// It is assigned an M and a P (g.m and g.m.p are valid).")]),s._v("\n\t_Grunning "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 2")]),s._v("\n\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// _Gsyscall means this goroutine is executing a system call.")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// It is not executing user code. The stack is owned by this")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// goroutine. It is not on a run queue. It is assigned an M.")]),s._v("\n\t_Gsyscall "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 3")]),s._v("\n\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// _Gwaiting means this goroutine is blocked in the runtime.")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// It is not executing user code. It is not on a run queue,")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// but should be recorded somewhere (e.g., a channel wait")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// queue) so it can be ready()d when necessary. The stack is")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// not owned *except* that a channel operation may read or")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// write parts of the stack under the appropriate channel")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// lock. Otherwise, it is not safe to access the stack after a")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// goroutine enters _Gwaiting (e.g., it may get moved).")]),s._v("\n\t_Gwaiting "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 4")]),s._v("\n\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// _Gmoribund_unused is currently unused, but hardcoded in gdb")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// scripts.")]),s._v("\n\t_Gmoribund_unused "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 5")]),s._v("\n\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// _Gdead means this goroutine is currently unused. It may be")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// just exited, on a free list, or just being initialized. It")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// is not executing user code. It may or may not have a stack")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// allocated. The G and its stack (if any) are owned by the M")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// that is exiting the G or that obtained the G from the free")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// list.")]),s._v("\n\t_Gdead "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 6")]),s._v("\n\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// _Genqueue_unused is currently unused.")]),s._v("\n\t_Genqueue_unused "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 7")]),s._v("\n\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// _Gcopystack means this goroutine's stack is being moved. It")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// is not executing user code and is not on a run queue. The")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// stack is owned by the goroutine that put it in _Gcopystack.")]),s._v("\n\t_Gcopystack "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 8")]),s._v("\n\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// _Gpreempted means this goroutine stopped itself for a")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// suspendG preemption. It is like _Gwaiting, but nothing is")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// yet responsible for ready()ing it. Some suspendG must CAS")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// the status to _Gwaiting to take responsibility for")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// ready()ing this G.")]),s._v("\n\t_Gpreempted "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 9")]),s._v("\n\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// _Gscan combined with one of the above states other than")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// _Grunning indicates that GC is scanning the stack. The")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// goroutine is not executing user code and the stack is owned")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// by the goroutine that set the _Gscan bit.")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// _Gscanrunning is different: it is used to briefly block")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// state transitions while GC signals the G to scan its own")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// stack. This is otherwise like _Grunning.")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// atomicstatus&~Gscan gives the state the goroutine will")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// return to when the scan completes.")]),s._v("\n\t_Gscan          "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0x1000")]),s._v("\n\t_Gscanrunnable  "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" _Gscan "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" _Grunnable  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 0x1001")]),s._v("\n\t_Gscanrunning   "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" _Gscan "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" _Grunning   "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 0x1002")]),s._v("\n\t_Gscansyscall   "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" _Gscan "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" _Gsyscall   "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 0x1003")]),s._v("\n\t_Gscanwaiting   "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" _Gscan "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" _Gwaiting   "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 0x1004")]),s._v("\n\t_Gscanpreempted "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" _Gscan "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" _Gpreempted "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 0x1009")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br"),a("span",{staticClass:"line-number"},[s._v("48")]),a("br"),a("span",{staticClass:"line-number"},[s._v("49")]),a("br"),a("span",{staticClass:"line-number"},[s._v("50")]),a("br"),a("span",{staticClass:"line-number"},[s._v("51")]),a("br"),a("span",{staticClass:"line-number"},[s._v("52")]),a("br"),a("span",{staticClass:"line-number"},[s._v("53")]),a("br"),a("span",{staticClass:"line-number"},[s._v("54")]),a("br"),a("span",{staticClass:"line-number"},[s._v("55")]),a("br"),a("span",{staticClass:"line-number"},[s._v("56")]),a("br"),a("span",{staticClass:"line-number"},[s._v("57")]),a("br"),a("span",{staticClass:"line-number"},[s._v("58")]),a("br"),a("span",{staticClass:"line-number"},[s._v("59")]),a("br"),a("span",{staticClass:"line-number"},[s._v("60")]),a("br"),a("span",{staticClass:"line-number"},[s._v("61")]),a("br"),a("span",{staticClass:"line-number"},[s._v("62")]),a("br"),a("span",{staticClass:"line-number"},[s._v("63")]),a("br"),a("span",{staticClass:"line-number"},[s._v("64")]),a("br"),a("span",{staticClass:"line-number"},[s._v("65")]),a("br"),a("span",{staticClass:"line-number"},[s._v("66")]),a("br"),a("span",{staticClass:"line-number"},[s._v("67")]),a("br"),a("span",{staticClass:"line-number"},[s._v("68")]),a("br"),a("span",{staticClass:"line-number"},[s._v("69")]),a("br"),a("span",{staticClass:"line-number"},[s._v("70")]),a("br"),a("span",{staticClass:"line-number"},[s._v("71")]),a("br"),a("span",{staticClass:"line-number"},[s._v("72")]),a("br"),a("span",{staticClass:"line-number"},[s._v("73")]),a("br"),a("span",{staticClass:"line-number"},[s._v("74")]),a("br"),a("span",{staticClass:"line-number"},[s._v("75")]),a("br"),a("span",{staticClass:"line-number"},[s._v("76")]),a("br"),a("span",{staticClass:"line-number"},[s._v("77")]),a("br"),a("span",{staticClass:"line-number"},[s._v("78")]),a("br"),a("span",{staticClass:"line-number"},[s._v("79")]),a("br"),a("span",{staticClass:"line-number"},[s._v("80")]),a("br"),a("span",{staticClass:"line-number"},[s._v("81")]),a("br"),a("span",{staticClass:"line-number"},[s._v("82")]),a("br"),a("span",{staticClass:"line-number"},[s._v("83")]),a("br"),a("span",{staticClass:"line-number"},[s._v("84")]),a("br"),a("span",{staticClass:"line-number"},[s._v("85")]),a("br"),a("span",{staticClass:"line-number"},[s._v("86")]),a("br"),a("span",{staticClass:"line-number"},[s._v("87")]),a("br"),a("span",{staticClass:"line-number"},[s._v("88")]),a("br"),a("span",{staticClass:"line-number"},[s._v("89")]),a("br"),a("span",{staticClass:"line-number"},[s._v("90")]),a("br"),a("span",{staticClass:"line-number"},[s._v("91")]),a("br"),a("span",{staticClass:"line-number"},[s._v("92")]),a("br"),a("span",{staticClass:"line-number"},[s._v("93")]),a("br")])]),a("h2",{attrs:{id:"引起-g-阻塞的事件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#引起-g-阻塞的事件"}},[s._v("#")]),s._v(" 引起 G 阻塞的事件")]),s._v(" "),a("div",{staticClass:"language-go line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n\twaitReasonZero                  waitReason "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("iota")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('// ""')]),s._v("\n\twaitReasonGCAssistMarking                         "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('// "GC assist marking"')]),s._v("\n\twaitReasonIOWait                                  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('// "IO wait"')]),s._v("\n\twaitReasonChanReceiveNilChan                      "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('// "chan receive (nil chan)"')]),s._v("\n\twaitReasonChanSendNilChan                         "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('// "chan send (nil chan)"')]),s._v("\n\twaitReasonDumpingHeap                             "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('// "dumping heap"')]),s._v("\n\twaitReasonGarbageCollection                       "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('// "garbage collection"')]),s._v("\n\twaitReasonGarbageCollectionScan                   "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('// "garbage collection scan"')]),s._v("\n\twaitReasonPanicWait                               "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('// "panicwait"')]),s._v("\n\twaitReasonSelect                                  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('// "select"')]),s._v("\n\twaitReasonSelectNoCases                           "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('// "select (no cases)"')]),s._v("\n\twaitReasonGCAssistWait                            "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('// "GC assist wait"')]),s._v("\n\twaitReasonGCSweepWait                             "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('// "GC sweep wait"')]),s._v("\n\twaitReasonGCScavengeWait                          "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('// "GC scavenge wait"')]),s._v("\n\twaitReasonChanReceive                             "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('// "chan receive"')]),s._v("\n\twaitReasonChanSend                                "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('// "chan send"')]),s._v("\n\twaitReasonFinalizerWait                           "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('// "finalizer wait"')]),s._v("\n\twaitReasonForceGGIdle                             "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('// "force gc (idle)"')]),s._v("\n\twaitReasonSemacquire                              "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('// "semacquire"')]),s._v("\n\twaitReasonSleep                                   "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('// "sleep"')]),s._v("\n\twaitReasonSyncCondWait                            "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('// "sync.Cond.Wait"')]),s._v("\n\twaitReasonTimerGoroutineIdle                      "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('// "timer goroutine (idle)"')]),s._v("\n\twaitReasonTraceReaderBlocked                      "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('// "trace reader (blocked)"')]),s._v("\n\twaitReasonWaitForGCCycle                          "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('// "wait for GC cycle"')]),s._v("\n\twaitReasonGCWorkerIdle                            "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('// "GC worker (idle)"')]),s._v("\n\twaitReasonPreempted                               "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('// "preempted"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br")])]),a("h2",{attrs:{id:"p-的-5-种状态"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#p-的-5-种状态"}},[s._v("#")]),s._v(" P 的 5 种状态")]),s._v(" "),a("div",{staticClass:"language-go line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("const")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// P status")]),s._v("\n\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// _Pidle means a P is not being used to run user code or the")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// scheduler. Typically, it's on the idle P list and available")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// to the scheduler, but it may just be transitioning between")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// other states.")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// The P is owned by the idle list or by whatever is")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// transitioning its state. Its run queue is empty.")]),s._v("\n\t_Pidle "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("iota")]),s._v("\n\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// _Prunning means a P is owned by an M and is being used to")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// run user code or the scheduler. Only the M that owns this P")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// is allowed to change the P's status from _Prunning. The M")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// may transition the P to _Pidle (if it has no more work to")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// do), _Psyscall (when entering a syscall), or _Pgcstop (to")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// halt for the GC). The M may also hand ownership of the P")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// off directly to another M (e.g., to schedule a locked G).")]),s._v("\n\t_Prunning\n\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// _Psyscall means a P is not running user code. It has")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// affinity to an M in a syscall but is not owned by it and")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// may be stolen by another M. This is similar to _Pidle but")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// uses lightweight transitions and maintains M affinity.")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// Leaving _Psyscall must be done with a CAS, either to steal")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// or retake the P. Note that there's an ABA hazard: even if")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// an M successfully CASes its original P back to _Prunning")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// after a syscall, it must understand the P may have been")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// used by another M in the interim.")]),s._v("\n\t_Psyscall\n\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// _Pgcstop means a P is halted for STW and owned by the M")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// that stopped the world. The M that stopped the world")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// continues to use its P, even in _Pgcstop. Transitioning")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// from _Prunning to _Pgcstop causes an M to release its P and")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// park.")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// The P retains its run queue and startTheWorld will restart")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// the scheduler on Ps with non-empty run queues.")]),s._v("\n\t_Pgcstop\n\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// _Pdead means a P is no longer used (GOMAXPROCS shrank). We")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// reuse Ps if GOMAXPROCS increases. A dead P is mostly")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// stripped of its resources, though a few things remain")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// (e.g., trace buffers).")]),s._v("\n\t_Pdead\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br"),a("span",{staticClass:"line-number"},[s._v("48")]),a("br"),a("span",{staticClass:"line-number"},[s._v("49")]),a("br")])]),a("h2",{attrs:{id:"调度器生命周期"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#调度器生命周期"}},[s._v("#")]),s._v(" 调度器生命周期")]),s._v(" "),a("p",[a("img",{attrs:{src:n(501),alt:"go-diaoduqi"}})]),s._v(" "),a("ol",[a("li",[s._v("runtime 创建最初的线程 m0 和 goroutine g0,并把两者关联")]),s._v(" "),a("li",[s._v("调度器初始化 : 初始化 m0、栈、垃圾回收以及创建由 GOMAXPROCS 个 P 构成的 P 列表")]),s._v(" "),a("li",[s._v("runtime.main 会调用 main.main 程序启动会为 runtime.main 创建 goroutine 称为 main goroutine, 然后 main goroutine 加入 p 的本地队列")]),s._v(" "),a("li",[s._v("启动 m0, m0 已绑定到 P ,会从 P 的本地队列获取 G,获取到 main goroutine")]),s._v(" "),a("li",[s._v("G 拥有栈, M 根据 G 中的栈信息和调度信息设置运行环境")]),s._v(" "),a("li",[s._v("M 运行 G")]),s._v(" "),a("li",[s._v("G 退出, M 再去获取可运行的 G,直到 main.main 退出, runtime.main 执行 defer 和 panic 处理或调用 runtime.exit 退出")])]),s._v(" "),a("h3",{attrs:{id:"可视化调度周期"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#可视化调度周期"}},[s._v("#")]),s._v(" 可视化调度周期")]),s._v(" "),a("div",{staticClass:"language-go line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// go run main.go && go tool trace trace.out")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("func")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("main")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\tf"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("_")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":=")]),s._v(" os"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("Create")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"trace.out"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("defer")]),s._v(" f"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("Close")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\ttrace"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("Start")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("f"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("defer")]),s._v(" trace"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("Stop")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\tfmt"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("Println")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"hello world"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("h3",{attrs:{id:"切换时保存上下文"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#切换时保存上下文"}},[s._v("#")]),s._v(" 切换时保存上下文")]),s._v(" "),a("h3",{attrs:{id:"重新调度时恢复上下文"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#重新调度时恢复上下文"}},[s._v("#")]),s._v(" 重新调度时恢复上下文")]),s._v(" "),a("h2",{attrs:{id:"异步抢占"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#异步抢占"}},[s._v("#")]),s._v(" 异步抢占")]),s._v(" "),a("p",[s._v("基于时间条件触发异步抢占当 goroutine 运行超过 10 毫秒,go 会尝试抢占它抢占是由线程 sysmon 发起的该线程用于监视运行时之后的长期运行的 goroutine,一旦检测到 goroutine 运行时间超过 10 毫秒就会向当前线程发出信号以抢占该线程.信号处理程序接收到消息线程就会中断不再处理当前 goroutine,调度了 gsignal 来管理传入到信号由于它发现这是个抢占指令,会执行停止当强 goroutine 的指令.go 将在程序计数器中推送一条指令,以使其看起来像正在运行的函数,此函数将暂存 goroutine ,并将其交给运行另一个 goroutine 调度程序.go 不能在任何地方停止该程序.")]),s._v(" "),a("ol",[a("li",[s._v("抢占阻塞在系统调用上的 P")]),s._v(" "),a("li",[s._v("抢占运行时间长的 G")])]),s._v(" "),a("p",[s._v("满足以上场景,就会发送信号给 M, M 收到信号休眠正在阻塞的 goroutine 调用绑定的信号方法,进行重新调度.")]),s._v(" "),a("h2",{attrs:{id:"recover-panic"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#recover-panic"}},[s._v("#")]),s._v(" recover panic")]),s._v(" "),a("p",[s._v("goroutine 没有父子关系,不能在一个 goroutine 中 recover 另一个 goroutine 重点 panic.协程没有上下级关系,没有跨协程的异常捕获机制.")]),s._v(" "),a("h2",{attrs:{id:"netpoller"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#netpoller"}},[s._v("#")]),s._v(" netpoller")]),s._v(" "),a("p",[s._v("当 goroutine 执行网络 IO 或者可以异步完成的系统调用时,会使用 netpoller 将多个单独的同步转换成一个单独的等待, goroutine 没有真正阻塞的系统调用,而是像等待 channel 就绪那样进入休眠状态等地网络套接字.")]),s._v(" "),a("ol",[a("li",[s._v("悲观方式 : 应用于预计会很慢的系统调用,运行时在系统调用前主动释放 p,之后再尝试将 p 找回来,如果无法获取则放入全局队列")]),s._v(" "),a("li",[s._v("乐观方式 : 应用于预计会很快的系统调用,不会释放 p,会设置一个特殊的 p 的状态标识并继续系统调用. sysmon goroutine 定期执行并寻找设置了这个系统调用中状态时间最长的 p,并将 p 从系统调用的 goroutine 那偷走,当系统调用返回,运行时代码检查 p 是否被偷走,如果没有则继续执行,如果 p 被偷走,会尝试获取其它 p,如果失败放入全局队列")])]),s._v(" "),a("p",[s._v("每个本地队列都有最大容量,为 256,在容量满了之后,任意新创建的 g 都会被放置到全局队列.仅在本地队列满了之后才会加入全局队列,也会在往调度器中批量注入时加入,如网络轮询器或垃圾回收期间等待的 goroutine.")]),s._v(" "),a("h2",{attrs:{id:"任务窃取顺序"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#任务窃取顺序"}},[s._v("#")]),s._v(" 任务窃取顺序")]),s._v(" "),a("ol",[a("li",[s._v("本地队列")]),s._v(" "),a("li",[s._v("全局队列")]),s._v(" "),a("li",[s._v("网络轮询器")]),s._v(" "),a("li",[s._v("其它 p 的本地队列(从其它处理器获取一半)")])]),s._v(" "),a("h2",{attrs:{id:"g-的-9-种状态-2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#g-的-9-种状态-2"}},[s._v("#")]),s._v(" g 的 9 种状态")]),s._v(" "),a("ul",[a("li",[a("code",[s._v("_Gidle")]),s._v(" : 刚刚被分配,还没有进行初始化.")]),s._v(" "),a("li",[a("code",[s._v("_Grunnable")]),s._v(" : 已经在运行队列中,还没有执行用户代码.")]),s._v(" "),a("li",[a("code",[s._v("_Grunning")]),s._v(" : 不在运行队列里中,已经可以执行用户代码,此时已经分配了 M 和 P.")]),s._v(" "),a("li",[a("code",[s._v("_Gsyscall")]),s._v(" : 正在执行系统调用,此时分配了 M.")]),s._v(" "),a("li",[a("code",[s._v("_Gwaiting")]),s._v(" : 在运行时被阻止,没有执行用户代码,也不在运行队列中,此时它正在某处阻塞等待中.")]),s._v(" "),a("li",[a("code",[s._v("_Gmoribund_unused")]),s._v(" : 尚未使用,但是在 gdb 中进行了硬编码.")]),s._v(" "),a("li",[a("code",[s._v("_Gdead")]),s._v(" : 尚未使用,这个状态可能是刚退出或是刚被初始化,此时它并没有执行用户代码，有可能有也有可能没有分配堆栈.")]),s._v(" "),a("li",[a("code",[s._v("_Genqueue_unused")]),s._v(" : 尚未使用.")]),s._v(" "),a("li",[a("code",[s._v("_Gcopystack")]),s._v(" : 正在复制堆栈,并没有执行用户代码,也不在运行队列中.")])])])}),[],!1,null,null,null);t.default=e.exports}}]);