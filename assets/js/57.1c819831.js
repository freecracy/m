(window.webpackJsonp=window.webpackJsonp||[]).push([[57],{561:function(s,a,t){"use strict";t.r(a);var e=t(20),n=Object(e.a)({},(function(){var s=this,a=s.$createElement,t=s._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"_0x04-编译器"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_0x04-编译器"}},[s._v("#")]),s._v(" 0x04.编译器")]),s._v(" "),t("p",[s._v("语法分析->抽象语法数(AST)->语义分析->中间代码(静态单赋值(SSA))")]),s._v(" "),t("div",{staticClass:"language-go line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-go"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// src/cmd/compile 编译 源代码目录")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// src/cmd/compile/internal/gc/main.go 编译器入口文件")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("go tool compile -S main.go\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[t("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("GOSSAFUNC")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("main Go tool compile main.go "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("open")]),s._v(" ssa.html\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("div",{staticClass:"language-sh line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sh"}},[t("code",[s._v("go build -gcflags"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"-S -N"')]),s._v(" main.go\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("编译器:")]),s._v(" "),t("ol",[t("li",[s._v("编译器前端: 词法分析,语法分析,类型检查,中间代码生成")]),s._v(" "),t("li",[s._v("编译器后端:目标代码生成和优化(将中间代码翻译成目标机器能运行的二进制机器码)")])]),s._v(" "),t("p",[s._v("Go 语言编译")]),s._v(" "),t("ol",[t("li",[s._v("词法与语法分析")]),s._v(" "),t("li",[s._v("类型检查和 AST 转换")]),s._v(" "),t("li",[s._v("中间代码生成(通用 SSA 生成)")]),s._v(" "),t("li",[s._v("机器码生成")])]),s._v(" "),t("h3",{attrs:{id:"词法分析"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#词法分析"}},[s._v("#")]),s._v(" 词法分析")]),s._v(" "),t("p",[s._v("将源代码文件中等字符串转换成 token,返回一个不包含空格,换行等字符的 token 序列")]),s._v(" "),t("h3",{attrs:{id:"语法分析"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#语法分析"}},[s._v("#")]),s._v(" 语法分析")]),s._v(" "),t("p",[s._v("语法分析的输入就是词法分析输出的 token,语法分析是将 token 序列转换成有意义的结构体,也就是语法树,每一个 AST 对应一个单独的 go 文件,")]),s._v(" "),t("h3",{attrs:{id:"类型检查"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#类型检查"}},[s._v("#")]),s._v(" 类型检查")]),s._v(" "),t("p",[s._v("类型进行校验的同时会展开内建函数(如 make),")]),s._v(" "),t("h3",{attrs:{id:"中间代码生成"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#中间代码生成"}},[s._v("#")]),s._v(" 中间代码生成")]),s._v(" "),t("p",[s._v("将 AST 转换成中间代码,compileFunctions 对项目中全部函数进行编译,")]),s._v(" "),t("h3",{attrs:{id:"机器码生成"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#机器码生成"}},[s._v("#")]),s._v(" 机器码生成")]),s._v(" "),t("div",{staticClass:"language-go line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-go"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// src/cmd/compile/internal")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// GOARCH=wasm GOOS=js go build -o lib.wasm main.go 将go编译成能够在浏览器上运行的webAssembly(二进制文件)")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("go tool cgo -godefs main.go "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 兼容 c 结构体")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("h2",{attrs:{id:"汇编"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#汇编"}},[s._v("#")]),s._v(" 汇编")]),s._v(" "),t("p",[s._v("4 个核心寄存器")]),s._v(" "),t("p",[s._v("FP :")]),s._v(" "),t("p",[s._v("SP :")]),s._v(" "),t("p",[s._v("SB : 全局静态基指针,一般用在声明函数、全局变量中")]),s._v(" "),t("p",[s._v("PC : 指令计数器")]),s._v(" "),t("h3",{attrs:{id:"常用操作指令"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#常用操作指令"}},[s._v("#")]),s._v(" 常用操作指令")]),s._v(" "),t("table",[t("thead",[t("tr",[t("th",[s._v("指令")]),s._v(" "),t("th",[s._v("用途")]),s._v(" "),t("th",[s._v("解释")])])]),s._v(" "),t("tbody",[t("tr",[t("td",[s._v("MOVQ")]),s._v(" "),t("td",[s._v("MOVQ 48 AX")]),s._v(" "),t("td",[s._v("把 48 传送到 AX")])]),s._v(" "),t("tr",[t("td",[s._v("LEAQ")]),s._v(" "),t("td",[s._v("LEAQ AX BX")]),s._v(" "),t("td",[s._v("把 AX 的有效地址传送到 BX")])]),s._v(" "),t("tr",[t("td",[s._v("PUSHQ")]),s._v(" "),t("td",[s._v("PUSHQ AX")]),s._v(" "),t("td",[s._v("将 AX 内容传送到栈顶位置")])]),s._v(" "),t("tr",[t("td",[s._v("POPQ")]),s._v(" "),t("td",[s._v("POPQ AX")]),s._v(" "),t("td",[s._v("弹出栈顶数据后修改栈顶指针")])]),s._v(" "),t("tr",[t("td",[s._v("ADDQ")]),s._v(" "),t("td",[s._v("ADDQ BX AX")]),s._v(" "),t("td",[s._v("AX += BX")])]),s._v(" "),t("tr",[t("td",[s._v("SUBQ")]),s._v(" "),t("td",[s._v("SUBQ BX AX")]),s._v(" "),t("td",[s._v("AX -= BX")])]),s._v(" "),t("tr",[t("td",[s._v("CMPQ")]),s._v(" "),t("td",[s._v("CMPQ SI CX")]),s._v(" "),t("td",[s._v("比较 SI 和 CX 的大小")])]),s._v(" "),t("tr",[t("td",[s._v("CALL")]),s._v(" "),t("td",[s._v("CALL runtime.println(SB)")]),s._v(" "),t("td",[s._v("发起调用")])]),s._v(" "),t("tr",[t("td",[s._v("JMP")]),s._v(" "),t("td",[s._v("JMP 0x0185")]),s._v(" "),t("td",[s._v("无条件转移至 0x0185 地址处")])]),s._v(" "),t("tr",[t("td",[s._v("JLS")]),s._v(" "),t("td",[s._v("JLS 0x0185")]),s._v(" "),t("td",[s._v("左边小于右边,则跳到 0x0185 位置")])])])]),s._v(" "),t("blockquote",[t("p",[s._v("后缀 Q 说明是 64 位上的汇编指令")])]),s._v(" "),t("h3",{attrs:{id:"获取汇编代码"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#获取汇编代码"}},[s._v("#")]),s._v(" 获取汇编代码")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 方法 1")]),s._v("\ngo build -gcflags "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"-N -l"')]),s._v(" main.go "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 生成可执行二进制文件")]),s._v("\ngo tool objdump -s "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"main\\."')]),s._v(" main "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 反编译获取汇编,main\\. 只输出 main 包中相关汇编 main\\.main 表示只输出 main 包中 main 方法相关汇编")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 方法 2")]),s._v("\ngo tool compile -S -N -l main.go\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 方法 3")]),s._v("\ngo build -gcflags "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"-N -l -S"')]),s._v(" main.go\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# -l 禁止内联")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# -N 编译时禁止优化")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# -S 输出汇编代码")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br")])])])}),[],!1,null,null,null);a.default=n.exports}}]);