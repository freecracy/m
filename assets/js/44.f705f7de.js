(window.webpackJsonp=window.webpackJsonp||[]).push([[44],{419:function(a,t,r){a.exports=r.p+"assets/img/eswrite.69257302.png"},625:function(a,t,r){"use strict";r.r(t);var s=r(20),e=Object(s.a)({},(function(){var a=this,t=a.$createElement,s=a._self._c||t;return s("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[s("h1",{attrs:{id:"es"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#es"}},[a._v("#")]),a._v(" ES")]),a._v(" "),s("h3",{attrs:{id:"写入数据"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#写入数据"}},[a._v("#")]),a._v(" 写入数据")]),a._v(" "),s("p",[a._v("es 搜索严重依赖 filesystem cache 如果给 filesystem cache 更多的内存,容纳所有的 idx segment file 文件,搜索基本走内存.要想性能好机器内存至少容纳总数据量的一半.通常配合 hbase 使用.")]),a._v(" "),s("p",[s("img",{attrs:{src:r(419),alt:"eswrite"}})]),a._v(" "),s("ol",[s("li",[a._v("客户端选择一个 node 发送请求,这个 node 就是协调节点")]),a._v(" "),s("li",[a._v("协调节点对文档进行路由,将请求转发给对应的 primary shard")]),a._v(" "),s("li",[a._v("实际的 primary shard 处理请求,然后将数据同步到 replica node")]),a._v(" "),s("li",[a._v("协调节点发现 primary node 和所有的 replica node 都搞定后,返回响应给客户端")])]),a._v(" "),s("h3",{attrs:{id:"读取数据"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#读取数据"}},[a._v("#")]),a._v(" 读取数据")]),a._v(" "),s("ol",[s("li",[a._v("客户端发送请求到任意一个 node,成为协调节点")]),a._v(" "),s("li",[a._v("协调节点对 doc id 进行哈希路由请求到对应 node ,使用随机轮训算法在 primary shard 和所有 replica 中随机一个,让读请求负载均衡")]),a._v(" "),s("li",[a._v("接收请求到 node 返回 document 给协调节点")]),a._v(" "),s("li",[a._v("协调节点返回 document 给客户端")])]),a._v(" "),s("h3",{attrs:{id:"搜索数据"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#搜索数据"}},[a._v("#")]),a._v(" 搜索数据")]),a._v(" "),s("ol",[s("li",[a._v("客户端请求到一个协调节点")]),a._v(" "),s("li",[a._v("协调节点将请求转发到所有的 primary shard 或 replica shard 都可以")]),a._v(" "),s("li",[a._v("每个 shard 将自己搜索结果(其实是一些 doc ID)返回给协调节点,协调节点进行数据合并、排序、分页等,产出最终结果")]),a._v(" "),s("li",[a._v("协调节点根据 doc id 去各个节点拉取实际 document 数据,最终返回给客户端")])]),a._v(" "),s("blockquote",[s("p",[a._v("写请求是写入 primary shard 然后同步给所有 replica shard,读请求可以从 primary shard 或 replica shard 读取,采用随机轮询算法.")])]),a._v(" "),s("h2",{attrs:{id:"数据检索"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#数据检索"}},[a._v("#")]),a._v(" 数据检索")]),a._v(" "),s("p",[a._v("数据检索主要分两个阶段 query 和 fetch.")]),a._v(" "),s("h3",{attrs:{id:"query-阶段"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#query-阶段"}},[a._v("#")]),a._v(" query 阶段")]),a._v(" "),s("ol",[s("li",[a._v("客户端发送请求到 node (coordinating)上, node 会创建一个优先级队列")]),a._v(" "),s("li",[a._v("node 转发 search 请求到每一个主分片和副本分片, 每个 shard 会在本地查询后添加结果到本地排序好的优先级队列")]),a._v(" "),s("li",[a._v("每个 shard 返回 docID 和所有参与排序字段的值到优先级队列然后再返回给 node 节点,node 负责将所有 shard 数据合并到全局排序列表")])]),a._v(" "),s("h3",{attrs:{id:"fetch阶段"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#fetch阶段"}},[a._v("#")]),a._v(" fetch阶段")]),a._v(" "),s("ol",[s("li",[a._v("coordinating 节点标识了哪些 document 需要被拉取,并发送一个 mutil get 请求到相关 shard 上")]),a._v(" "),s("li",[a._v("每个 shard 加载相关 document,如果需要他们就返回到 coordinating 节点")]),a._v(" "),s("li",[a._v("所有 document 被拉取回来后将返回结果集到客户端")])]),a._v(" "),s("h3",{attrs:{id:"scroll读取-游标查询-用于分页"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#scroll读取-游标查询-用于分页"}},[a._v("#")]),a._v(" scroll读取(游标查询,用于分页)")]),a._v(" "),s("p",[a._v("每次返回一个 croll_id 下一次查询是需要把上次返回的 scroll_id 传递进去.")]),a._v(" "),s("h2",{attrs:{id:"分页"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#分页"}},[a._v("#")]),a._v(" 分页")]),a._v(" "),s("ol",[s("li",[a._v("不允许深度分页")]),a._v(" "),s("li",[a._v("类似微博一页一页刷出来 scroll api")])]),a._v(" "),s("h2",{attrs:{id:"倒排索引"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#倒排索引"}},[a._v("#")]),a._v(" 倒排索引")]),a._v(" "),s("h2",{attrs:{id:"打分机制"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#打分机制"}},[a._v("#")]),a._v(" 打分机制")]),a._v(" "),s("h2",{attrs:{id:"全文检索"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#全文检索"}},[a._v("#")]),a._v(" 全文检索")]),a._v(" "),s("h2",{attrs:{id:"分词"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#分词"}},[a._v("#")]),a._v(" 分词")]),a._v(" "),s("table",[s("thead",[s("tr",[s("th",[a._v("集群健康状态")]),a._v(" "),s("th",[a._v("说明")])])]),a._v(" "),s("tbody",[s("tr",[s("td",[a._v("Green")]),a._v(" "),s("td",[a._v("所有主分片和副本分片都可用")])]),a._v(" "),s("tr",[s("td",[a._v("Yellow")]),a._v(" "),s("td",[a._v("所有主分片可用,但不是所有副本分片都可用")])]),a._v(" "),s("tr",[s("td",[a._v("Red")]),a._v(" "),s("td",[a._v("主分片处于不可用状态")])])])]),a._v(" "),s("h2",{attrs:{id:"flink"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#flink"}},[a._v("#")]),a._v(" Flink")]),a._v(" "),s("h2",{attrs:{id:"hbase"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#hbase"}},[a._v("#")]),a._v(" HBase")])])}),[],!1,null,null,null);t.default=e.exports}}]);