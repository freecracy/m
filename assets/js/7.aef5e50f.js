(window.webpackJsonp=window.webpackJsonp||[]).push([[7],{400:function(t,a,s){t.exports=s.p+"assets/img/go-tool-trace-web.6b3a508e.png"},401:function(t,a,s){t.exports=s.p+"assets/img/go-tool-trace-scheduler.0a182063.png"},402:function(t,a,s){t.exports=s.p+"assets/img/go-tool-trace-goroutines.a043c12e.png"},403:function(t,a,s){t.exports=s.p+"assets/img/go-tool-trace-goroutine-2.bb83bb56.png"},404:function(t,a,s){t.exports=s.p+"assets/img/go-tool-trace-view.32be93a4.png"},596:function(t,a,s){"use strict";s.r(a);var e=s(20),r=Object(e.a)({},(function(){var t=this,a=t.$createElement,e=t._self._c||a;return e("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[e("h1",{attrs:{id:"trace-实战"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#trace-实战"}},[t._v("#")]),t._v(" trace 实战")]),t._v(" "),e("h2",{attrs:{id:"场景"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#场景"}},[t._v("#")]),t._v(" 场景")]),t._v(" "),e("p",[t._v("trace 是基于事件的而不是基于采样的.")]),t._v(" "),e("ul",[e("li",[t._v("并行执行度不足,比如没有充分利用多核资源")]),t._v(" "),e("li",[t._v("因 GC 导致延迟较大")]),t._v(" "),e("li",[t._v("Goroutine 执行情况分析,发现各种阻塞(锁竞争、系统调用、调度、辅助 GC)导致的运行时短或延迟问题")])]),t._v(" "),e("h2",{attrs:{id:"添加-trace"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#添加-trace"}},[t._v("#")]),t._v(" 添加 trace")]),t._v(" "),e("h3",{attrs:{id:"手动添加"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#手动添加"}},[t._v("#")]),t._v(" 手动添加")]),t._v(" "),e("div",{staticClass:"language-go line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-go"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// runtime/trace")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("main")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    trace"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("Start")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("os"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Stderr"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("defer")]),t._v(" trace"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("Stop")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    ch "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("make")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("chan")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("string")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("go")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("func")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        ch "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<-")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"trace 实战"')]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<-")]),t._v("ch\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// go tool trace trace.out")]),t._v("\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br"),e("span",{staticClass:"line-number"},[t._v("4")]),e("br"),e("span",{staticClass:"line-number"},[t._v("5")]),e("br"),e("span",{staticClass:"line-number"},[t._v("6")]),e("br"),e("span",{staticClass:"line-number"},[t._v("7")]),e("br"),e("span",{staticClass:"line-number"},[t._v("8")]),e("br"),e("span",{staticClass:"line-number"},[t._v("9")]),e("br"),e("span",{staticClass:"line-number"},[t._v("10")]),e("br"),e("span",{staticClass:"line-number"},[t._v("11")]),e("br")])]),e("h3",{attrs:{id:"pprof"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#pprof"}},[t._v("#")]),t._v(" pprof")]),t._v(" "),e("p",[e("code",[t._v("net/http/pprof")]),t._v("中的 trace 函数负责处理"),e("code",[t._v("debug/pprof/trace")]),t._v("对请求.")]),t._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[t._v("// net/http/pprof\n"),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$wget")]),t._v(" -O trace.out http://localhost:6060/debug/pprof/trace?seconds"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("5")]),t._v("\n\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br")])]),e("h3",{attrs:{id:"test-trace"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#test-trace"}},[t._v("#")]),t._v(" test trace")]),t._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[t._v("go "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("test")]),t._v(" -trace trace.out ./"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v(".\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br")])]),e("h2",{attrs:{id:"生成跟踪文件"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#生成跟踪文件"}},[t._v("#")]),t._v(" 生成跟踪文件")]),t._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[t._v("go run main.go "),e("span",{pre:!0,attrs:{class:"token operator"}},[e("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[t._v("2")]),t._v(">")]),t._v(" trace.out\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br")])]),e("h2",{attrs:{id:"启动可视化界面"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#启动可视化界面"}},[t._v("#")]),t._v(" 启动可视化界面")]),t._v(" "),e("div",{staticClass:"language-go line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-go"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("go")]),t._v(" tool trace trace"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("out\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br")])]),e("p",[e("img",{attrs:{src:s(400),alt:"go-tool-trace-web"}})]),t._v(" "),e("table",[e("thead",[e("tr",[e("th",[t._v("描述")]),t._v(" "),e("th",[t._v("备注")])])]),t._v(" "),e("tbody",[e("tr",[e("td",[t._v("View trace")]),t._v(" "),e("td",[t._v("查看跟踪")])]),t._v(" "),e("tr",[e("td",[t._v("Goroutine analysis")]),t._v(" "),e("td",[t._v("Goroutine 分析")])]),t._v(" "),e("tr",[e("td",[t._v("Network blocking profile")]),t._v(" "),e("td",[t._v("网络阻塞情况")])]),t._v(" "),e("tr",[e("td",[t._v("Synchronization blocking profile")]),t._v(" "),e("td",[t._v("同步阻塞概况")])]),t._v(" "),e("tr",[e("td",[t._v("Syscall blocking profile")]),t._v(" "),e("td",[t._v("系统调用阻塞概况")])]),t._v(" "),e("tr",[e("td",[t._v("Scheduler latency profile")]),t._v(" "),e("td",[t._v("调度延迟概况")])]),t._v(" "),e("tr",[e("td",[t._v("User-defined tasks")]),t._v(" "),e("td",[t._v("用户自定义任务")])]),t._v(" "),e("tr",[e("td",[t._v("User-defined regions")]),t._v(" "),e("td",[t._v("用户自定义区域")])]),t._v(" "),e("tr",[e("td",[t._v("Minimum mutator utilization")]),t._v(" "),e("td",[t._v("最低 Mutator 利用率")])])])]),t._v(" "),e("h2",{attrs:{id:"结果"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#结果"}},[t._v("#")]),t._v(" 结果")]),t._v(" "),e("ul",[e("li",[t._v("时间线")]),t._v(" "),e("li",[t._v("采样状态区")]),t._v(" "),e("li",[t._v("p 视角、g 视角 : 对应两行,上面一行代表运行在 p 上的 g 的主事件,第二行则是其它事件,如系统调用、运行时事件、g 运行时完成任务、并行标记")]),t._v(" "),e("li",[t._v("事件详情区")])]),t._v(" "),e("h3",{attrs:{id:"调度延迟概况"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#调度延迟概况"}},[t._v("#")]),t._v(" 调度延迟概况")]),t._v(" "),e("p",[e("img",{attrs:{src:s(401),alt:"go-trace-trace-scheduler"}})]),t._v(" "),e("h3",{attrs:{id:"goroutine-分析"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#goroutine-分析"}},[t._v("#")]),t._v(" goroutine 分析")]),t._v(" "),e("p",[t._v("能通过这个功能呢看到整个运行过程每个函数块有多少 goroutine,同时也可以看到 当前 goroutine 在整个调用好使中的占比,及 GC 清扫和 GC 暂停等待的开销.可以得知到底哪慢,然后决定下一步排查方向.")]),t._v(" "),e("p",[e("img",{attrs:{src:s(402),alt:"go-tool-trace-goroutines"}})]),t._v(" "),e("p",[e("img",{attrs:{src:s(403),alt:"go-tool-trace-goroutine-2"}})]),t._v(" "),e("table",[e("thead",[e("tr",[e("th",[t._v("名称")]),t._v(" "),e("th",[t._v("含义")]),t._v(" "),e("th",[t._v("耗时")])])]),t._v(" "),e("tbody",[e("tr",[e("td",[t._v("Goroutine")]),t._v(" "),e("td",[t._v("goroutine ID")]),t._v(" "),e("td",[t._v("19")])]),t._v(" "),e("tr",[e("td",[t._v("Execution Time")]),t._v(" "),e("td",[t._v("执行时间")]),t._v(" "),e("td",[t._v("17µs")])]),t._v(" "),e("tr",[e("td",[t._v("Network wait")]),t._v(" "),e("td",[t._v("网络等待时间")]),t._v(" "),e("td",[t._v("0ns")])]),t._v(" "),e("tr",[e("td",[t._v("Sync block")]),t._v(" "),e("td",[t._v("同步阻塞时间")]),t._v(" "),e("td",[t._v("0ns")])]),t._v(" "),e("tr",[e("td",[t._v("Blocking syscall")]),t._v(" "),e("td",[t._v("调用阻塞时间")]),t._v(" "),e("td",[t._v("0ns")])]),t._v(" "),e("tr",[e("td",[t._v("Scheduler wait")]),t._v(" "),e("td",[t._v("调度等待时间")]),t._v(" "),e("td",[t._v("15µs")])]),t._v(" "),e("tr",[e("td",[t._v("GC sweeping")]),t._v(" "),e("td",[t._v("GC 清扫")]),t._v(" "),e("td",[t._v("0ns (0.0%)")])]),t._v(" "),e("tr",[e("td",[t._v("GC pause")]),t._v(" "),e("td",[t._v("GC 暂停")]),t._v(" "),e("td",[t._v("0ns (0.0%)")])])])]),t._v(" "),e("h3",{attrs:{id:"查看跟踪"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#查看跟踪"}},[t._v("#")]),t._v(" 查看跟踪")]),t._v(" "),e("p",[e("img",{attrs:{src:s(404),alt:"go-tool-trace-view"}})]),t._v(" "),e("ol",[e("li",[t._v("时间线 : 现实执行时间单元,根据时间维度不同可以调整区间")]),t._v(" "),e("li",[t._v("堆 : 显示执行期间的内存分配和释放情况")]),t._v(" "),e("li",[t._v("协程 : 显示执行期间每个 goroutine 运行阶段有多少个协程在运行包含 GC 等待(GCWaiting)、可运行(Runnable)、运行中(Running)三种状态")]),t._v(" "),e("li",[t._v("os 线程: 显示在执行期间有多少个线程在运行,包含正在调用 syscall(InSyscall)、运行中(Running)两种状态")]),t._v(" "),e("li",[t._v("虚拟处理器 : 每个 p 显示一行,一般默认为系统内核数")]),t._v(" "),e("li",[t._v("协程和事件 : 显示在每个 p 上有什么 Goroutine 正在运行,连线行为代表事件关联.")])]),t._v(" "),e("table",[e("thead",[e("tr",[e("th",[t._v("名称")]),t._v(" "),e("th",[t._v("备注")])])]),t._v(" "),e("tbody",[e("tr",[e("td",[t._v("Start")]),t._v(" "),e("td",[t._v("开始时间")])]),t._v(" "),e("tr",[e("td",[t._v("Wall Duration")]),t._v(" "),e("td",[t._v("持续时间")])]),t._v(" "),e("tr",[e("td",[t._v("Self Time")]),t._v(" "),e("td",[t._v("执行时间")])]),t._v(" "),e("tr",[e("td",[t._v("Start Stack Trace")]),t._v(" "),e("td",[t._v("开始时堆栈信息")])]),t._v(" "),e("tr",[e("td",[t._v("End Stack Trace")]),t._v(" "),e("td",[t._v("结束时堆栈信息")])]),t._v(" "),e("tr",[e("td",[t._v("Incoming flow")]),t._v(" "),e("td",[t._v("输入流")])]),t._v(" "),e("tr",[e("td",[t._v("Outgoing flow")]),t._v(" "),e("td",[t._v("输出流")])]),t._v(" "),e("tr",[e("td",[t._v("Preceding events")]),t._v(" "),e("td",[t._v("之前的事件")])]),t._v(" "),e("tr",[e("td",[t._v("Following events")]),t._v(" "),e("td",[t._v("之后的事件")])]),t._v(" "),e("tr",[e("td",[t._v("All connected")]),t._v(" "),e("td",[t._v("所有连接的事件")])])])]),t._v(" "),e("blockquote",[e("p",[t._v("w : 快捷键放大时间线")])]),t._v(" "),e("h3",{attrs:{id:"网络阻塞概况"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#网络阻塞概况"}},[t._v("#")]),t._v(" 网络阻塞概况")]),t._v(" "),e("h3",{attrs:{id:"系统调用阻塞概况"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#系统调用阻塞概况"}},[t._v("#")]),t._v(" 系统调用阻塞概况")]),t._v(" "),e("h2",{attrs:{id:"线上"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#线上"}},[t._v("#")]),t._v(" 线上")]),t._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[t._v('# _ "net/http/pprof"')]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("curl")]),t._v(" http://127.0.0.1:6060/debug/pprof/trace?seconds"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("20")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" trace.out\ngo tool trace trace.out\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br")])]),e("h2",{attrs:{id:"小结"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#小结"}},[t._v("#")]),t._v(" 小结")]),t._v(" "),e("ul",[e("li",[t._v("view trace : p 视角")]),t._v(" "),e("li",[t._v("Goroutine analysis : g 视角")])])])}),[],!1,null,null,null);a.default=r.exports}}]);