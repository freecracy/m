(window.webpackJsonp=window.webpackJsonp||[]).push([[255],{553:function(s,t,a){"use strict";a.r(t);var r=a(20),e=Object(r.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"秒杀抢购"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#秒杀抢购"}},[s._v("#")]),s._v(" 秒杀抢购")]),s._v(" "),a("ol",[a("li",[s._v("独立部署,独立域名,与现有业务隔离")]),s._v(" "),a("li",[s._v("重新设计秒杀商品页面,页面内容静态化用户请求不经过用户服务")]),s._v(" "),a("li",[s._v("避免直接访问下单页面 url 需要将 url 动态化,即即使系统开发者也无法在秒杀前访问 url,下单页面 url 加入服务端生成的随机数做为参数")]),s._v(" "),a("li",[s._v("按钮秒杀前后置灰,如 redis 存入随机数,静态化页面通过重新生成一个新的 js 文件,去服务其获取随机数.")])]),s._v(" "),a("h2",{attrs:{id:"高并发"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#高并发"}},[s._v("#")]),s._v(" 高并发")]),s._v(" "),a("ol",[a("li",[s._v("扩容(提升整体 QPS)")]),s._v(" "),a("li",[s._v("服务拆分(提升 QPS)")]),s._v(" "),a("li",[s._v("降级、限流(保证系统可用性)")]),s._v(" "),a("li",[s._v("分布式缓存(降低 RT)")]),s._v(" "),a("li",[s._v("读写分离、分库分表、数据容灾(数据库可用性、并发量)")]),s._v(" "),a("li",[s._v("MQ、异步(降低 RT)")]),s._v(" "),a("li",[s._v("分布式锁(脏数据)")]),s._v(" "),a("li",[s._v("分布式事务(数据一致性)")])]),s._v(" "),a("h2",{attrs:{id:"高可用"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#高可用"}},[s._v("#")]),s._v(" 高可用")]),s._v(" "),a("ol",[a("li",[s._v("注册中心")])]),s._v(" "),a("h2",{attrs:{id:"问题"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#问题"}},[s._v("#")]),s._v(" 问题")]),s._v(" "),a("ol",[a("li",[s._v("超卖")]),s._v(" "),a("li",[s._v("高并发")]),s._v(" "),a("li",[s._v("接口防刷")]),s._v(" "),a("li",[s._v("秒杀 url")]),s._v(" "),a("li",[s._v("数据库设计")])]),s._v(" "),a("h2",{attrs:{id:"设计"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#设计"}},[s._v("#")]),s._v(" 设计")]),s._v(" "),a("h3",{attrs:{id:"数据库设计"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#数据库设计"}},[s._v("#")]),s._v(" 数据库设计")]),s._v(" "),a("ol",[a("li",[s._v("秒杀订单表 : order_id、user_id、goods_id、state(已支付、未支付)、create_time")]),s._v(" "),a("li",[s._v("秒杀货品表 : id、goods_id、stock(库存)、version、start_time、end_time")])]),s._v(" "),a("h3",{attrs:{id:"秒杀-url-设计"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#秒杀-url-设计"}},[s._v("#")]),s._v(" 秒杀 url 设计")]),s._v(" "),a("p",[s._v("避免 url 直接访问后台接口可以将 url 动态化,即使开发系统的人开始前也无法得知 url. 通过 md5 加密一段随机字符串作为秒杀 url,前端访问后台获取具体 url,后台通过后才可以继续秒杀.")]),s._v(" "),a("h3",{attrs:{id:"页面静态化"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#页面静态化"}},[s._v("#")]),s._v(" 页面静态化")]),s._v(" "),a("p",[s._v("商品描述、参数、成交记录、图像、评价等写入静态页面不需要访问数据库、不需要访问后端服务器、直接缓存 cdn、减轻秒杀服务器压力")]),s._v(" "),a("h3",{attrs:{id:"精简-sql"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#精简-sql"}},[s._v("#")]),s._v(" 精简 sql")]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("update")]),s._v(" miaosha_goods "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("set")]),s._v(" stock"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("stock"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("where")]),s._v(" good_id "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" a "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("and")]),s._v(" verison "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" b "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("and")]),s._v(" stock "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h3",{attrs:{id:"redis-预扣库存"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#redis-预扣库存"}},[s._v("#")]),s._v(" redis 预扣库存")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("redis.set"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("goodsid, "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("100")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 开始前设置库存")]),s._v("\nintegerstock "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("interger"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("redis.get"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("goodsid"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 下单后,判断 stock 然后减 1")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("p",[s._v("需要注意订单取消时,新增库存后不要超过预设置的总库存数,查库存和扣减库存都是原子操作,下次下单直接在 redis 查就可以了.")]),s._v(" "),a("h3",{attrs:{id:"接口限流"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#接口限流"}},[s._v("#")]),s._v(" 接口限流")]),s._v(" "),a("ol",[a("li",[s._v("前端限流 : 前端一段时间内只发一次请求")]),s._v(" "),a("li",[s._v("统一个用户 x 秒内重复请求直接拒绝 : 通过 redis 键过期策略"),a("code",[s._v("value = redis.get(userid)")]),s._v("获取到 value 为空或 nil 表示有效请求,然后放行,如果不为空则为重复请求直接丢弃.如果有效设置过期时间,userID 作为 key")]),s._v(" "),a("li",[s._v("普通限流 : 保障后端服务可用性")])]),s._v(" "),a("h3",{attrs:{id:"异步下单"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#异步下单"}},[s._v("#")]),s._v(" 异步下单")]),s._v(" "),a("p",[s._v("在经过限流、库存校验后进入下单步骤的都是有效请求,然后发送到队列,队列接收消息异步下单,下单完入库,如果没问题通知用户.如果失败可以采用补偿机制,重试.")]),s._v(" "),a("h3",{attrs:{id:"服务降级"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#服务降级"}},[s._v("#")]),s._v(" 服务降级")]),s._v(" "),a("p",[s._v("服务宕机要有可行性方案,业务层面给用户友好提示.")]),s._v(" "),a("h2",{attrs:{id:"小结"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#小结"}},[s._v("#")]),s._v(" 小结")]),s._v(" "),a("ul",[a("li",[s._v("并发高分布式锁,并发量不大 mysql 悲观锁和乐关锁")])])])}),[],!1,null,null,null);t.default=e.exports}}]);