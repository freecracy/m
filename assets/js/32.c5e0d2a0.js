(window.webpackJsonp=window.webpackJsonp||[]).push([[32],{484:function(t,s,a){t.exports=a.p+"assets/img/memery-slice-string.1e84e072.png"},530:function(t,s,a){"use strict";a.r(s);var e=a(20),r=Object(e.a)({},(function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[e("h1",{attrs:{id:"_0x08-性能剖析"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_0x08-性能剖析"}},[t._v("#")]),t._v(" 0x08.性能剖析")]),t._v(" "),e("h2",{attrs:{id:"pprof-trace"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#pprof-trace"}},[t._v("#")]),t._v(" pprof + trace")]),t._v(" "),e("h3",{attrs:{id:"性能剖析-pprof"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#性能剖析-pprof"}},[t._v("#")]),t._v(" 性能剖析 pprof")]),t._v(" "),e("p",[t._v("GOGC 默认 100 使得堆大小到达它初始态的两倍时触发 GC,这个值改成一个更大的数会延缓 GC 的触发,降低 GC 频率.大约配置 2000.")]),t._v(" "),e("div",{staticClass:"language-go line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-go"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("go")]),t._v(" http"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("ListenAndServe")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"127.0.0.1:8080"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("nil")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\tb "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("make")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),e("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("byte")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("4096")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" i "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" i "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("len")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("b"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" i"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("++")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\tb"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("i"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" b"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("i"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0xf")]),t._v("\n\t"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\ttime"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("Sleep")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("time"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Nanosecond"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br"),e("span",{staticClass:"line-number"},[t._v("4")]),e("br"),e("span",{staticClass:"line-number"},[t._v("5")]),e("br"),e("span",{staticClass:"line-number"},[t._v("6")]),e("br"),e("span",{staticClass:"line-number"},[t._v("7")]),e("br"),e("span",{staticClass:"line-number"},[t._v("8")]),e("br")])]),e("ol",[e("li",[t._v("web 界面")]),t._v(" "),e("li",[t._v("交互模式")]),t._v(" "),e("li",[t._v("火焰图")])]),t._v(" "),e("div",{staticClass:"language-sh line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[t._v("curl")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'http://localhost:8080/debug/pprof/allocs?debug=1'")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[e("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[t._v("2")]),t._v(">")]),t._v("/dev/null "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("grep")]),t._v(" PauseNs "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# curl查看GC的STW时间")]),t._v("\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br")])]),e("h3",{attrs:{id:"性能剖析-trace"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#性能剖析-trace"}},[t._v("#")]),t._v(" 性能剖析 trace")]),t._v(" "),e("h2",{attrs:{id:"godebug-看调度跟踪"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#godebug-看调度跟踪"}},[t._v("#")]),t._v(" godebug 看调度跟踪")]),t._v(" "),e("h2",{attrs:{id:"godebug-看-gc"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#godebug-看-gc"}},[t._v("#")]),t._v(" godebug 看 GC")]),t._v(" "),e("p",[e("a",{attrs:{href:"https://book.eddycjy.com/golang/tools/go-tool-pprof.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("godebug"),e("OutboundLink")],1)]),t._v(" "),e("p",[t._v("尽量自动化一切能够自动化的步骤,让工程师审查真正重要的逻辑和设计")]),t._v(" "),e("p",[t._v("goimports:官方,就是等 于 gofmt 加上依赖包管理 代码规范,包管理")]),t._v(" "),e("p",[t._v("golint:官方,可定制化较低,静态代码检查")]),t._v(" "),e("p",[t._v("更推荐的方法是在基础库或者框架中使用 golint 进行 静态检查(或者同时使用 golint 和 golangci-lint)， 在其他的项目中使用可定制化的 golangci-lint 来进行 静态检查，因为在基础库和框架中施加强限制对于整体 的代码质量有着更大的收益。")]),t._v(" "),e("p",[t._v("按照职责垂直拆分的方式在单体服务遇到瓶颈时非 常容易对微服务进行拆分，我们可以直接将一个负 责独立功能的 package 拆出去，对这部分性能热点 单独进行扩容;区别于传统的层级水平拆分(MVC)")]),t._v(" "),e("p",[t._v("我们不应该在 init 中做过重的初始化逻辑， 而是做一些简单、轻量的前置条件判断")]),t._v(" "),e("h2",{attrs:{id:"mock"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#mock"}},[t._v("#")]),t._v(" mock")]),t._v(" "),e("h3",{attrs:{id:"接口"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#接口"}},[t._v("#")]),t._v(" 接口")]),t._v(" "),e("p",[t._v("golang/gomock")]),t._v(" "),e("p",[t._v("mockgen")]),t._v(" "),e("h3",{attrs:{id:"数据库"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#数据库"}},[t._v("#")]),t._v(" 数据库")]),t._v(" "),e("p",[t._v("sqlmock")]),t._v(" "),e("h3",{attrs:{id:"http"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#http"}},[t._v("#")]),t._v(" HTTP")]),t._v(" "),e("p",[t._v("httpmock")]),t._v(" "),e("h3",{attrs:{id:"任意函数"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#任意函数"}},[t._v("#")]),t._v(" 任意函数")]),t._v(" "),e("p",[t._v("bouk/monkey:万能的方法，但是只在万不得已 时使用，类似的代码写起来非常冗长而且 不直观;")]),t._v(" "),e("p",[t._v("断言:使用社区的 "),e("a",{attrs:{href:"https://github.com/stretchr/testify",target:"_blank",rel:"noopener noreferrer"}},[t._v("testify"),e("OutboundLink")],1),t._v(" 快速验证方法的返回 值;")]),t._v(" "),e("div",{staticClass:"language-sh line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("echo")]),t._v(" -e "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'HTTP/1.1 200 OK"),e("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[t._v("\\n")]),t._v("Access-Control-Allow-Origin: *"),e("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[t._v("\\n")]),t._v("Content-type: text/event-stream"),e("span",{pre:!0,attrs:{class:"token entity",title:"\\n"}},[t._v("\\n")]),t._v("'")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("tail")]),t._v(" -f ./iam.log "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("sed")]),t._v(" -e "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'s/^/data: /;s/$/"),e("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[t._v("\\\\")]),t._v("n/'")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("nc")]),t._v(" -l "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("1234")]),t._v("\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br")])]),e("div",{staticClass:"language-sh line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[t._v("mylxsw/remote-tail\nhttp://taillog.cn\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br")])]),e("h2",{attrs:{id:"pprof"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#pprof"}},[t._v("#")]),t._v(" pprof")]),t._v(" "),e("p",[e("a",{attrs:{href:"https://github.com/google/pprof/blob/master/doc/README.md",target:"_blank",rel:"noopener noreferrer"}},[t._v("pprof"),e("OutboundLink")],1)]),t._v(" "),e("p",[t._v("可视化性能分析工具")]),t._v(" "),e("h3",{attrs:{id:"采样方式"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#采样方式"}},[t._v("#")]),t._v(" 采样方式")]),t._v(" "),e("ol",[e("li",[t._v("runtime/pprof: 采集程序(非 server )指定区块的运行数据进行分析")]),t._v(" "),e("li",[t._v("net/http/pprof: 采集 server 运行时数据")]),t._v(" "),e("li",[t._v("go test: 通过运行测试用例采集数据")])]),t._v(" "),e("h3",{attrs:{id:"使用方法"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#使用方法"}},[t._v("#")]),t._v(" 使用方法")]),t._v(" "),e("ol",[e("li",[t._v("生产报告")]),t._v(" "),e("li",[t._v("交互终端")]),t._v(" "),e("li",[t._v("web 界面")])]),t._v(" "),e("h3",{attrs:{id:"web-界面"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#web-界面"}},[t._v("#")]),t._v(" web 界面")]),t._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[t._v("\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br")])]),e("h3",{attrs:{id:"交互终端"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#交互终端"}},[t._v("#")]),t._v(" 交互终端")]),t._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[t._v("go tool pprof http://localhost:8080/debug/pprof/profile?second"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("60")]),t._v("\ngo tool pprof https+insecure://localhost:8080/debug/pprof/profile?second"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("60")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# tls")]),t._v("\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br")])]),e("h2",{attrs:{id:"生成火焰图"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#生成火焰图"}},[t._v("#")]),t._v(" 生成火焰图")]),t._v(" "),e("ul",[e("li",[t._v("perf")]),t._v(" "),e("li",[t._v("systemtap")]),t._v(" "),e("li",[t._v("go-torch")])]),t._v(" "),e("h2",{attrs:{id:"字节切片转字符串"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#字节切片转字符串"}},[t._v("#")]),t._v(" 字节切片转字符串")]),t._v(" "),e("div",{staticClass:"language-go line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-go"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("main")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\tb "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),e("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("byte")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'a'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'b'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'c'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\ta "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("string")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("b"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\tfmt"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("Println")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("a"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br"),e("span",{staticClass:"line-number"},[t._v("4")]),e("br"),e("span",{staticClass:"line-number"},[t._v("5")]),e("br")])]),e("p",[e("img",{attrs:{src:a(484),alt:"字节切片转字符串内存分配"}})]),t._v(" "),e("h2",{attrs:{id:"gotraceback"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#gotraceback"}},[t._v("#")]),t._v(" GOTRACEBACK")]),t._v(" "),e("p",[t._v("gotraceback 环境变量控制 core dump 的输出.")]),t._v(" "),e("table",[e("thead",[e("tr",[e("th",[t._v("值")]),t._v(" "),e("th",[t._v("作用")])])]),t._v(" "),e("tbody",[e("tr",[e("td",[t._v("none")]),t._v(" "),e("td",[t._v("不显示任何堆栈跟踪")])]),t._v(" "),e("tr",[e("td",[t._v("single")]),t._v(" "),e("td",[t._v("默认选项,显示当前 goroutine 堆栈跟踪")])]),t._v(" "),e("tr",[e("td",[t._v("all")]),t._v(" "),e("td",[t._v("显示所有用户创建的 goroutine 堆栈跟踪")])]),t._v(" "),e("tr",[e("td",[t._v("system")]),t._v(" "),e("td",[t._v("显示所有堆栈跟踪,甚至运行时的跟踪")])]),t._v(" "),e("tr",[e("td",[t._v("crash")]),t._v(" "),e("td",[t._v("如果没有足够日志或崩溃无法重现,这是个不错的选择")])])])]),t._v(" "),e("h3",{attrs:{id:"delve"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#delve"}},[t._v("#")]),t._v(" delve")]),t._v(" "),e("p",[e("a",{attrs:{href:"https://github.com/go-delve/delve",target:"_blank",rel:"noopener noreferrer"}},[t._v("delve"),e("OutboundLink")],1)]),t._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[t._v("dlv "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("exec")]),t._v(" ./main "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 调试二进制")]),t._v("\ndlv attach pid ./main "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 调试进程")]),t._v("\ndlv core ./main core.0000 "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 调试 core 文件")]),t._v("\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br")])]),e("table",[e("thead",[e("tr",[e("th",[t._v("命令")]),t._v(" "),e("th",[t._v("作用")])])]),t._v(" "),e("tbody",[e("tr",[e("td",[t._v("call")]),t._v(" "),e("td",[t._v("call 函数,会导致程序运行")])]),t._v(" "),e("tr",[e("td",[t._v("continue")]),t._v(" "),e("td",[t._v("继续运行")])]),t._v(" "),e("tr",[e("td",[t._v("next")]),t._v(" "),e("td",[t._v("单步调试")])]),t._v(" "),e("tr",[e("td",[t._v("restart")]),t._v(" "),e("td",[t._v("重启")])]),t._v(" "),e("tr",[e("td",[t._v("step")]),t._v(" "),e("td",[t._v("单步调试,某个函数")])]),t._v(" "),e("tr",[e("td",[t._v("step-instruction")]),t._v(" "),e("td",[t._v("单步调试汇编指令")])]),t._v(" "),e("tr",[e("td",[t._v("stepout")]),t._v(" "),e("td",[t._v("从当前函数跳出")])]),t._v(" "),e("tr",[e("td",[t._v("break (alias b)")]),t._v(" "),e("td",[t._v("设置断点")])]),t._v(" "),e("tr",[e("td",[t._v("breakpoint (alias bp)")]),t._v(" "),e("td",[t._v("打印所有断点信息")])]),t._v(" "),e("tr",[e("td",[t._v("clear")]),t._v(" "),e("td",[t._v("清理断点")])]),t._v(" "),e("tr",[e("td",[t._v("clearall")]),t._v(" "),e("td",[t._v("清理所有断点")])]),t._v(" "),e("tr",[e("td",[t._v("condition (alias cond)")]),t._v(" "),e("td",[t._v("设置条件断点")])]),t._v(" "),e("tr",[e("td",[t._v("on")]),t._v(" "),e("td",[t._v("当断点命中时设置一段命令")])]),t._v(" "),e("tr",[e("td",[t._v("trace (alias t)")]),t._v(" "),e("td",[t._v("设置跟踪点其实是一个只打印信息不中断程序的端点")])]),t._v(" "),e("tr",[e("td",[t._v("args")]),t._v(" "),e("td",[t._v("打印程序的传参")])]),t._v(" "),e("tr",[e("td",[t._v("examinemem (alias x)")]),t._v(" "),e("td",[t._v("解析内存")])]),t._v(" "),e("tr",[e("td",[t._v("locals")]),t._v(" "),e("td",[t._v("打印本地变量")])]),t._v(" "),e("tr",[e("td",[t._v("print (alias p)")]),t._v(" "),e("td",[t._v("打印表达式或变量")])]),t._v(" "),e("tr",[e("td",[t._v("regs")]),t._v(" "),e("td",[t._v("打印寄存器信息")])]),t._v(" "),e("tr",[e("td",[t._v("set")]),t._v(" "),e("td",[t._v("赋值")])]),t._v(" "),e("tr",[e("td",[t._v("vars")]),t._v(" "),e("td",[t._v("打印全局变量")])]),t._v(" "),e("tr",[e("td",[t._v("whatis")]),t._v(" "),e("td",[t._v("打印类型信息")])]),t._v(" "),e("tr",[e("td",[t._v("goroutine (alias gr)")]),t._v(" "),e("td",[t._v("打印协程信息")])]),t._v(" "),e("tr",[e("td",[t._v("goroutines (alias grs)")]),t._v(" "),e("td",[t._v("打印所有协程 "),e("code",[t._v("-t")]),t._v("展开所有堆栈")])]),t._v(" "),e("tr",[e("td",[t._v("thread (alias tr)")]),t._v(" "),e("td",[t._v("切换到某个线程")])]),t._v(" "),e("tr",[e("td",[t._v("threads")]),t._v(" "),e("td",[t._v("打印所有线程信息")])]),t._v(" "),e("tr",[e("td",[t._v("deferred")]),t._v(" "),e("td",[t._v("在 defer 函数上下文执行命令")])]),t._v(" "),e("tr",[e("td",[t._v("down")]),t._v(" "),e("td",[t._v("上堆栈")])]),t._v(" "),e("tr",[e("td",[t._v("frame")]),t._v(" "),e("td",[t._v("跳到某个具体堆栈")])]),t._v(" "),e("tr",[e("td",[t._v("stack (alias bt)")]),t._v(" "),e("td",[t._v("打印堆栈信息")])]),t._v(" "),e("tr",[e("td",[t._v("up")]),t._v(" "),e("td",[t._v("下堆栈")])]),t._v(" "),e("tr",[e("td",[t._v("config")]),t._v(" "),e("td",[t._v("配置变更")])]),t._v(" "),e("tr",[e("td",[t._v("disassemble (alias disass)")]),t._v(" "),e("td",[t._v("反汇编")])]),t._v(" "),e("tr",[e("td",[t._v("funcs")]),t._v(" "),e("td",[t._v("打印所有函数符号")])]),t._v(" "),e("tr",[e("td",[t._v("libraries")]),t._v(" "),e("td",[t._v("打印所有加载的动态库")])]),t._v(" "),e("tr",[e("td",[t._v("list (alias ls | l)")]),t._v(" "),e("td",[t._v("显示源码")])]),t._v(" "),e("tr",[e("td",[t._v("types")]),t._v(" "),e("td",[t._v("打印所有类型信息")])])])]),t._v(" "),e("h2",{attrs:{id:"trace"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#trace"}},[t._v("#")]),t._v(" trace")]),t._v(" "),e("div",{staticClass:"language-sh line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[t._v("go "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("test")]),t._v(" -trace trace.out\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("curl")]),t._v(" http://debug/pprof/trace?seconds"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("60")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" trace.out\ngo tool trace trace.out\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br")])]),e("h2",{attrs:{id:"mmu"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#mmu"}},[t._v("#")]),t._v(" MMU")]),t._v(" "),e("h2",{attrs:{id:"pprof-2"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#pprof-2"}},[t._v("#")]),t._v(" pprof")]),t._v(" "),e("div",{staticClass:"language-go line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-go"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// runtime/pprof.go")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 堆栈分析")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("WriteHeapProfile")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("w io"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Writer"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("error")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// cpu分析")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("StartCPUProfile")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("w io"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Writer"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("error")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("StopCPUProfile")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br"),e("span",{staticClass:"line-number"},[t._v("4")]),e("br"),e("span",{staticClass:"line-number"},[t._v("5")]),e("br"),e("span",{staticClass:"line-number"},[t._v("6")]),e("br")])]),e("p",[t._v("pprof 是二进制文件,需要需要生成 svg、pdf、png 等格式文件")]),t._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[t._v("go tool pprof -svg ./pprof\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br")])]),e("h2",{attrs:{id:"gotool"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#gotool"}},[t._v("#")]),t._v(" gotool")]),t._v(" "),e("h3",{attrs:{id:"nm"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#nm"}},[t._v("#")]),t._v(" nm")]),t._v(" "),e("p",[t._v("查看符号表,等同于系统 nm 命令,")]),t._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[t._v("go tool nm main "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 地址 类型 符号")]),t._v("\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br")])]),e("h3",{attrs:{id:"compile"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#compile"}},[t._v("#")]),t._v(" compile")]),t._v(" "),e("p",[t._v("查看汇编代码")]),t._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[t._v("go tool compile -N -l -S main.go\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br")])]),e("h3",{attrs:{id:"objdump"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#objdump"}},[t._v("#")]),t._v(" objdump")]),t._v(" "),e("p",[t._v("反汇编的二进制工具,等同于系统 objdump.")]),t._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[t._v("go tool objdump main.o\ngo tool objdump -s main main.o "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 反汇编某个函数")]),t._v("\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br")])]),e("h3",{attrs:{id:"pprof-3"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#pprof-3"}},[t._v("#")]),t._v(" pprof")]),t._v(" "),e("p",[t._v("如果是 net/http/pprof 方式可以直接在控制台输入,浏览器查看,也可以把信息 dump 到本地,通过 tool 去分析")]),t._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[t._v("curl")]),t._v(" -sS "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'http://127.0.0.1/debug/pprof/heap?seconds=5'")]),t._v(" -o heap.pprof "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# dump 内存")]),t._v("\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br")])]),e("ol",[e("li",[t._v("cpu 分析 : 采样消耗 cpu 的调用,一般用来定位排查耗费计算资源的地方")]),t._v(" "),e("li",[t._v("memroy : 内存分析,一般用来排查内存占用,内存泄漏问题,每 512KB 采样一次内存采样是针对堆栈不是类型.内存采样一定是通过"),e("code",[t._v("mProf_Malloc,mProf_Free")]),t._v("两个函数,如果 cgo 分配的内存,不会调用这两个函数,所以 cgo 导致的内存问题 "),e("code",[t._v("go tool pprof")]),t._v("是分析不出来的")]),t._v(" "),e("li",[t._v("Block : 阻塞分析,采样程序阻塞调用")]),t._v(" "),e("li",[t._v("Mutex : 互斥锁分析,采样互斥锁竞争情况")]),t._v(" "),e("li",[t._v("goroutine 分析: 可以对当前应用程序正在运行的 goroutine 进行堆栈跟踪和分析")])]),t._v(" "),e("blockquote",[e("p",[e("code",[t._v("?debug=1")]),t._v("不带 debug 参数会自动下载对应 profile 文件,部署环境中,为了安全不会对外暴露 pprof 端口,会通过 curl、wget 方式进行 profile 文件间接拉取,debug 有实效性,经常需要及时将当前状态下 profile 文件存储下来进行分析.")])]),t._v(" "),e("h3",{attrs:{id:"trace-2"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#trace-2"}},[t._v("#")]),t._v(" trace")]),t._v(" "),e("p",[t._v("STW 然后 get context(栈信息), goroutine 快照,恢复运行将 trace 信息推送到 trace buffer,trace 允许跟踪采样一段时间的信息,然后 dump 成文件,最后调用"),e("code",[t._v("go tool trace")]),t._v("分析 dump 文件,并以 web 形式打开.w 可以放大时间线.")]),t._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[t._v("go run main.go "),e("span",{pre:!0,attrs:{class:"token operator"}},[e("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[t._v("2")]),t._v(">")]),t._v(" trace.out\ngo tool trace trace.out\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br")])]),e("ol",[e("li",[t._v("gc(idle) 是没有工作时标记内存的 goroutine")]),t._v(" "),e("li",[t._v("STW 两个停止阶段")]),t._v(" "),e("li",[t._v("mark assist 重新执行分配内存重新标记内存的 goroutine")]),t._v(" "),e("li",[t._v("GXX runtime.bgweep 内存扫描阶段")]),t._v(" "),e("li",[t._v("GXX runtime.gcBgMarkWorker 标记内存专有 goroutine")]),t._v(" "),e("li",[t._v("syscall 系统调用")])]),t._v(" "),e("div",{staticClass:"language-go line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-go"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("main")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\ttrace"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("Start")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("os"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Stderr"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("defer")]),t._v(" trace"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("Stop")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\tch "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("make")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("chan")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("string")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("go")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("func")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\tch "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<-")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"EDDYCJY"')]),t._v("\n\t"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<-")]),t._v("ch\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br"),e("span",{staticClass:"line-number"},[t._v("4")]),e("br"),e("span",{staticClass:"line-number"},[t._v("5")]),e("br"),e("span",{staticClass:"line-number"},[t._v("6")]),e("br"),e("span",{staticClass:"line-number"},[t._v("7")]),e("br"),e("span",{staticClass:"line-number"},[t._v("8")]),e("br"),e("span",{staticClass:"line-number"},[t._v("9")]),e("br")])]),e("table",[e("thead",[e("tr",[e("th",[t._v("列")]),t._v(" "),e("th",[t._v("描述")])])]),t._v(" "),e("tbody",[e("tr",[e("td",[t._v("view trace")]),t._v(" "),e("td",[t._v("查看跟踪")])]),t._v(" "),e("tr",[e("td",[t._v("goroutine analysis")]),t._v(" "),e("td",[t._v("goroutine 分析,每个函数块有多少 goroutine 在跑")])]),t._v(" "),e("tr",[e("td",[t._v("network blocking profile")]),t._v(" "),e("td",[t._v("网络阻塞情况")])]),t._v(" "),e("tr",[e("td",[t._v("synchronization blocking profile")]),t._v(" "),e("td",[t._v("同步阻塞情况")])]),t._v(" "),e("tr",[e("td",[t._v("syscall blocking profile")]),t._v(" "),e("td",[t._v("系统调用情况")])]),t._v(" "),e("tr",[e("td",[t._v("scheduler latency profile")]),t._v(" "),e("td",[t._v("调度延迟情况,可以查看调度过程")])]),t._v(" "),e("tr",[e("td",[t._v("user defined tasks")]),t._v(" "),e("td",[t._v("用户自定义任务")])]),t._v(" "),e("tr",[e("td",[t._v("user defined regions")]),t._v(" "),e("td",[t._v("用户自定义区域")])]),t._v(" "),e("tr",[e("td",[t._v("mininum mutator utilization")]),t._v(" "),e("td",[t._v("最低 mutator 利用")])])])]),t._v(" "),e("h3",{attrs:{id:"test"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#test"}},[t._v("#")]),t._v(" test")]),t._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[t._v("go "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("test")]),t._v(" -c "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 编译测试文件,可以一台机器编译,一台机器测试")]),t._v("\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br")])]),e("h3",{attrs:{id:"cover"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#cover"}},[t._v("#")]),t._v(" cover")]),t._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[t._v("go "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("test")]),t._v(" -coverprofile"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("coverage.out "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 跑单测的时候记录代码覆盖率")]),t._v("\ngo tool cover -func"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("coverage.out "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 得到覆盖率报告")]),t._v("\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br")])]),e("h2",{attrs:{id:"debug"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#debug"}},[t._v("#")]),t._v(" debug")]),t._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("GODEBUG")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"allocfreetrace=1"')]),t._v("\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br")])]),e("h2",{attrs:{id:"偶尔异常"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#偶尔异常"}},[t._v("#")]),t._v(" 偶尔异常")]),t._v(" "),e("p",[t._v("cpu、内存、goroutine 暴涨都可以用数值表示(突然比正常平均值高出百分之 N、超过模块正常情况下最高水位)")]),t._v(" "),e("ol",[e("li",[t._v("cpu 抖动 : 模块内触发率低的逻辑")]),t._v(" "),e("li",[t._v("内存使用抖动 : 大量请求创建过多对象、也可能 goroutine 泄漏")]),t._v(" "),e("li",[t._v("goroutine 数暴涨 : 可能是死锁,可能是生产完了 channel 没关闭")])]),t._v(" "),e("p",[t._v("请几个周期收集数据,当出现波动时 dump 数据,文件保存下来模块挂了也无所谓.")]),t._v(" "),e("ol",[e("li",[t._v("dump 当前 goroutine 栈")]),t._v(" "),e("li",[t._v("dump 当前 cpu profile")]),t._v(" "),e("li",[t._v("dump 当前 off-cpu profile")]),t._v(" "),e("li",[t._v("dump 几秒的 trace (消耗资源,不建议)")]),t._v(" "),e("li",[t._v("cpu 内存的采集,物理机 gopsutil, docker cgroup")])]),t._v(" "),e("h2",{attrs:{id:"问题"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#问题"}},[t._v("#")]),t._v(" 问题")]),t._v(" "),e("ol",[e("li",[t._v("升级最新稳定版")]),t._v(" "),e("li",[t._v("pprof cpu(GC)、内存、堆栈采样(大对象分配)")])]),t._v(" "),e("h2",{attrs:{id:"竞态检测"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#竞态检测"}},[t._v("#")]),t._v(" 竞态检测")]),t._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[t._v("go "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("test")]),t._v(" -race\ngo run -race\nbo build -race\ngo "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" -race\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br"),e("span",{staticClass:"line-number"},[t._v("4")]),e("br")])]),e("h2",{attrs:{id:"gops"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#gops"}},[t._v("#")]),t._v(" gops")]),t._v(" "),e("p",[e("a",{attrs:{href:"https://github.com/google/gops",target:"_blank",rel:"noopener noreferrer"}},[t._v("gops"),e("OutboundLink")],1)]),t._v(" "),e("h2",{attrs:{id:"pprof-4"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#pprof-4"}},[t._v("#")]),t._v(" pprof")]),t._v(" "),e("ol",[e("li",[t._v("heap : 活动对象的内存分配")]),t._v(" "),e("li",[t._v("threadcreate : 导致创建新 OS 线程的堆栈跟踪")]),t._v(" "),e("li",[t._v("goroutine : 所有当前 goroutine 的堆栈跟踪")]),t._v(" "),e("li",[t._v("allocs : 活动对象的内存分配采样")]),t._v(" "),e("li",[t._v("Block : 导致阻塞的堆栈跟踪")]),t._v(" "),e("li",[t._v("Mutex : 竞争互斥的堆栈跟踪")])]),t._v(" "),e("h2",{attrs:{id:"go-callvis"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#go-callvis"}},[t._v("#")]),t._v(" go-callvis")]),t._v(" "),e("p",[e("a",{attrs:{href:"https://github.com/ofabry/go-callvis",target:"_blank",rel:"noopener noreferrer"}},[t._v("go-callvis"),e("OutboundLink")],1)]),t._v(" "),e("h2",{attrs:{id:"goroutine-泄漏"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#goroutine-泄漏"}},[t._v("#")]),t._v(" goroutine 泄漏")]),t._v(" "),e("p",[t._v("常规 pprof dump 两份采样数据,"),e("code",[t._v("--base")]),t._v("比较.")]),t._v(" "),e("h3",{attrs:{id:"主动关闭-resp"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#主动关闭-resp"}},[t._v("#")]),t._v(" 主动关闭 resp")]),t._v(" "),e("div",{staticClass:"language-go line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-go"}},[e("code",[t._v("client "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("http"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Client"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("_")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" err "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" client"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("Do")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("req"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" err "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("nil")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//...")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("defer")]),t._v(" resp"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Body"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("Close")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 不关闭会导致 goroutine 泄漏")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// net/http/transport.go:dailconn")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("t "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v("Transport"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("dialConn")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("...")]),t._v("\n\t"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("go")]),t._v(" pconn"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("readLoop")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("go")]),t._v(" pconn"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("writeLoop")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" pconn"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("nil")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br"),e("span",{staticClass:"line-number"},[t._v("4")]),e("br"),e("span",{staticClass:"line-number"},[t._v("5")]),e("br"),e("span",{staticClass:"line-number"},[t._v("6")]),e("br"),e("span",{staticClass:"line-number"},[t._v("7")]),e("br"),e("span",{staticClass:"line-number"},[t._v("8")]),e("br"),e("span",{staticClass:"line-number"},[t._v("9")]),e("br"),e("span",{staticClass:"line-number"},[t._v("10")]),e("br"),e("span",{staticClass:"line-number"},[t._v("11")]),e("br"),e("span",{staticClass:"line-number"},[t._v("12")]),e("br"),e("span",{staticClass:"line-number"},[t._v("13")]),e("br")])]),e("h2",{attrs:{id:"案例分析"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#案例分析"}},[t._v("#")]),t._v(" 案例分析")]),t._v(" "),e("h3",{attrs:{id:"案例-1"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#案例-1"}},[t._v("#")]),t._v(" 案例 1")]),t._v(" "),e("h4",{attrs:{id:"问题-2"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#问题-2"}},[t._v("#")]),t._v(" 问题")]),t._v(" "),e("p",[t._v("内存疯长")]),t._v(" "),e("h4",{attrs:{id:"排查过程"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#排查过程"}},[t._v("#")]),t._v(" 排查过程")]),t._v(" "),e("ol",[e("li",[t._v("引入 pprof : 程序中引入 pprof")]),t._v(" "),e("li",[t._v("gotest : 使用 gotest 发起测试请求")]),t._v(" "),e("li",[t._v("查看 pprof 的 goroutine : goroutine 滞留导致栈没有被释放、goroutine 没有被释放、goroutine 指向的对象没有被回收")]),t._v(" "),e("li",[t._v("原因 channel 阻塞 : channel 阻塞是 goroutine 泄漏的主要发生点,如 rpc、http 请求流未能关闭")]),t._v(" "),e("li",[t._v("并发 test 原因 : 客户端作为单例,不是线程安全的,没有并发控制,遇到并发请求时会创建大量客户端")]),t._v(" "),e("li",[t._v("代码 : map 清理时没有释放里面的连接、读取配置文件出错没有异常处理没有异常处理,使用默认值(默认值很小)")])]),t._v(" "),e("h2",{attrs:{id:"cpu-profiler"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#cpu-profiler"}},[t._v("#")]),t._v(" cpu profiler")]),t._v(" "),e("p",[t._v("使用 setitimer 系统调用,操作系统会每秒 100 次向程序发送 SIGPROF 信号.在 GO 进程中会选择随机的信号执行 sigtrampgo 函数.该函数使用 sigprof 或 sigprofNonGo 来记录线程当前的栈.")]),t._v(" "),e("h3",{attrs:{id:"on-cpu-profiler"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#on-cpu-profiler"}},[t._v("#")]),t._v(" on-cpu profiler")]),t._v(" "),e("p",[t._v("内置,对于瓶颈在 cpu 消耗的应用.")]),t._v(" "),e("h3",{attrs:{id:"off-cpu-profiler"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#off-cpu-profiler"}},[t._v("#")]),t._v(" off-cpu profiler")]),t._v(" "),e("p",[t._v("fgprof,对于 cpu 使用不高,但接口延迟却很大的应用.fgprof 是启动一个后台的 goroutine 每秒启动 99 次,调用 runtime.GoroutineProfile 来采集所有 goroutine 的栈.性能消耗大,只适合在测试环境使用.")]),t._v(" "),e("h2",{attrs:{id:"memory-profiler"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#memory-profiler"}},[t._v("#")]),t._v(" memory profiler")]),t._v(" "),e("ul",[e("li",[t._v("inuse_objects : 内存中驻留对象")]),t._v(" "),e("li",[t._v("inuse_space : 应用占用 RSS 过大")]),t._v(" "),e("li",[t._v("alloc_objects : 历史上大量内存分配行为导致 cpu 或内存大幅上升")]),t._v(" "),e("li",[t._v("alloc_space : 历史上发生过内存使用大量上升时")])]),t._v(" "),e("h2",{attrs:{id:"trace-3"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#trace-3"}},[t._v("#")]),t._v(" trace")]),t._v(" "),e("p",[t._v("一般情况下不需要 trace 来定位性能问题,通过压测 + profile 可以解决大部分问题,当问题与 runtime 有关,采集 trace 对性能影响还是比较大的,开启 gctrace 把日志重定向到文件,因为 gctrace 日志 print 是在 stw 期间做的.")]),t._v(" "),e("h2",{attrs:{id:"perf"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#perf"}},[t._v("#")]),t._v(" perf")]),t._v(" "),e("p",[t._v("如果应用没有开启 pprof,线上应急使用可以临时使用 perf")]),t._v(" "),e("h2",{attrs:{id:"基准测试"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#基准测试"}},[t._v("#")]),t._v(" 基准测试")]),t._v(" "),e("p",[t._v("benchmark")]),t._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[t._v("go "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("test")]),t._v(" -bench"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(".\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br")])]),e("h2",{attrs:{id:"例子"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#例子"}},[t._v("#")]),t._v(" 例子")]),t._v(" "),e("h3",{attrs:{id:"和-fmt"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#和-fmt"}},[t._v("#")]),t._v(" + 和 fmt")]),t._v(" "),e("p",[t._v("使用 + 进行字符串拼接不会在堆上产生额外的对象,使用 fmt 系列函数,会造成局部对象逃逸到堆上.导致线上 GC 压力过大.")]),t._v(" "),e("h3",{attrs:{id:"sync-pool"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#sync-pool"}},[t._v("#")]),t._v(" sync.Pool")]),t._v(" "),e("p",[t._v("复用堆上对象.")]),t._v(" "),e("h2",{attrs:{id:"常见问题"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#常见问题"}},[t._v("#")]),t._v(" 常见问题")]),t._v(" "),e("ol",[e("li",[t._v("调度占用过多 cpu : goroutine 频繁创建和销毁")]),t._v(" "),e("li",[t._v("进程占用大量内存")]),t._v(" "),e("li",[t._v("锁冲突严重")])]),t._v(" "),e("h2",{attrs:{id:"逃逸分析"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#逃逸分析"}},[t._v("#")]),t._v(" 逃逸分析")]),t._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# src/cmd/compile/internal/gc/escape.go")]),t._v("\ngo build -gcflags "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"-m -l"')]),t._v(" main.go "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# -m 逃逸分析 -l 禁止内连")]),t._v("\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br")])]),e("blockquote",[e("p",[t._v("切片 append 可能引发逃逸分析,当 cap 附加元素超过 cap 时,运行时会在堆上分配一个更大的空间将原栈上的元素复制过去,后续该切片的元素就存储在堆上,创建 slice 时建议带上预估的 cap,减少堆内存的频繁分配,切片变量未逃逸的情况下,在 cap 容量下所有元素都分配在栈上")])]),t._v(" "),e("h3",{attrs:{id:"原则"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#原则"}},[t._v("#")]),t._v(" 原则")]),t._v(" "),e("ol",[e("li",[t._v("指向栈对象的指针不能存储在堆中")]),t._v(" "),e("li",[t._v("指向栈对象的指针不能超过该对象的存活期(指针不能在栈对象销毁后依然存活)")])]),t._v(" "),e("h3",{attrs:{id:"实现"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#实现"}},[t._v("#")]),t._v(" 实现")]),t._v(" "),e("ol",[e("li",[t._v("构建一个有向加权图,代表由语句和表达式分配的变量,边代表变量之间的赋值,权重代表寻址和取址的次数")]),t._v(" "),e("li",[t._v("遍历该有向加权图,在图中 寻找可能违反上述不变量条件的的赋值路径,如果一个变量的地址是存储在堆或其他可能超过它存活期的地方,权重减为负数,那么就会被标记为需要在堆上分配")]),t._v(" "),e("li",[t._v("为了支持函数间的分析,记录每个函数的参数到堆以及其结果到数据流,算法将这些信息称为参数标签,这些标签在静态调用时使用,以改善对函数参数的逃逸分析")])]),t._v(" "),e("h3",{attrs:{id:"手动强制避免逃逸"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#手动强制避免逃逸"}},[t._v("#")]),t._v(" 手动强制避免逃逸")]),t._v(" "),e("p",[t._v("通过 uintptr 做一次转换,将指针转换成数值,切断了逃逸分析的数据流跟踪,避免指针逃逸.")]),t._v(" "),e("h2",{attrs:{id:"监控"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#监控"}},[t._v("#")]),t._v(" 监控")]),t._v(" "),e("ol",[e("li",[e("a",{attrs:{href:"https://github.com/shirou/gopsutil",target:"_blank",rel:"noopener noreferrer"}},[t._v("gopsutil"),e("OutboundLink")],1)])]),t._v(" "),e("h2",{attrs:{id:"runtime-setfinalizer"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#runtime-setfinalizer"}},[t._v("#")]),t._v(" runtime.SetFinalizer")]),t._v(" "),e("p",[t._v("实现析构函数.")]),t._v(" "),e("p",[t._v("net/http/pprof 不使用时不会造成影响")]),t._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[t._v("go tool pprof --http :8080 "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 获取远程 profile 文件")]),t._v("\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br")])]),e("h2",{attrs:{id:"trace-vs-pprof"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#trace-vs-pprof"}},[t._v("#")]),t._v(" trace vs pprof")]),t._v(" "),e("ol",[e("li",[e("p",[t._v("trace : 侧重分析采样时间内系统做了什么,原理是监听调度器事件,记录操作耗时相关信息,为每个 event 打上时间,性能开销较大")]),t._v(" "),e("p",[t._v("a. 与 goroutine 调度有关的事件,创建、启动、结束,同步原语(mutex、channel 收发)上的阻塞和解锁")]),t._v(" "),e("p",[t._v("b. 与网络有关的事件,goroutine 在网络 io 上的阻塞和解锁")]),t._v(" "),e("p",[t._v("c. 与系统调用有关的事件,goroutine 进入系统调用与从系统调用的返回")]),t._v(" "),e("p",[t._v("d. 与 gc 有关的事件, GC 开始,停止,并发标记,清扫开始和暂停")])]),t._v(" "),e("li",[e("p",[t._v("pprof : 微秒级采样可以使用 uber 的 pprof++,及 pprof label 的使用")])])]),t._v(" "),e("h2",{attrs:{id:"优化"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#优化"}},[t._v("#")]),t._v(" 优化")]),t._v(" "),e("div",{staticClass:"language-go line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-go"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// pp 分析具体代码块")]),t._v("\npprof"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("StartCPUProfile")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("cpu"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("pprof"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\npprof"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("StopCPUProfile\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 找到性能瓶颈")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("go")]),t._v(" tool pprof cpu"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("pprof "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" top10\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 单测 & 压测 优化")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("go")]),t._v(" test\ntesting"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("AllocsPerRun "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 测试查看内存")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("go")]),t._v(" benchmark\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br"),e("span",{staticClass:"line-number"},[t._v("4")]),e("br"),e("span",{staticClass:"line-number"},[t._v("5")]),e("br"),e("span",{staticClass:"line-number"},[t._v("6")]),e("br"),e("span",{staticClass:"line-number"},[t._v("7")]),e("br"),e("span",{staticClass:"line-number"},[t._v("8")]),e("br"),e("span",{staticClass:"line-number"},[t._v("9")]),e("br")])]),e("h2",{attrs:{id:"例子-2"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#例子-2"}},[t._v("#")]),t._v(" 例子")]),t._v(" "),e("div",{staticClass:"language-go line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-go"}},[e("code",[t._v("sync"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("pool "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// sync.Pool 处理大对象,因为会直接在堆上分配")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),e("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("byte")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("unsafe"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("Pointer")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("s"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 字符串-> 字节切片")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),e("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("string")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("unsafe"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("Pointer")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("buf"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 字节切片 -> 字符串 缓存区不能修改,否则会 panic")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 重置缓存区")]),t._v("\nbytes"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Buffer"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Reset\nbuf "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" buf"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br"),e("span",{staticClass:"line-number"},[t._v("4")]),e("br"),e("span",{staticClass:"line-number"},[t._v("5")]),e("br"),e("span",{staticClass:"line-number"},[t._v("6")]),e("br")])]),e("ol",[e("li",[t._v("优先选择初始分配大小的数组,而不是不指定大小将其留给增长因子")])]),t._v(" "),e("h2",{attrs:{id:"逃逸场景"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#逃逸场景"}},[t._v("#")]),t._v(" 逃逸场景")]),t._v(" "),e("p",[t._v("避免 gc 从以下四个方面入手:")]),t._v(" "),e("ol",[e("li",[t._v("指针逃逸 : 返回局部变量的指针")]),t._v(" "),e("li",[t._v("栈空间不足(空间开辟过大) : 当栈空间不足以存放当前对象时或无法判断当前切片长度时会将对象分配到堆上")]),t._v(" "),e("li",[t._v("动态类型逃逸(不确定对象大小)")]),t._v(" "),e("li",[t._v("闭包引用对象逃逸")])]),t._v(" "),e("h2",{attrs:{id:"常驻内存对象个数"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#常驻内存对象个数"}},[t._v("#")]),t._v(" 常驻内存对象个数")]),t._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[t._v("go tool pprof -inuse_objects http://127.0.0.1:6060/debug/pprof/heap\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br")])]),e("h2",{attrs:{id:"小结"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#小结"}},[t._v("#")]),t._v(" 小结")]),t._v(" "),e("ul",[e("li",[e("p",[t._v("cpu、内存、磁盘 io、网络 io、socket fd 文件数量")])]),t._v(" "),e("li",[e("p",[t._v("goroutine")])]),t._v(" "),e("li",[e("p",[t._v("profile (syscall、scanobject 等)")])]),t._v(" "),e("li",[e("p",[t._v("head (降低常驻内存对象可以降低 GC 频率)")])]),t._v(" "),e("li",[e("p",[t._v("默认 512kb 采样"),e("code",[t._v("runtime.MemProfileRate")]),t._v("调整采样频率")])])]),t._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[t._v("heap\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("top")]),t._v(" -cum "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 将函数调用关系中的数据进行累积")]),t._v("\ngo tool pprof -alloc_space -cum -svg http://127.0.0.1:8080/debug/pprof/heap "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" heap.svg "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 直接生成 svg 图片")]),t._v("\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br")])]),e("ul",[e("li",[e("code",[t._v("--inuse_space")]),t._v(" : 来分析程序常驻内存的占用情况,heap 内存")]),t._v(" "),e("li",[e("code",[t._v("--alloc_objects")]),t._v(" : 来分析内存的临时分配情况, 应该是 stack 内存")])]),t._v(" "),e("h3",{attrs:{id:"建议"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#建议"}},[t._v("#")]),t._v(" 建议")]),t._v(" "),e("ul",[e("li",[t._v("将多个小对象合并成大对象")]),t._v(" "),e("li",[t._v("减少不必要指针间接引用,多用 copy 引用")]),t._v(" "),e("li",[t._v("局部变量逃逸时聚合")])]),t._v(" "),e("div",{staticClass:"language-go line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-go"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" k"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" v "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("range")]),t._v(" m "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    k"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" v "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" k"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" v\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("go")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("func")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// use k and v")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" k"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" v "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("range")]),t._v(" m "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    x "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" k"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" v "),e("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("string")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("k"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" v"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("go")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("func")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// use x.k and x.v")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[t._v("1")]),e("br"),e("span",{staticClass:"line-number"},[t._v("2")]),e("br"),e("span",{staticClass:"line-number"},[t._v("3")]),e("br"),e("span",{staticClass:"line-number"},[t._v("4")]),e("br"),e("span",{staticClass:"line-number"},[t._v("5")]),e("br"),e("span",{staticClass:"line-number"},[t._v("6")]),e("br"),e("span",{staticClass:"line-number"},[t._v("7")]),e("br"),e("span",{staticClass:"line-number"},[t._v("8")]),e("br"),e("span",{staticClass:"line-number"},[t._v("9")]),e("br"),e("span",{staticClass:"line-number"},[t._v("10")]),e("br"),e("span",{staticClass:"line-number"},[t._v("11")]),e("br"),e("span",{staticClass:"line-number"},[t._v("12")]),e("br")])]),e("ul",[e("li",[t._v("少用 []byte 多用数组")]),t._v(" "),e("li",[t._v("sync.Pool 缓存常用对象")])]),t._v(" "),e("h2",{attrs:{id:"监控自动化"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#监控自动化"}},[t._v("#")]),t._v(" 监控自动化")]),t._v(" "),e("p",[t._v("以 5s 为单位,把进程的 CPU 使用"),e("a",{attrs:{href:"https://github.com/shirou/gopsutil",target:"_blank",rel:"noopener noreferrer"}},[t._v("gopsutil"),e("OutboundLink")],1),t._v(", RSS "),e("a",{attrs:{href:"https://github.com/shirou/gopsutil",target:"_blank",rel:"noopener noreferrer"}},[t._v("gopsutil"),e("OutboundLink")],1),t._v(",goroutine 数"),e("code",[t._v("runtime.NumGoroutine")]),t._v("用 10 大小的环形数组保存下来,每次采集到新值与之前多个周期的平均值 diff.")]),t._v(" "),e("ul",[e("li",[t._v("若 cpu 抖动,从当前开始采集 cpu profile 5s")]),t._v(" "),e("li",[t._v("若 RSS 抖动,将当前进程的 heap profile 记录下来")]),t._v(" "),e("li",[t._v("若 goroutine 抖动,将当前进程的 goroutine profile 记录下来")])]),t._v(" "),e("h3",{attrs:{id:"开源工具"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#开源工具"}},[t._v("#")]),t._v(" 开源工具")]),t._v(" "),e("ul",[e("li",[e("a",{attrs:{href:"https://grafana.com/oss/prometheus/exporters/go-exporter/",target:"_blank",rel:"noopener noreferrer"}},[t._v("go-exporter"),e("OutboundLink")],1)]),t._v(" "),e("li",[e("a",{attrs:{href:"https://github.com/divan/expvarmon",target:"_blank",rel:"noopener noreferrer"}},[t._v("expvarmon"),e("OutboundLink")],1)])])])}),[],!1,null,null,null);s.default=r.exports}}]);