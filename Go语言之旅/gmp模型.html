<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>gmp 模型 | 嗯哼人生</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="">
    <meta name="referrer" content="no-referrer">
    
    <link rel="preload" href="/m/assets/css/0.styles.1e386fb6.css" as="style"><link rel="preload" href="/m/assets/js/app.71fdaff2.js" as="script"><link rel="preload" href="/m/assets/js/2.351ead77.js" as="script"><link rel="preload" href="/m/assets/js/12.c3dadd73.js" as="script"><link rel="prefetch" href="/m/assets/js/10.98c1e7e0.js"><link rel="prefetch" href="/m/assets/js/100.d7774ae1.js"><link rel="prefetch" href="/m/assets/js/101.0d4dea0d.js"><link rel="prefetch" href="/m/assets/js/102.6867f859.js"><link rel="prefetch" href="/m/assets/js/103.9d24bd08.js"><link rel="prefetch" href="/m/assets/js/104.4d59f256.js"><link rel="prefetch" href="/m/assets/js/105.ff49af8e.js"><link rel="prefetch" href="/m/assets/js/106.b26c7611.js"><link rel="prefetch" href="/m/assets/js/107.da5be320.js"><link rel="prefetch" href="/m/assets/js/108.0c03f842.js"><link rel="prefetch" href="/m/assets/js/109.5587de24.js"><link rel="prefetch" href="/m/assets/js/11.4e6d88d4.js"><link rel="prefetch" href="/m/assets/js/110.40ae6022.js"><link rel="prefetch" href="/m/assets/js/111.0353ccf3.js"><link rel="prefetch" href="/m/assets/js/112.f562c096.js"><link rel="prefetch" href="/m/assets/js/113.7926c003.js"><link rel="prefetch" href="/m/assets/js/114.356035f0.js"><link rel="prefetch" href="/m/assets/js/115.15e5e23e.js"><link rel="prefetch" href="/m/assets/js/116.2db2b1ed.js"><link rel="prefetch" href="/m/assets/js/117.2658e42c.js"><link rel="prefetch" href="/m/assets/js/118.037a8503.js"><link rel="prefetch" href="/m/assets/js/119.21153540.js"><link rel="prefetch" href="/m/assets/js/120.b8f0644f.js"><link rel="prefetch" href="/m/assets/js/121.4c1c263a.js"><link rel="prefetch" href="/m/assets/js/122.d6ba18dd.js"><link rel="prefetch" href="/m/assets/js/123.ceef4883.js"><link rel="prefetch" href="/m/assets/js/124.9e5f50ca.js"><link rel="prefetch" href="/m/assets/js/125.de1ddc80.js"><link rel="prefetch" href="/m/assets/js/126.ae350aea.js"><link rel="prefetch" href="/m/assets/js/127.4636f6be.js"><link rel="prefetch" href="/m/assets/js/128.13b379ab.js"><link rel="prefetch" href="/m/assets/js/129.e7b0a15f.js"><link rel="prefetch" href="/m/assets/js/13.a52bd89b.js"><link rel="prefetch" href="/m/assets/js/130.147cdf11.js"><link rel="prefetch" href="/m/assets/js/131.c7a07871.js"><link rel="prefetch" href="/m/assets/js/132.faf72eb9.js"><link rel="prefetch" href="/m/assets/js/133.6301923b.js"><link rel="prefetch" href="/m/assets/js/134.4357c6e4.js"><link rel="prefetch" href="/m/assets/js/135.0ea43a3d.js"><link rel="prefetch" href="/m/assets/js/136.5a7c2377.js"><link rel="prefetch" href="/m/assets/js/137.393c998e.js"><link rel="prefetch" href="/m/assets/js/138.dcf958b6.js"><link rel="prefetch" href="/m/assets/js/139.1ccac68b.js"><link rel="prefetch" href="/m/assets/js/14.96fff293.js"><link rel="prefetch" href="/m/assets/js/140.938c314e.js"><link rel="prefetch" href="/m/assets/js/141.03cc2137.js"><link rel="prefetch" href="/m/assets/js/142.db00aba9.js"><link rel="prefetch" href="/m/assets/js/143.6d7b22af.js"><link rel="prefetch" href="/m/assets/js/144.850ed5a9.js"><link rel="prefetch" href="/m/assets/js/145.a1958a5f.js"><link rel="prefetch" href="/m/assets/js/146.1b350d4f.js"><link rel="prefetch" href="/m/assets/js/147.961f3ccd.js"><link rel="prefetch" href="/m/assets/js/148.cb4f8811.js"><link rel="prefetch" href="/m/assets/js/149.45ad7c2c.js"><link rel="prefetch" href="/m/assets/js/15.c507965f.js"><link rel="prefetch" href="/m/assets/js/150.5d952b70.js"><link rel="prefetch" href="/m/assets/js/151.5c794bb0.js"><link rel="prefetch" href="/m/assets/js/152.974e657e.js"><link rel="prefetch" href="/m/assets/js/153.b7cf98f6.js"><link rel="prefetch" href="/m/assets/js/154.be904394.js"><link rel="prefetch" href="/m/assets/js/155.769e3b0d.js"><link rel="prefetch" href="/m/assets/js/156.6107a44f.js"><link rel="prefetch" href="/m/assets/js/157.0bf74a2b.js"><link rel="prefetch" href="/m/assets/js/158.d499f907.js"><link rel="prefetch" href="/m/assets/js/159.6b2acd2c.js"><link rel="prefetch" href="/m/assets/js/16.247520d0.js"><link rel="prefetch" href="/m/assets/js/160.ec909209.js"><link rel="prefetch" href="/m/assets/js/161.4832768d.js"><link rel="prefetch" href="/m/assets/js/162.ae74834a.js"><link rel="prefetch" href="/m/assets/js/163.8af51be9.js"><link rel="prefetch" href="/m/assets/js/164.0d64a1ef.js"><link rel="prefetch" href="/m/assets/js/165.5e5a775c.js"><link rel="prefetch" href="/m/assets/js/166.121987f8.js"><link rel="prefetch" href="/m/assets/js/167.1c270942.js"><link rel="prefetch" href="/m/assets/js/168.200df8c8.js"><link rel="prefetch" href="/m/assets/js/169.84f5e0d7.js"><link rel="prefetch" href="/m/assets/js/17.3cb462b5.js"><link rel="prefetch" href="/m/assets/js/170.57b7eec5.js"><link rel="prefetch" href="/m/assets/js/171.d993d636.js"><link rel="prefetch" href="/m/assets/js/172.820d00a1.js"><link rel="prefetch" href="/m/assets/js/173.cc29ff6e.js"><link rel="prefetch" href="/m/assets/js/174.99d62af7.js"><link rel="prefetch" href="/m/assets/js/175.da874148.js"><link rel="prefetch" href="/m/assets/js/176.d0755bfc.js"><link rel="prefetch" href="/m/assets/js/177.8b00d874.js"><link rel="prefetch" href="/m/assets/js/178.2b0cfda8.js"><link rel="prefetch" href="/m/assets/js/179.780a3873.js"><link rel="prefetch" href="/m/assets/js/18.298da910.js"><link rel="prefetch" href="/m/assets/js/180.7c0ac3dc.js"><link rel="prefetch" href="/m/assets/js/181.507f9073.js"><link rel="prefetch" href="/m/assets/js/182.87f76d4a.js"><link rel="prefetch" href="/m/assets/js/183.1410502e.js"><link rel="prefetch" href="/m/assets/js/184.80666cb3.js"><link rel="prefetch" href="/m/assets/js/185.dc628b97.js"><link rel="prefetch" href="/m/assets/js/186.c2560a3f.js"><link rel="prefetch" href="/m/assets/js/187.6af43ea3.js"><link rel="prefetch" href="/m/assets/js/188.da75b50c.js"><link rel="prefetch" href="/m/assets/js/189.78dd960b.js"><link rel="prefetch" href="/m/assets/js/19.d9eabdf8.js"><link rel="prefetch" href="/m/assets/js/190.017586b9.js"><link rel="prefetch" href="/m/assets/js/191.5fa65eb7.js"><link rel="prefetch" href="/m/assets/js/192.5bb628c7.js"><link rel="prefetch" href="/m/assets/js/193.35707c80.js"><link rel="prefetch" href="/m/assets/js/194.35c3b13b.js"><link rel="prefetch" href="/m/assets/js/195.6dc8874b.js"><link rel="prefetch" href="/m/assets/js/196.01a1e825.js"><link rel="prefetch" href="/m/assets/js/197.5745084a.js"><link rel="prefetch" href="/m/assets/js/198.0455ca12.js"><link rel="prefetch" href="/m/assets/js/199.75129c13.js"><link rel="prefetch" href="/m/assets/js/20.ce14ddb9.js"><link rel="prefetch" href="/m/assets/js/200.a08681d0.js"><link rel="prefetch" href="/m/assets/js/201.a54018b7.js"><link rel="prefetch" href="/m/assets/js/202.2361e839.js"><link rel="prefetch" href="/m/assets/js/203.b92491ee.js"><link rel="prefetch" href="/m/assets/js/204.13742571.js"><link rel="prefetch" href="/m/assets/js/205.b066e447.js"><link rel="prefetch" href="/m/assets/js/206.e2c72f2c.js"><link rel="prefetch" href="/m/assets/js/207.09a83a9a.js"><link rel="prefetch" href="/m/assets/js/208.f4b8d71c.js"><link rel="prefetch" href="/m/assets/js/209.1a4e4d18.js"><link rel="prefetch" href="/m/assets/js/21.0dc0e0bf.js"><link rel="prefetch" href="/m/assets/js/210.9709d46f.js"><link rel="prefetch" href="/m/assets/js/211.3704916b.js"><link rel="prefetch" href="/m/assets/js/212.7c96c99f.js"><link rel="prefetch" href="/m/assets/js/213.b4aedaa1.js"><link rel="prefetch" href="/m/assets/js/214.d0b2586b.js"><link rel="prefetch" href="/m/assets/js/215.2268650a.js"><link rel="prefetch" href="/m/assets/js/216.dcaa6f2f.js"><link rel="prefetch" href="/m/assets/js/217.33aaf649.js"><link rel="prefetch" href="/m/assets/js/218.216d8592.js"><link rel="prefetch" href="/m/assets/js/219.44d35873.js"><link rel="prefetch" href="/m/assets/js/22.ce355d8a.js"><link rel="prefetch" href="/m/assets/js/220.ff06fa11.js"><link rel="prefetch" href="/m/assets/js/221.93379b76.js"><link rel="prefetch" href="/m/assets/js/222.6f0bbeea.js"><link rel="prefetch" href="/m/assets/js/223.4c5e29f0.js"><link rel="prefetch" href="/m/assets/js/224.e7be32e4.js"><link rel="prefetch" href="/m/assets/js/225.4915db8f.js"><link rel="prefetch" href="/m/assets/js/226.60f21d11.js"><link rel="prefetch" href="/m/assets/js/227.0e63cf34.js"><link rel="prefetch" href="/m/assets/js/228.e7b7a543.js"><link rel="prefetch" href="/m/assets/js/229.73bf392a.js"><link rel="prefetch" href="/m/assets/js/23.40c917ac.js"><link rel="prefetch" href="/m/assets/js/230.9f789c55.js"><link rel="prefetch" href="/m/assets/js/231.8fd85bc2.js"><link rel="prefetch" href="/m/assets/js/232.e6c4a62c.js"><link rel="prefetch" href="/m/assets/js/233.45636bf3.js"><link rel="prefetch" href="/m/assets/js/234.5194ce16.js"><link rel="prefetch" href="/m/assets/js/235.15ba019b.js"><link rel="prefetch" href="/m/assets/js/236.ac5768c1.js"><link rel="prefetch" href="/m/assets/js/237.91ec2e5a.js"><link rel="prefetch" href="/m/assets/js/238.af630344.js"><link rel="prefetch" href="/m/assets/js/239.b2b84093.js"><link rel="prefetch" href="/m/assets/js/24.5b681006.js"><link rel="prefetch" href="/m/assets/js/240.9c9b1fba.js"><link rel="prefetch" href="/m/assets/js/241.c26c2147.js"><link rel="prefetch" href="/m/assets/js/242.ce44f37f.js"><link rel="prefetch" href="/m/assets/js/243.aa04b829.js"><link rel="prefetch" href="/m/assets/js/244.ee4c9090.js"><link rel="prefetch" href="/m/assets/js/245.62ebda1d.js"><link rel="prefetch" href="/m/assets/js/246.2fd9ce22.js"><link rel="prefetch" href="/m/assets/js/247.52b3e746.js"><link rel="prefetch" href="/m/assets/js/248.2e432a32.js"><link rel="prefetch" href="/m/assets/js/249.4598fccb.js"><link rel="prefetch" href="/m/assets/js/25.d5d6ba55.js"><link rel="prefetch" href="/m/assets/js/250.7c93bc3e.js"><link rel="prefetch" href="/m/assets/js/251.4d402930.js"><link rel="prefetch" href="/m/assets/js/252.1b3fb775.js"><link rel="prefetch" href="/m/assets/js/253.01a9b4f8.js"><link rel="prefetch" href="/m/assets/js/254.29de4256.js"><link rel="prefetch" href="/m/assets/js/255.4911ce12.js"><link rel="prefetch" href="/m/assets/js/256.0a40f8d2.js"><link rel="prefetch" href="/m/assets/js/257.2111ae5e.js"><link rel="prefetch" href="/m/assets/js/258.0e9b2cd1.js"><link rel="prefetch" href="/m/assets/js/259.43158d35.js"><link rel="prefetch" href="/m/assets/js/26.b1e00e8a.js"><link rel="prefetch" href="/m/assets/js/260.72ea8c45.js"><link rel="prefetch" href="/m/assets/js/261.3f679643.js"><link rel="prefetch" href="/m/assets/js/262.d9ecaed6.js"><link rel="prefetch" href="/m/assets/js/27.556976c4.js"><link rel="prefetch" href="/m/assets/js/28.11027d56.js"><link rel="prefetch" href="/m/assets/js/29.f40ac6f5.js"><link rel="prefetch" href="/m/assets/js/3.a2a1a8e5.js"><link rel="prefetch" href="/m/assets/js/30.3b59bb10.js"><link rel="prefetch" href="/m/assets/js/31.c37142be.js"><link rel="prefetch" href="/m/assets/js/32.c5e0d2a0.js"><link rel="prefetch" href="/m/assets/js/33.4f5f3a8d.js"><link rel="prefetch" href="/m/assets/js/34.4a3a9398.js"><link rel="prefetch" href="/m/assets/js/35.77f89f97.js"><link rel="prefetch" href="/m/assets/js/36.6ea00d3c.js"><link rel="prefetch" href="/m/assets/js/37.b5a3b5b4.js"><link rel="prefetch" href="/m/assets/js/38.24b26621.js"><link rel="prefetch" href="/m/assets/js/39.ab372876.js"><link rel="prefetch" href="/m/assets/js/4.b9f14f77.js"><link rel="prefetch" href="/m/assets/js/40.7a81caac.js"><link rel="prefetch" href="/m/assets/js/41.d23cf8c8.js"><link rel="prefetch" href="/m/assets/js/42.ef938986.js"><link rel="prefetch" href="/m/assets/js/43.708a3cf3.js"><link rel="prefetch" href="/m/assets/js/44.f705f7de.js"><link rel="prefetch" href="/m/assets/js/45.0e6afdb6.js"><link rel="prefetch" href="/m/assets/js/46.9815c7cc.js"><link rel="prefetch" href="/m/assets/js/47.5d1c1dcc.js"><link rel="prefetch" href="/m/assets/js/48.d9d571a6.js"><link rel="prefetch" href="/m/assets/js/49.9cbaa1e9.js"><link rel="prefetch" href="/m/assets/js/5.57dbdc35.js"><link rel="prefetch" href="/m/assets/js/50.265f94f4.js"><link rel="prefetch" href="/m/assets/js/51.094b2e7f.js"><link rel="prefetch" href="/m/assets/js/52.8b7101c0.js"><link rel="prefetch" href="/m/assets/js/53.98f3fc0b.js"><link rel="prefetch" href="/m/assets/js/54.b3d830fd.js"><link rel="prefetch" href="/m/assets/js/55.fb9cd8c7.js"><link rel="prefetch" href="/m/assets/js/56.878cf94b.js"><link rel="prefetch" href="/m/assets/js/57.1c819831.js"><link rel="prefetch" href="/m/assets/js/58.ac3faf70.js"><link rel="prefetch" href="/m/assets/js/59.b0483bf9.js"><link rel="prefetch" href="/m/assets/js/6.a0c51186.js"><link rel="prefetch" href="/m/assets/js/60.48c301e6.js"><link rel="prefetch" href="/m/assets/js/61.4bf4f2e7.js"><link rel="prefetch" href="/m/assets/js/62.d927584b.js"><link rel="prefetch" href="/m/assets/js/63.b72a48f3.js"><link rel="prefetch" href="/m/assets/js/64.6923d7c8.js"><link rel="prefetch" href="/m/assets/js/65.042fc335.js"><link rel="prefetch" href="/m/assets/js/66.1afdb278.js"><link rel="prefetch" href="/m/assets/js/67.04f7b0c7.js"><link rel="prefetch" href="/m/assets/js/68.97789db4.js"><link rel="prefetch" href="/m/assets/js/69.d914e9f8.js"><link rel="prefetch" href="/m/assets/js/7.aef5e50f.js"><link rel="prefetch" href="/m/assets/js/70.84845956.js"><link rel="prefetch" href="/m/assets/js/71.d6e9132a.js"><link rel="prefetch" href="/m/assets/js/72.2c1f5783.js"><link rel="prefetch" href="/m/assets/js/73.789e9372.js"><link rel="prefetch" href="/m/assets/js/74.e79f4842.js"><link rel="prefetch" href="/m/assets/js/75.4a389066.js"><link rel="prefetch" href="/m/assets/js/76.f5721f28.js"><link rel="prefetch" href="/m/assets/js/77.e6ce992d.js"><link rel="prefetch" href="/m/assets/js/78.5c31237a.js"><link rel="prefetch" href="/m/assets/js/79.6a4f09e0.js"><link rel="prefetch" href="/m/assets/js/8.aac4a85a.js"><link rel="prefetch" href="/m/assets/js/80.23b925ca.js"><link rel="prefetch" href="/m/assets/js/81.bc8138cb.js"><link rel="prefetch" href="/m/assets/js/82.4783bc83.js"><link rel="prefetch" href="/m/assets/js/83.1be8f057.js"><link rel="prefetch" href="/m/assets/js/84.3132660e.js"><link rel="prefetch" href="/m/assets/js/85.95c5ab8b.js"><link rel="prefetch" href="/m/assets/js/86.17c9a201.js"><link rel="prefetch" href="/m/assets/js/87.daa0da6b.js"><link rel="prefetch" href="/m/assets/js/88.9409cacc.js"><link rel="prefetch" href="/m/assets/js/89.bf04eaa0.js"><link rel="prefetch" href="/m/assets/js/9.0dd0ff11.js"><link rel="prefetch" href="/m/assets/js/90.5e1e2630.js"><link rel="prefetch" href="/m/assets/js/91.6466b581.js"><link rel="prefetch" href="/m/assets/js/92.0dd7ffc6.js"><link rel="prefetch" href="/m/assets/js/93.045047c7.js"><link rel="prefetch" href="/m/assets/js/94.ce06dedb.js"><link rel="prefetch" href="/m/assets/js/95.f673ef28.js"><link rel="prefetch" href="/m/assets/js/96.1f73d13d.js"><link rel="prefetch" href="/m/assets/js/97.b1800fdc.js"><link rel="prefetch" href="/m/assets/js/98.245eb5e4.js"><link rel="prefetch" href="/m/assets/js/99.2cfc78a1.js">
    <link rel="stylesheet" href="/m/assets/css/0.styles.1e386fb6.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/m/" class="home-link router-link-active"><!----> <span class="site-name">嗯哼人生</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/m/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="https://cn100800.tk" target="_blank" rel="noopener noreferrer" class="nav-link external">
  主站
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="mailto:freecracy1024@gmail.com" class="nav-link external">
  mail
  <!----></a></div><div class="nav-item"><a href="https://google.com.hk" target="_blank" rel="noopener noreferrer" class="nav-link external">
  google
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/m/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="https://cn100800.tk" target="_blank" rel="noopener noreferrer" class="nav-link external">
  主站
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="mailto:freecracy1024@gmail.com" class="nav-link external">
  mail
  <!----></a></div><div class="nav-item"><a href="https://google.com.hk" target="_blank" rel="noopener noreferrer" class="nav-link external">
  google
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Go语言之旅</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/m/Go语言之旅/slice.html" class="sidebar-link">slice</a></li><li><a href="/m/Go语言之旅/0x00.开发环境.html" class="sidebar-link">0x00.开发环境</a></li><li><a href="/m/Go语言之旅/0x04.select.html" class="sidebar-link">0x04.select</a></li><li><a href="/m/Go语言之旅/0x05.编译器.html" class="sidebar-link">0x04.编译器</a></li><li><a href="/m/Go语言之旅/0x05.编译器02.html" class="sidebar-link">0x05.编译器02</a></li><li><a href="/m/Go语言之旅/0x06.数据结构.html" class="sidebar-link">0x06.数据结构</a></li><li><a href="/m/Go语言之旅/0x07.context.html" class="sidebar-link">0x07.context</a></li><li><a href="/m/Go语言之旅/0x08.性能剖析.html" class="sidebar-link">0x08.性能剖析</a></li><li><a href="/m/Go语言之旅/0x09.reflect.html" class="sidebar-link">0x09.reflect</a></li><li><a href="/m/Go语言之旅/0x12.interface.html" class="sidebar-link">0x12.interface</a></li><li><a href="/m/Go语言之旅/0x13.package.html" class="sidebar-link">0x13.package</a></li><li><a href="/m/Go语言之旅/0x14.问题集.html" class="sidebar-link">0x14.问题集</a></li><li><a href="/m/Go语言之旅/0x15.leet.html" class="sidebar-link">0x15.leet</a></li><li><a href="/m/Go语言之旅/0x16.命令行参数.html" class="sidebar-link">0x16.命令行参数</a></li><li><a href="/m/Go语言之旅/GODEBUG.html" class="sidebar-link">GODEBUG</a></li><li><a href="/m/Go语言之旅/bitmap.html" class="sidebar-link">bitmap</a></li><li><a href="/m/Go语言之旅/channel.html" class="sidebar-link">channel</a></li><li><a href="/m/Go语言之旅/defer.html" class="sidebar-link">defer</a></li><li><a href="/m/Go语言之旅/gmp模型.html" class="active sidebar-link">gmp 模型</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/m/Go语言之旅/gmp模型.html#调度器" class="sidebar-link">调度器</a></li><li class="sidebar-sub-header"><a href="/m/Go语言之旅/gmp模型.html#goroutine" class="sidebar-link">goroutine</a></li><li class="sidebar-sub-header"><a href="/m/Go语言之旅/gmp模型.html#线程自旋" class="sidebar-link">线程自旋</a></li><li class="sidebar-sub-header"><a href="/m/Go语言之旅/gmp模型.html#定义" class="sidebar-link">定义</a></li><li class="sidebar-sub-header"><a href="/m/Go语言之旅/gmp模型.html#进程-线程-协程" class="sidebar-link">进程 &amp; 线程 &amp; 协程</a></li><li class="sidebar-sub-header"><a href="/m/Go语言之旅/gmp模型.html#系统调用-库函数" class="sidebar-link">系统调用 &amp; 库函数</a></li><li class="sidebar-sub-header"><a href="/m/Go语言之旅/gmp模型.html#进程线程协程" class="sidebar-link">进程线程协程</a></li><li class="sidebar-sub-header"><a href="/m/Go语言之旅/gmp模型.html#timer-队列" class="sidebar-link">timer 队列</a></li><li class="sidebar-sub-header"><a href="/m/Go语言之旅/gmp模型.html#g-的-9-种状态" class="sidebar-link">G 的 9 种状态</a></li><li class="sidebar-sub-header"><a href="/m/Go语言之旅/gmp模型.html#引起-g-阻塞的事件" class="sidebar-link">引起 G 阻塞的事件</a></li><li class="sidebar-sub-header"><a href="/m/Go语言之旅/gmp模型.html#p-的-5-种状态" class="sidebar-link">P 的 5 种状态</a></li><li class="sidebar-sub-header"><a href="/m/Go语言之旅/gmp模型.html#调度器生命周期" class="sidebar-link">调度器生命周期</a></li><li class="sidebar-sub-header"><a href="/m/Go语言之旅/gmp模型.html#异步抢占" class="sidebar-link">异步抢占</a></li><li class="sidebar-sub-header"><a href="/m/Go语言之旅/gmp模型.html#recover-panic" class="sidebar-link">recover panic</a></li><li class="sidebar-sub-header"><a href="/m/Go语言之旅/gmp模型.html#netpoller" class="sidebar-link">netpoller</a></li><li class="sidebar-sub-header"><a href="/m/Go语言之旅/gmp模型.html#任务窃取顺序" class="sidebar-link">任务窃取顺序</a></li><li class="sidebar-sub-header"><a href="/m/Go语言之旅/gmp模型.html#g-的-9-种状态-2" class="sidebar-link">g 的 9 种状态</a></li></ul></li><li><a href="/m/Go语言之旅/make.html" class="sidebar-link">make</a></li><li><a href="/m/Go语言之旅/map.html" class="sidebar-link">map</a></li><li><a href="/m/Go语言之旅/mock.html" class="sidebar-link">mock</a></li><li><a href="/m/Go语言之旅/0x03.内存模型.html" class="sidebar-link">0x03.内存模型</a></li><li><a href="/m/Go语言之旅/tool.html" class="sidebar-link">tool</a></li><li><a href="/m/Go语言之旅/内存管理.html" class="sidebar-link">第四章 : 内存管理</a></li><li><a href="/m/Go语言之旅/协程池.html" class="sidebar-link">协程池</a></li><li><a href="/m/Go语言之旅/协程调度.html" class="sidebar-link">第三章 : 协程调度</a></li><li><a href="/m/Go语言之旅/垃圾回收.html" class="sidebar-link">垃圾回收</a></li><li><a href="/m/Go语言之旅/基础.html" class="sidebar-link">基础</a></li><li><a href="/m/Go语言之旅/工具集.html" class="sidebar-link">工具集</a></li><li><a href="/m/Go语言之旅/常用数据结构实现原理.html" class="sidebar-link">第一章 : 常用数据结构实现原理</a></li><li><a href="/m/Go语言之旅/常见控制结构实现原理.html" class="sidebar-link">第二章 : 常见控制结构实现原理</a></li><li><a href="/m/Go语言之旅/并发控制.html" class="sidebar-link">第五章 : 并发控制</a></li><li><a href="/m/Go语言之旅/思考题.html" class="sidebar-link">思考题</a></li><li><a href="/m/Go语言之旅/文件操作.html" class="sidebar-link">文件操作</a></li><li><a href="/m/Go语言之旅/框架.html" class="sidebar-link">框架</a></li><li><a href="/m/Go语言之旅/泛型.html" class="sidebar-link">泛型</a></li><li><a href="/m/Go语言之旅/版本更新.html" class="sidebar-link">版本更新</a></li><li><a href="/m/Go语言之旅/调试.html" class="sidebar-link">调试</a></li><li><a href="/m/Go语言之旅/进程线程协程.html" class="sidebar-link">进程线程协程</a></li><li><a href="/m/Go语言之旅/部署.html" class="sidebar-link">部署</a></li><li><a href="/m/Go语言之旅/闭包.html" class="sidebar-link">闭包</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>文章</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>标准库</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>源码</span> <span class="arrow right"></span></p> <!----></section></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Redis</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Deno</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>其他</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>周末闲谈</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>深度好文</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>漫步 Linux</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>算法</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>设计模式</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>鸡汤软文</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="gmp-模型"><a href="#gmp-模型" class="header-anchor">#</a> gmp 模型</h1> <h2 id="调度器"><a href="#调度器" class="header-anchor">#</a> 调度器</h2> <p>M 被创建后会在 P 空闲队列中获取 P 进行绑定,未绑定则进入阻塞状态.P 可以和多个 M 进行绑定,同一时刻只能绑定在一个 M 上. S 全局调度器, 维护 M、P 和 G 队列,负责调度.</p> <p>本地队列 : 每个 P 维护一个本地队列存放,当前与 P 绑定的 M 若生产 G 会放入本地队列,当本地队列满会拿出一半的本地队列中的 G 放入全局队列,如果当前 M 绑定的 P 没有可执行的 G 随机从 P 中拿去一半放入自己的队列.</p> <p>全局队列 : 存放本地队列溢出的 G,调度过程中有 1/61 概率检查全局队列,确保全局队列中的 G 会被执行.</p> <p>如果当前 M 执行的 G 调度 syscall 阻塞, P 会与 M 进行分离, M 负责执行阻塞的 G,P 带着队列中的 G 绑定到新的 M 中,继续执行其他 G,使得当前 G 进入阻塞也不会硬系那个 P 去执行其他 G. M 执行 G 阻塞操作返回后如果没有了 P,尝试获取新的 P 去执行,如果获取不到 P,M 就会把当前 G 放入全局队列等待调度,自己处于休眠状态.</p> <p><img src="data:image/png;base64,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" alt="GMP"></p> <h2 id="goroutine"><a href="#goroutine" class="header-anchor">#</a> goroutine</h2> <p>可以看作是用户态的线程,用户态的线程是需要自己去调度的.go 运行时 scheduler 去完成调度.</p> <h2 id="线程自旋"><a href="#线程自旋" class="header-anchor">#</a> 线程自旋</h2> <p>相对与阻塞线程变现为循环执行指定逻辑而不进入阻塞状态,在 go 调度逻辑中为了实现高并发如果全局队列和本地队列都为空绑定 P 的 M 没有 G 可执行会进入自旋状态等待新的 G,不会进入阻塞休眠状态,减少上下文切换成本.只有绑定了 P 的 M 才会进入自旋状态.最多有 GOMAXPROCS 个自旋线程,未绑定的空闲 M 会进入休眠状态.</p> <h2 id="定义"><a href="#定义" class="header-anchor">#</a> 定义</h2> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// src/runtime/HACKING.md</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">type</span> g <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	<span class="token comment">// Stack parameters.</span>
	<span class="token comment">// stack describes the actual stack memory: [stack.lo, stack.hi).</span>
	<span class="token comment">// stackguard0 is the stack pointer compared in the Go stack growth prologue.</span>
	<span class="token comment">// It is stack.lo+StackGuard normally, but can be StackPreempt to trigger a preemption.</span>
	<span class="token comment">// stackguard1 is the stack pointer compared in the C stack growth prologue.</span>
	<span class="token comment">// It is stack.lo+StackGuard on g0 and gsignal stacks.</span>
	<span class="token comment">// It is ~0 on other goroutine stacks, to trigger a call to morestackc (and crash).</span>
	stack       stack   <span class="token comment">// offset known to runtime/cgo</span>
	stackguard0 <span class="token builtin">uintptr</span> <span class="token comment">// offset known to liblink</span>
	stackguard1 <span class="token builtin">uintptr</span> <span class="token comment">// offset known to liblink</span>

	_panic         <span class="token operator">*</span>_panic <span class="token comment">// innermost panic - offset known to liblink</span>
	_defer         <span class="token operator">*</span>_defer <span class="token comment">// innermost defer</span>
	m              <span class="token operator">*</span>m      <span class="token comment">// current m; offset known to arm liblink</span>
	sched          gobuf
	syscallsp      <span class="token builtin">uintptr</span>        <span class="token comment">// if status==Gsyscall, syscallsp = sched.sp to use during gc</span>
	syscallpc      <span class="token builtin">uintptr</span>        <span class="token comment">// if status==Gsyscall, syscallpc = sched.pc to use during gc</span>
	stktopsp       <span class="token builtin">uintptr</span>        <span class="token comment">// expected sp at top of stack, to check in traceback</span>
	param          unsafe<span class="token punctuation">.</span>Pointer <span class="token comment">// passed parameter on wakeup</span>
	atomicstatus   <span class="token builtin">uint32</span>
	stackLock      <span class="token builtin">uint32</span> <span class="token comment">// sigprof/scang lock; TODO: fold in to atomicstatus</span>
	goid           <span class="token builtin">int64</span>
	schedlink      guintptr
	waitsince      <span class="token builtin">int64</span>      <span class="token comment">// approx time when the g become blocked</span>
	waitreason     waitReason <span class="token comment">// if status==Gwaiting</span>
	preempt        <span class="token builtin">bool</span>       <span class="token comment">// preemption signal, duplicates stackguard0 = stackpreempt</span>
	paniconfault   <span class="token builtin">bool</span>       <span class="token comment">// panic (instead of crash) on unexpected fault address</span>
	preemptscan    <span class="token builtin">bool</span>       <span class="token comment">// preempted g does scan for gc</span>
	gcscandone     <span class="token builtin">bool</span>       <span class="token comment">// g has scanned stack; protected by _Gscan bit in status</span>
	gcscanvalid    <span class="token builtin">bool</span>       <span class="token comment">// false at start of gc cycle, true if G has not run since last scan; TODO: remove?</span>
	throwsplit     <span class="token builtin">bool</span>       <span class="token comment">// must not split stack</span>
	raceignore     <span class="token builtin">int8</span>       <span class="token comment">// ignore race detection events</span>
	sysblocktraced <span class="token builtin">bool</span>       <span class="token comment">// StartTrace has emitted EvGoInSyscall about this goroutine</span>
	sysexitticks   <span class="token builtin">int64</span>      <span class="token comment">// cputicks when syscall has returned (for tracing)</span>
	traceseq       <span class="token builtin">uint64</span>     <span class="token comment">// trace event sequencer</span>
	tracelastp     puintptr   <span class="token comment">// last P emitted an event for this goroutine</span>
	lockedm        muintptr
	sig            <span class="token builtin">uint32</span>
	writebuf       <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span>
	sigcode0       <span class="token builtin">uintptr</span>
	sigcode1       <span class="token builtin">uintptr</span>
	sigpc          <span class="token builtin">uintptr</span>
	gopc           <span class="token builtin">uintptr</span>         <span class="token comment">// pc of go statement that created this goroutine</span>
	ancestors      <span class="token operator">*</span><span class="token punctuation">[</span><span class="token punctuation">]</span>ancestorInfo <span class="token comment">// ancestor information goroutine(s) that created this goroutine (only used if debug.tracebackancestors)</span>
	startpc        <span class="token builtin">uintptr</span>         <span class="token comment">// pc of goroutine function</span>
	racectx        <span class="token builtin">uintptr</span>
	waiting        <span class="token operator">*</span>sudog         <span class="token comment">// sudog structures this g is waiting on (that have a valid elem ptr); in lock order</span>
	cgoCtxt        <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">uintptr</span>      <span class="token comment">// cgo traceback context</span>
	labels         unsafe<span class="token punctuation">.</span>Pointer <span class="token comment">// profiler labels</span>
	timer          <span class="token operator">*</span>timer         <span class="token comment">// cached timer for time.Sleep</span>
	selectDone     <span class="token builtin">uint32</span>         <span class="token comment">// are we participating in a select and did someone win the race?</span>

	<span class="token comment">// Per-G GC state</span>

	<span class="token comment">// gcAssistBytes is this G's GC assist credit in terms of</span>
	<span class="token comment">// bytes allocated. If this is positive, then the G has credit</span>
	<span class="token comment">// to allocate gcAssistBytes bytes without assisting. If this</span>
	<span class="token comment">// is negative, then the G must correct this by performing</span>
	<span class="token comment">// scan work. We track this in bytes to make it fast to update</span>
	<span class="token comment">// and check for debt in the malloc hot path. The assist ratio</span>
	<span class="token comment">// determines how this corresponds to scan work debt.</span>
	gcAssistBytes <span class="token builtin">int64</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br></div></div><div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">type</span> m <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	g0      <span class="token operator">*</span>g     <span class="token comment">// goroutine with scheduling stack</span>
	morebuf gobuf  <span class="token comment">// gobuf arg to morestack</span>
	divmod  <span class="token builtin">uint32</span> <span class="token comment">// div/mod denominator for arm - known to liblink</span>

	<span class="token comment">// Fields not known to debuggers.</span>
	procid        <span class="token builtin">uint64</span>       <span class="token comment">// for debuggers, but offset not hard-coded</span>
	gsignal       <span class="token operator">*</span>g           <span class="token comment">// signal-handling g</span>
	goSigStack    gsignalStack <span class="token comment">// Go-allocated signal handling stack</span>
	sigmask       sigset       <span class="token comment">// storage for saved signal mask</span>
	tls           <span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token builtin">uintptr</span>   <span class="token comment">// thread-local storage (for x86 extern register)</span>
	mstartfn      <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	curg          <span class="token operator">*</span>g       <span class="token comment">// current running goroutine</span>
	caughtsig     guintptr <span class="token comment">// goroutine running during fatal signal</span>
	p             puintptr <span class="token comment">// attached p for executing go code (nil if not executing go code)</span>
	nextp         puintptr
	oldp          puintptr <span class="token comment">// the p that was attached before executing a syscall</span>
	id            <span class="token builtin">int64</span>
	mallocing     <span class="token builtin">int32</span>
	throwing      <span class="token builtin">int32</span>
	preemptoff    <span class="token builtin">string</span> <span class="token comment">// if != &quot;&quot;, keep curg running on this m</span>
	locks         <span class="token builtin">int32</span>
	dying         <span class="token builtin">int32</span>
	profilehz     <span class="token builtin">int32</span>
	spinning      <span class="token builtin">bool</span> <span class="token comment">// m is out of work and is actively looking for work</span>
	blocked       <span class="token builtin">bool</span> <span class="token comment">// m is blocked on a note</span>
	newSigstack   <span class="token builtin">bool</span> <span class="token comment">// minit on C thread called sigaltstack</span>
	printlock     <span class="token builtin">int8</span>
	incgo         <span class="token builtin">bool</span>   <span class="token comment">// m is executing a cgo call</span>
	freeWait      <span class="token builtin">uint32</span> <span class="token comment">// if == 0, safe to free g0 and delete m (atomic)</span>
	fastrand      <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token builtin">uint32</span>
	needextram    <span class="token builtin">bool</span>
	traceback     <span class="token builtin">uint8</span>
	ncgocall      <span class="token builtin">uint64</span>      <span class="token comment">// number of cgo calls in total</span>
	ncgo          <span class="token builtin">int32</span>       <span class="token comment">// number of cgo calls currently in progress</span>
	cgoCallersUse <span class="token builtin">uint32</span>      <span class="token comment">// if non-zero, cgoCallers in use temporarily</span>
	cgoCallers    <span class="token operator">*</span>cgoCallers <span class="token comment">// cgo traceback if crashing in cgo call</span>
	park          note
	alllink       <span class="token operator">*</span>m <span class="token comment">// on allm</span>
	schedlink     muintptr
	mcache        <span class="token operator">*</span>mcache
	lockedg       guintptr
	createstack   <span class="token punctuation">[</span><span class="token number">32</span><span class="token punctuation">]</span><span class="token builtin">uintptr</span> <span class="token comment">// stack that created this thread.</span>
	lockedExt     <span class="token builtin">uint32</span>      <span class="token comment">// tracking for external LockOSThread</span>
	lockedInt     <span class="token builtin">uint32</span>      <span class="token comment">// tracking for internal lockOSThread</span>
	nextwaitm     muintptr    <span class="token comment">// next m waiting for lock</span>
	waitunlockf   <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token operator">*</span>g<span class="token punctuation">,</span> unsafe<span class="token punctuation">.</span>Pointer<span class="token punctuation">)</span> <span class="token builtin">bool</span>
	waitlock      unsafe<span class="token punctuation">.</span>Pointer
	waittraceev   <span class="token builtin">byte</span>
	waittraceskip <span class="token builtin">int</span>
	startingtrace <span class="token builtin">bool</span>
	syscalltick   <span class="token builtin">uint32</span>
	thread        <span class="token builtin">uintptr</span> <span class="token comment">// thread handle</span>
	freelink      <span class="token operator">*</span>m      <span class="token comment">// on sched.freem</span>

	<span class="token comment">// these are here because they are too large to be on the stack</span>
	<span class="token comment">// of low-level NOSPLIT functions.</span>
	libcall   libcall
	libcallpc <span class="token builtin">uintptr</span> <span class="token comment">// for cpu profiler</span>
	libcallsp <span class="token builtin">uintptr</span>
	libcallg  guintptr
	syscall   libcall <span class="token comment">// stores syscall parameters on windows</span>

	vdsoSP <span class="token builtin">uintptr</span> <span class="token comment">// SP for traceback while in VDSO call (0 if not in call)</span>
	vdsoPC <span class="token builtin">uintptr</span> <span class="token comment">// PC for traceback while in VDSO call</span>

	dlogPerM

	mOS
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br></div></div><div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">type</span> p <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	id          <span class="token builtin">int32</span>
	status      <span class="token builtin">uint32</span> <span class="token comment">// one of pidle/prunning/...</span>
	link        puintptr
	schedtick   <span class="token builtin">uint32</span>     <span class="token comment">// incremented on every scheduler call</span>
	syscalltick <span class="token builtin">uint32</span>     <span class="token comment">// incremented on every system call</span>
	sysmontick  sysmontick <span class="token comment">// last tick observed by sysmon</span>
	m           muintptr   <span class="token comment">// back-link to associated m (nil if idle)</span>
	mcache      <span class="token operator">*</span>mcache
	raceprocctx <span class="token builtin">uintptr</span>

	deferpool    <span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>_defer <span class="token comment">// pool of available defer structs of different sizes (see panic.go)</span>
	deferpoolbuf <span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">32</span><span class="token punctuation">]</span><span class="token operator">*</span>_defer

	<span class="token comment">// Cache of goroutine ids, amortizes accesses to runtime·sched.goidgen.</span>
	goidcache    <span class="token builtin">uint64</span>
	goidcacheend <span class="token builtin">uint64</span>

	<span class="token comment">// Queue of runnable goroutines. Accessed without lock.</span>
	runqhead <span class="token builtin">uint32</span>
	runqtail <span class="token builtin">uint32</span>
	runq     <span class="token punctuation">[</span><span class="token number">256</span><span class="token punctuation">]</span>guintptr
	<span class="token comment">// runnext, if non-nil, is a runnable G that was ready'd by</span>
	<span class="token comment">// the current G and should be run next instead of what's in</span>
	<span class="token comment">// runq if there's time remaining in the running G's time</span>
	<span class="token comment">// slice. It will inherit the time left in the current time</span>
	<span class="token comment">// slice. If a set of goroutines is locked in a</span>
	<span class="token comment">// communicate-and-wait pattern, this schedules that set as a</span>
	<span class="token comment">// unit and eliminates the (potentially large) scheduling</span>
	<span class="token comment">// latency that otherwise arises from adding the ready'd</span>
	<span class="token comment">// goroutines to the end of the run queue.</span>
	runnext guintptr

	<span class="token comment">// Available G's (status == Gdead)</span>
	gFree <span class="token keyword">struct</span> <span class="token punctuation">{</span>
		gList
		n <span class="token builtin">int32</span>
	<span class="token punctuation">}</span>

	sudogcache <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>sudog
	sudogbuf   <span class="token punctuation">[</span><span class="token number">128</span><span class="token punctuation">]</span><span class="token operator">*</span>sudog

	tracebuf traceBufPtr

	<span class="token comment">// traceSweep indicates the sweep events should be traced.</span>
	<span class="token comment">// This is used to defer the sweep start event until a span</span>
	<span class="token comment">// has actually been swept.</span>
	traceSweep <span class="token builtin">bool</span>
	<span class="token comment">// traceSwept and traceReclaimed track the number of bytes</span>
	<span class="token comment">// swept and reclaimed by sweeping in the current sweep loop.</span>
	traceSwept<span class="token punctuation">,</span> traceReclaimed <span class="token builtin">uintptr</span>

	palloc persistentAlloc <span class="token comment">// per-P to avoid mutex</span>

	<span class="token boolean">_</span> <span class="token builtin">uint32</span> <span class="token comment">// Alignment for atomic fields below</span>

	<span class="token comment">// Per-P GC state</span>
	gcAssistTime         <span class="token builtin">int64</span>    <span class="token comment">// Nanoseconds in assistAlloc</span>
	gcFractionalMarkTime <span class="token builtin">int64</span>    <span class="token comment">// Nanoseconds in fractional mark worker (atomic)</span>
	gcBgMarkWorker       guintptr <span class="token comment">// (atomic)</span>
	gcMarkWorkerMode     gcMarkWorkerMode

	<span class="token comment">// gcMarkWorkerStartTime is the nanotime() at which this mark</span>
	<span class="token comment">// worker started.</span>
	gcMarkWorkerStartTime <span class="token builtin">int64</span>

	<span class="token comment">// gcw is this P's GC work buffer cache. The work buffer is</span>
	<span class="token comment">// filled by write barriers, drained by mutator assists, and</span>
	<span class="token comment">// disposed on certain GC state transitions.</span>
	gcw gcWork

	<span class="token comment">// wbBuf is this P's GC write barrier buffer.</span>
	<span class="token comment">//</span>
	<span class="token comment">// TODO: Consider caching this in the running G.</span>
	wbBuf wbBuf

	runSafePointFn <span class="token builtin">uint32</span> <span class="token comment">// if 1, run sched.safePointFn at next safe point</span>

	pad cpu<span class="token punctuation">.</span>CacheLinePad
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br></div></div><h3 id="抢占式调度"><a href="#抢占式调度" class="header-anchor">#</a> 抢占式调度</h3> <div class="language-go line-numbers-mode"><pre class="language-go"><code>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="进程-线程-协程"><a href="#进程-线程-协程" class="header-anchor">#</a> 进程 &amp; 线程 &amp; 协程</h2> <table><thead><tr><th></th> <th>goroutine</th> <th>线程</th> <th>进程</th></tr></thead> <tbody><tr><td>内存占用</td> <td>栈内存消耗 2kb,栈空间不够才扩容,http server 一个请求一个 goroutine 开销更小</td> <td>需要 1M 的栈内存,还需要 a guard page 和其他线程栈空间隔离</td> <td></td></tr> <tr><td>创建和销毁</td> <td>用户级别,只需要一个结构体</td> <td>内核级别需要和操作系统打交道,通常用线程池解决</td> <td></td></tr> <tr><td>切换</td> <td>只需要保存三个寄存器(PC、BP、SP),约 200ns</td> <td>需要保存各种寄存器,约 1000-1500 纳秒</td> <td></td></tr></tbody></table> <h3 id="线程创建销毁切换"><a href="#线程创建销毁切换" class="header-anchor">#</a> 线程创建销毁切换</h3> <h3 id="goroutine-创建销毁切换"><a href="#goroutine-创建销毁切换" class="header-anchor">#</a> goroutine 创建销毁切换</h3> <h2 id="系统调用-库函数"><a href="#系统调用-库函数" class="header-anchor">#</a> 系统调用 &amp; 库函数</h2> <p>系统调用是操作系统为用提供的一系列接口,这些接口提供了系统对硬件设备的操作,库函数是对系统调用的一层封装,库函数可以包含一个系统调用,有可能有好几个系统调用,也可以没有(不涉及内核操作),库函数运行在用户态.</p> <p>使用 ltrace 查看 SYS_开头的都是系统调用</p> <p>write 函数是将数据写入系统缓存区</p> <p>fsync 函数强制将缓存区数据写入磁盘</p> <h3 id="go-语言中的系统调用"><a href="#go-语言中的系统调用" class="header-anchor">#</a> go 语言中的系统调用</h3> <p>尽管 go 提供 cgo 方便调用 C 函数,但还是自己对系统调用进行了封装,</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// syscall.go</span>
Syscall     <span class="token comment">// 参数不超过 4 个的系统调用</span>
Syscall6    <span class="token comment">// 参数不超过 6 个的系统调用</span>
RawSyscall <span class="token comment">// 区别在与有没有 runtime</span>
RawSyscall6
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h2 id="进程线程协程"><a href="#进程线程协程" class="header-anchor">#</a> 进程线程协程</h2> <p>创建、调度、销毁</p> <h3 id="进程"><a href="#进程" class="header-anchor">#</a> 进程</h3> <p>资源管理最小单元.<code>size</code>命令可以查看编译后程序各个区域的大小.</p> <p><img src="/m/assets/img/process.20a41f34.png" alt="process"></p> <h3 id="线程"><a href="#线程" class="header-anchor">#</a> 线程</h3> <p>运行调度的最小单元,线程被包含在进程中,是实际运行单元,多线程共享进程中全部系统资源.但线程有自己的调用栈、寄存器、线程本地存储,线程创建开销是堆栈的建立、分配内存、上下文切换(最大开销)</p> <p>线程并没有特定数据结构,只有<code>task</code>这一个描述进程的结构体,内核只有进程没有线程,线程调度当作进程调度,线程其实是和其他进程共享资源的轻量级进程.</p> <p>只有一个执行上下文和调度程序的统计信息与父进程共享进程地址空间.</p> <p>线程分用户级线程和内核级线程.</p> <p>用户线程的创建、调度、同步、销毁都由用户空间库函数完成不需要内核参与,此线程资源消耗低.</p> <ol><li>用户线程只能参与该进程处理器资源、不能参与全局处理器资源</li> <li>用户线程开销低</li> <li>内核并不知道用户线程的存在</li> <li>如果引起阻塞调用,会立即阻塞该线程所属的整个进程.</li> <li>只有一个处理器分配给该进程,不能发挥多核优势.</li></ol> <p>内核线程建立和销毁都是操作系统负责,通过系统调用完成.内核维护进程和线程上下文信息和内存切换.</p> <ol><li>参与全局资源分配,可以利用多核优势</li> <li>被内核调度,创建、销毁、调度都由内核管理</li> <li>内核线程阻塞时同一个进程中的线程仍能继续运行</li> <li>线程调度开销大,几乎和进程差不多</li> <li>线程表放在操作系统固定表空间或堆栈空间,内核线程数量是有限的</li></ol> <h3 id="协程"><a href="#协程" class="header-anchor">#</a> 协程</h3> <p>io 密集型服务瓶颈不在 cpu 执行速度,而在尽可能快速完成高并发多连接下数据读写.</p> <ol><li>多进程 : 频繁调度切换、资源不共享(需要额外引入进程通信机制)</li> <li>多线程 : 高并发场景下大量 io 等待导致频繁挂起和切换、共享资源存在竞争问题</li></ol> <p>线程调度 : 需要保存用户线程状态到内存,恢复另一个线程的状态到寄存器,然后更新调度器数据结构,需要用户态和内核态切换</p> <p>协程调度 : 完全用户控制、自己的寄存器上下文和栈,调度时将寄存器上下文和栈保存到其他地方,切换回来时恢复先前保存到寄存器上下文和栈直接操作用户空间栈,没有内核切换开销.</p> <h3 id="进程调度"><a href="#进程调度" class="header-anchor">#</a> 进程调度</h3> <h3 id="线程调度"><a href="#线程调度" class="header-anchor">#</a> 线程调度</h3> <h2 id="timer-队列"><a href="#timer-队列" class="header-anchor">#</a> timer 队列</h2> <p>创建 timer 会自动生成 goroutine 放入 timer 队列,每一轮调度都会检计时器队列是否就绪,如果有会将其排入本地队列根据本地队列大小会有延迟,引入异步抢占,goroutine 运行 10 ms 后会被抢占,减少延迟,一个 p 上创建计时器太多会拖累处理器,当前 p 繁忙时可以由另一个 p 运行计时器.异步抢占和工作窃取出现延迟可能性很小.</p> <h2 id="g-的-9-种状态"><a href="#g-的-9-种状态" class="header-anchor">#</a> G 的 9 种状态</h2> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// runtime/runtime2.go</span>
<span class="token comment">// defined constants</span>
<span class="token keyword">const</span> <span class="token punctuation">(</span>
	<span class="token comment">// G status</span>
	<span class="token comment">//</span>
	<span class="token comment">// Beyond indicating the general state of a G, the G status</span>
	<span class="token comment">// acts like a lock on the goroutine's stack (and hence its</span>
	<span class="token comment">// ability to execute user code).</span>
	<span class="token comment">//</span>
	<span class="token comment">// If you add to this list, add to the list</span>
	<span class="token comment">// of &quot;okay during garbage collection&quot; status</span>
	<span class="token comment">// in mgcmark.go too.</span>
	<span class="token comment">//</span>
	<span class="token comment">// TODO(austin): The _Gscan bit could be much lighter-weight.</span>
	<span class="token comment">// For example, we could choose not to run _Gscanrunnable</span>
	<span class="token comment">// goroutines found in the run queue, rather than CAS-looping</span>
	<span class="token comment">// until they become _Grunnable. And transitions like</span>
	<span class="token comment">// _Gscanwaiting -&gt; _Gscanrunnable are actually okay because</span>
	<span class="token comment">// they don't affect stack ownership.</span>

	<span class="token comment">// _Gidle means this goroutine was just allocated and has not</span>
	<span class="token comment">// yet been initialized.</span>
	_Gidle <span class="token operator">=</span> <span class="token boolean">iota</span> <span class="token comment">// 0</span>

	<span class="token comment">// _Grunnable means this goroutine is on a run queue. It is</span>
	<span class="token comment">// not currently executing user code. The stack is not owned.</span>
	_Grunnable <span class="token comment">// 1</span>

	<span class="token comment">// _Grunning means this goroutine may execute user code. The</span>
	<span class="token comment">// stack is owned by this goroutine. It is not on a run queue.</span>
	<span class="token comment">// It is assigned an M and a P (g.m and g.m.p are valid).</span>
	_Grunning <span class="token comment">// 2</span>

	<span class="token comment">// _Gsyscall means this goroutine is executing a system call.</span>
	<span class="token comment">// It is not executing user code. The stack is owned by this</span>
	<span class="token comment">// goroutine. It is not on a run queue. It is assigned an M.</span>
	_Gsyscall <span class="token comment">// 3</span>

	<span class="token comment">// _Gwaiting means this goroutine is blocked in the runtime.</span>
	<span class="token comment">// It is not executing user code. It is not on a run queue,</span>
	<span class="token comment">// but should be recorded somewhere (e.g., a channel wait</span>
	<span class="token comment">// queue) so it can be ready()d when necessary. The stack is</span>
	<span class="token comment">// not owned *except* that a channel operation may read or</span>
	<span class="token comment">// write parts of the stack under the appropriate channel</span>
	<span class="token comment">// lock. Otherwise, it is not safe to access the stack after a</span>
	<span class="token comment">// goroutine enters _Gwaiting (e.g., it may get moved).</span>
	_Gwaiting <span class="token comment">// 4</span>

	<span class="token comment">// _Gmoribund_unused is currently unused, but hardcoded in gdb</span>
	<span class="token comment">// scripts.</span>
	_Gmoribund_unused <span class="token comment">// 5</span>

	<span class="token comment">// _Gdead means this goroutine is currently unused. It may be</span>
	<span class="token comment">// just exited, on a free list, or just being initialized. It</span>
	<span class="token comment">// is not executing user code. It may or may not have a stack</span>
	<span class="token comment">// allocated. The G and its stack (if any) are owned by the M</span>
	<span class="token comment">// that is exiting the G or that obtained the G from the free</span>
	<span class="token comment">// list.</span>
	_Gdead <span class="token comment">// 6</span>

	<span class="token comment">// _Genqueue_unused is currently unused.</span>
	_Genqueue_unused <span class="token comment">// 7</span>

	<span class="token comment">// _Gcopystack means this goroutine's stack is being moved. It</span>
	<span class="token comment">// is not executing user code and is not on a run queue. The</span>
	<span class="token comment">// stack is owned by the goroutine that put it in _Gcopystack.</span>
	_Gcopystack <span class="token comment">// 8</span>

	<span class="token comment">// _Gpreempted means this goroutine stopped itself for a</span>
	<span class="token comment">// suspendG preemption. It is like _Gwaiting, but nothing is</span>
	<span class="token comment">// yet responsible for ready()ing it. Some suspendG must CAS</span>
	<span class="token comment">// the status to _Gwaiting to take responsibility for</span>
	<span class="token comment">// ready()ing this G.</span>
	_Gpreempted <span class="token comment">// 9</span>

	<span class="token comment">// _Gscan combined with one of the above states other than</span>
	<span class="token comment">// _Grunning indicates that GC is scanning the stack. The</span>
	<span class="token comment">// goroutine is not executing user code and the stack is owned</span>
	<span class="token comment">// by the goroutine that set the _Gscan bit.</span>
	<span class="token comment">//</span>
	<span class="token comment">// _Gscanrunning is different: it is used to briefly block</span>
	<span class="token comment">// state transitions while GC signals the G to scan its own</span>
	<span class="token comment">// stack. This is otherwise like _Grunning.</span>
	<span class="token comment">//</span>
	<span class="token comment">// atomicstatus&amp;~Gscan gives the state the goroutine will</span>
	<span class="token comment">// return to when the scan completes.</span>
	_Gscan          <span class="token operator">=</span> <span class="token number">0x1000</span>
	_Gscanrunnable  <span class="token operator">=</span> _Gscan <span class="token operator">+</span> _Grunnable  <span class="token comment">// 0x1001</span>
	_Gscanrunning   <span class="token operator">=</span> _Gscan <span class="token operator">+</span> _Grunning   <span class="token comment">// 0x1002</span>
	_Gscansyscall   <span class="token operator">=</span> _Gscan <span class="token operator">+</span> _Gsyscall   <span class="token comment">// 0x1003</span>
	_Gscanwaiting   <span class="token operator">=</span> _Gscan <span class="token operator">+</span> _Gwaiting   <span class="token comment">// 0x1004</span>
	_Gscanpreempted <span class="token operator">=</span> _Gscan <span class="token operator">+</span> _Gpreempted <span class="token comment">// 0x1009</span>
<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br></div></div><h2 id="引起-g-阻塞的事件"><a href="#引起-g-阻塞的事件" class="header-anchor">#</a> 引起 G 阻塞的事件</h2> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">const</span> <span class="token punctuation">(</span>
	waitReasonZero                  waitReason <span class="token operator">=</span> <span class="token boolean">iota</span> <span class="token comment">// &quot;&quot;</span>
	waitReasonGCAssistMarking                         <span class="token comment">// &quot;GC assist marking&quot;</span>
	waitReasonIOWait                                  <span class="token comment">// &quot;IO wait&quot;</span>
	waitReasonChanReceiveNilChan                      <span class="token comment">// &quot;chan receive (nil chan)&quot;</span>
	waitReasonChanSendNilChan                         <span class="token comment">// &quot;chan send (nil chan)&quot;</span>
	waitReasonDumpingHeap                             <span class="token comment">// &quot;dumping heap&quot;</span>
	waitReasonGarbageCollection                       <span class="token comment">// &quot;garbage collection&quot;</span>
	waitReasonGarbageCollectionScan                   <span class="token comment">// &quot;garbage collection scan&quot;</span>
	waitReasonPanicWait                               <span class="token comment">// &quot;panicwait&quot;</span>
	waitReasonSelect                                  <span class="token comment">// &quot;select&quot;</span>
	waitReasonSelectNoCases                           <span class="token comment">// &quot;select (no cases)&quot;</span>
	waitReasonGCAssistWait                            <span class="token comment">// &quot;GC assist wait&quot;</span>
	waitReasonGCSweepWait                             <span class="token comment">// &quot;GC sweep wait&quot;</span>
	waitReasonGCScavengeWait                          <span class="token comment">// &quot;GC scavenge wait&quot;</span>
	waitReasonChanReceive                             <span class="token comment">// &quot;chan receive&quot;</span>
	waitReasonChanSend                                <span class="token comment">// &quot;chan send&quot;</span>
	waitReasonFinalizerWait                           <span class="token comment">// &quot;finalizer wait&quot;</span>
	waitReasonForceGGIdle                             <span class="token comment">// &quot;force gc (idle)&quot;</span>
	waitReasonSemacquire                              <span class="token comment">// &quot;semacquire&quot;</span>
	waitReasonSleep                                   <span class="token comment">// &quot;sleep&quot;</span>
	waitReasonSyncCondWait                            <span class="token comment">// &quot;sync.Cond.Wait&quot;</span>
	waitReasonTimerGoroutineIdle                      <span class="token comment">// &quot;timer goroutine (idle)&quot;</span>
	waitReasonTraceReaderBlocked                      <span class="token comment">// &quot;trace reader (blocked)&quot;</span>
	waitReasonWaitForGCCycle                          <span class="token comment">// &quot;wait for GC cycle&quot;</span>
	waitReasonGCWorkerIdle                            <span class="token comment">// &quot;GC worker (idle)&quot;</span>
	waitReasonPreempted                               <span class="token comment">// &quot;preempted&quot;</span>
<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><h2 id="p-的-5-种状态"><a href="#p-的-5-种状态" class="header-anchor">#</a> P 的 5 种状态</h2> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">const</span> <span class="token punctuation">(</span>
	<span class="token comment">// P status</span>

	<span class="token comment">// _Pidle means a P is not being used to run user code or the</span>
	<span class="token comment">// scheduler. Typically, it's on the idle P list and available</span>
	<span class="token comment">// to the scheduler, but it may just be transitioning between</span>
	<span class="token comment">// other states.</span>
	<span class="token comment">//</span>
	<span class="token comment">// The P is owned by the idle list or by whatever is</span>
	<span class="token comment">// transitioning its state. Its run queue is empty.</span>
	_Pidle <span class="token operator">=</span> <span class="token boolean">iota</span>

	<span class="token comment">// _Prunning means a P is owned by an M and is being used to</span>
	<span class="token comment">// run user code or the scheduler. Only the M that owns this P</span>
	<span class="token comment">// is allowed to change the P's status from _Prunning. The M</span>
	<span class="token comment">// may transition the P to _Pidle (if it has no more work to</span>
	<span class="token comment">// do), _Psyscall (when entering a syscall), or _Pgcstop (to</span>
	<span class="token comment">// halt for the GC). The M may also hand ownership of the P</span>
	<span class="token comment">// off directly to another M (e.g., to schedule a locked G).</span>
	_Prunning

	<span class="token comment">// _Psyscall means a P is not running user code. It has</span>
	<span class="token comment">// affinity to an M in a syscall but is not owned by it and</span>
	<span class="token comment">// may be stolen by another M. This is similar to _Pidle but</span>
	<span class="token comment">// uses lightweight transitions and maintains M affinity.</span>
	<span class="token comment">//</span>
	<span class="token comment">// Leaving _Psyscall must be done with a CAS, either to steal</span>
	<span class="token comment">// or retake the P. Note that there's an ABA hazard: even if</span>
	<span class="token comment">// an M successfully CASes its original P back to _Prunning</span>
	<span class="token comment">// after a syscall, it must understand the P may have been</span>
	<span class="token comment">// used by another M in the interim.</span>
	_Psyscall

	<span class="token comment">// _Pgcstop means a P is halted for STW and owned by the M</span>
	<span class="token comment">// that stopped the world. The M that stopped the world</span>
	<span class="token comment">// continues to use its P, even in _Pgcstop. Transitioning</span>
	<span class="token comment">// from _Prunning to _Pgcstop causes an M to release its P and</span>
	<span class="token comment">// park.</span>
	<span class="token comment">//</span>
	<span class="token comment">// The P retains its run queue and startTheWorld will restart</span>
	<span class="token comment">// the scheduler on Ps with non-empty run queues.</span>
	_Pgcstop

	<span class="token comment">// _Pdead means a P is no longer used (GOMAXPROCS shrank). We</span>
	<span class="token comment">// reuse Ps if GOMAXPROCS increases. A dead P is mostly</span>
	<span class="token comment">// stripped of its resources, though a few things remain</span>
	<span class="token comment">// (e.g., trace buffers).</span>
	_Pdead
<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br></div></div><h2 id="调度器生命周期"><a href="#调度器生命周期" class="header-anchor">#</a> 调度器生命周期</h2> <p><img src="/m/assets/img/go-diaoduqi.8e5fb71a.png" alt="go-diaoduqi"></p> <ol><li>runtime 创建最初的线程 m0 和 goroutine g0,并把两者关联</li> <li>调度器初始化 : 初始化 m0、栈、垃圾回收以及创建由 GOMAXPROCS 个 P 构成的 P 列表</li> <li>runtime.main 会调用 main.main 程序启动会为 runtime.main 创建 goroutine 称为 main goroutine, 然后 main goroutine 加入 p 的本地队列</li> <li>启动 m0, m0 已绑定到 P ,会从 P 的本地队列获取 G,获取到 main goroutine</li> <li>G 拥有栈, M 根据 G 中的栈信息和调度信息设置运行环境</li> <li>M 运行 G</li> <li>G 退出, M 再去获取可运行的 G,直到 main.main 退出, runtime.main 执行 defer 和 panic 处理或调用 runtime.exit 退出</li></ol> <h3 id="可视化调度周期"><a href="#可视化调度周期" class="header-anchor">#</a> 可视化调度周期</h3> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// go run main.go &amp;&amp; go tool trace trace.out</span>
<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	f<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> os<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token string">&quot;trace.out&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> f<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	trace<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span>
	<span class="token keyword">defer</span> trace<span class="token punctuation">.</span><span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;hello world&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="切换时保存上下文"><a href="#切换时保存上下文" class="header-anchor">#</a> 切换时保存上下文</h3> <h3 id="重新调度时恢复上下文"><a href="#重新调度时恢复上下文" class="header-anchor">#</a> 重新调度时恢复上下文</h3> <h2 id="异步抢占"><a href="#异步抢占" class="header-anchor">#</a> 异步抢占</h2> <p>基于时间条件触发异步抢占当 goroutine 运行超过 10 毫秒,go 会尝试抢占它抢占是由线程 sysmon 发起的该线程用于监视运行时之后的长期运行的 goroutine,一旦检测到 goroutine 运行时间超过 10 毫秒就会向当前线程发出信号以抢占该线程.信号处理程序接收到消息线程就会中断不再处理当前 goroutine,调度了 gsignal 来管理传入到信号由于它发现这是个抢占指令,会执行停止当强 goroutine 的指令.go 将在程序计数器中推送一条指令,以使其看起来像正在运行的函数,此函数将暂存 goroutine ,并将其交给运行另一个 goroutine 调度程序.go 不能在任何地方停止该程序.</p> <ol><li>抢占阻塞在系统调用上的 P</li> <li>抢占运行时间长的 G</li></ol> <p>满足以上场景,就会发送信号给 M, M 收到信号休眠正在阻塞的 goroutine 调用绑定的信号方法,进行重新调度.</p> <h2 id="recover-panic"><a href="#recover-panic" class="header-anchor">#</a> recover panic</h2> <p>goroutine 没有父子关系,不能在一个 goroutine 中 recover 另一个 goroutine 重点 panic.协程没有上下级关系,没有跨协程的异常捕获机制.</p> <h2 id="netpoller"><a href="#netpoller" class="header-anchor">#</a> netpoller</h2> <p>当 goroutine 执行网络 IO 或者可以异步完成的系统调用时,会使用 netpoller 将多个单独的同步转换成一个单独的等待, goroutine 没有真正阻塞的系统调用,而是像等待 channel 就绪那样进入休眠状态等地网络套接字.</p> <ol><li>悲观方式 : 应用于预计会很慢的系统调用,运行时在系统调用前主动释放 p,之后再尝试将 p 找回来,如果无法获取则放入全局队列</li> <li>乐观方式 : 应用于预计会很快的系统调用,不会释放 p,会设置一个特殊的 p 的状态标识并继续系统调用. sysmon goroutine 定期执行并寻找设置了这个系统调用中状态时间最长的 p,并将 p 从系统调用的 goroutine 那偷走,当系统调用返回,运行时代码检查 p 是否被偷走,如果没有则继续执行,如果 p 被偷走,会尝试获取其它 p,如果失败放入全局队列</li></ol> <p>每个本地队列都有最大容量,为 256,在容量满了之后,任意新创建的 g 都会被放置到全局队列.仅在本地队列满了之后才会加入全局队列,也会在往调度器中批量注入时加入,如网络轮询器或垃圾回收期间等待的 goroutine.</p> <h2 id="任务窃取顺序"><a href="#任务窃取顺序" class="header-anchor">#</a> 任务窃取顺序</h2> <ol><li>本地队列</li> <li>全局队列</li> <li>网络轮询器</li> <li>其它 p 的本地队列(从其它处理器获取一半)</li></ol> <h2 id="g-的-9-种状态-2"><a href="#g-的-9-种状态-2" class="header-anchor">#</a> g 的 9 种状态</h2> <ul><li><code>_Gidle</code> : 刚刚被分配,还没有进行初始化.</li> <li><code>_Grunnable</code> : 已经在运行队列中,还没有执行用户代码.</li> <li><code>_Grunning</code> : 不在运行队列里中,已经可以执行用户代码,此时已经分配了 M 和 P.</li> <li><code>_Gsyscall</code> : 正在执行系统调用,此时分配了 M.</li> <li><code>_Gwaiting</code> : 在运行时被阻止,没有执行用户代码,也不在运行队列中,此时它正在某处阻塞等待中.</li> <li><code>_Gmoribund_unused</code> : 尚未使用,但是在 gdb 中进行了硬编码.</li> <li><code>_Gdead</code> : 尚未使用,这个状态可能是刚退出或是刚被初始化,此时它并没有执行用户代码，有可能有也有可能没有分配堆栈.</li> <li><code>_Genqueue_unused</code> : 尚未使用.</li> <li><code>_Gcopystack</code> : 正在复制堆栈,并没有执行用户代码,也不在运行队列中.</li></ul></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">最后更新:</span> <span class="time">8/21/2021, 11:03:37 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/m/Go语言之旅/defer.html" class="prev">
        defer
      </a></span> <span class="next"><a href="/m/Go语言之旅/make.html">
        make
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/m/assets/js/app.71fdaff2.js" defer></script><script src="/m/assets/js/2.351ead77.js" defer></script><script src="/m/assets/js/12.c3dadd73.js" defer></script>
  </body>
</html>
