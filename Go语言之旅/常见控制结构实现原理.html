<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>第二章 : 常见控制结构实现原理 | 嗯哼人生</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="">
    <meta name="referrer" content="no-referrer">
    
    <link rel="preload" href="/m/assets/css/0.styles.1e386fb6.css" as="style"><link rel="preload" href="/m/assets/js/app.71fdaff2.js" as="script"><link rel="preload" href="/m/assets/js/2.351ead77.js" as="script"><link rel="preload" href="/m/assets/js/24.5b681006.js" as="script"><link rel="prefetch" href="/m/assets/js/10.98c1e7e0.js"><link rel="prefetch" href="/m/assets/js/100.d7774ae1.js"><link rel="prefetch" href="/m/assets/js/101.0d4dea0d.js"><link rel="prefetch" href="/m/assets/js/102.6867f859.js"><link rel="prefetch" href="/m/assets/js/103.9d24bd08.js"><link rel="prefetch" href="/m/assets/js/104.4d59f256.js"><link rel="prefetch" href="/m/assets/js/105.ff49af8e.js"><link rel="prefetch" href="/m/assets/js/106.b26c7611.js"><link rel="prefetch" href="/m/assets/js/107.da5be320.js"><link rel="prefetch" href="/m/assets/js/108.0c03f842.js"><link rel="prefetch" href="/m/assets/js/109.5587de24.js"><link rel="prefetch" href="/m/assets/js/11.4e6d88d4.js"><link rel="prefetch" href="/m/assets/js/110.40ae6022.js"><link rel="prefetch" href="/m/assets/js/111.0353ccf3.js"><link rel="prefetch" href="/m/assets/js/112.f562c096.js"><link rel="prefetch" href="/m/assets/js/113.7926c003.js"><link rel="prefetch" href="/m/assets/js/114.356035f0.js"><link rel="prefetch" href="/m/assets/js/115.15e5e23e.js"><link rel="prefetch" href="/m/assets/js/116.2db2b1ed.js"><link rel="prefetch" href="/m/assets/js/117.2658e42c.js"><link rel="prefetch" href="/m/assets/js/118.037a8503.js"><link rel="prefetch" href="/m/assets/js/119.21153540.js"><link rel="prefetch" href="/m/assets/js/12.c3dadd73.js"><link rel="prefetch" href="/m/assets/js/120.b8f0644f.js"><link rel="prefetch" href="/m/assets/js/121.4c1c263a.js"><link rel="prefetch" href="/m/assets/js/122.d6ba18dd.js"><link rel="prefetch" href="/m/assets/js/123.ceef4883.js"><link rel="prefetch" href="/m/assets/js/124.9e5f50ca.js"><link rel="prefetch" href="/m/assets/js/125.de1ddc80.js"><link rel="prefetch" href="/m/assets/js/126.ae350aea.js"><link rel="prefetch" href="/m/assets/js/127.4636f6be.js"><link rel="prefetch" href="/m/assets/js/128.13b379ab.js"><link rel="prefetch" href="/m/assets/js/129.e7b0a15f.js"><link rel="prefetch" href="/m/assets/js/13.a52bd89b.js"><link rel="prefetch" href="/m/assets/js/130.147cdf11.js"><link rel="prefetch" href="/m/assets/js/131.c7a07871.js"><link rel="prefetch" href="/m/assets/js/132.faf72eb9.js"><link rel="prefetch" href="/m/assets/js/133.6301923b.js"><link rel="prefetch" href="/m/assets/js/134.4357c6e4.js"><link rel="prefetch" href="/m/assets/js/135.0ea43a3d.js"><link rel="prefetch" href="/m/assets/js/136.5a7c2377.js"><link rel="prefetch" href="/m/assets/js/137.393c998e.js"><link rel="prefetch" href="/m/assets/js/138.dcf958b6.js"><link rel="prefetch" href="/m/assets/js/139.1ccac68b.js"><link rel="prefetch" href="/m/assets/js/14.96fff293.js"><link rel="prefetch" href="/m/assets/js/140.938c314e.js"><link rel="prefetch" href="/m/assets/js/141.03cc2137.js"><link rel="prefetch" href="/m/assets/js/142.db00aba9.js"><link rel="prefetch" href="/m/assets/js/143.6d7b22af.js"><link rel="prefetch" href="/m/assets/js/144.850ed5a9.js"><link rel="prefetch" href="/m/assets/js/145.a1958a5f.js"><link rel="prefetch" href="/m/assets/js/146.1b350d4f.js"><link rel="prefetch" href="/m/assets/js/147.961f3ccd.js"><link rel="prefetch" href="/m/assets/js/148.cb4f8811.js"><link rel="prefetch" href="/m/assets/js/149.45ad7c2c.js"><link rel="prefetch" href="/m/assets/js/15.c507965f.js"><link rel="prefetch" href="/m/assets/js/150.5d952b70.js"><link rel="prefetch" href="/m/assets/js/151.5c794bb0.js"><link rel="prefetch" href="/m/assets/js/152.974e657e.js"><link rel="prefetch" href="/m/assets/js/153.b7cf98f6.js"><link rel="prefetch" href="/m/assets/js/154.be904394.js"><link rel="prefetch" href="/m/assets/js/155.769e3b0d.js"><link rel="prefetch" href="/m/assets/js/156.6107a44f.js"><link rel="prefetch" href="/m/assets/js/157.0bf74a2b.js"><link rel="prefetch" href="/m/assets/js/158.d499f907.js"><link rel="prefetch" href="/m/assets/js/159.6b2acd2c.js"><link rel="prefetch" href="/m/assets/js/16.247520d0.js"><link rel="prefetch" href="/m/assets/js/160.ec909209.js"><link rel="prefetch" href="/m/assets/js/161.4832768d.js"><link rel="prefetch" href="/m/assets/js/162.ae74834a.js"><link rel="prefetch" href="/m/assets/js/163.8af51be9.js"><link rel="prefetch" href="/m/assets/js/164.0d64a1ef.js"><link rel="prefetch" href="/m/assets/js/165.5e5a775c.js"><link rel="prefetch" href="/m/assets/js/166.121987f8.js"><link rel="prefetch" href="/m/assets/js/167.1c270942.js"><link rel="prefetch" href="/m/assets/js/168.200df8c8.js"><link rel="prefetch" href="/m/assets/js/169.84f5e0d7.js"><link rel="prefetch" href="/m/assets/js/17.3cb462b5.js"><link rel="prefetch" href="/m/assets/js/170.57b7eec5.js"><link rel="prefetch" href="/m/assets/js/171.d993d636.js"><link rel="prefetch" href="/m/assets/js/172.820d00a1.js"><link rel="prefetch" href="/m/assets/js/173.cc29ff6e.js"><link rel="prefetch" href="/m/assets/js/174.99d62af7.js"><link rel="prefetch" href="/m/assets/js/175.da874148.js"><link rel="prefetch" href="/m/assets/js/176.d0755bfc.js"><link rel="prefetch" href="/m/assets/js/177.8b00d874.js"><link rel="prefetch" href="/m/assets/js/178.2b0cfda8.js"><link rel="prefetch" href="/m/assets/js/179.780a3873.js"><link rel="prefetch" href="/m/assets/js/18.298da910.js"><link rel="prefetch" href="/m/assets/js/180.7c0ac3dc.js"><link rel="prefetch" href="/m/assets/js/181.507f9073.js"><link rel="prefetch" href="/m/assets/js/182.87f76d4a.js"><link rel="prefetch" href="/m/assets/js/183.1410502e.js"><link rel="prefetch" href="/m/assets/js/184.80666cb3.js"><link rel="prefetch" href="/m/assets/js/185.dc628b97.js"><link rel="prefetch" href="/m/assets/js/186.c2560a3f.js"><link rel="prefetch" href="/m/assets/js/187.6af43ea3.js"><link rel="prefetch" href="/m/assets/js/188.da75b50c.js"><link rel="prefetch" href="/m/assets/js/189.78dd960b.js"><link rel="prefetch" href="/m/assets/js/19.d9eabdf8.js"><link rel="prefetch" href="/m/assets/js/190.017586b9.js"><link rel="prefetch" href="/m/assets/js/191.5fa65eb7.js"><link rel="prefetch" href="/m/assets/js/192.5bb628c7.js"><link rel="prefetch" href="/m/assets/js/193.35707c80.js"><link rel="prefetch" href="/m/assets/js/194.35c3b13b.js"><link rel="prefetch" href="/m/assets/js/195.6dc8874b.js"><link rel="prefetch" href="/m/assets/js/196.01a1e825.js"><link rel="prefetch" href="/m/assets/js/197.5745084a.js"><link rel="prefetch" href="/m/assets/js/198.0455ca12.js"><link rel="prefetch" href="/m/assets/js/199.75129c13.js"><link rel="prefetch" href="/m/assets/js/20.ce14ddb9.js"><link rel="prefetch" href="/m/assets/js/200.a08681d0.js"><link rel="prefetch" href="/m/assets/js/201.a54018b7.js"><link rel="prefetch" href="/m/assets/js/202.2361e839.js"><link rel="prefetch" href="/m/assets/js/203.b92491ee.js"><link rel="prefetch" href="/m/assets/js/204.13742571.js"><link rel="prefetch" href="/m/assets/js/205.b066e447.js"><link rel="prefetch" href="/m/assets/js/206.e2c72f2c.js"><link rel="prefetch" href="/m/assets/js/207.09a83a9a.js"><link rel="prefetch" href="/m/assets/js/208.f4b8d71c.js"><link rel="prefetch" href="/m/assets/js/209.1a4e4d18.js"><link rel="prefetch" href="/m/assets/js/21.0dc0e0bf.js"><link rel="prefetch" href="/m/assets/js/210.9709d46f.js"><link rel="prefetch" href="/m/assets/js/211.3704916b.js"><link rel="prefetch" href="/m/assets/js/212.7c96c99f.js"><link rel="prefetch" href="/m/assets/js/213.b4aedaa1.js"><link rel="prefetch" href="/m/assets/js/214.d0b2586b.js"><link rel="prefetch" href="/m/assets/js/215.2268650a.js"><link rel="prefetch" href="/m/assets/js/216.dcaa6f2f.js"><link rel="prefetch" href="/m/assets/js/217.33aaf649.js"><link rel="prefetch" href="/m/assets/js/218.216d8592.js"><link rel="prefetch" href="/m/assets/js/219.44d35873.js"><link rel="prefetch" href="/m/assets/js/22.ce355d8a.js"><link rel="prefetch" href="/m/assets/js/220.ff06fa11.js"><link rel="prefetch" href="/m/assets/js/221.93379b76.js"><link rel="prefetch" href="/m/assets/js/222.6f0bbeea.js"><link rel="prefetch" href="/m/assets/js/223.4c5e29f0.js"><link rel="prefetch" href="/m/assets/js/224.e7be32e4.js"><link rel="prefetch" href="/m/assets/js/225.4915db8f.js"><link rel="prefetch" href="/m/assets/js/226.60f21d11.js"><link rel="prefetch" href="/m/assets/js/227.0e63cf34.js"><link rel="prefetch" href="/m/assets/js/228.e7b7a543.js"><link rel="prefetch" href="/m/assets/js/229.73bf392a.js"><link rel="prefetch" href="/m/assets/js/23.40c917ac.js"><link rel="prefetch" href="/m/assets/js/230.9f789c55.js"><link rel="prefetch" href="/m/assets/js/231.8fd85bc2.js"><link rel="prefetch" href="/m/assets/js/232.e6c4a62c.js"><link rel="prefetch" href="/m/assets/js/233.45636bf3.js"><link rel="prefetch" href="/m/assets/js/234.5194ce16.js"><link rel="prefetch" href="/m/assets/js/235.15ba019b.js"><link rel="prefetch" href="/m/assets/js/236.ac5768c1.js"><link rel="prefetch" href="/m/assets/js/237.91ec2e5a.js"><link rel="prefetch" href="/m/assets/js/238.af630344.js"><link rel="prefetch" href="/m/assets/js/239.b2b84093.js"><link rel="prefetch" href="/m/assets/js/240.9c9b1fba.js"><link rel="prefetch" href="/m/assets/js/241.c26c2147.js"><link rel="prefetch" href="/m/assets/js/242.ce44f37f.js"><link rel="prefetch" href="/m/assets/js/243.aa04b829.js"><link rel="prefetch" href="/m/assets/js/244.ee4c9090.js"><link rel="prefetch" href="/m/assets/js/245.62ebda1d.js"><link rel="prefetch" href="/m/assets/js/246.2fd9ce22.js"><link rel="prefetch" href="/m/assets/js/247.52b3e746.js"><link rel="prefetch" href="/m/assets/js/248.2e432a32.js"><link rel="prefetch" href="/m/assets/js/249.4598fccb.js"><link rel="prefetch" href="/m/assets/js/25.d5d6ba55.js"><link rel="prefetch" href="/m/assets/js/250.7c93bc3e.js"><link rel="prefetch" href="/m/assets/js/251.4d402930.js"><link rel="prefetch" href="/m/assets/js/252.1b3fb775.js"><link rel="prefetch" href="/m/assets/js/253.01a9b4f8.js"><link rel="prefetch" href="/m/assets/js/254.29de4256.js"><link rel="prefetch" href="/m/assets/js/255.4911ce12.js"><link rel="prefetch" href="/m/assets/js/256.0a40f8d2.js"><link rel="prefetch" href="/m/assets/js/257.2111ae5e.js"><link rel="prefetch" href="/m/assets/js/258.0e9b2cd1.js"><link rel="prefetch" href="/m/assets/js/259.43158d35.js"><link rel="prefetch" href="/m/assets/js/26.b1e00e8a.js"><link rel="prefetch" href="/m/assets/js/260.72ea8c45.js"><link rel="prefetch" href="/m/assets/js/261.3f679643.js"><link rel="prefetch" href="/m/assets/js/262.d9ecaed6.js"><link rel="prefetch" href="/m/assets/js/27.556976c4.js"><link rel="prefetch" href="/m/assets/js/28.11027d56.js"><link rel="prefetch" href="/m/assets/js/29.f40ac6f5.js"><link rel="prefetch" href="/m/assets/js/3.a2a1a8e5.js"><link rel="prefetch" href="/m/assets/js/30.3b59bb10.js"><link rel="prefetch" href="/m/assets/js/31.c37142be.js"><link rel="prefetch" href="/m/assets/js/32.c5e0d2a0.js"><link rel="prefetch" href="/m/assets/js/33.4f5f3a8d.js"><link rel="prefetch" href="/m/assets/js/34.4a3a9398.js"><link rel="prefetch" href="/m/assets/js/35.77f89f97.js"><link rel="prefetch" href="/m/assets/js/36.6ea00d3c.js"><link rel="prefetch" href="/m/assets/js/37.b5a3b5b4.js"><link rel="prefetch" href="/m/assets/js/38.24b26621.js"><link rel="prefetch" href="/m/assets/js/39.ab372876.js"><link rel="prefetch" href="/m/assets/js/4.b9f14f77.js"><link rel="prefetch" href="/m/assets/js/40.7a81caac.js"><link rel="prefetch" href="/m/assets/js/41.d23cf8c8.js"><link rel="prefetch" href="/m/assets/js/42.ef938986.js"><link rel="prefetch" href="/m/assets/js/43.708a3cf3.js"><link rel="prefetch" href="/m/assets/js/44.f705f7de.js"><link rel="prefetch" href="/m/assets/js/45.0e6afdb6.js"><link rel="prefetch" href="/m/assets/js/46.9815c7cc.js"><link rel="prefetch" href="/m/assets/js/47.5d1c1dcc.js"><link rel="prefetch" href="/m/assets/js/48.d9d571a6.js"><link rel="prefetch" href="/m/assets/js/49.9cbaa1e9.js"><link rel="prefetch" href="/m/assets/js/5.57dbdc35.js"><link rel="prefetch" href="/m/assets/js/50.265f94f4.js"><link rel="prefetch" href="/m/assets/js/51.094b2e7f.js"><link rel="prefetch" href="/m/assets/js/52.8b7101c0.js"><link rel="prefetch" href="/m/assets/js/53.98f3fc0b.js"><link rel="prefetch" href="/m/assets/js/54.b3d830fd.js"><link rel="prefetch" href="/m/assets/js/55.fb9cd8c7.js"><link rel="prefetch" href="/m/assets/js/56.878cf94b.js"><link rel="prefetch" href="/m/assets/js/57.1c819831.js"><link rel="prefetch" href="/m/assets/js/58.ac3faf70.js"><link rel="prefetch" href="/m/assets/js/59.b0483bf9.js"><link rel="prefetch" href="/m/assets/js/6.a0c51186.js"><link rel="prefetch" href="/m/assets/js/60.48c301e6.js"><link rel="prefetch" href="/m/assets/js/61.4bf4f2e7.js"><link rel="prefetch" href="/m/assets/js/62.d927584b.js"><link rel="prefetch" href="/m/assets/js/63.b72a48f3.js"><link rel="prefetch" href="/m/assets/js/64.6923d7c8.js"><link rel="prefetch" href="/m/assets/js/65.042fc335.js"><link rel="prefetch" href="/m/assets/js/66.1afdb278.js"><link rel="prefetch" href="/m/assets/js/67.04f7b0c7.js"><link rel="prefetch" href="/m/assets/js/68.97789db4.js"><link rel="prefetch" href="/m/assets/js/69.d914e9f8.js"><link rel="prefetch" href="/m/assets/js/7.aef5e50f.js"><link rel="prefetch" href="/m/assets/js/70.84845956.js"><link rel="prefetch" href="/m/assets/js/71.d6e9132a.js"><link rel="prefetch" href="/m/assets/js/72.2c1f5783.js"><link rel="prefetch" href="/m/assets/js/73.789e9372.js"><link rel="prefetch" href="/m/assets/js/74.e79f4842.js"><link rel="prefetch" href="/m/assets/js/75.4a389066.js"><link rel="prefetch" href="/m/assets/js/76.f5721f28.js"><link rel="prefetch" href="/m/assets/js/77.e6ce992d.js"><link rel="prefetch" href="/m/assets/js/78.5c31237a.js"><link rel="prefetch" href="/m/assets/js/79.6a4f09e0.js"><link rel="prefetch" href="/m/assets/js/8.aac4a85a.js"><link rel="prefetch" href="/m/assets/js/80.23b925ca.js"><link rel="prefetch" href="/m/assets/js/81.bc8138cb.js"><link rel="prefetch" href="/m/assets/js/82.4783bc83.js"><link rel="prefetch" href="/m/assets/js/83.1be8f057.js"><link rel="prefetch" href="/m/assets/js/84.3132660e.js"><link rel="prefetch" href="/m/assets/js/85.95c5ab8b.js"><link rel="prefetch" href="/m/assets/js/86.17c9a201.js"><link rel="prefetch" href="/m/assets/js/87.daa0da6b.js"><link rel="prefetch" href="/m/assets/js/88.9409cacc.js"><link rel="prefetch" href="/m/assets/js/89.bf04eaa0.js"><link rel="prefetch" href="/m/assets/js/9.0dd0ff11.js"><link rel="prefetch" href="/m/assets/js/90.5e1e2630.js"><link rel="prefetch" href="/m/assets/js/91.6466b581.js"><link rel="prefetch" href="/m/assets/js/92.0dd7ffc6.js"><link rel="prefetch" href="/m/assets/js/93.045047c7.js"><link rel="prefetch" href="/m/assets/js/94.ce06dedb.js"><link rel="prefetch" href="/m/assets/js/95.f673ef28.js"><link rel="prefetch" href="/m/assets/js/96.1f73d13d.js"><link rel="prefetch" href="/m/assets/js/97.b1800fdc.js"><link rel="prefetch" href="/m/assets/js/98.245eb5e4.js"><link rel="prefetch" href="/m/assets/js/99.2cfc78a1.js">
    <link rel="stylesheet" href="/m/assets/css/0.styles.1e386fb6.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/m/" class="home-link router-link-active"><!----> <span class="site-name">嗯哼人生</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/m/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="https://cn100800.tk" target="_blank" rel="noopener noreferrer" class="nav-link external">
  主站
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="mailto:freecracy1024@gmail.com" class="nav-link external">
  mail
  <!----></a></div><div class="nav-item"><a href="https://google.com.hk" target="_blank" rel="noopener noreferrer" class="nav-link external">
  google
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/m/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="https://cn100800.tk" target="_blank" rel="noopener noreferrer" class="nav-link external">
  主站
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="mailto:freecracy1024@gmail.com" class="nav-link external">
  mail
  <!----></a></div><div class="nav-item"><a href="https://google.com.hk" target="_blank" rel="noopener noreferrer" class="nav-link external">
  google
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Go语言之旅</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/m/Go语言之旅/slice.html" class="sidebar-link">slice</a></li><li><a href="/m/Go语言之旅/0x00.开发环境.html" class="sidebar-link">0x00.开发环境</a></li><li><a href="/m/Go语言之旅/0x04.select.html" class="sidebar-link">0x04.select</a></li><li><a href="/m/Go语言之旅/0x05.编译器.html" class="sidebar-link">0x04.编译器</a></li><li><a href="/m/Go语言之旅/0x05.编译器02.html" class="sidebar-link">0x05.编译器02</a></li><li><a href="/m/Go语言之旅/0x06.数据结构.html" class="sidebar-link">0x06.数据结构</a></li><li><a href="/m/Go语言之旅/0x07.context.html" class="sidebar-link">0x07.context</a></li><li><a href="/m/Go语言之旅/0x08.性能剖析.html" class="sidebar-link">0x08.性能剖析</a></li><li><a href="/m/Go语言之旅/0x09.reflect.html" class="sidebar-link">0x09.reflect</a></li><li><a href="/m/Go语言之旅/0x12.interface.html" class="sidebar-link">0x12.interface</a></li><li><a href="/m/Go语言之旅/0x13.package.html" class="sidebar-link">0x13.package</a></li><li><a href="/m/Go语言之旅/0x14.问题集.html" class="sidebar-link">0x14.问题集</a></li><li><a href="/m/Go语言之旅/0x15.leet.html" class="sidebar-link">0x15.leet</a></li><li><a href="/m/Go语言之旅/0x16.命令行参数.html" class="sidebar-link">0x16.命令行参数</a></li><li><a href="/m/Go语言之旅/GODEBUG.html" class="sidebar-link">GODEBUG</a></li><li><a href="/m/Go语言之旅/bitmap.html" class="sidebar-link">bitmap</a></li><li><a href="/m/Go语言之旅/channel.html" class="sidebar-link">channel</a></li><li><a href="/m/Go语言之旅/defer.html" class="sidebar-link">defer</a></li><li><a href="/m/Go语言之旅/gmp模型.html" class="sidebar-link">gmp 模型</a></li><li><a href="/m/Go语言之旅/make.html" class="sidebar-link">make</a></li><li><a href="/m/Go语言之旅/map.html" class="sidebar-link">map</a></li><li><a href="/m/Go语言之旅/mock.html" class="sidebar-link">mock</a></li><li><a href="/m/Go语言之旅/0x03.内存模型.html" class="sidebar-link">0x03.内存模型</a></li><li><a href="/m/Go语言之旅/tool.html" class="sidebar-link">tool</a></li><li><a href="/m/Go语言之旅/内存管理.html" class="sidebar-link">第四章 : 内存管理</a></li><li><a href="/m/Go语言之旅/协程池.html" class="sidebar-link">协程池</a></li><li><a href="/m/Go语言之旅/协程调度.html" class="sidebar-link">第三章 : 协程调度</a></li><li><a href="/m/Go语言之旅/垃圾回收.html" class="sidebar-link">垃圾回收</a></li><li><a href="/m/Go语言之旅/基础.html" class="sidebar-link">基础</a></li><li><a href="/m/Go语言之旅/工具集.html" class="sidebar-link">工具集</a></li><li><a href="/m/Go语言之旅/常用数据结构实现原理.html" class="sidebar-link">第一章 : 常用数据结构实现原理</a></li><li><a href="/m/Go语言之旅/常见控制结构实现原理.html" class="active sidebar-link">第二章 : 常见控制结构实现原理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/m/Go语言之旅/常见控制结构实现原理.html#defer" class="sidebar-link">defer</a></li><li class="sidebar-sub-header"><a href="/m/Go语言之旅/常见控制结构实现原理.html#select" class="sidebar-link">select</a></li><li class="sidebar-sub-header"><a href="/m/Go语言之旅/常见控制结构实现原理.html#range" class="sidebar-link">range</a></li><li class="sidebar-sub-header"><a href="/m/Go语言之旅/常见控制结构实现原理.html#mutex" class="sidebar-link">mutex</a></li><li class="sidebar-sub-header"><a href="/m/Go语言之旅/常见控制结构实现原理.html#rwmutex" class="sidebar-link">RWMutex</a></li></ul></li><li><a href="/m/Go语言之旅/并发控制.html" class="sidebar-link">第五章 : 并发控制</a></li><li><a href="/m/Go语言之旅/思考题.html" class="sidebar-link">思考题</a></li><li><a href="/m/Go语言之旅/文件操作.html" class="sidebar-link">文件操作</a></li><li><a href="/m/Go语言之旅/框架.html" class="sidebar-link">框架</a></li><li><a href="/m/Go语言之旅/泛型.html" class="sidebar-link">泛型</a></li><li><a href="/m/Go语言之旅/版本更新.html" class="sidebar-link">版本更新</a></li><li><a href="/m/Go语言之旅/调试.html" class="sidebar-link">调试</a></li><li><a href="/m/Go语言之旅/进程线程协程.html" class="sidebar-link">进程线程协程</a></li><li><a href="/m/Go语言之旅/部署.html" class="sidebar-link">部署</a></li><li><a href="/m/Go语言之旅/闭包.html" class="sidebar-link">闭包</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>文章</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>标准库</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>源码</span> <span class="arrow right"></span></p> <!----></section></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Redis</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Deno</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>其他</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>周末闲谈</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>深度好文</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>漫步 Linux</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>算法</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>设计模式</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>鸡汤软文</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="第二章-常见控制结构实现原理"><a href="#第二章-常见控制结构实现原理" class="header-anchor">#</a> 第二章 : 常见控制结构实现原理</h1> <h2 id="defer"><a href="#defer" class="header-anchor">#</a> defer</h2> <p>用于延迟函数调用,每次 defer 都会把一个函数压入栈中,函数返回前把延迟的函数取出来执行.设计初衷是简化函数返回时资源的清理动作,资源一般有依赖顺序释放时要反向进行,每申请到一个用完需要释放的资源立即定义一个 defer 来释放资源.</p> <h3 id="例子"><a href="#例子" class="header-anchor">#</a> 例子</h3> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> aint <span class="token operator">=</span> <span class="token number">1</span>
	<span class="token keyword">defer</span> fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>aint<span class="token punctuation">)</span> <span class="token comment">// 1 延迟函数参数在 defer 语句出现时已经确定,无论后面怎么修改都不会影响延迟函数</span>
	aint <span class="token operator">=</span> <span class="token number">2</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="规则"><a href="#规则" class="header-anchor">#</a> 规则</h3> <ol><li>延迟函数的参数在 defer 语句出现时就已经确定, 对于指针类型参数,延迟函数的参数是一个地址值,后面的语句对变量的修改可能会影响延迟函数</li> <li>延迟函数的执行按后进先出顺序执行,即先出现的 defer 最后执行</li> <li>延迟函数可能操作主函数的具名返回值</li></ol> <h3 id="函数返回过程"><a href="#函数返回过程" class="header-anchor">#</a> 函数返回过程</h3> <p>returen 不是一个原子操作,return 只代理汇编指令 ret, 即跳转语句执行,比如 <code>return i</code>实际上分两步即将 i 值存入栈中作为返回值,然后执行跳转而 defer 的执行时机正好是跳转前,所以 defer 执行时有机会操作返回值(返回值没有名字没有关系).</p> <h4 id="主函数拥有匿名返回值-返回字面值"><a href="#主函数拥有匿名返回值-返回字面值" class="header-anchor">#</a> 主函数拥有匿名返回值,返回字面值</h4> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> i <span class="token builtin">int</span>
	<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		i<span class="token operator">++</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token number">1</span> <span class="token comment">// return 语句直接把 1 写入栈中作为返回值,延迟函数无法操作该返回值,所以无法影响返回值</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h4 id="主函数拥有匿名返回值-返回变量"><a href="#主函数拥有匿名返回值-返回变量" class="header-anchor">#</a> 主函数拥有匿名返回值,返回变量</h4> <p>主函数拥有一个匿名返回值返回本地或全局变量这种情况下 defer 可以引用返回值,但不会改变返回值.</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> i <span class="token builtin">int</span>
	<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		i<span class="token operator">++</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> i
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h4 id="主函数拥有具名返回值"><a href="#主函数拥有具名返回值" class="header-anchor">#</a> 主函数拥有具名返回值</h4> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>ret <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">defer</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		ret<span class="token operator">++</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> <span class="token number">0</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="结构体-实现原理"><a href="#结构体-实现原理" class="header-anchor">#</a> 结构体(实现原理)</h3> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// runtime/runtime2.go:_defer</span>
<span class="token keyword">type</span> _defer <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	siz     <span class="token builtin">int32</span> <span class="token comment">// includes both arguments and results</span>
	started <span class="token builtin">bool</span>
	heap    <span class="token builtin">bool</span>
	openDefer <span class="token builtin">bool</span>
	sp        <span class="token builtin">uintptr</span>  <span class="token comment">// 函数栈地址</span>
	pc        <span class="token builtin">uintptr</span>  <span class="token comment">// 程序计数器</span>
	fn        <span class="token operator">*</span>funcval <span class="token comment">// 函数地址</span>
	_panic    <span class="token operator">*</span>_panic  <span class="token comment">// panic that is running defer</span>
	link      <span class="token operator">*</span>_defer  <span class="token comment">// 指向自身结构的指针,用于连接多个 defer</span>
	fd   unsafe<span class="token punctuation">.</span>Pointer <span class="token comment">// funcdata for the function associated with the frame</span>
	varp <span class="token builtin">uintptr</span>        <span class="token comment">// value of varp for the stack frame</span>
	framepc <span class="token builtin">uintptr</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>每个 goroutine 数据结构中实际上也有一个 defer 指针,该指针指向一个 defer 的单链表,每次声明一个 defer 时就将 defer 插入到单链表表头,每次执行 defer 时就从单链表表头取出一个 defer 执行.新声明的 defer 总是添加到链表头部.函数返回前执行 defer 则从链表首部依次取出执行.一个 goroutine 可能调用多个函数,进入函数时添加 defer,离开函数时取出 defer,即便调用多个函数也总能保证 FIFO 方式执行.</p> <h3 id="创建和执行"><a href="#创建和执行" class="header-anchor">#</a> 创建和执行</h3> <p>在编译阶段声明 defer 处插入 <code>deferproc()</code>函数,在函数 return 前插入 <code>deferreturn()</code>函数.</p> <h4 id="创建"><a href="#创建" class="header-anchor">#</a> 创建</h4> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// 在声明 defer 处调用,将 defer 函数存入 goroutine 的链表中</span>
<span class="token keyword">func</span> <span class="token function">deferproc</span><span class="token punctuation">(</span>siz <span class="token builtin">int32</span><span class="token punctuation">,</span> fn <span class="token operator">*</span>funcval<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// arguments of fn follow fn</span>
	gp <span class="token operator">:=</span> <span class="token function">getg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> gp<span class="token punctuation">.</span>m<span class="token punctuation">.</span>curg <span class="token operator">!=</span> gp <span class="token punctuation">{</span>
		<span class="token comment">// go code on the system stack can't defer</span>
		<span class="token function">throw</span><span class="token punctuation">(</span><span class="token string">&quot;defer on system stack&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	sp <span class="token operator">:=</span> <span class="token function">getcallersp</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	argp <span class="token operator">:=</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>fn<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> unsafe<span class="token punctuation">.</span><span class="token function">Sizeof</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span>
	callerpc <span class="token operator">:=</span> <span class="token function">getcallerpc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	d <span class="token operator">:=</span> <span class="token function">newdefer</span><span class="token punctuation">(</span>siz<span class="token punctuation">)</span>
	<span class="token keyword">if</span> d<span class="token punctuation">.</span>_panic <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token function">throw</span><span class="token punctuation">(</span><span class="token string">&quot;deferproc: d.panic != nil after newdefer&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	d<span class="token punctuation">.</span>link <span class="token operator">=</span> gp<span class="token punctuation">.</span>_defer
	gp<span class="token punctuation">.</span>_defer <span class="token operator">=</span> d
	d<span class="token punctuation">.</span>fn <span class="token operator">=</span> fn
	d<span class="token punctuation">.</span>pc <span class="token operator">=</span> callerpc
	d<span class="token punctuation">.</span>sp <span class="token operator">=</span> sp
	<span class="token keyword">switch</span> siz <span class="token punctuation">{</span>
	<span class="token keyword">case</span> <span class="token number">0</span><span class="token punctuation">:</span>
		<span class="token comment">// Do nothing.</span>
	<span class="token keyword">case</span> sys<span class="token punctuation">.</span>PtrSize<span class="token punctuation">:</span>
		<span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token builtin">uintptr</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">deferArgs</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token builtin">uintptr</span><span class="token punctuation">)</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>argp<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">default</span><span class="token punctuation">:</span>
		<span class="token function">memmove</span><span class="token punctuation">(</span><span class="token function">deferArgs</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">,</span> unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span>argp<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>siz<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token function">return0</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><h4 id="执行"><a href="#执行" class="header-anchor">#</a> 执行</h4> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// 在 returen(ret) 指令前调用,将 defer 从 goroutine 链表中取出并执行</span>
<span class="token keyword">func</span> <span class="token function">deferreturn</span><span class="token punctuation">(</span>arg0 <span class="token builtin">uintptr</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	gp <span class="token operator">:=</span> <span class="token function">getg</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	d <span class="token operator">:=</span> gp<span class="token punctuation">.</span>_defer
	<span class="token keyword">if</span> d <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	sp <span class="token operator">:=</span> <span class="token function">getcallersp</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> d<span class="token punctuation">.</span>sp <span class="token operator">!=</span> sp <span class="token punctuation">{</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> d<span class="token punctuation">.</span>openDefer <span class="token punctuation">{</span>
		done <span class="token operator">:=</span> <span class="token function">runOpenDeferFrame</span><span class="token punctuation">(</span>gp<span class="token punctuation">,</span> d<span class="token punctuation">)</span>
		<span class="token keyword">if</span> <span class="token operator">!</span>done <span class="token punctuation">{</span>
			<span class="token function">throw</span><span class="token punctuation">(</span><span class="token string">&quot;unfinished open-coded defers in deferreturn&quot;</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		gp<span class="token punctuation">.</span>_defer <span class="token operator">=</span> d<span class="token punctuation">.</span>link
		<span class="token function">freedefer</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">switch</span> d<span class="token punctuation">.</span>siz <span class="token punctuation">{</span>
	<span class="token keyword">case</span> <span class="token number">0</span><span class="token punctuation">:</span>
		<span class="token comment">// Do nothing.</span>
	<span class="token keyword">case</span> sys<span class="token punctuation">.</span>PtrSize<span class="token punctuation">:</span>
		<span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token builtin">uintptr</span><span class="token punctuation">)</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>arg0<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token builtin">uintptr</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token function">deferArgs</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">default</span><span class="token punctuation">:</span>
		<span class="token function">memmove</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>arg0<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">deferArgs</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>d<span class="token punctuation">.</span>siz<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	fn <span class="token operator">:=</span> d<span class="token punctuation">.</span>fn
	d<span class="token punctuation">.</span>fn <span class="token operator">=</span> <span class="token boolean">nil</span>
	gp<span class="token punctuation">.</span>_defer <span class="token operator">=</span> d<span class="token punctuation">.</span>link
	<span class="token function">freedefer</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span>
	<span class="token boolean">_</span> <span class="token operator">=</span> fn<span class="token punctuation">.</span>fn
	<span class="token function">jmpdefer</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> <span class="token function">uintptr</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>arg0<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><h3 id="小结"><a href="#小结" class="header-anchor">#</a> 小结</h3> <ol><li>defer 定义的延迟函数参数在 defer 语句出现时就已经确定下来了</li> <li>定义顺序与执行顺序相反</li> <li>return 不是原子操作,执行过程 : 保存返回值(若有)、执行 defer (若有)、执行 ret 跳转</li> <li>申请资源后立即使用 defer 关闭资源是个好习惯</li></ol> <h2 id="select"><a href="#select" class="header-anchor">#</a> select</h2> <h3 id="例子-2"><a href="#例子-2" class="header-anchor">#</a> 例子</h3> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">select</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>对于空 select 程序会被阻塞,即当前 goroutine 会被阻塞,同时 go 自带死锁检测机制当发现当前 goroutine 再也没有机会被唤醒时则会 panic.</p> <h3 id="case-结构体"><a href="#case-结构体" class="header-anchor">#</a> case 结构体</h3> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// runtime/select.go:scase</span>
<span class="token keyword">type</span> scase <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	c           <span class="token operator">*</span>hchan         <span class="token comment">// chan</span>
	elem        unsafe<span class="token punctuation">.</span>Pointer <span class="token comment">// data element</span>
	kind        <span class="token builtin">uint16</span>
	pc          <span class="token builtin">uintptr</span> <span class="token comment">// race pc (for race detector / msan)</span>
	releasetime <span class="token builtin">int64</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> <span class="token punctuation">(</span>
	caseNil     <span class="token operator">=</span> <span class="token boolean">iota</span>
	caseRecv    <span class="token comment">// case 语句中尝试读取 scase.c 中的数据</span>
	caseSend    <span class="token comment">// case 语句中尝试向 scase.c 中写入数据</span>
	caseDefault <span class="token comment">// default 语句</span>
<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><ol><li>scase.c 当前 case 语句所操作的 channel 指针,一个 case 语句只能操作一个 channel</li> <li>scase.kind 表示该 case 的类型,分为读 channel、写 channel、default</li> <li>scase.elem 表示缓存区地址,根据 scase.kind 不同有不同的用途</li></ol> <blockquote><p>scase.kind = caseRecv : scase.elem 表示读出 channel 的数据存放地址</p> <p>scase.kind = caseSend : scase.elem 表示将要写入 channel 的数据存放地址</p></blockquote> <h3 id="select-实现逻辑"><a href="#select-实现逻辑" class="header-anchor">#</a> select 实现逻辑</h3> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// runtime/select.go:selectgo</span>
<span class="token keyword">func</span> <span class="token function">selectgo</span><span class="token punctuation">(</span>cas0 <span class="token operator">*</span>scase<span class="token punctuation">,</span> order0 <span class="token operator">*</span><span class="token builtin">uint16</span><span class="token punctuation">,</span> ncases <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// 1. 锁定 scase 语句中所有 channel</span>
	<span class="token comment">// 2. 按照随机顺序检测 scase 中 channel 是否 ready</span>
	<span class="token comment">//    2.1 如果 case 可读,则读取 channel 中数据,解锁所有的 channel,然后返回 (case index, true)</span>
	<span class="token comment">//    2.2 如果 case 可写,则将数据写入 channel,解锁所有 channel,然后返回 (case index, false)</span>
	<span class="token comment">//    2.3 所有 case 都未 ready,则解锁所有 channel,然后返回 (default index, false)</span>
	<span class="token comment">// 3. 所有 case 都未 ready,且没有 default 语句</span>
	<span class="token comment">//    3.1 将当前 goroutine 加入到所有 channel 的等待队列</span>
	<span class="token comment">//    3.2 将当前 goroutine 转入阻塞,等待被唤醒</span>
	<span class="token comment">// 4. 唤醒后返回 channel 对应的 case index</span>
	<span class="token comment">//    4.1 如果是读操作,解锁所有 channel,然后返回 (case index, true)</span>
	<span class="token comment">//    4.2 如果是写操作,解锁所有 channel,然后返回 (case index, false)</span>
<span class="token punctuation">}</span>
<span class="token comment">// pollorder : 每次 selectgo 执行都会把 scase 序列打乱,以达到随机检测 case 的目的</span>
<span class="token comment">// lockorder : 所有 case 语句中的 channel 序列,以达到去重防止 channel 加锁时重复加锁</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><blockquote><p>对于读 channel 的 case 来说, 如<code>case elem,ok := &lt;-chan</code>,如果 chanenl 有可能被其它 roroutine 关闭的情况下一定要检测读取是否成功,因为 close 的 channel 也有可能返回,此时<code>ok == false</code>.</p></blockquote> <h4 id="函数参数"><a href="#函数参数" class="header-anchor">#</a> 函数参数</h4> <ol><li>cas0 : 为 scase 数组的首地址, selectgo() 就是从这行 scase 中找出一个返回</li> <li>order0 : 为一个两倍 cas0 数组长度的 buffer,保存 scase 随机序列 pollorder 和 scase 中 channel 地址序列 lockorder</li> <li>ncases : 表示 scase 数组的长度</li></ol> <h4 id="函数返回值"><a href="#函数返回值" class="header-anchor">#</a> 函数返回值</h4> <ol><li>int : 选中 case 的编号,这个 case 编号跟代码一致</li> <li>bool : 是否成功从 channel 中读取了数据,如果选中 case 是从 channel 中读取数据,则该返回值表示是否读取成功</li></ol> <h3 id="小结-2"><a href="#小结-2" class="header-anchor">#</a> 小结</h3> <ol><li>select 语句中除 default 外,每个 case 操作一个 channel,要么读要么写</li> <li>select 语句中除 default 外,各 case 执行顺序是随机的</li> <li>select 语句中如果没有 default,则会阻塞等待任一 case</li> <li>select 语句中读操作要判断是否成功读取,关闭的 channel 也可以读取</li></ol> <h2 id="range"><a href="#range" class="header-anchor">#</a> range</h2> <h3 id="例子-遍历切片"><a href="#例子-遍历切片" class="header-anchor">#</a> 例子-遍历切片</h3> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">RangeSlice</span><span class="token punctuation">(</span>slice <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> index<span class="token punctuation">,</span> value <span class="token operator">:=</span> <span class="token keyword">range</span> slice <span class="token punctuation">{</span>
		<span class="token boolean">_</span><span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">=</span> index<span class="token punctuation">,</span> value
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 优化 : 遍历过程中每次迭代会对 index 和 value 进行赋值,如果数据量或 value 类型为 string 时,对 value 的赋值操作可能是多余的,可在 for-range 中忽略 value 值,使用 slice[index] 引用 value 的值</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="例子-遍历-map"><a href="#例子-遍历-map" class="header-anchor">#</a> 例子-遍历 map</h3> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">RangeMap</span><span class="token punctuation">(</span>myMap <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">int</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">for</span> key<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> <span class="token keyword">range</span> myMap <span class="token punctuation">{</span>
		<span class="token boolean">_</span><span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">=</span> key<span class="token punctuation">,</span> myMap<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 优化 : for-range 只获取 key,然后根据 key 值获取 value 值,看似减少了一次赋值,但通过 key 值查找 value 值性能消耗可能高于赋值消耗,能否优化取决于 map 存储数据结构的特征,实际情况进行优化</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="例子-动态遍历"><a href="#例子-动态遍历" class="header-anchor">#</a> 例子-动态遍历</h3> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	v <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">}</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token keyword">range</span> v <span class="token punctuation">{</span>
		v <span class="token operator">=</span> <span class="token function">append</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> i<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 能够正常结束,循环内改变切片长度,不影响循环次数,循环次数在循环开始前就已经确定了</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="实现原理"><a href="#实现原理" class="header-anchor">#</a> 实现原理</h3> <p>range 支持数组、数组指针、切片、map、channel.</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">// golang/gofrontend/blob/master/go/statements.cc:For_range_statement::do_lower()</span>
<span class="token comment">// Arrange to do a loop appropriate for the type.  We will produce</span>
  <span class="token comment">//   for INIT ; COND ; POST {</span>
  <span class="token comment">//           ITER_INIT</span>
  <span class="token comment">//           INDEX = INDEX_TEMP</span>
  <span class="token comment">//           VALUE = VALUE_TEMP // If there is a value</span>
  <span class="token comment">//           original statements</span>
  <span class="token comment">//   }</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h4 id="range-for-slice"><a href="#range-for-slice" class="header-anchor">#</a> range for slice</h4> <div class="language-c line-numbers-mode"><pre class="language-c"><code>  <span class="token comment">// The loop we generate:</span>
  <span class="token comment">//   for_temp := range</span>
  <span class="token comment">//   len_temp := len(for_temp)</span>
  <span class="token comment">//   for index_temp = 0; index_temp &lt; len_temp; index_temp++ {</span>
  <span class="token comment">//           value_temp = for_temp[index_temp]</span>
  <span class="token comment">//           index = index_temp</span>
  <span class="token comment">//           value = value_temp</span>
  <span class="token comment">//           original body</span>
  <span class="token comment">//   }</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>遍历 slice 前先获得 slice 的长度 len_temp 作为循环次数,循环体中每次循环会先获取元素值,如果 for-range 中接收 index 和 value 的话,会对 index 和 value 进行一次赋值.由于循环开始前,循环次数就已经确定了所以循环过程中新添加元素是没有办法遍历到的.数组与数组指针的遍历过程与 slice 基本一致.</p> <h4 id="range-for-map"><a href="#range-for-map" class="header-anchor">#</a> range for map</h4> <div class="language-c line-numbers-mode"><pre class="language-c"><code>  <span class="token comment">// The loop we generate:</span>
  <span class="token comment">//   var hiter map_iteration_struct</span>
  <span class="token comment">//   for mapiterinit(type, range, &amp;hiter); hiter.key != nil; mapiternext(&amp;hiter) {</span>
  <span class="token comment">//           index_temp = *hiter.key</span>
  <span class="token comment">//           value_temp = *hiter.val</span>
  <span class="token comment">//           index = index_temp</span>
  <span class="token comment">//           value = value_temp</span>
  <span class="token comment">//           original body</span>
  <span class="token comment">//   }</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>遍历 map 时没有指定循环次数,循环体与遍历 slice 类似.由于 map 底层实现与 slice 不同, map 底层采用 hash 表实现的,插入位置是随机的,所以遍历过程中新插入的数据不能保证遍历到.</p> <h4 id="range-for-channel"><a href="#range-for-channel" class="header-anchor">#</a> range for channel</h4> <div class="language-go line-numbers-mode"><pre class="language-go"><code>  <span class="token comment">// The loop we generate:</span>
  <span class="token comment">//   for {</span>
  <span class="token comment">//           index_temp, ok_temp = &lt;-range</span>
  <span class="token comment">//           if !ok_temp {</span>
  <span class="token comment">//                   break</span>
  <span class="token comment">//           }</span>
  <span class="token comment">//           index = index_temp</span>
  <span class="token comment">//           original body</span>
  <span class="token comment">//   }</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>channel 遍历依次从 channel 中读取数据,读取前是不知道有多少个元素的,如果 channel 中没有元素,则会阻塞等待,如果 channel 已被关闭则会解除阻塞并退出循环.</p> <blockquote><p>index_temp 实际上应该为 value_temp,因为 index 对于 channel 没有意义</p> <p>使用 for-range 遍历 channel 时只能获取一个返回值</p></blockquote> <h3 id="小结-3"><a href="#小结-3" class="header-anchor">#</a> 小结</h3> <ol><li>遍历过程中适情况放弃 index 或 value,可以一定程度上提高性能</li> <li>遍历 channel 时,如果 channel 没有数据,可能会阻塞</li> <li>尽量避免遍历过程中修改原数据</li> <li>for-range 的实现实际上是 C 风格的 for 循环</li> <li>使用 index 和 value 接收 range 返回值会发生一次数据拷贝</li></ol> <h2 id="mutex"><a href="#mutex" class="header-anchor">#</a> mutex</h2> <h3 id="结构体"><a href="#结构体" class="header-anchor">#</a> 结构体</h3> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// sync/mutex.go:Mutex</span>
<span class="token keyword">type</span> Mutex <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	state <span class="token builtin">int32</span>
	sema  <span class="token builtin">uint32</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ol><li>Mutex.state : 表示互斥锁的状态,比如是否被锁定等, 32 位的整型变量,内部实现时把该变量分成 4 份,记录 4 种状态</li> <li>Mutex.sema : 表示信号量,协程阻塞等待该信号量,解锁的协程释放信号量从而唤醒等待信号的协程</li></ol> <p><img src="/m/assets/img/go-mutex-state.ff33a56f.png" alt="go-mutex-state"></p> <table><thead><tr><th>状态</th> <th>描述</th> <th>位数</th></tr></thead> <tbody><tr><td>locked</td> <td>表示该 Mutex 是否被锁定, 0 没有锁定, 1 已被锁定</td> <td>1 bit</td></tr> <tr><td>woken</td> <td>是否有协程已被唤醒, 0 没有协程唤醒 1 已有协程唤醒正在加锁过程中</td> <td>1 bit</td></tr> <tr><td>starving</td> <td>是否处于饥饿状态, 0 没有饥饿 1 饥饿状态,有协程阻塞了超过 1 ms</td> <td>1 bit</td></tr> <tr><td>waiter</td> <td>表示阻塞等待锁的协程个数,协程解锁时根据该值判断是否需要释放信号量</td> <td>29 bit</td></tr></tbody></table> <p>协程之间抢锁实际上是抢给 locked 赋值的权利,能给 locked 置 1,就说明抢锁成功.抢不到的话就阻塞等待 Mutex.sema 信号量,一旦持有锁的协程解锁,等待的协程会依次被唤醒, woken 和 starving 主要用于控制协程间的抢锁过程.</p> <h3 id="加锁过程"><a href="#加锁过程" class="header-anchor">#</a> 加锁过程</h3> <p>加锁分为成功和失败两种情况,成功直接获取锁,失败后当前协程被阻塞</p> <h4 id="简单加锁"><a href="#简单加锁" class="header-anchor">#</a> 简单加锁</h4> <p>只有一个协程在加锁,没有其它协程干扰,加锁过程获取判断 locked 标志位是否为 0,如果 0 则把 locked 位置 1,代表加锁成功,加锁成功后只是 locked 位置 1,其它状态位没有发生变化.</p> <h4 id="加锁被阻塞"><a href="#加锁被阻塞" class="header-anchor">#</a> 加锁被阻塞</h4> <p>假设加锁时,锁已被其它协程占用了,当一个协程对一个已被占用的锁再次加锁时, waiter 计数器增加了 1,此时协程被阻塞,直到 locked 位变为 0 后才会被唤醒.</p> <h3 id="解锁过程"><a href="#解锁过程" class="header-anchor">#</a> 解锁过程</h3> <h4 id="简单解锁"><a href="#简单解锁" class="header-anchor">#</a> 简单解锁</h4> <p>由于没有其它协程阻塞等待加锁,此时解锁时只需要把 locked 位置 0 即可,不需要释放信号量.</p> <h4 id="解锁并唤醒协程"><a href="#解锁并唤醒协程" class="header-anchor">#</a> 解锁并唤醒协程</h4> <p>假设解锁时有一个或多个协程阻塞,解锁过程分为 2 步,一是把 locked 位置 0,二是查看到 waiter &gt; 0 所以释放一个信号量,唤醒一个阻塞的协程被唤醒的协程把 locked 位置 1,于是新协程获取到锁.</p> <p><img src="/m/assets/img/go-mutex-lock-unlock.baeca015.png" alt="go-mutex-lock-unlock"></p> <h3 id="自旋过程"><a href="#自旋过程" class="header-anchor">#</a> 自旋过程</h3> <p>加锁时如果当前 locked 位为 1,说明该锁由其它协程持有,尝试加锁的协程并不会马上转入阻塞,而会持续的 locked 位是否变为 0,这个过程即为自旋过程.自旋过程时间很短,但如果在自旋过程中发现锁已被释放那么协程可以立即获取锁.此时即便有协程被唤醒也无法获取锁,只能再次阻塞,自旋的好处是当加锁失败时不会立即转入阻塞,有一定机会获取到锁,这样可以避免协程的切换.</p> <p>自旋对应 cpu 的 PAUSE 指令, cpu 对该指令什么都不做相当于 cpu 空转,对程序而言相当于 sleep 了一小段时间,时间非常短,当前实现是 30 个时钟周期.自旋过程中会持续探测 locked 是否变为 0,连续两次探测间隔就是执行这些 PAUSE 指令,不同于 sleep,不需要将协程转为睡眠状态.</p> <h4 id="自旋条件"><a href="#自旋条件" class="header-anchor">#</a> 自旋条件</h4> <p>加锁时程序会自动判断是否可以自旋,无限制的自旋会给 cpu 带来压力.总而言之,就是在不忙的时候才会启用自旋.</p> <ol><li>自旋次数要足够小,通常为 4,自旋最多 4 次</li> <li>cpu 核数要大于 1,否则自旋没有意义,因为此时不可能有其它协程释放锁</li> <li>协程调度机制中的 process 数量要大于 1,比如使用<code>GOMAXPROCS()</code>将处理器设置为 1 就不能启用自旋</li> <li>协程调度机制中的可运行队列必须为空,否则会延迟协程调度</li></ol> <h4 id="自旋的优势"><a href="#自旋的优势" class="header-anchor">#</a> 自旋的优势</h4> <p>充分利用 cpu,避免协程切换,因为当前申请加锁的协程拥有 cpu,如果经过短时间的自旋可以获得锁,当前协程可以继续运行,不必进入阻塞状态.</p> <h4 id="自旋问题"><a href="#自旋问题" class="header-anchor">#</a> 自旋问题</h4> <p>如果自旋过程中获得锁,之前阻塞的协程将无法获得锁,如果加锁协程特别多,每次都通过自旋获得锁,那么之前被阻塞的协程将很难获得锁,从而进入饥饿状态.为避免协程长时间无法获取锁,1.8 版本后增加了一个状态,即 Mutex.starving.这个状态下不会自旋,一旦有协程释放锁那么一定会唤醒一个协程并成功加锁.</p> <h3 id="mutex模式"><a href="#mutex模式" class="header-anchor">#</a> Mutex模式</h3> <h3 id="normal-模式"><a href="#normal-模式" class="header-anchor">#</a> normal 模式</h3> <p>默认模式,该模式下协程如果加锁不成功,不会立即转入阻塞排队,而是判断是否满足自旋条件,如果满足会启动自旋过程,尝试抢锁.</p> <h3 id="starvation-模式"><a href="#starvation-模式" class="header-anchor">#</a> starvation 模式</h3> <p>自旋过程中如果能抢到锁,意味着同一时刻有协程释放了锁,释放锁时如果发现有阻塞等待的协程还会释放一个信号量来唤醒一个等待协程,被唤醒的协程得到 cpu 后开始执行,此时发现锁已被抢占了自己只好再次阻塞不过在阻塞前会判断自上次阻塞到本地阻塞经过了多长时间如果超过 1ms 的话会将 Mutex 标记为极饿模式,然后再阻塞,处于饥饿模式不会启动自旋过程,一旦有协程释放了锁,那么一定会唤醒协程,被唤醒的协程将会成功获取锁,同时把等待计数减 1.</p> <h3 id="woken-状态"><a href="#woken-状态" class="header-anchor">#</a> woken 状态</h3> <p>woken 状态用于加锁解锁的通信,同一时刻,两个协程一个在加锁一个在解锁,在加锁的协程可能在自旋过程中,此时将 woken 标记为 1,用于通知解锁协程不必释放信号量了,意思是只管解锁不必释放信号量,我马上就可以拿到锁.</p> <h3 id="重复解锁发生-panic"><a href="#重复解锁发生-panic" class="header-anchor">#</a> 重复解锁发生 panic</h3> <p>如果多次 unlock 可能每次都释放一个信号量,这样会唤醒多个协程,多个协程唤醒后会继续在 lock 逻辑里抢锁,会增加 lock 实现复杂度,也会引起不必要的协程切换.</p> <h3 id="tips"><a href="#tips" class="header-anchor">#</a> tips</h3> <ol><li>使用 defer 避免死锁 : 加锁后立即使用 defer 对其解锁,可以有效避免死锁</li> <li>加锁和解锁应该成对出现 : 最好在一个层次的代码中,比如同一个函数,重复解锁会 panic,应避免这种操作的可能性</li></ol> <h2 id="rwmutex"><a href="#rwmutex" class="header-anchor">#</a> RWMutex</h2> <h3 id="解决问题"><a href="#解决问题" class="header-anchor">#</a> 解决问题</h3> <ol><li>写锁需要阻塞写锁 : 一个协程拥有写锁时,其它协程写锁定需要阻塞</li> <li>写锁需要阻塞读锁 : 一个协程拥有写锁时,其它协程读锁定需要阻塞</li> <li>读锁需要阻塞写锁 : 一个协程拥有读锁时,其它协程写锁定需要阻塞</li> <li>读锁不能阻塞读锁 : 一个协程拥有读锁时,其它协程可以也拥有读锁</li></ol> <h3 id="结构体-2"><a href="#结构体-2" class="header-anchor">#</a> 结构体</h3> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// sync/rwmutex.go:RWMutex</span>
<span class="token keyword">type</span> RWMutex <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	w           Mutex  <span class="token comment">// 用于控制多个写锁,获得写锁首先要获取该锁,如果有写锁正在进行,再来的写锁将会阻塞于此</span>
	writerSem   <span class="token builtin">uint32</span> <span class="token comment">// 写阻塞等待信号量,最后一个读锁释放时会释放该信号量</span>
	readerSem   <span class="token builtin">uint32</span> <span class="token comment">// 读阻塞协程等待的信号量,持有写锁的协程释放锁后会释放信号量</span>
	readerCount <span class="token builtin">int32</span>  <span class="token comment">// 记录读读个数</span>
	readerWait  <span class="token builtin">int32</span>  <span class="token comment">// 记录写阻塞的个数</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><ol><li>RLock() : 读锁定</li> <li>RUnlock() : 解除读锁定</li> <li>Lock() : 写锁定,与 Mutex 完全一致</li> <li>Unlock() : 解除写锁定,与 Mutex 完全一致</li></ol> <h3 id="lock"><a href="#lock" class="header-anchor">#</a> Lock()</h3> <ol><li>获取互斥锁</li> <li>阻塞等待所有读操作结束(如果有读话)</li></ol> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>rw <span class="token operator">*</span>RWMutex<span class="token punctuation">)</span> <span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> race<span class="token punctuation">.</span>Enabled <span class="token punctuation">{</span>
		<span class="token boolean">_</span> <span class="token operator">=</span> rw<span class="token punctuation">.</span>w<span class="token punctuation">.</span>state
		race<span class="token punctuation">.</span><span class="token function">Disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// First, resolve competition with other writers.</span>
	rw<span class="token punctuation">.</span>w<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// Announce to readers there is a pending writer.</span>
	r <span class="token operator">:=</span> atomic<span class="token punctuation">.</span><span class="token function">AddInt32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rw<span class="token punctuation">.</span>readerCount<span class="token punctuation">,</span> <span class="token operator">-</span>rwmutexMaxReaders<span class="token punctuation">)</span> <span class="token operator">+</span> rwmutexMaxReaders
	<span class="token comment">// Wait for active readers.</span>
	<span class="token keyword">if</span> r <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> atomic<span class="token punctuation">.</span><span class="token function">AddInt32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rw<span class="token punctuation">.</span>readerWait<span class="token punctuation">,</span> r<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token function">runtime_SemacquireMutex</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rw<span class="token punctuation">.</span>writerSem<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> race<span class="token punctuation">.</span>Enabled <span class="token punctuation">{</span>
		race<span class="token punctuation">.</span><span class="token function">Enable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		race<span class="token punctuation">.</span><span class="token function">Acquire</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rw<span class="token punctuation">.</span>readerSem<span class="token punctuation">)</span><span class="token punctuation">)</span>
		race<span class="token punctuation">.</span><span class="token function">Acquire</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rw<span class="token punctuation">.</span>writerSem<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><h3 id="unlock"><a href="#unlock" class="header-anchor">#</a> Unlock()</h3> <ol><li>唤醒因读锁定而阻塞的协程(如果有的话)</li> <li>解除互斥锁</li></ol> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>rw <span class="token operator">*</span>RWMutex<span class="token punctuation">)</span> <span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> race<span class="token punctuation">.</span>Enabled <span class="token punctuation">{</span>
		<span class="token boolean">_</span> <span class="token operator">=</span> rw<span class="token punctuation">.</span>w<span class="token punctuation">.</span>state
		race<span class="token punctuation">.</span><span class="token function">Release</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rw<span class="token punctuation">.</span>readerSem<span class="token punctuation">)</span><span class="token punctuation">)</span>
		race<span class="token punctuation">.</span><span class="token function">Disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// Announce to readers there is no active writer.</span>
	r <span class="token operator">:=</span> atomic<span class="token punctuation">.</span><span class="token function">AddInt32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rw<span class="token punctuation">.</span>readerCount<span class="token punctuation">,</span> rwmutexMaxReaders<span class="token punctuation">)</span>
	<span class="token keyword">if</span> r <span class="token operator">&gt;=</span> rwmutexMaxReaders <span class="token punctuation">{</span>
		race<span class="token punctuation">.</span><span class="token function">Enable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token function">throw</span><span class="token punctuation">(</span><span class="token string">&quot;sync: Unlock of unlocked RWMutex&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// Unblock blocked readers, if any.</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">int</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		<span class="token function">runtime_Semrelease</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rw<span class="token punctuation">.</span>readerSem<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token comment">// Allow other writers to proceed.</span>
	rw<span class="token punctuation">.</span>w<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> race<span class="token punctuation">.</span>Enabled <span class="token punctuation">{</span>
		race<span class="token punctuation">.</span><span class="token function">Enable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><h3 id="rlock"><a href="#rlock" class="header-anchor">#</a> RLock()</h3> <ol><li>增加读操作计数,即 readerCount++</li> <li>阻塞,等待写操作结束(如果有读话)</li></ol> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>rw <span class="token operator">*</span>RWMutex<span class="token punctuation">)</span> <span class="token function">RLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> race<span class="token punctuation">.</span>Enabled <span class="token punctuation">{</span>
		<span class="token boolean">_</span> <span class="token operator">=</span> rw<span class="token punctuation">.</span>w<span class="token punctuation">.</span>state
		race<span class="token punctuation">.</span><span class="token function">Disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> atomic<span class="token punctuation">.</span><span class="token function">AddInt32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rw<span class="token punctuation">.</span>readerCount<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token comment">// A writer is pending, wait for it.</span>
		<span class="token function">runtime_SemacquireMutex</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rw<span class="token punctuation">.</span>readerSem<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> race<span class="token punctuation">.</span>Enabled <span class="token punctuation">{</span>
		race<span class="token punctuation">.</span><span class="token function">Enable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		race<span class="token punctuation">.</span><span class="token function">Acquire</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rw<span class="token punctuation">.</span>readerSem<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h3 id="runlock"><a href="#runlock" class="header-anchor">#</a> RUnlock()</h3> <ol><li>减少读操作计数,即 readerCount--</li> <li>唤醒等待写操作的协程(如果有的话)</li></ol> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>rw <span class="token operator">*</span>RWMutex<span class="token punctuation">)</span> <span class="token function">RUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> race<span class="token punctuation">.</span>Enabled <span class="token punctuation">{</span>
		<span class="token boolean">_</span> <span class="token operator">=</span> rw<span class="token punctuation">.</span>w<span class="token punctuation">.</span>state
		race<span class="token punctuation">.</span><span class="token function">ReleaseMerge</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rw<span class="token punctuation">.</span>writerSem<span class="token punctuation">)</span><span class="token punctuation">)</span>
		race<span class="token punctuation">.</span><span class="token function">Disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> r <span class="token operator">:=</span> atomic<span class="token punctuation">.</span><span class="token function">AddInt32</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>rw<span class="token punctuation">.</span>readerCount<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span> r <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token punctuation">{</span>
		<span class="token comment">// Outlined slow-path to allow the fast-path to be inlined</span>
		rw<span class="token punctuation">.</span><span class="token function">rUnlockSlow</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> race<span class="token punctuation">.</span>Enabled <span class="token punctuation">{</span>
		race<span class="token punctuation">.</span><span class="token function">Enable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">最后更新:</span> <span class="time">9/27/2020, 9:20:30 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/m/Go语言之旅/常用数据结构实现原理.html" class="prev">
        第一章 : 常用数据结构实现原理
      </a></span> <span class="next"><a href="/m/Go语言之旅/并发控制.html">
        第五章 : 并发控制
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/m/assets/js/app.71fdaff2.js" defer></script><script src="/m/assets/js/2.351ead77.js" defer></script><script src="/m/assets/js/24.5b681006.js" defer></script>
  </body>
</html>
