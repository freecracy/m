<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>0x03.内存模型 | 嗯哼人生</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="">
    <meta name="referrer" content="no-referrer">
    
    <link rel="preload" href="/m/assets/css/0.styles.1e386fb6.css" as="style"><link rel="preload" href="/m/assets/js/app.71fdaff2.js" as="script"><link rel="preload" href="/m/assets/js/2.351ead77.js" as="script"><link rel="preload" href="/m/assets/js/55.fb9cd8c7.js" as="script"><link rel="prefetch" href="/m/assets/js/10.98c1e7e0.js"><link rel="prefetch" href="/m/assets/js/100.d7774ae1.js"><link rel="prefetch" href="/m/assets/js/101.0d4dea0d.js"><link rel="prefetch" href="/m/assets/js/102.6867f859.js"><link rel="prefetch" href="/m/assets/js/103.9d24bd08.js"><link rel="prefetch" href="/m/assets/js/104.4d59f256.js"><link rel="prefetch" href="/m/assets/js/105.ff49af8e.js"><link rel="prefetch" href="/m/assets/js/106.b26c7611.js"><link rel="prefetch" href="/m/assets/js/107.da5be320.js"><link rel="prefetch" href="/m/assets/js/108.0c03f842.js"><link rel="prefetch" href="/m/assets/js/109.5587de24.js"><link rel="prefetch" href="/m/assets/js/11.4e6d88d4.js"><link rel="prefetch" href="/m/assets/js/110.40ae6022.js"><link rel="prefetch" href="/m/assets/js/111.0353ccf3.js"><link rel="prefetch" href="/m/assets/js/112.f562c096.js"><link rel="prefetch" href="/m/assets/js/113.7926c003.js"><link rel="prefetch" href="/m/assets/js/114.356035f0.js"><link rel="prefetch" href="/m/assets/js/115.15e5e23e.js"><link rel="prefetch" href="/m/assets/js/116.2db2b1ed.js"><link rel="prefetch" href="/m/assets/js/117.2658e42c.js"><link rel="prefetch" href="/m/assets/js/118.037a8503.js"><link rel="prefetch" href="/m/assets/js/119.21153540.js"><link rel="prefetch" href="/m/assets/js/12.c3dadd73.js"><link rel="prefetch" href="/m/assets/js/120.b8f0644f.js"><link rel="prefetch" href="/m/assets/js/121.4c1c263a.js"><link rel="prefetch" href="/m/assets/js/122.d6ba18dd.js"><link rel="prefetch" href="/m/assets/js/123.ceef4883.js"><link rel="prefetch" href="/m/assets/js/124.9e5f50ca.js"><link rel="prefetch" href="/m/assets/js/125.de1ddc80.js"><link rel="prefetch" href="/m/assets/js/126.ae350aea.js"><link rel="prefetch" href="/m/assets/js/127.4636f6be.js"><link rel="prefetch" href="/m/assets/js/128.13b379ab.js"><link rel="prefetch" href="/m/assets/js/129.e7b0a15f.js"><link rel="prefetch" href="/m/assets/js/13.a52bd89b.js"><link rel="prefetch" href="/m/assets/js/130.147cdf11.js"><link rel="prefetch" href="/m/assets/js/131.c7a07871.js"><link rel="prefetch" href="/m/assets/js/132.faf72eb9.js"><link rel="prefetch" href="/m/assets/js/133.6301923b.js"><link rel="prefetch" href="/m/assets/js/134.4357c6e4.js"><link rel="prefetch" href="/m/assets/js/135.0ea43a3d.js"><link rel="prefetch" href="/m/assets/js/136.5a7c2377.js"><link rel="prefetch" href="/m/assets/js/137.393c998e.js"><link rel="prefetch" href="/m/assets/js/138.dcf958b6.js"><link rel="prefetch" href="/m/assets/js/139.1ccac68b.js"><link rel="prefetch" href="/m/assets/js/14.96fff293.js"><link rel="prefetch" href="/m/assets/js/140.938c314e.js"><link rel="prefetch" href="/m/assets/js/141.03cc2137.js"><link rel="prefetch" href="/m/assets/js/142.db00aba9.js"><link rel="prefetch" href="/m/assets/js/143.6d7b22af.js"><link rel="prefetch" href="/m/assets/js/144.850ed5a9.js"><link rel="prefetch" href="/m/assets/js/145.a1958a5f.js"><link rel="prefetch" href="/m/assets/js/146.1b350d4f.js"><link rel="prefetch" href="/m/assets/js/147.961f3ccd.js"><link rel="prefetch" href="/m/assets/js/148.cb4f8811.js"><link rel="prefetch" href="/m/assets/js/149.45ad7c2c.js"><link rel="prefetch" href="/m/assets/js/15.c507965f.js"><link rel="prefetch" href="/m/assets/js/150.5d952b70.js"><link rel="prefetch" href="/m/assets/js/151.5c794bb0.js"><link rel="prefetch" href="/m/assets/js/152.974e657e.js"><link rel="prefetch" href="/m/assets/js/153.b7cf98f6.js"><link rel="prefetch" href="/m/assets/js/154.be904394.js"><link rel="prefetch" href="/m/assets/js/155.769e3b0d.js"><link rel="prefetch" href="/m/assets/js/156.6107a44f.js"><link rel="prefetch" href="/m/assets/js/157.0bf74a2b.js"><link rel="prefetch" href="/m/assets/js/158.d499f907.js"><link rel="prefetch" href="/m/assets/js/159.6b2acd2c.js"><link rel="prefetch" href="/m/assets/js/16.247520d0.js"><link rel="prefetch" href="/m/assets/js/160.ec909209.js"><link rel="prefetch" href="/m/assets/js/161.4832768d.js"><link rel="prefetch" href="/m/assets/js/162.ae74834a.js"><link rel="prefetch" href="/m/assets/js/163.8af51be9.js"><link rel="prefetch" href="/m/assets/js/164.0d64a1ef.js"><link rel="prefetch" href="/m/assets/js/165.5e5a775c.js"><link rel="prefetch" href="/m/assets/js/166.121987f8.js"><link rel="prefetch" href="/m/assets/js/167.1c270942.js"><link rel="prefetch" href="/m/assets/js/168.200df8c8.js"><link rel="prefetch" href="/m/assets/js/169.84f5e0d7.js"><link rel="prefetch" href="/m/assets/js/17.3cb462b5.js"><link rel="prefetch" href="/m/assets/js/170.57b7eec5.js"><link rel="prefetch" href="/m/assets/js/171.d993d636.js"><link rel="prefetch" href="/m/assets/js/172.820d00a1.js"><link rel="prefetch" href="/m/assets/js/173.cc29ff6e.js"><link rel="prefetch" href="/m/assets/js/174.99d62af7.js"><link rel="prefetch" href="/m/assets/js/175.da874148.js"><link rel="prefetch" href="/m/assets/js/176.d0755bfc.js"><link rel="prefetch" href="/m/assets/js/177.8b00d874.js"><link rel="prefetch" href="/m/assets/js/178.2b0cfda8.js"><link rel="prefetch" href="/m/assets/js/179.780a3873.js"><link rel="prefetch" href="/m/assets/js/18.298da910.js"><link rel="prefetch" href="/m/assets/js/180.7c0ac3dc.js"><link rel="prefetch" href="/m/assets/js/181.507f9073.js"><link rel="prefetch" href="/m/assets/js/182.87f76d4a.js"><link rel="prefetch" href="/m/assets/js/183.1410502e.js"><link rel="prefetch" href="/m/assets/js/184.80666cb3.js"><link rel="prefetch" href="/m/assets/js/185.dc628b97.js"><link rel="prefetch" href="/m/assets/js/186.c2560a3f.js"><link rel="prefetch" href="/m/assets/js/187.6af43ea3.js"><link rel="prefetch" href="/m/assets/js/188.da75b50c.js"><link rel="prefetch" href="/m/assets/js/189.78dd960b.js"><link rel="prefetch" href="/m/assets/js/19.d9eabdf8.js"><link rel="prefetch" href="/m/assets/js/190.017586b9.js"><link rel="prefetch" href="/m/assets/js/191.5fa65eb7.js"><link rel="prefetch" href="/m/assets/js/192.5bb628c7.js"><link rel="prefetch" href="/m/assets/js/193.35707c80.js"><link rel="prefetch" href="/m/assets/js/194.35c3b13b.js"><link rel="prefetch" href="/m/assets/js/195.6dc8874b.js"><link rel="prefetch" href="/m/assets/js/196.01a1e825.js"><link rel="prefetch" href="/m/assets/js/197.5745084a.js"><link rel="prefetch" href="/m/assets/js/198.0455ca12.js"><link rel="prefetch" href="/m/assets/js/199.75129c13.js"><link rel="prefetch" href="/m/assets/js/20.ce14ddb9.js"><link rel="prefetch" href="/m/assets/js/200.a08681d0.js"><link rel="prefetch" href="/m/assets/js/201.a54018b7.js"><link rel="prefetch" href="/m/assets/js/202.2361e839.js"><link rel="prefetch" href="/m/assets/js/203.b92491ee.js"><link rel="prefetch" href="/m/assets/js/204.13742571.js"><link rel="prefetch" href="/m/assets/js/205.b066e447.js"><link rel="prefetch" href="/m/assets/js/206.e2c72f2c.js"><link rel="prefetch" href="/m/assets/js/207.09a83a9a.js"><link rel="prefetch" href="/m/assets/js/208.f4b8d71c.js"><link rel="prefetch" href="/m/assets/js/209.1a4e4d18.js"><link rel="prefetch" href="/m/assets/js/21.0dc0e0bf.js"><link rel="prefetch" href="/m/assets/js/210.9709d46f.js"><link rel="prefetch" href="/m/assets/js/211.3704916b.js"><link rel="prefetch" href="/m/assets/js/212.7c96c99f.js"><link rel="prefetch" href="/m/assets/js/213.b4aedaa1.js"><link rel="prefetch" href="/m/assets/js/214.d0b2586b.js"><link rel="prefetch" href="/m/assets/js/215.2268650a.js"><link rel="prefetch" href="/m/assets/js/216.dcaa6f2f.js"><link rel="prefetch" href="/m/assets/js/217.33aaf649.js"><link rel="prefetch" href="/m/assets/js/218.216d8592.js"><link rel="prefetch" href="/m/assets/js/219.44d35873.js"><link rel="prefetch" href="/m/assets/js/22.ce355d8a.js"><link rel="prefetch" href="/m/assets/js/220.ff06fa11.js"><link rel="prefetch" href="/m/assets/js/221.93379b76.js"><link rel="prefetch" href="/m/assets/js/222.6f0bbeea.js"><link rel="prefetch" href="/m/assets/js/223.4c5e29f0.js"><link rel="prefetch" href="/m/assets/js/224.e7be32e4.js"><link rel="prefetch" href="/m/assets/js/225.4915db8f.js"><link rel="prefetch" href="/m/assets/js/226.60f21d11.js"><link rel="prefetch" href="/m/assets/js/227.0e63cf34.js"><link rel="prefetch" href="/m/assets/js/228.e7b7a543.js"><link rel="prefetch" href="/m/assets/js/229.73bf392a.js"><link rel="prefetch" href="/m/assets/js/23.40c917ac.js"><link rel="prefetch" href="/m/assets/js/230.9f789c55.js"><link rel="prefetch" href="/m/assets/js/231.8fd85bc2.js"><link rel="prefetch" href="/m/assets/js/232.e6c4a62c.js"><link rel="prefetch" href="/m/assets/js/233.45636bf3.js"><link rel="prefetch" href="/m/assets/js/234.5194ce16.js"><link rel="prefetch" href="/m/assets/js/235.15ba019b.js"><link rel="prefetch" href="/m/assets/js/236.ac5768c1.js"><link rel="prefetch" href="/m/assets/js/237.91ec2e5a.js"><link rel="prefetch" href="/m/assets/js/238.af630344.js"><link rel="prefetch" href="/m/assets/js/239.b2b84093.js"><link rel="prefetch" href="/m/assets/js/24.5b681006.js"><link rel="prefetch" href="/m/assets/js/240.9c9b1fba.js"><link rel="prefetch" href="/m/assets/js/241.c26c2147.js"><link rel="prefetch" href="/m/assets/js/242.ce44f37f.js"><link rel="prefetch" href="/m/assets/js/243.aa04b829.js"><link rel="prefetch" href="/m/assets/js/244.ee4c9090.js"><link rel="prefetch" href="/m/assets/js/245.62ebda1d.js"><link rel="prefetch" href="/m/assets/js/246.2fd9ce22.js"><link rel="prefetch" href="/m/assets/js/247.52b3e746.js"><link rel="prefetch" href="/m/assets/js/248.2e432a32.js"><link rel="prefetch" href="/m/assets/js/249.4598fccb.js"><link rel="prefetch" href="/m/assets/js/25.d5d6ba55.js"><link rel="prefetch" href="/m/assets/js/250.7c93bc3e.js"><link rel="prefetch" href="/m/assets/js/251.4d402930.js"><link rel="prefetch" href="/m/assets/js/252.1b3fb775.js"><link rel="prefetch" href="/m/assets/js/253.01a9b4f8.js"><link rel="prefetch" href="/m/assets/js/254.29de4256.js"><link rel="prefetch" href="/m/assets/js/255.4911ce12.js"><link rel="prefetch" href="/m/assets/js/256.0a40f8d2.js"><link rel="prefetch" href="/m/assets/js/257.2111ae5e.js"><link rel="prefetch" href="/m/assets/js/258.0e9b2cd1.js"><link rel="prefetch" href="/m/assets/js/259.43158d35.js"><link rel="prefetch" href="/m/assets/js/26.b1e00e8a.js"><link rel="prefetch" href="/m/assets/js/260.72ea8c45.js"><link rel="prefetch" href="/m/assets/js/261.3f679643.js"><link rel="prefetch" href="/m/assets/js/262.d9ecaed6.js"><link rel="prefetch" href="/m/assets/js/27.556976c4.js"><link rel="prefetch" href="/m/assets/js/28.11027d56.js"><link rel="prefetch" href="/m/assets/js/29.f40ac6f5.js"><link rel="prefetch" href="/m/assets/js/3.a2a1a8e5.js"><link rel="prefetch" href="/m/assets/js/30.3b59bb10.js"><link rel="prefetch" href="/m/assets/js/31.c37142be.js"><link rel="prefetch" href="/m/assets/js/32.c5e0d2a0.js"><link rel="prefetch" href="/m/assets/js/33.4f5f3a8d.js"><link rel="prefetch" href="/m/assets/js/34.4a3a9398.js"><link rel="prefetch" href="/m/assets/js/35.77f89f97.js"><link rel="prefetch" href="/m/assets/js/36.6ea00d3c.js"><link rel="prefetch" href="/m/assets/js/37.b5a3b5b4.js"><link rel="prefetch" href="/m/assets/js/38.24b26621.js"><link rel="prefetch" href="/m/assets/js/39.ab372876.js"><link rel="prefetch" href="/m/assets/js/4.b9f14f77.js"><link rel="prefetch" href="/m/assets/js/40.7a81caac.js"><link rel="prefetch" href="/m/assets/js/41.d23cf8c8.js"><link rel="prefetch" href="/m/assets/js/42.ef938986.js"><link rel="prefetch" href="/m/assets/js/43.708a3cf3.js"><link rel="prefetch" href="/m/assets/js/44.f705f7de.js"><link rel="prefetch" href="/m/assets/js/45.0e6afdb6.js"><link rel="prefetch" href="/m/assets/js/46.9815c7cc.js"><link rel="prefetch" href="/m/assets/js/47.5d1c1dcc.js"><link rel="prefetch" href="/m/assets/js/48.d9d571a6.js"><link rel="prefetch" href="/m/assets/js/49.9cbaa1e9.js"><link rel="prefetch" href="/m/assets/js/5.57dbdc35.js"><link rel="prefetch" href="/m/assets/js/50.265f94f4.js"><link rel="prefetch" href="/m/assets/js/51.094b2e7f.js"><link rel="prefetch" href="/m/assets/js/52.8b7101c0.js"><link rel="prefetch" href="/m/assets/js/53.98f3fc0b.js"><link rel="prefetch" href="/m/assets/js/54.b3d830fd.js"><link rel="prefetch" href="/m/assets/js/56.878cf94b.js"><link rel="prefetch" href="/m/assets/js/57.1c819831.js"><link rel="prefetch" href="/m/assets/js/58.ac3faf70.js"><link rel="prefetch" href="/m/assets/js/59.b0483bf9.js"><link rel="prefetch" href="/m/assets/js/6.a0c51186.js"><link rel="prefetch" href="/m/assets/js/60.48c301e6.js"><link rel="prefetch" href="/m/assets/js/61.4bf4f2e7.js"><link rel="prefetch" href="/m/assets/js/62.d927584b.js"><link rel="prefetch" href="/m/assets/js/63.b72a48f3.js"><link rel="prefetch" href="/m/assets/js/64.6923d7c8.js"><link rel="prefetch" href="/m/assets/js/65.042fc335.js"><link rel="prefetch" href="/m/assets/js/66.1afdb278.js"><link rel="prefetch" href="/m/assets/js/67.04f7b0c7.js"><link rel="prefetch" href="/m/assets/js/68.97789db4.js"><link rel="prefetch" href="/m/assets/js/69.d914e9f8.js"><link rel="prefetch" href="/m/assets/js/7.aef5e50f.js"><link rel="prefetch" href="/m/assets/js/70.84845956.js"><link rel="prefetch" href="/m/assets/js/71.d6e9132a.js"><link rel="prefetch" href="/m/assets/js/72.2c1f5783.js"><link rel="prefetch" href="/m/assets/js/73.789e9372.js"><link rel="prefetch" href="/m/assets/js/74.e79f4842.js"><link rel="prefetch" href="/m/assets/js/75.4a389066.js"><link rel="prefetch" href="/m/assets/js/76.f5721f28.js"><link rel="prefetch" href="/m/assets/js/77.e6ce992d.js"><link rel="prefetch" href="/m/assets/js/78.5c31237a.js"><link rel="prefetch" href="/m/assets/js/79.6a4f09e0.js"><link rel="prefetch" href="/m/assets/js/8.aac4a85a.js"><link rel="prefetch" href="/m/assets/js/80.23b925ca.js"><link rel="prefetch" href="/m/assets/js/81.bc8138cb.js"><link rel="prefetch" href="/m/assets/js/82.4783bc83.js"><link rel="prefetch" href="/m/assets/js/83.1be8f057.js"><link rel="prefetch" href="/m/assets/js/84.3132660e.js"><link rel="prefetch" href="/m/assets/js/85.95c5ab8b.js"><link rel="prefetch" href="/m/assets/js/86.17c9a201.js"><link rel="prefetch" href="/m/assets/js/87.daa0da6b.js"><link rel="prefetch" href="/m/assets/js/88.9409cacc.js"><link rel="prefetch" href="/m/assets/js/89.bf04eaa0.js"><link rel="prefetch" href="/m/assets/js/9.0dd0ff11.js"><link rel="prefetch" href="/m/assets/js/90.5e1e2630.js"><link rel="prefetch" href="/m/assets/js/91.6466b581.js"><link rel="prefetch" href="/m/assets/js/92.0dd7ffc6.js"><link rel="prefetch" href="/m/assets/js/93.045047c7.js"><link rel="prefetch" href="/m/assets/js/94.ce06dedb.js"><link rel="prefetch" href="/m/assets/js/95.f673ef28.js"><link rel="prefetch" href="/m/assets/js/96.1f73d13d.js"><link rel="prefetch" href="/m/assets/js/97.b1800fdc.js"><link rel="prefetch" href="/m/assets/js/98.245eb5e4.js"><link rel="prefetch" href="/m/assets/js/99.2cfc78a1.js">
    <link rel="stylesheet" href="/m/assets/css/0.styles.1e386fb6.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/m/" class="home-link router-link-active"><!----> <span class="site-name">嗯哼人生</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/m/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="https://cn100800.tk" target="_blank" rel="noopener noreferrer" class="nav-link external">
  主站
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="mailto:freecracy1024@gmail.com" class="nav-link external">
  mail
  <!----></a></div><div class="nav-item"><a href="https://google.com.hk" target="_blank" rel="noopener noreferrer" class="nav-link external">
  google
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/m/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="https://cn100800.tk" target="_blank" rel="noopener noreferrer" class="nav-link external">
  主站
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="mailto:freecracy1024@gmail.com" class="nav-link external">
  mail
  <!----></a></div><div class="nav-item"><a href="https://google.com.hk" target="_blank" rel="noopener noreferrer" class="nav-link external">
  google
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Go语言之旅</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/m/Go语言之旅/slice.html" class="sidebar-link">slice</a></li><li><a href="/m/Go语言之旅/0x00.开发环境.html" class="sidebar-link">0x00.开发环境</a></li><li><a href="/m/Go语言之旅/0x04.select.html" class="sidebar-link">0x04.select</a></li><li><a href="/m/Go语言之旅/0x05.编译器.html" class="sidebar-link">0x04.编译器</a></li><li><a href="/m/Go语言之旅/0x05.编译器02.html" class="sidebar-link">0x05.编译器02</a></li><li><a href="/m/Go语言之旅/0x06.数据结构.html" class="sidebar-link">0x06.数据结构</a></li><li><a href="/m/Go语言之旅/0x07.context.html" class="sidebar-link">0x07.context</a></li><li><a href="/m/Go语言之旅/0x08.性能剖析.html" class="sidebar-link">0x08.性能剖析</a></li><li><a href="/m/Go语言之旅/0x09.reflect.html" class="sidebar-link">0x09.reflect</a></li><li><a href="/m/Go语言之旅/0x12.interface.html" class="sidebar-link">0x12.interface</a></li><li><a href="/m/Go语言之旅/0x13.package.html" class="sidebar-link">0x13.package</a></li><li><a href="/m/Go语言之旅/0x14.问题集.html" class="sidebar-link">0x14.问题集</a></li><li><a href="/m/Go语言之旅/0x15.leet.html" class="sidebar-link">0x15.leet</a></li><li><a href="/m/Go语言之旅/0x16.命令行参数.html" class="sidebar-link">0x16.命令行参数</a></li><li><a href="/m/Go语言之旅/GODEBUG.html" class="sidebar-link">GODEBUG</a></li><li><a href="/m/Go语言之旅/bitmap.html" class="sidebar-link">bitmap</a></li><li><a href="/m/Go语言之旅/channel.html" class="sidebar-link">channel</a></li><li><a href="/m/Go语言之旅/defer.html" class="sidebar-link">defer</a></li><li><a href="/m/Go语言之旅/gmp模型.html" class="sidebar-link">gmp 模型</a></li><li><a href="/m/Go语言之旅/make.html" class="sidebar-link">make</a></li><li><a href="/m/Go语言之旅/map.html" class="sidebar-link">map</a></li><li><a href="/m/Go语言之旅/mock.html" class="sidebar-link">mock</a></li><li><a href="/m/Go语言之旅/0x03.内存模型.html" class="active sidebar-link">0x03.内存模型</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/m/Go语言之旅/0x03.内存模型.html#内存管理单元" class="sidebar-link">内存管理单元</a></li><li class="sidebar-sub-header"><a href="/m/Go语言之旅/0x03.内存模型.html#堆内存管理" class="sidebar-link">堆内存管理</a></li><li class="sidebar-sub-header"><a href="/m/Go语言之旅/0x03.内存模型.html#全局栈内存管理" class="sidebar-link">全局栈内存管理</a></li><li class="sidebar-sub-header"><a href="/m/Go语言之旅/0x03.内存模型.html#申请内存" class="sidebar-link">申请内存</a></li><li class="sidebar-sub-header"><a href="/m/Go语言之旅/0x03.内存模型.html#栈扩容" class="sidebar-link">栈扩容</a></li><li class="sidebar-sub-header"><a href="/m/Go语言之旅/0x03.内存模型.html#栈收缩" class="sidebar-link">栈收缩</a></li><li class="sidebar-sub-header"><a href="/m/Go语言之旅/0x03.内存模型.html#段错误" class="sidebar-link">段错误</a></li><li class="sidebar-sub-header"><a href="/m/Go语言之旅/0x03.内存模型.html#变量分配" class="sidebar-link">变量分配</a></li><li class="sidebar-sub-header"><a href="/m/Go语言之旅/0x03.内存模型.html#内存清理" class="sidebar-link">内存清理</a></li><li class="sidebar-sub-header"><a href="/m/Go语言之旅/0x03.内存模型.html#goroutine栈" class="sidebar-link">goroutine栈</a></li><li class="sidebar-sub-header"><a href="/m/Go语言之旅/0x03.内存模型.html#逃逸分析" class="sidebar-link">逃逸分析</a></li><li class="sidebar-sub-header"><a href="/m/Go语言之旅/0x03.内存模型.html#内联" class="sidebar-link">内联</a></li><li class="sidebar-sub-header"><a href="/m/Go语言之旅/0x03.内存模型.html#内存分配" class="sidebar-link">内存分配</a></li><li class="sidebar-sub-header"><a href="/m/Go语言之旅/0x03.内存模型.html#内存泄漏" class="sidebar-link">内存泄漏</a></li></ul></li><li><a href="/m/Go语言之旅/tool.html" class="sidebar-link">tool</a></li><li><a href="/m/Go语言之旅/内存管理.html" class="sidebar-link">第四章 : 内存管理</a></li><li><a href="/m/Go语言之旅/协程池.html" class="sidebar-link">协程池</a></li><li><a href="/m/Go语言之旅/协程调度.html" class="sidebar-link">第三章 : 协程调度</a></li><li><a href="/m/Go语言之旅/垃圾回收.html" class="sidebar-link">垃圾回收</a></li><li><a href="/m/Go语言之旅/基础.html" class="sidebar-link">基础</a></li><li><a href="/m/Go语言之旅/工具集.html" class="sidebar-link">工具集</a></li><li><a href="/m/Go语言之旅/常用数据结构实现原理.html" class="sidebar-link">第一章 : 常用数据结构实现原理</a></li><li><a href="/m/Go语言之旅/常见控制结构实现原理.html" class="sidebar-link">第二章 : 常见控制结构实现原理</a></li><li><a href="/m/Go语言之旅/并发控制.html" class="sidebar-link">第五章 : 并发控制</a></li><li><a href="/m/Go语言之旅/思考题.html" class="sidebar-link">思考题</a></li><li><a href="/m/Go语言之旅/文件操作.html" class="sidebar-link">文件操作</a></li><li><a href="/m/Go语言之旅/框架.html" class="sidebar-link">框架</a></li><li><a href="/m/Go语言之旅/泛型.html" class="sidebar-link">泛型</a></li><li><a href="/m/Go语言之旅/版本更新.html" class="sidebar-link">版本更新</a></li><li><a href="/m/Go语言之旅/调试.html" class="sidebar-link">调试</a></li><li><a href="/m/Go语言之旅/进程线程协程.html" class="sidebar-link">进程线程协程</a></li><li><a href="/m/Go语言之旅/部署.html" class="sidebar-link">部署</a></li><li><a href="/m/Go语言之旅/闭包.html" class="sidebar-link">闭包</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>文章</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>标准库</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>源码</span> <span class="arrow right"></span></p> <!----></section></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Redis</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Deno</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>其他</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>周末闲谈</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>深度好文</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>漫步 Linux</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>算法</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>设计模式</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>鸡汤软文</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="_0x03-内存模型"><a href="#_0x03-内存模型" class="header-anchor">#</a> 0x03.内存模型</h1> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">type</span> mcache <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	<span class="token comment">// The following members are accessed on every malloc,</span>
	<span class="token comment">// so they are grouped here for better caching.</span>
	next_sample <span class="token builtin">uintptr</span> <span class="token comment">// trigger heap sample after allocating this many bytes</span>
	local_scan  <span class="token builtin">uintptr</span> <span class="token comment">// bytes of scannable heap allocated</span>

	<span class="token comment">// Allocator cache for tiny objects w/o pointers.</span>
	<span class="token comment">// See &quot;Tiny allocator&quot; comment in malloc.go.</span>

	<span class="token comment">// tiny points to the beginning of the current tiny block, or</span>
	<span class="token comment">// nil if there is no current tiny block.</span>
	<span class="token comment">//</span>
	<span class="token comment">// tiny is a heap pointer. Since mcache is in non-GC'd memory,</span>
	<span class="token comment">// we handle it by clearing it in releaseAll during mark</span>
	<span class="token comment">// termination.</span>
	tiny             <span class="token builtin">uintptr</span>
	tinyoffset       <span class="token builtin">uintptr</span>
	local_tinyallocs <span class="token builtin">uintptr</span> <span class="token comment">// number of tiny allocs not counted in other stats</span>

	<span class="token comment">// The rest is not accessed on every malloc.</span>

	alloc <span class="token punctuation">[</span>numSpanClasses<span class="token punctuation">]</span><span class="token operator">*</span>mspan <span class="token comment">// spans to allocate from, indexed by spanClass</span>

	stackcache <span class="token punctuation">[</span>_NumStackOrders<span class="token punctuation">]</span>stackfreelist

	<span class="token comment">// Local allocator stats, flushed during GC.</span>
	local_largefree  <span class="token builtin">uintptr</span>                  <span class="token comment">// bytes freed for large objects (&gt;maxsmallsize)</span>
	local_nlargefree <span class="token builtin">uintptr</span>                  <span class="token comment">// number of frees for large objects (&gt;maxsmallsize)</span>
	local_nsmallfree <span class="token punctuation">[</span>_NumSizeClasses<span class="token punctuation">]</span><span class="token builtin">uintptr</span> <span class="token comment">// number of frees for small objects (&lt;=maxsmallsize)</span>

	<span class="token comment">// flushGen indicates the sweepgen during which this mcache</span>
	<span class="token comment">// was last flushed. If flushGen != mheap_.sweepgen, the spans</span>
	<span class="token comment">// in this mcache are stale and need to the flushed so they</span>
	<span class="token comment">// can be swept. This is done in acquirep.</span>
	flushGen <span class="token builtin">uint32</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">type</span> mheap <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	<span class="token comment">// lock must only be acquired on the system stack, otherwise a g</span>
	<span class="token comment">// could self-deadlock if its stack grows with the lock held.</span>
	lock      mutex
	free      mTreap <span class="token comment">// free spans</span>
	sweepgen  <span class="token builtin">uint32</span> <span class="token comment">// sweep generation, see comment in mspan</span>
	sweepdone <span class="token builtin">uint32</span> <span class="token comment">// all spans are swept</span>
	sweepers  <span class="token builtin">uint32</span> <span class="token comment">// number of active sweepone calls</span>

	<span class="token comment">// allspans is a slice of all mspans ever created. Each mspan</span>
	<span class="token comment">// appears exactly once.</span>
	<span class="token comment">//</span>
	<span class="token comment">// The memory for allspans is manually managed and can be</span>
	<span class="token comment">// reallocated and move as the heap grows.</span>
	<span class="token comment">//</span>
	<span class="token comment">// In general, allspans is protected by mheap_.lock, which</span>
	<span class="token comment">// prevents concurrent access as well as freeing the backing</span>
	<span class="token comment">// store. Accesses during STW might not hold the lock, but</span>
	<span class="token comment">// must ensure that allocation cannot happen around the</span>
	<span class="token comment">// access (since that may free the backing store).</span>
	allspans <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>mspan <span class="token comment">// all spans out there</span>

	<span class="token comment">// sweepSpans contains two mspan stacks: one of swept in-use</span>
	<span class="token comment">// spans, and one of unswept in-use spans. These two trade</span>
	<span class="token comment">// roles on each GC cycle. Since the sweepgen increases by 2</span>
	<span class="token comment">// on each cycle, this means the swept spans are in</span>
	<span class="token comment">// sweepSpans[sweepgen/2%2] and the unswept spans are in</span>
	<span class="token comment">// sweepSpans[1-sweepgen/2%2]. Sweeping pops spans from the</span>
	<span class="token comment">// unswept stack and pushes spans that are still in-use on the</span>
	<span class="token comment">// swept stack. Likewise, allocating an in-use span pushes it</span>
	<span class="token comment">// on the swept stack.</span>
	sweepSpans <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>gcSweepBuf

	<span class="token boolean">_</span> <span class="token builtin">uint32</span> <span class="token comment">// align uint64 fields on 32-bit for atomics</span>

	<span class="token comment">// Proportional sweep</span>
	<span class="token comment">//</span>
	<span class="token comment">// These parameters represent a linear function from heap_live</span>
	<span class="token comment">// to page sweep count. The proportional sweep system works to</span>
	<span class="token comment">// stay in the black by keeping the current page sweep count</span>
	<span class="token comment">// above this line at the current heap_live.</span>
	<span class="token comment">//</span>
	<span class="token comment">// The line has slope sweepPagesPerByte and passes through a</span>
	<span class="token comment">// basis point at (sweepHeapLiveBasis, pagesSweptBasis). At</span>
	<span class="token comment">// any given time, the system is at (memstats.heap_live,</span>
	<span class="token comment">// pagesSwept) in this space.</span>
	<span class="token comment">//</span>
	<span class="token comment">// It's important that the line pass through a point we</span>
	<span class="token comment">// control rather than simply starting at a (0,0) origin</span>
	<span class="token comment">// because that lets us adjust sweep pacing at any time while</span>
	<span class="token comment">// accounting for current progress. If we could only adjust</span>
	<span class="token comment">// the slope, it would create a discontinuity in debt if any</span>
	<span class="token comment">// progress has already been made.</span>
	pagesInUse         <span class="token builtin">uint64</span>  <span class="token comment">// pages of spans in stats mSpanInUse; R/W with mheap.lock</span>
	pagesSwept         <span class="token builtin">uint64</span>  <span class="token comment">// pages swept this cycle; updated atomically</span>
	pagesSweptBasis    <span class="token builtin">uint64</span>  <span class="token comment">// pagesSwept to use as the origin of the sweep ratio; updated atomically</span>
	sweepHeapLiveBasis <span class="token builtin">uint64</span>  <span class="token comment">// value of heap_live to use as the origin of sweep ratio; written with lock, read without</span>
	sweepPagesPerByte  <span class="token builtin">float64</span> <span class="token comment">// proportional sweep ratio; written with lock, read without</span>
	<span class="token comment">// TODO(austin): pagesInUse should be a uintptr, but the 386</span>
	<span class="token comment">// compiler can't 8-byte align fields.</span>

	<span class="token comment">// Scavenger pacing parameters</span>
	<span class="token comment">//</span>
	<span class="token comment">// The two basis parameters and the scavenge ratio parallel the proportional</span>
	<span class="token comment">// sweeping implementation, the primary differences being that:</span>
	<span class="token comment">//  * Scavenging concerns itself with RSS, estimated as heapRetained()</span>
	<span class="token comment">//  * Rather than pacing the scavenger to the GC, it is paced to a</span>
	<span class="token comment">//    time-based rate computed in gcPaceScavenger.</span>
	<span class="token comment">//</span>
	<span class="token comment">// scavengeRetainedGoal represents our goal RSS.</span>
	<span class="token comment">//</span>
	<span class="token comment">// All fields must be accessed with lock.</span>
	<span class="token comment">//</span>
	<span class="token comment">// TODO(mknyszek): Consider abstracting the basis fields and the scavenge ratio</span>
	<span class="token comment">// into its own type so that this logic may be shared with proportional sweeping.</span>
	scavengeTimeBasis     <span class="token builtin">int64</span>
	scavengeRetainedBasis <span class="token builtin">uint64</span>
	scavengeBytesPerNS    <span class="token builtin">float64</span>
	scavengeRetainedGoal  <span class="token builtin">uint64</span>

	<span class="token comment">// Page reclaimer state</span>

	<span class="token comment">// reclaimIndex is the page index in allArenas of next page to</span>
	<span class="token comment">// reclaim. Specifically, it refers to page (i %</span>
	<span class="token comment">// pagesPerArena) of arena allArenas[i / pagesPerArena].</span>
	<span class="token comment">//</span>
	<span class="token comment">// If this is &gt;= 1&lt;&lt;63, the page reclaimer is done scanning</span>
	<span class="token comment">// the page marks.</span>
	<span class="token comment">//</span>
	<span class="token comment">// This is accessed atomically.</span>
	reclaimIndex <span class="token builtin">uint64</span>
	<span class="token comment">// reclaimCredit is spare credit for extra pages swept. Since</span>
	<span class="token comment">// the page reclaimer works in large chunks, it may reclaim</span>
	<span class="token comment">// more than requested. Any spare pages released go to this</span>
	<span class="token comment">// credit pool.</span>
	<span class="token comment">//</span>
	<span class="token comment">// This is accessed atomically.</span>
	reclaimCredit <span class="token builtin">uintptr</span>

	<span class="token comment">// Malloc stats.</span>
	largealloc  <span class="token builtin">uint64</span>                  <span class="token comment">// bytes allocated for large objects</span>
	nlargealloc <span class="token builtin">uint64</span>                  <span class="token comment">// number of large object allocations</span>
	largefree   <span class="token builtin">uint64</span>                  <span class="token comment">// bytes freed for large objects (&gt;maxsmallsize)</span>
	nlargefree  <span class="token builtin">uint64</span>                  <span class="token comment">// number of frees for large objects (&gt;maxsmallsize)</span>
	nsmallfree  <span class="token punctuation">[</span>_NumSizeClasses<span class="token punctuation">]</span><span class="token builtin">uint64</span> <span class="token comment">// number of frees for small objects (&lt;=maxsmallsize)</span>

	<span class="token comment">// arenas is the heap arena map. It points to the metadata for</span>
	<span class="token comment">// the heap for every arena frame of the entire usable virtual</span>
	<span class="token comment">// address space.</span>
	<span class="token comment">//</span>
	<span class="token comment">// Use arenaIndex to compute indexes into this array.</span>
	<span class="token comment">//</span>
	<span class="token comment">// For regions of the address space that are not backed by the</span>
	<span class="token comment">// Go heap, the arena map contains nil.</span>
	<span class="token comment">//</span>
	<span class="token comment">// Modifications are protected by mheap_.lock. Reads can be</span>
	<span class="token comment">// performed without locking; however, a given entry can</span>
	<span class="token comment">// transition from nil to non-nil at any time when the lock</span>
	<span class="token comment">// isn't held. (Entries never transitions back to nil.)</span>
	<span class="token comment">//</span>
	<span class="token comment">// In general, this is a two-level mapping consisting of an L1</span>
	<span class="token comment">// map and possibly many L2 maps. This saves space when there</span>
	<span class="token comment">// are a huge number of arena frames. However, on many</span>
	<span class="token comment">// platforms (even 64-bit), arenaL1Bits is 0, making this</span>
	<span class="token comment">// effectively a single-level map. In this case, arenas[0]</span>
	<span class="token comment">// will never be nil.</span>
	arenas <span class="token punctuation">[</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> arenaL1Bits<span class="token punctuation">]</span><span class="token operator">*</span><span class="token punctuation">[</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> arenaL2Bits<span class="token punctuation">]</span><span class="token operator">*</span>heapArena

	<span class="token comment">// heapArenaAlloc is pre-reserved space for allocating heapArena</span>
	<span class="token comment">// objects. This is only used on 32-bit, where we pre-reserve</span>
	<span class="token comment">// this space to avoid interleaving it with the heap itself.</span>
	heapArenaAlloc linearAlloc

	<span class="token comment">// arenaHints is a list of addresses at which to attempt to</span>
	<span class="token comment">// add more heap arenas. This is initially populated with a</span>
	<span class="token comment">// set of general hint addresses, and grown with the bounds of</span>
	<span class="token comment">// actual heap arena ranges.</span>
	arenaHints <span class="token operator">*</span>arenaHint

	<span class="token comment">// arena is a pre-reserved space for allocating heap arenas</span>
	<span class="token comment">// (the actual arenas). This is only used on 32-bit.</span>
	arena linearAlloc

	<span class="token comment">// allArenas is the arenaIndex of every mapped arena. This can</span>
	<span class="token comment">// be used to iterate through the address space.</span>
	<span class="token comment">//</span>
	<span class="token comment">// Access is protected by mheap_.lock. However, since this is</span>
	<span class="token comment">// append-only and old backing arrays are never freed, it is</span>
	<span class="token comment">// safe to acquire mheap_.lock, copy the slice header, and</span>
	<span class="token comment">// then release mheap_.lock.</span>
	allArenas <span class="token punctuation">[</span><span class="token punctuation">]</span>arenaIdx

	<span class="token comment">// sweepArenas is a snapshot of allArenas taken at the</span>
	<span class="token comment">// beginning of the sweep cycle. This can be read safely by</span>
	<span class="token comment">// simply blocking GC (by disabling preemption).</span>
	sweepArenas <span class="token punctuation">[</span><span class="token punctuation">]</span>arenaIdx

	<span class="token boolean">_</span> <span class="token builtin">uint32</span> <span class="token comment">// ensure 64-bit alignment of central</span>

	<span class="token comment">// central free lists for small size classes.</span>
	<span class="token comment">// the padding makes sure that the mcentrals are</span>
	<span class="token comment">// spaced CacheLinePadSize bytes apart, so that each mcentral.lock</span>
	<span class="token comment">// gets its own cache line.</span>
	<span class="token comment">// central is indexed by spanClass.</span>
	central <span class="token punctuation">[</span>numSpanClasses<span class="token punctuation">]</span><span class="token keyword">struct</span> <span class="token punctuation">{</span>
		mcentral mcentral
		pad      <span class="token punctuation">[</span>cpu<span class="token punctuation">.</span>CacheLinePadSize <span class="token operator">-</span> unsafe<span class="token punctuation">.</span><span class="token function">Sizeof</span><span class="token punctuation">(</span>mcentral<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">%</span>cpu<span class="token punctuation">.</span>CacheLinePadSize<span class="token punctuation">]</span><span class="token builtin">byte</span>
	<span class="token punctuation">}</span>

	spanalloc             fixalloc <span class="token comment">// allocator for span*</span>
	cachealloc            fixalloc <span class="token comment">// allocator for mcache*</span>
	treapalloc            fixalloc <span class="token comment">// allocator for treapNodes*</span>
	specialfinalizeralloc fixalloc <span class="token comment">// allocator for specialfinalizer*</span>
	specialprofilealloc   fixalloc <span class="token comment">// allocator for specialprofile*</span>
	speciallock           mutex    <span class="token comment">// lock for special record allocators.</span>
	arenaHintAlloc        fixalloc <span class="token comment">// allocator for arenaHints</span>

	unused <span class="token operator">*</span>specialfinalizer <span class="token comment">// never set, just here to force the specialfinalizer type into DWARF</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br></div></div><div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">type</span> mcentral <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	lock      mutex
	spanclass spanClass
	nonempty  mSpanList <span class="token comment">// list of spans with a free object, ie a nonempty free list</span>
	empty     mSpanList <span class="token comment">// list of spans with no free objects (or cached in an mcache)</span>

	<span class="token comment">// nmalloc is the cumulative count of objects allocated from</span>
	<span class="token comment">// this mcentral, assuming all spans in mcaches are</span>
	<span class="token comment">// fully-allocated. Written atomically, read under STW.</span>
	nmalloc <span class="token builtin">uint64</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">type</span> mspan <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	next <span class="token operator">*</span>mspan     <span class="token comment">// next span in list, or nil if none</span>
	prev <span class="token operator">*</span>mspan     <span class="token comment">// previous span in list, or nil if none</span>
	list <span class="token operator">*</span>mSpanList <span class="token comment">// For debugging. TODO: Remove.</span>

	startAddr <span class="token builtin">uintptr</span> <span class="token comment">// address of first byte of span aka s.base()</span>
	npages    <span class="token builtin">uintptr</span> <span class="token comment">// number of pages in span</span>

	manualFreeList gclinkptr <span class="token comment">// list of free objects in mSpanManual spans</span>

	<span class="token comment">// freeindex is the slot index between 0 and nelems at which to begin scanning</span>
	<span class="token comment">// for the next free object in this span.</span>
	<span class="token comment">// Each allocation scans allocBits starting at freeindex until it encounters a 0</span>
	<span class="token comment">// indicating a free object. freeindex is then adjusted so that subsequent scans begin</span>
	<span class="token comment">// just past the newly discovered free object.</span>
	<span class="token comment">//</span>
	<span class="token comment">// If freeindex == nelem, this span has no free objects.</span>
	<span class="token comment">//</span>
	<span class="token comment">// allocBits is a bitmap of objects in this span.</span>
	<span class="token comment">// If n &gt;= freeindex and allocBits[n/8] &amp; (1&lt;&lt;(n%8)) is 0</span>
	<span class="token comment">// then object n is free;</span>
	<span class="token comment">// otherwise, object n is allocated. Bits starting at nelem are</span>
	<span class="token comment">// undefined and should never be referenced.</span>
	<span class="token comment">//</span>
	<span class="token comment">// Object n starts at address n*elemsize + (start &lt;&lt; pageShift).</span>
	freeindex <span class="token builtin">uintptr</span>
	<span class="token comment">// TODO: Look up nelems from sizeclass and remove this field if it</span>
	<span class="token comment">// helps performance.</span>
	nelems <span class="token builtin">uintptr</span> <span class="token comment">// number of object in the span.</span>

	<span class="token comment">// Cache of the allocBits at freeindex. allocCache is shifted</span>
	<span class="token comment">// such that the lowest bit corresponds to the bit freeindex.</span>
	<span class="token comment">// allocCache holds the complement of allocBits, thus allowing</span>
	<span class="token comment">// ctz (count trailing zero) to use it directly.</span>
	<span class="token comment">// allocCache may contain bits beyond s.nelems; the caller must ignore</span>
	<span class="token comment">// these.</span>
	allocCache <span class="token builtin">uint64</span>

	<span class="token comment">// allocBits and gcmarkBits hold pointers to a span's mark and</span>
	<span class="token comment">// allocation bits. The pointers are 8 byte aligned.</span>
	<span class="token comment">// There are three arenas where this data is held.</span>
	<span class="token comment">// free: Dirty arenas that are no longer accessed</span>
	<span class="token comment">//       and can be reused.</span>
	<span class="token comment">// next: Holds information to be used in the next GC cycle.</span>
	<span class="token comment">// current: Information being used during this GC cycle.</span>
	<span class="token comment">// previous: Information being used during the last GC cycle.</span>
	<span class="token comment">// A new GC cycle starts with the call to finishsweep_m.</span>
	<span class="token comment">// finishsweep_m moves the previous arena to the free arena,</span>
	<span class="token comment">// the current arena to the previous arena, and</span>
	<span class="token comment">// the next arena to the current arena.</span>
	<span class="token comment">// The next arena is populated as the spans request</span>
	<span class="token comment">// memory to hold gcmarkBits for the next GC cycle as well</span>
	<span class="token comment">// as allocBits for newly allocated spans.</span>
	<span class="token comment">//</span>
	<span class="token comment">// The pointer arithmetic is done &quot;by hand&quot; instead of using</span>
	<span class="token comment">// arrays to avoid bounds checks along critical performance</span>
	<span class="token comment">// paths.</span>
	<span class="token comment">// The sweep will free the old allocBits and set allocBits to the</span>
	<span class="token comment">// gcmarkBits. The gcmarkBits are replaced with a fresh zeroed</span>
	<span class="token comment">// out memory.</span>
	allocBits  <span class="token operator">*</span>gcBits
	gcmarkBits <span class="token operator">*</span>gcBits

	<span class="token comment">// sweep generation:</span>
	<span class="token comment">// if sweepgen == h-&gt;sweepgen - 2, the span needs sweeping</span>
	<span class="token comment">// if sweepgen == h-&gt;sweepgen - 1, the span is currently being swept</span>
	<span class="token comment">// if sweepgen == h-&gt;sweepgen, the span is swept and ready to use</span>
	<span class="token comment">// if sweepgen == h-&gt;sweepgen + 1, the span was cached before sweep began and is still cached, and needs sweeping</span>
	<span class="token comment">// if sweepgen == h-&gt;sweepgen + 3, the span was swept and then cached and is still cached</span>
	<span class="token comment">// h-&gt;sweepgen is incremented by 2 after every GC</span>

	sweepgen    <span class="token builtin">uint32</span>
	divMul      <span class="token builtin">uint16</span>     <span class="token comment">// for divide by elemsize - divMagic.mul</span>
	baseMask    <span class="token builtin">uint16</span>     <span class="token comment">// if non-0, elemsize is a power of 2, &amp; this will get object allocation base</span>
	allocCount  <span class="token builtin">uint16</span>     <span class="token comment">// number of allocated objects</span>
	spanclass   spanClass  <span class="token comment">// size class and noscan (uint8)</span>
	state       mSpanState <span class="token comment">// mspaninuse etc</span>
	needzero    <span class="token builtin">uint8</span>      <span class="token comment">// needs to be zeroed before allocation</span>
	divShift    <span class="token builtin">uint8</span>      <span class="token comment">// for divide by elemsize - divMagic.shift</span>
	divShift2   <span class="token builtin">uint8</span>      <span class="token comment">// for divide by elemsize - divMagic.shift2</span>
	scavenged   <span class="token builtin">bool</span>       <span class="token comment">// whether this span has had its pages released to the OS</span>
	elemsize    <span class="token builtin">uintptr</span>    <span class="token comment">// computed from sizeclass or from npages</span>
	limit       <span class="token builtin">uintptr</span>    <span class="token comment">// end of data in span</span>
	speciallock mutex      <span class="token comment">// guards specials list</span>
	specials    <span class="token operator">*</span>special   <span class="token comment">// linked list of special records sorted by offset.</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br></div></div><h2 id="内存管理单元"><a href="#内存管理单元" class="header-anchor">#</a> 内存管理单元</h2> <p>mspan、mcache、mcentral、mheap</p> <h2 id="堆内存管理"><a href="#堆内存管理" class="header-anchor">#</a> 堆内存管理</h2> <h2 id="全局栈内存管理"><a href="#全局栈内存管理" class="header-anchor">#</a> 全局栈内存管理</h2> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// rumtime/proc.go</span>
<span class="token function">schedinit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// runtime/stack.go</span>
<span class="token function">stackinit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
stackpool
stackpoolItem
stackLarge
mSpanList
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h2 id="申请内存"><a href="#申请内存" class="header-anchor">#</a> 申请内存</h2> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// runtime/proc.go</span>
<span class="token function">newproc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token function">newproc1</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h2 id="栈扩容"><a href="#栈扩容" class="header-anchor">#</a> 栈扩容</h2> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// rumtime/stack.go</span>
<span class="token function">newstack</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token function">copystack</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h2 id="栈收缩"><a href="#栈收缩" class="header-anchor">#</a> 栈收缩</h2> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// runtime/mgcmark.go</span>
<span class="token function">scanstack</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token function">shrinkstack</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h2 id="段错误"><a href="#段错误" class="header-anchor">#</a> 段错误</h2> <p>指访问的内存超出了系统给这个程序所设定的内存空间,如访问不存在内存地址、访问受保护的内存地址、访问只读内存地址、栈溢出等.</p> <p>进程表(PCB)中保存着物理内存的起始地址(base)和长度(bound结束地址或limit长度).当进程被调度时会操作系统会从PCB中读取base和bound,然后拷贝到cpu寄存器中,cpu会用虚拟地址加base来找到物理地址.如果超出limit就会是一个不属于他的地址.cpu会抛出一个异常,如果操作系统设定了异常处理程序,就会被cpu唤醒,并且知道发生了cpu内存异常,默认给出错进程发送一个信号(SIGSEGV段错误),这个进程因为不合法的内存访问而终止.</p> <p>内存碎片: 操作系统分配了内存,进程却没使用到,</p> <p>分段: 物理内存按照虚拟逻辑段分段,code、heap、stack,虚拟内存会分段映射到物理内存中,根据base和bound来计算,这样heap和stack中的空白就是内存碎片,不用实际分配内存.</p> <p>段共享: 物理内存分段解决了为空闲虚拟内存分配物理内存的问题.还可以在不同进程的虚拟地址中共享物理内存.如两次运行一个程序,代码段是共享的.只要分配独立的heap和stack就可以了.</p> <p>段保护: 每个物理段创建出来会注册一个权限标识,如果是只读的,cpu如果进行写入操作系统就会禁止该行为,如code段,heap和stack是可读可写的不可执行,防止向heap和stack中注入恶意代码.内存段全线可以在运行时改变.</p> <p>mmap可以创建共享区域.</p> <p>分段会造成过多内存碎片,用户级进程会不断分配和释放内存,所以这个段会不断扩张和收缩,操作系统必须维护空闲内存列表.如果空闲内存大于进行请求分配的内存,但这个空闲列表不是连续的.不能把这些空闲分配给进程就会拒绝进程的内存分配请求.操作系统对内存压缩把空闲区域合并成一个大的连续内存块,这样就可以满足之后的内存分配请求了.压缩耗时会占用cpu,</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>/proc/pid/maps <span class="token comment"># 查看进程段</span>
pmap <span class="token comment"># 查看进程段</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>内存分页 : 分页信息会保存保存在一个进程页表到结构中,页表保存物理地址和虚拟地址的映射.页是操作系统管理的最小单元.分页后每个进程关联一个页表结构,不需要使用bound和limit了.而是虚拟页号和页偏移.内存访问一次获取页表,一次获取数据.</p> <p>快速重编址缓存 :</p> <p>段错误 : 虚拟地址转换成物理地址如果这个物理地址超出物理段界限、违反段保护权限,默认情况下操作系统会返回一个SIGSEGV错误信号.默认处理行为是kill这个进程,并输出一个消息<code>segmentation fault</code>说白了就是内存访问错误.</p> <h2 id="变量分配"><a href="#变量分配" class="header-anchor">#</a> 变量分配</h2> <p>提供3种分析变量分配到堆还是栈的分析方式,如果编译器不能确保变量在函数 return 之后不再被引用或者一个局部变量非常大会被分配在堆上而不是栈上,如果一个变量被取地址就有可能被分配到堆上.指针可以减少变量在函数传递时的数据值拷贝,如果分配到堆上 的共享变量过多会增加 GC 压力.</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// 逃逸分析</span>
<span class="token keyword">go</span> build <span class="token operator">-</span>gcflags<span class="token operator">=</span><span class="token string">'-m -m'</span> main<span class="token punctuation">.</span><span class="token keyword">go</span>
<span class="token comment">// 内存分配器追踪</span>
GODEBUG<span class="token operator">=</span>allocfreetrace<span class="token operator">=</span><span class="token number">1</span> <span class="token keyword">go</span> run main<span class="token punctuation">.</span><span class="token keyword">go</span> <span class="token number">2</span><span class="token operator">&gt;</span><span class="token operator">&amp;</span><span class="token number">1</span> <span class="token operator">|</span>grep <span class="token operator">-</span>C <span class="token number">10</span> mian <span class="token comment">// grep 只显示用户代码引发的分配信息</span>
<span class="token comment">// 汇编分析</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>GC会用一个 gcmarkBits 来跟踪正在使用的你村.正在使用的你村会被标记为黑色,当前执行而又不能到达的内存保持为白色</p> <h2 id="内存清理"><a href="#内存清理" class="header-anchor">#</a> 内存清理</h2> <h2 id="goroutine栈"><a href="#goroutine栈" class="header-anchor">#</a> goroutine栈</h2> <p>变量要么在栈中传递要么在堆中共享.只读变量可能分配在代码段.</p> <ol><li>当栈不够用时创建一个更大的栈</li> <li>把老栈所有内容拷贝到新的栈</li> <li>调整拷贝过去的内容中的指针(栈内的地址只被栈里使用,堆内没有使用),把老栈地址改成新栈的(栈内地址减去老栈地址求出相对起始地址的偏移量,然后再加上新栈的起始地址,就可以得到新的内存地址),在堆内的变量无法知道哪个变量用了栈内地址,无法更改它的值,所以有了逃逸分析避免这个问题</li> <li>销毁老的栈</li> <li>goroutine 的栈变大了之后不再收缩,一致保持该大小直到被回收.</li></ol> <h2 id="逃逸分析"><a href="#逃逸分析" class="header-anchor">#</a> 逃逸分析</h2> <p>函数内变量没有被传到函数外就没有逃逸,否则逃逸,逃逸的变量分配到堆上,通过逃逸分析对变量位置分配提前优化,减少堆上变量,减轻 gc 压力.</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// go run -gcflags &quot;-m -l&quot; main.go</span>
<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	result <span class="token operator">:=</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;%v\n&quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>result<span class="token punctuation">)</span> <span class="token comment">// 传给 Prinf 使传递了指针所以发生逃逸</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">add</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
	result <span class="token operator">:=</span> a <span class="token operator">+</span> b
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;%v\n&quot;</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>result<span class="token punctuation">)</span> <span class="token comment">// 传给 Prinf 使传递了指针所以发生逃逸</span>
	<span class="token keyword">return</span> result
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	result <span class="token operator">:=</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;%v\n&quot;</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span> <span class="token comment">// ??? 为什么发送逃逸 ??? 被 fmt.Printf 引用了就会一定发生逃逸</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">add</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
	result <span class="token operator">:=</span> a <span class="token operator">+</span> b
	<span class="token keyword">return</span> result
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h2 id="内联"><a href="#内联" class="header-anchor">#</a> 内联</h2> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// go:noinline</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>禁止 go 对函数内联.内联是一种手动或编译器优化将简短函数调用替换成函数体本身可以消除函数调用开销</p> <h2 id="内存分配"><a href="#内存分配" class="header-anchor">#</a> 内存分配</h2> <p>32k 以下内存申请会从 mcache 分配, mcache 持有一系列大小为 32k 的内存块一个内存块叫一个 msapn,每个 p 会绑定一个 mcache, nache 包含 70 种 mspan 从 8k 到 32k,当 mcache 没有空闲时会从 mcentral 申请, mcentral 持有特定大小的 mspan 列表包含分配出去的和未分配出去的.</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">type</span> mcentral <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    <span class="token comment">// 互斥锁</span>
    lock mutex
    <span class="token comment">// 规格</span>
    sizeclass <span class="token builtin">int32</span>
    <span class="token comment">// 尚有空闲object的mspan链表</span>
    nonempty mSpanList
    <span class="token comment">// 没有空闲object的mspan链表，或者是已被mcache取走的msapn链表</span>
    empty mSpanList
    <span class="token comment">// 已累计分配的对象个数</span>
    nmalloc <span class="token builtin">uint64</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>mheap 主要用于大对象分配,以及管理未切割的 mspan,用于给 mcentral 切割成小对象, mheap 中有所有规格的 mcentral,运行时使用 runtime.heaparea 管理所有内存,每个 heaparea 都会管理 64M 内存.如果 area 没有足够空间会调用 runtime.mhap.sysalloc 从系统申请内存.</p> <h2 id="内存泄漏"><a href="#内存泄漏" class="header-anchor">#</a> 内存泄漏</h2> <p>指程序中动态分配的堆内存由于某种原因未释放或无法释放,造成内存浪费. Go 中内存泄漏大多数原因是 goroutine 泄漏.</p> <blockquote><ol><li>MADV_DONTNEED : 内核会在进程的页表中将这些页标记为<em>未分配</em>,从而进程的 RSS 会尽快释放和变小,OS 后续可以将对应的物理页分配给其他进程</li> <li>MADV_FREE : 内核只会在页表中将这些进程表计为<em>可回收</em>,在需要的时候才回收这些页面</li> <li>1.12 以前 MADV_DONTNEED, 1.12-1.15 MADV_FREE 1.16 MADV_DONTNEED</li></ol></blockquote></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">最后更新:</span> <span class="time">2/10/2021, 10:29:03 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/m/Go语言之旅/mock.html" class="prev">
        mock
      </a></span> <span class="next"><a href="/m/Go语言之旅/tool.html">
        tool
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/m/assets/js/app.71fdaff2.js" defer></script><script src="/m/assets/js/2.351ead77.js" defer></script><script src="/m/assets/js/55.fb9cd8c7.js" defer></script>
  </body>
</html>
