<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>第三章 : 协程调度 | 嗯哼人生</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="">
    <meta name="referrer" content="no-referrer">
    
    <link rel="preload" href="/m/assets/css/0.styles.1e386fb6.css" as="style"><link rel="preload" href="/m/assets/js/app.71fdaff2.js" as="script"><link rel="preload" href="/m/assets/js/2.351ead77.js" as="script"><link rel="preload" href="/m/assets/js/74.e79f4842.js" as="script"><link rel="prefetch" href="/m/assets/js/10.98c1e7e0.js"><link rel="prefetch" href="/m/assets/js/100.d7774ae1.js"><link rel="prefetch" href="/m/assets/js/101.0d4dea0d.js"><link rel="prefetch" href="/m/assets/js/102.6867f859.js"><link rel="prefetch" href="/m/assets/js/103.9d24bd08.js"><link rel="prefetch" href="/m/assets/js/104.4d59f256.js"><link rel="prefetch" href="/m/assets/js/105.ff49af8e.js"><link rel="prefetch" href="/m/assets/js/106.b26c7611.js"><link rel="prefetch" href="/m/assets/js/107.da5be320.js"><link rel="prefetch" href="/m/assets/js/108.0c03f842.js"><link rel="prefetch" href="/m/assets/js/109.5587de24.js"><link rel="prefetch" href="/m/assets/js/11.4e6d88d4.js"><link rel="prefetch" href="/m/assets/js/110.40ae6022.js"><link rel="prefetch" href="/m/assets/js/111.0353ccf3.js"><link rel="prefetch" href="/m/assets/js/112.f562c096.js"><link rel="prefetch" href="/m/assets/js/113.7926c003.js"><link rel="prefetch" href="/m/assets/js/114.356035f0.js"><link rel="prefetch" href="/m/assets/js/115.15e5e23e.js"><link rel="prefetch" href="/m/assets/js/116.2db2b1ed.js"><link rel="prefetch" href="/m/assets/js/117.2658e42c.js"><link rel="prefetch" href="/m/assets/js/118.037a8503.js"><link rel="prefetch" href="/m/assets/js/119.21153540.js"><link rel="prefetch" href="/m/assets/js/12.c3dadd73.js"><link rel="prefetch" href="/m/assets/js/120.b8f0644f.js"><link rel="prefetch" href="/m/assets/js/121.4c1c263a.js"><link rel="prefetch" href="/m/assets/js/122.d6ba18dd.js"><link rel="prefetch" href="/m/assets/js/123.ceef4883.js"><link rel="prefetch" href="/m/assets/js/124.9e5f50ca.js"><link rel="prefetch" href="/m/assets/js/125.de1ddc80.js"><link rel="prefetch" href="/m/assets/js/126.ae350aea.js"><link rel="prefetch" href="/m/assets/js/127.4636f6be.js"><link rel="prefetch" href="/m/assets/js/128.13b379ab.js"><link rel="prefetch" href="/m/assets/js/129.e7b0a15f.js"><link rel="prefetch" href="/m/assets/js/13.a52bd89b.js"><link rel="prefetch" href="/m/assets/js/130.147cdf11.js"><link rel="prefetch" href="/m/assets/js/131.c7a07871.js"><link rel="prefetch" href="/m/assets/js/132.faf72eb9.js"><link rel="prefetch" href="/m/assets/js/133.6301923b.js"><link rel="prefetch" href="/m/assets/js/134.4357c6e4.js"><link rel="prefetch" href="/m/assets/js/135.0ea43a3d.js"><link rel="prefetch" href="/m/assets/js/136.5a7c2377.js"><link rel="prefetch" href="/m/assets/js/137.393c998e.js"><link rel="prefetch" href="/m/assets/js/138.dcf958b6.js"><link rel="prefetch" href="/m/assets/js/139.1ccac68b.js"><link rel="prefetch" href="/m/assets/js/14.96fff293.js"><link rel="prefetch" href="/m/assets/js/140.938c314e.js"><link rel="prefetch" href="/m/assets/js/141.03cc2137.js"><link rel="prefetch" href="/m/assets/js/142.db00aba9.js"><link rel="prefetch" href="/m/assets/js/143.6d7b22af.js"><link rel="prefetch" href="/m/assets/js/144.850ed5a9.js"><link rel="prefetch" href="/m/assets/js/145.a1958a5f.js"><link rel="prefetch" href="/m/assets/js/146.1b350d4f.js"><link rel="prefetch" href="/m/assets/js/147.961f3ccd.js"><link rel="prefetch" href="/m/assets/js/148.cb4f8811.js"><link rel="prefetch" href="/m/assets/js/149.45ad7c2c.js"><link rel="prefetch" href="/m/assets/js/15.c507965f.js"><link rel="prefetch" href="/m/assets/js/150.5d952b70.js"><link rel="prefetch" href="/m/assets/js/151.5c794bb0.js"><link rel="prefetch" href="/m/assets/js/152.974e657e.js"><link rel="prefetch" href="/m/assets/js/153.b7cf98f6.js"><link rel="prefetch" href="/m/assets/js/154.be904394.js"><link rel="prefetch" href="/m/assets/js/155.769e3b0d.js"><link rel="prefetch" href="/m/assets/js/156.6107a44f.js"><link rel="prefetch" href="/m/assets/js/157.0bf74a2b.js"><link rel="prefetch" href="/m/assets/js/158.d499f907.js"><link rel="prefetch" href="/m/assets/js/159.6b2acd2c.js"><link rel="prefetch" href="/m/assets/js/16.247520d0.js"><link rel="prefetch" href="/m/assets/js/160.ec909209.js"><link rel="prefetch" href="/m/assets/js/161.4832768d.js"><link rel="prefetch" href="/m/assets/js/162.ae74834a.js"><link rel="prefetch" href="/m/assets/js/163.8af51be9.js"><link rel="prefetch" href="/m/assets/js/164.0d64a1ef.js"><link rel="prefetch" href="/m/assets/js/165.5e5a775c.js"><link rel="prefetch" href="/m/assets/js/166.121987f8.js"><link rel="prefetch" href="/m/assets/js/167.1c270942.js"><link rel="prefetch" href="/m/assets/js/168.200df8c8.js"><link rel="prefetch" href="/m/assets/js/169.84f5e0d7.js"><link rel="prefetch" href="/m/assets/js/17.3cb462b5.js"><link rel="prefetch" href="/m/assets/js/170.57b7eec5.js"><link rel="prefetch" href="/m/assets/js/171.d993d636.js"><link rel="prefetch" href="/m/assets/js/172.820d00a1.js"><link rel="prefetch" href="/m/assets/js/173.cc29ff6e.js"><link rel="prefetch" href="/m/assets/js/174.99d62af7.js"><link rel="prefetch" href="/m/assets/js/175.da874148.js"><link rel="prefetch" href="/m/assets/js/176.d0755bfc.js"><link rel="prefetch" href="/m/assets/js/177.8b00d874.js"><link rel="prefetch" href="/m/assets/js/178.2b0cfda8.js"><link rel="prefetch" href="/m/assets/js/179.780a3873.js"><link rel="prefetch" href="/m/assets/js/18.298da910.js"><link rel="prefetch" href="/m/assets/js/180.7c0ac3dc.js"><link rel="prefetch" href="/m/assets/js/181.507f9073.js"><link rel="prefetch" href="/m/assets/js/182.87f76d4a.js"><link rel="prefetch" href="/m/assets/js/183.1410502e.js"><link rel="prefetch" href="/m/assets/js/184.80666cb3.js"><link rel="prefetch" href="/m/assets/js/185.dc628b97.js"><link rel="prefetch" href="/m/assets/js/186.c2560a3f.js"><link rel="prefetch" href="/m/assets/js/187.6af43ea3.js"><link rel="prefetch" href="/m/assets/js/188.da75b50c.js"><link rel="prefetch" href="/m/assets/js/189.78dd960b.js"><link rel="prefetch" href="/m/assets/js/19.d9eabdf8.js"><link rel="prefetch" href="/m/assets/js/190.017586b9.js"><link rel="prefetch" href="/m/assets/js/191.5fa65eb7.js"><link rel="prefetch" href="/m/assets/js/192.5bb628c7.js"><link rel="prefetch" href="/m/assets/js/193.35707c80.js"><link rel="prefetch" href="/m/assets/js/194.35c3b13b.js"><link rel="prefetch" href="/m/assets/js/195.6dc8874b.js"><link rel="prefetch" href="/m/assets/js/196.01a1e825.js"><link rel="prefetch" href="/m/assets/js/197.5745084a.js"><link rel="prefetch" href="/m/assets/js/198.0455ca12.js"><link rel="prefetch" href="/m/assets/js/199.75129c13.js"><link rel="prefetch" href="/m/assets/js/20.ce14ddb9.js"><link rel="prefetch" href="/m/assets/js/200.a08681d0.js"><link rel="prefetch" href="/m/assets/js/201.a54018b7.js"><link rel="prefetch" href="/m/assets/js/202.2361e839.js"><link rel="prefetch" href="/m/assets/js/203.b92491ee.js"><link rel="prefetch" href="/m/assets/js/204.13742571.js"><link rel="prefetch" href="/m/assets/js/205.b066e447.js"><link rel="prefetch" href="/m/assets/js/206.e2c72f2c.js"><link rel="prefetch" href="/m/assets/js/207.09a83a9a.js"><link rel="prefetch" href="/m/assets/js/208.f4b8d71c.js"><link rel="prefetch" href="/m/assets/js/209.1a4e4d18.js"><link rel="prefetch" href="/m/assets/js/21.0dc0e0bf.js"><link rel="prefetch" href="/m/assets/js/210.9709d46f.js"><link rel="prefetch" href="/m/assets/js/211.3704916b.js"><link rel="prefetch" href="/m/assets/js/212.7c96c99f.js"><link rel="prefetch" href="/m/assets/js/213.b4aedaa1.js"><link rel="prefetch" href="/m/assets/js/214.d0b2586b.js"><link rel="prefetch" href="/m/assets/js/215.2268650a.js"><link rel="prefetch" href="/m/assets/js/216.dcaa6f2f.js"><link rel="prefetch" href="/m/assets/js/217.33aaf649.js"><link rel="prefetch" href="/m/assets/js/218.216d8592.js"><link rel="prefetch" href="/m/assets/js/219.44d35873.js"><link rel="prefetch" href="/m/assets/js/22.ce355d8a.js"><link rel="prefetch" href="/m/assets/js/220.ff06fa11.js"><link rel="prefetch" href="/m/assets/js/221.93379b76.js"><link rel="prefetch" href="/m/assets/js/222.6f0bbeea.js"><link rel="prefetch" href="/m/assets/js/223.4c5e29f0.js"><link rel="prefetch" href="/m/assets/js/224.e7be32e4.js"><link rel="prefetch" href="/m/assets/js/225.4915db8f.js"><link rel="prefetch" href="/m/assets/js/226.60f21d11.js"><link rel="prefetch" href="/m/assets/js/227.0e63cf34.js"><link rel="prefetch" href="/m/assets/js/228.e7b7a543.js"><link rel="prefetch" href="/m/assets/js/229.73bf392a.js"><link rel="prefetch" href="/m/assets/js/23.40c917ac.js"><link rel="prefetch" href="/m/assets/js/230.9f789c55.js"><link rel="prefetch" href="/m/assets/js/231.8fd85bc2.js"><link rel="prefetch" href="/m/assets/js/232.e6c4a62c.js"><link rel="prefetch" href="/m/assets/js/233.45636bf3.js"><link rel="prefetch" href="/m/assets/js/234.5194ce16.js"><link rel="prefetch" href="/m/assets/js/235.15ba019b.js"><link rel="prefetch" href="/m/assets/js/236.ac5768c1.js"><link rel="prefetch" href="/m/assets/js/237.91ec2e5a.js"><link rel="prefetch" href="/m/assets/js/238.af630344.js"><link rel="prefetch" href="/m/assets/js/239.b2b84093.js"><link rel="prefetch" href="/m/assets/js/24.5b681006.js"><link rel="prefetch" href="/m/assets/js/240.9c9b1fba.js"><link rel="prefetch" href="/m/assets/js/241.c26c2147.js"><link rel="prefetch" href="/m/assets/js/242.ce44f37f.js"><link rel="prefetch" href="/m/assets/js/243.aa04b829.js"><link rel="prefetch" href="/m/assets/js/244.ee4c9090.js"><link rel="prefetch" href="/m/assets/js/245.62ebda1d.js"><link rel="prefetch" href="/m/assets/js/246.2fd9ce22.js"><link rel="prefetch" href="/m/assets/js/247.52b3e746.js"><link rel="prefetch" href="/m/assets/js/248.2e432a32.js"><link rel="prefetch" href="/m/assets/js/249.4598fccb.js"><link rel="prefetch" href="/m/assets/js/25.d5d6ba55.js"><link rel="prefetch" href="/m/assets/js/250.7c93bc3e.js"><link rel="prefetch" href="/m/assets/js/251.4d402930.js"><link rel="prefetch" href="/m/assets/js/252.1b3fb775.js"><link rel="prefetch" href="/m/assets/js/253.01a9b4f8.js"><link rel="prefetch" href="/m/assets/js/254.29de4256.js"><link rel="prefetch" href="/m/assets/js/255.4911ce12.js"><link rel="prefetch" href="/m/assets/js/256.0a40f8d2.js"><link rel="prefetch" href="/m/assets/js/257.2111ae5e.js"><link rel="prefetch" href="/m/assets/js/258.0e9b2cd1.js"><link rel="prefetch" href="/m/assets/js/259.43158d35.js"><link rel="prefetch" href="/m/assets/js/26.b1e00e8a.js"><link rel="prefetch" href="/m/assets/js/260.72ea8c45.js"><link rel="prefetch" href="/m/assets/js/261.3f679643.js"><link rel="prefetch" href="/m/assets/js/262.d9ecaed6.js"><link rel="prefetch" href="/m/assets/js/27.556976c4.js"><link rel="prefetch" href="/m/assets/js/28.11027d56.js"><link rel="prefetch" href="/m/assets/js/29.f40ac6f5.js"><link rel="prefetch" href="/m/assets/js/3.a2a1a8e5.js"><link rel="prefetch" href="/m/assets/js/30.3b59bb10.js"><link rel="prefetch" href="/m/assets/js/31.c37142be.js"><link rel="prefetch" href="/m/assets/js/32.c5e0d2a0.js"><link rel="prefetch" href="/m/assets/js/33.4f5f3a8d.js"><link rel="prefetch" href="/m/assets/js/34.4a3a9398.js"><link rel="prefetch" href="/m/assets/js/35.77f89f97.js"><link rel="prefetch" href="/m/assets/js/36.6ea00d3c.js"><link rel="prefetch" href="/m/assets/js/37.b5a3b5b4.js"><link rel="prefetch" href="/m/assets/js/38.24b26621.js"><link rel="prefetch" href="/m/assets/js/39.ab372876.js"><link rel="prefetch" href="/m/assets/js/4.b9f14f77.js"><link rel="prefetch" href="/m/assets/js/40.7a81caac.js"><link rel="prefetch" href="/m/assets/js/41.d23cf8c8.js"><link rel="prefetch" href="/m/assets/js/42.ef938986.js"><link rel="prefetch" href="/m/assets/js/43.708a3cf3.js"><link rel="prefetch" href="/m/assets/js/44.f705f7de.js"><link rel="prefetch" href="/m/assets/js/45.0e6afdb6.js"><link rel="prefetch" href="/m/assets/js/46.9815c7cc.js"><link rel="prefetch" href="/m/assets/js/47.5d1c1dcc.js"><link rel="prefetch" href="/m/assets/js/48.d9d571a6.js"><link rel="prefetch" href="/m/assets/js/49.9cbaa1e9.js"><link rel="prefetch" href="/m/assets/js/5.57dbdc35.js"><link rel="prefetch" href="/m/assets/js/50.265f94f4.js"><link rel="prefetch" href="/m/assets/js/51.094b2e7f.js"><link rel="prefetch" href="/m/assets/js/52.8b7101c0.js"><link rel="prefetch" href="/m/assets/js/53.98f3fc0b.js"><link rel="prefetch" href="/m/assets/js/54.b3d830fd.js"><link rel="prefetch" href="/m/assets/js/55.fb9cd8c7.js"><link rel="prefetch" href="/m/assets/js/56.878cf94b.js"><link rel="prefetch" href="/m/assets/js/57.1c819831.js"><link rel="prefetch" href="/m/assets/js/58.ac3faf70.js"><link rel="prefetch" href="/m/assets/js/59.b0483bf9.js"><link rel="prefetch" href="/m/assets/js/6.a0c51186.js"><link rel="prefetch" href="/m/assets/js/60.48c301e6.js"><link rel="prefetch" href="/m/assets/js/61.4bf4f2e7.js"><link rel="prefetch" href="/m/assets/js/62.d927584b.js"><link rel="prefetch" href="/m/assets/js/63.b72a48f3.js"><link rel="prefetch" href="/m/assets/js/64.6923d7c8.js"><link rel="prefetch" href="/m/assets/js/65.042fc335.js"><link rel="prefetch" href="/m/assets/js/66.1afdb278.js"><link rel="prefetch" href="/m/assets/js/67.04f7b0c7.js"><link rel="prefetch" href="/m/assets/js/68.97789db4.js"><link rel="prefetch" href="/m/assets/js/69.d914e9f8.js"><link rel="prefetch" href="/m/assets/js/7.aef5e50f.js"><link rel="prefetch" href="/m/assets/js/70.84845956.js"><link rel="prefetch" href="/m/assets/js/71.d6e9132a.js"><link rel="prefetch" href="/m/assets/js/72.2c1f5783.js"><link rel="prefetch" href="/m/assets/js/73.789e9372.js"><link rel="prefetch" href="/m/assets/js/75.4a389066.js"><link rel="prefetch" href="/m/assets/js/76.f5721f28.js"><link rel="prefetch" href="/m/assets/js/77.e6ce992d.js"><link rel="prefetch" href="/m/assets/js/78.5c31237a.js"><link rel="prefetch" href="/m/assets/js/79.6a4f09e0.js"><link rel="prefetch" href="/m/assets/js/8.aac4a85a.js"><link rel="prefetch" href="/m/assets/js/80.23b925ca.js"><link rel="prefetch" href="/m/assets/js/81.bc8138cb.js"><link rel="prefetch" href="/m/assets/js/82.4783bc83.js"><link rel="prefetch" href="/m/assets/js/83.1be8f057.js"><link rel="prefetch" href="/m/assets/js/84.3132660e.js"><link rel="prefetch" href="/m/assets/js/85.95c5ab8b.js"><link rel="prefetch" href="/m/assets/js/86.17c9a201.js"><link rel="prefetch" href="/m/assets/js/87.daa0da6b.js"><link rel="prefetch" href="/m/assets/js/88.9409cacc.js"><link rel="prefetch" href="/m/assets/js/89.bf04eaa0.js"><link rel="prefetch" href="/m/assets/js/9.0dd0ff11.js"><link rel="prefetch" href="/m/assets/js/90.5e1e2630.js"><link rel="prefetch" href="/m/assets/js/91.6466b581.js"><link rel="prefetch" href="/m/assets/js/92.0dd7ffc6.js"><link rel="prefetch" href="/m/assets/js/93.045047c7.js"><link rel="prefetch" href="/m/assets/js/94.ce06dedb.js"><link rel="prefetch" href="/m/assets/js/95.f673ef28.js"><link rel="prefetch" href="/m/assets/js/96.1f73d13d.js"><link rel="prefetch" href="/m/assets/js/97.b1800fdc.js"><link rel="prefetch" href="/m/assets/js/98.245eb5e4.js"><link rel="prefetch" href="/m/assets/js/99.2cfc78a1.js">
    <link rel="stylesheet" href="/m/assets/css/0.styles.1e386fb6.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/m/" class="home-link router-link-active"><!----> <span class="site-name">嗯哼人生</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/m/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="https://cn100800.tk" target="_blank" rel="noopener noreferrer" class="nav-link external">
  主站
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="mailto:freecracy1024@gmail.com" class="nav-link external">
  mail
  <!----></a></div><div class="nav-item"><a href="https://google.com.hk" target="_blank" rel="noopener noreferrer" class="nav-link external">
  google
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/m/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="https://cn100800.tk" target="_blank" rel="noopener noreferrer" class="nav-link external">
  主站
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="mailto:freecracy1024@gmail.com" class="nav-link external">
  mail
  <!----></a></div><div class="nav-item"><a href="https://google.com.hk" target="_blank" rel="noopener noreferrer" class="nav-link external">
  google
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Go语言之旅</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/m/Go语言之旅/slice.html" class="sidebar-link">slice</a></li><li><a href="/m/Go语言之旅/0x00.开发环境.html" class="sidebar-link">0x00.开发环境</a></li><li><a href="/m/Go语言之旅/0x04.select.html" class="sidebar-link">0x04.select</a></li><li><a href="/m/Go语言之旅/0x05.编译器.html" class="sidebar-link">0x04.编译器</a></li><li><a href="/m/Go语言之旅/0x05.编译器02.html" class="sidebar-link">0x05.编译器02</a></li><li><a href="/m/Go语言之旅/0x06.数据结构.html" class="sidebar-link">0x06.数据结构</a></li><li><a href="/m/Go语言之旅/0x07.context.html" class="sidebar-link">0x07.context</a></li><li><a href="/m/Go语言之旅/0x08.性能剖析.html" class="sidebar-link">0x08.性能剖析</a></li><li><a href="/m/Go语言之旅/0x09.reflect.html" class="sidebar-link">0x09.reflect</a></li><li><a href="/m/Go语言之旅/0x12.interface.html" class="sidebar-link">0x12.interface</a></li><li><a href="/m/Go语言之旅/0x13.package.html" class="sidebar-link">0x13.package</a></li><li><a href="/m/Go语言之旅/0x14.问题集.html" class="sidebar-link">0x14.问题集</a></li><li><a href="/m/Go语言之旅/0x15.leet.html" class="sidebar-link">0x15.leet</a></li><li><a href="/m/Go语言之旅/0x16.命令行参数.html" class="sidebar-link">0x16.命令行参数</a></li><li><a href="/m/Go语言之旅/GODEBUG.html" class="sidebar-link">GODEBUG</a></li><li><a href="/m/Go语言之旅/bitmap.html" class="sidebar-link">bitmap</a></li><li><a href="/m/Go语言之旅/channel.html" class="sidebar-link">channel</a></li><li><a href="/m/Go语言之旅/defer.html" class="sidebar-link">defer</a></li><li><a href="/m/Go语言之旅/gmp模型.html" class="sidebar-link">gmp 模型</a></li><li><a href="/m/Go语言之旅/make.html" class="sidebar-link">make</a></li><li><a href="/m/Go语言之旅/map.html" class="sidebar-link">map</a></li><li><a href="/m/Go语言之旅/mock.html" class="sidebar-link">mock</a></li><li><a href="/m/Go语言之旅/0x03.内存模型.html" class="sidebar-link">0x03.内存模型</a></li><li><a href="/m/Go语言之旅/tool.html" class="sidebar-link">tool</a></li><li><a href="/m/Go语言之旅/内存管理.html" class="sidebar-link">第四章 : 内存管理</a></li><li><a href="/m/Go语言之旅/协程池.html" class="sidebar-link">协程池</a></li><li><a href="/m/Go语言之旅/协程调度.html" class="active sidebar-link">第三章 : 协程调度</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/m/Go语言之旅/协程调度.html#线程池的缺陷" class="sidebar-link">线程池的缺陷</a></li><li class="sidebar-sub-header"><a href="/m/Go语言之旅/协程调度.html#goroutine-调度器" class="sidebar-link">goroutine 调度器</a></li><li class="sidebar-sub-header"><a href="/m/Go语言之旅/协程调度.html#系统监视器" class="sidebar-link">系统监视器</a></li><li class="sidebar-sub-header"><a href="/m/Go语言之旅/协程调度.html#协程数" class="sidebar-link">协程数</a></li><li class="sidebar-sub-header"><a href="/m/Go语言之旅/协程调度.html#协程创建" class="sidebar-link">协程创建</a></li><li class="sidebar-sub-header"><a href="/m/Go语言之旅/协程调度.html#协程退出" class="sidebar-link">协程退出</a></li><li class="sidebar-sub-header"><a href="/m/Go语言之旅/协程调度.html#channel-阻塞-goroutine-阻塞和唤醒" class="sidebar-link">channel 阻塞, goroutine 阻塞和唤醒</a></li><li class="sidebar-sub-header"><a href="/m/Go语言之旅/协程调度.html#g0" class="sidebar-link">g0</a></li><li class="sidebar-sub-header"><a href="/m/Go语言之旅/协程调度.html#关闭异步抢占" class="sidebar-link">关闭异步抢占</a></li><li class="sidebar-sub-header"><a href="/m/Go语言之旅/协程调度.html#gsignal" class="sidebar-link">gsignal</a></li></ul></li><li><a href="/m/Go语言之旅/垃圾回收.html" class="sidebar-link">垃圾回收</a></li><li><a href="/m/Go语言之旅/基础.html" class="sidebar-link">基础</a></li><li><a href="/m/Go语言之旅/工具集.html" class="sidebar-link">工具集</a></li><li><a href="/m/Go语言之旅/常用数据结构实现原理.html" class="sidebar-link">第一章 : 常用数据结构实现原理</a></li><li><a href="/m/Go语言之旅/常见控制结构实现原理.html" class="sidebar-link">第二章 : 常见控制结构实现原理</a></li><li><a href="/m/Go语言之旅/并发控制.html" class="sidebar-link">第五章 : 并发控制</a></li><li><a href="/m/Go语言之旅/思考题.html" class="sidebar-link">思考题</a></li><li><a href="/m/Go语言之旅/文件操作.html" class="sidebar-link">文件操作</a></li><li><a href="/m/Go语言之旅/框架.html" class="sidebar-link">框架</a></li><li><a href="/m/Go语言之旅/泛型.html" class="sidebar-link">泛型</a></li><li><a href="/m/Go语言之旅/版本更新.html" class="sidebar-link">版本更新</a></li><li><a href="/m/Go语言之旅/调试.html" class="sidebar-link">调试</a></li><li><a href="/m/Go语言之旅/进程线程协程.html" class="sidebar-link">进程线程协程</a></li><li><a href="/m/Go语言之旅/部署.html" class="sidebar-link">部署</a></li><li><a href="/m/Go语言之旅/闭包.html" class="sidebar-link">闭包</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>文章</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>标准库</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>源码</span> <span class="arrow right"></span></p> <!----></section></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Redis</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Deno</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>其他</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>周末闲谈</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>深度好文</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>漫步 Linux</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>算法</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>设计模式</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>鸡汤软文</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="第三章-协程调度"><a href="#第三章-协程调度" class="header-anchor">#</a> 第三章 : 协程调度</h1> <h2 id="线程池的缺陷"><a href="#线程池的缺陷" class="header-anchor">#</a> 线程池的缺陷</h2> <p>高并发场景频繁创建线程会造成不必要的开销,所以有了线程池.线程池中预先保存一定数量的线程,而新任务将不再以创建线程的方式执行,而是将任务发布到任务队列,线程池中的线程不断的从任务队列中取出任务并执行,可以有效的减少线程创建和销毁带来的开销.线程池中线程的调度完全交给操作系统进行调度.如果 worker 线程执行的任务发生系统调用则操作系统会将该线程置为阻塞状态,该线程怠工,也就意味着消费任务队列的 worker 线程变少了,也就是说线程池消费任务队列的能力变弱了.如果任务队列里的大部分任务都会进行系统调用,大部分 worker 线程会进入阻塞状态,从而任务队列里的任务产生堆积.解决该问题的一个思路是重新审视线程池中线程的数量,增加线程池中线程数量可以提高消费能力,但随着线程数量增多,会产生过多线程争抢 cpu,消费能力会有上限,甚至出现消费能力下降.</p> <h2 id="goroutine-调度器"><a href="#goroutine-调度器" class="header-anchor">#</a> goroutine 调度器</h2> <p>线程数量过多意味着操作系统会不断的切换线程,频繁上下文切换就成了性能瓶颈. go 提供一种机制可以在线程种自己实现调度,上下文切换更轻量做到线程数少,并发数并不少的效果.</p> <ol><li>G : 协程,每个 go 关键字会创建一个协程,从技术角度来说<code>协程就是你可以暂停执行的函数</code></li> <li>M : 工作线程,称作 Machine</li> <li>P : 处理器,包含运行代码的必要资源,也有调度 G 的能力,不是指 cpu</li></ol> <p>M 必须拥有 P 才可以执行 G 中的代码, P 包含一个包含多个 G 的本地队列, P 可以调度 G 交由 M 执行.P 的个数在程序启动时决定,默认等同于 cpu 核数, M 必须持有一个 P 才可以运行 G,所以同时运行的 M 个数,以达到尽可能使用 cpu 也不会产生过多的线程切换开销.</p> <p>协程拥有自己的寄存器上下文和栈协程调度切换时将寄存器上下文和栈保存到其它地方切换回来时恢复先前保存的上下文和栈,直接操作栈基本没有内核切换开销,可以不加锁的访问全局变量,所以上下文切换非常快.</p> <h3 id="p-和-m-哪个个数多"><a href="#p-和-m-哪个个数多" class="header-anchor">#</a> P 和 M 哪个个数多</h3> <p>M 多 ??</p> <h3 id="队列轮转"><a href="#队列轮转" class="header-anchor">#</a> 队列轮转</h3> <p>每个 P 维护一个本地队列,不考虑 G 进入系统调用或 io 操作的情况下, P 周期性的将 G 调度到 M 中执行,执行一小段时间将上下文保存下来然后将 G 放到队列尾部,然后从队列中重新取出一个 G 进行调度.每个 P 会周期性的查看全局队列中是否有 G 待运行,并将其调度到 M 中执行,全局队列中 G 的来源,主要从系统调用中恢复的 G,之所以会周期性查看全局队列,为防止全局队列中的 G 被饿死.</p> <h3 id="系统调用"><a href="#系统调用" class="header-anchor">#</a> 系统调用</h3> <p>P 的个数默认等于 cpu 核数,每个 M 必须持有一个 P 才可以执行 G,一般情况下 M 的个数会略大于 P 的个数,这个多出来的 M 将会在 G 发生系统调用时发挥作用.类似线程池, GO 也提供一个 M 的池子,需要时从池中获取,用完放回池子,不够用时再创建一个.</p> <p>当 G0 即将进入系统调用时, M0 将释放 P,进而某个空闲的 M1 获取 P,继续执行 P 本地队列中剩下的 G. M0 由于系统调用被阻塞, M1 接替 M0 工作,只要 P 不空闲就可以保证充分利用 CPU. M1 的来源可能是 M 的缓冲池,也可能是新建的,当 G0 系统调用结束后根据 M0 是否能获取到 P 将会将 G0 做不同的处理 :</p> <ol><li>如果有空闲的 P,则获取一个 P,继续执行 G0</li> <li>如果没有空闲的 P,则将 G0 放入全局队列,等待被其它的 P 调度.然后 M0 将进入缓存池睡眠</li></ol> <h3 id="工作量窃取"><a href="#工作量窃取" class="header-anchor">#</a> 工作量窃取</h3> <p>本地队列在调度过程中具有优先级,多个 P 本地队列中的 G 数量可能不均衡,如果 P 将本地队列中的 G 运行完了,会去查询全局队列,如果全局队列也没有 G,此时,空闲的 P 会将其它 P 中的 G 窃取一半过来.</p> <h3 id="gomaxprocs-设置对性能的影响"><a href="#gomaxprocs-设置对性能的影响" class="header-anchor">#</a> GOMAXPROCS 设置对性能的影响</h3> <p>一般为 cpu 核数可以充分利用 cpu,某些 IO 密集型应用中并不意味着性能最好,理论上某个 goroutine 进入系统调用时会有一个新的 M 被启用或创建,继续占满 cpu,但由于调度器检测到 M 被阻塞是有一定延迟的,也就是旧的 M 被阻塞和新的 M 得到运行之间有一定间隔.所以 IO 密集型应用中不妨把 GOMAXPROCS 设置的大一些,效果会更好.</p> <h3 id="异步抢占"><a href="#异步抢占" class="header-anchor">#</a> 异步抢占</h3> <p>有一个特殊的 sysmon 线程做抢占式调度,当一个 goroutine 占用 cpu 超过 10 毫秒之后,调度器会根据实际情况提供不保证的协程切换.</p> <h3 id="栈空间最大最小"><a href="#栈空间最大最小" class="header-anchor">#</a> 栈空间最大最小</h3> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// runtime/stack.go</span>
_StackMin <span class="token operator">=</span> <span class="token number">2048</span> <span class="token comment">// 最小 2kb</span>
<span class="token keyword">var</span> maxstacksize <span class="token builtin">uintptr</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">20</span> <span class="token comment">// 默认在 64 位系统上是 1GB</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="分段栈"><a href="#分段栈" class="header-anchor">#</a> 分段栈</h3> <p>1.3 版本以前使用栈结构是分段栈,运行时调用<code>runtime.morestack</code>和<code>runtime.newstack</code>创建一个新的栈空间,栈空间是不连续的,多个栈会以双向链表形式串联起来,运行时会通过指针找到连续的栈片段.缺点 : 函数调用时触发栈扩容,函数返回时会触发栈的收缩.</p> <h3 id="连续栈"><a href="#连续栈" class="header-anchor">#</a> 连续栈</h3> <p>每当栈空间不足时,初始化一个比旧栈大两倍的心栈并将原栈中所有值都迁移到新的栈中新的局部变量或者函数调用就有了足够的内存空间.</p> <h4 id="栈扩容"><a href="#栈扩容" class="header-anchor">#</a> 栈扩容</h4> <p>编译器会为函数调用插入运行时检查<code>runtime.morestack()</code>会在几乎所有函数调用前检查当前 goroutine 的栈内存是否充足,如果当前栈需要扩容会调用<code>runtime.newstack()</code>创建新的栈.旧栈的大小是通过保存在 goroutine 中的 stack 信息里记录的栈区内存边界计算出来的,然后用旧栈两倍大小创建新栈,创建前会检查新栈大小是否超过了单个栈的内存上限.如果目标栈没有超出限制会将 goroutine 切换至<code>——Gcopystack</code>状态并调用<code>runtime.copystack()</code>开始栈的拷贝,在拷贝栈内存之前,运行时会先通过<code>runtime.stackalloc()</code>分配新的栈空间.新栈的初始化和复制比较简单,复杂的地方在于将指向源栈中内存指针调整为指向新的栈,完成后会释放掉旧栈的内存空间.</p> <ol><li>调用<code>runtime.newstack</code>在内存空间中分配更大的栈内存空间</li> <li>使用<code>runtime.copystack</code>将旧栈中所有内容复制到新的栈中,栈扩容后同一个变量内存地址会发生变化</li> <li>将指向旧栈对应变量的指针重新指向新栈</li> <li>调用<code>runtime.stackfree</code>销毁并回收旧栈的内存空间</li></ol> <h4 id="栈缩容"><a href="#栈缩容" class="header-anchor">#</a> 栈缩容</h4> <p>在 goroutine 运行过程中,如果栈空间使用率不超过 1/4,在垃圾回收时使用<code>runtime.shrinkstack()</code>进行栈缩容,缩容前会进行前置检查,如果触发缩容,新栈大小是原始大小的一半,不过新栈大小低于最低限制 2kb 缩容就会停止.缩容也会调用<code>runtime.copystack()</code>将旧栈数据拷贝到新栈然后调整原来指针的指向.</p> <h4 id="例子"><a href="#例子" class="header-anchor">#</a> 例子</h4> <p>修改源文件<code>runtime/stack.go</code>设置<code>stackDebug=1</code>使用命令<code>go build -gcflags -S main.go</code>观察栈的初始化和扩容缩容.当 main 函数里其它函数执行完只有 main 函数还在栈空间里,如果这时系统进行垃圾回收就会对这个 goroutine 的栈区进行缩容.</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">var</span> x <span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token builtin">int</span>
	<span class="token function">println</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>x<span class="token punctuation">)</span>
	<span class="token function">a</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
	runtime<span class="token punctuation">.</span><span class="token function">GC</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 查看缩容</span>
	<span class="token function">println</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>x<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">//go:noinline</span>
<span class="token keyword">func</span> <span class="token function">a</span><span class="token punctuation">(</span>x <span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">println</span><span class="token punctuation">(</span><span class="token string">`func a`</span><span class="token punctuation">)</span>
	<span class="token keyword">var</span> y <span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token builtin">int</span>
	<span class="token function">b</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">//go:noinline</span>
<span class="token keyword">func</span> <span class="token function">b</span><span class="token punctuation">(</span>x <span class="token punctuation">[</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">println</span><span class="token punctuation">(</span><span class="token string">`func b`</span><span class="token punctuation">)</span>
	<span class="token keyword">var</span> y <span class="token punctuation">[</span><span class="token number">1000</span><span class="token punctuation">]</span><span class="token builtin">int</span>
	<span class="token function">c</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">//go:noinline</span>
<span class="token keyword">func</span> <span class="token function">c</span><span class="token punctuation">(</span>x <span class="token punctuation">[</span><span class="token number">1000</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">println</span><span class="token punctuation">(</span><span class="token string">`func c`</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><h3 id="goroutine-中的栈"><a href="#goroutine-中的栈" class="header-anchor">#</a> goroutine 中的栈</h3> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">type</span> g <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	stack       stack   <span class="token comment">// offset known to runtime/cgo</span>
	stackguard0 <span class="token builtin">uintptr</span> <span class="token comment">// offset known to liblink</span>
	stackguard1 <span class="token builtin">uintptr</span> <span class="token comment">// offset known to liblink</span>
<span class="token punctuation">}</span>
<span class="token keyword">type</span> stack <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	lo <span class="token builtin">uintptr</span>
	hi <span class="token builtin">uintptr</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="全局栈缓存"><a href="#全局栈缓存" class="header-anchor">#</a> 全局栈缓存</h3> <p>栈空间在运行时包含两个全局变量<code>runtime.stackpool</code>和<code>runtime.stackLarge</code>,分别表示全局栈缓存和大栈缓存.前者可分配小于 32kb 的内存,后者用来分配大于 32kb 的栈空间.</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// runtime/stack.go</span>
<span class="token comment">// 都与 mspan 有关</span>
<span class="token keyword">var</span> stackpool <span class="token punctuation">[</span>_NumStackOrders<span class="token punctuation">]</span><span class="token keyword">struct</span> <span class="token punctuation">{</span>
	item stackpoolItem
	<span class="token boolean">_</span>    <span class="token punctuation">[</span>cpu<span class="token punctuation">.</span>CacheLinePadSize <span class="token operator">-</span> unsafe<span class="token punctuation">.</span><span class="token function">Sizeof</span><span class="token punctuation">(</span>stackpoolItem<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">%</span>cpu<span class="token punctuation">.</span>CacheLinePadSize<span class="token punctuation">]</span><span class="token builtin">byte</span>
<span class="token punctuation">}</span>

<span class="token keyword">type</span> stackpoolItem <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	mu   mutex
	span mSpanList
<span class="token punctuation">}</span>

<span class="token keyword">var</span> stackLarge <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	lock mutex
	free <span class="token punctuation">[</span>heapAddrBits <span class="token operator">-</span> pageShift<span class="token punctuation">]</span>mSpanList <span class="token comment">// free lists by log_2(s.npages)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h3 id="栈缓存"><a href="#栈缓存" class="header-anchor">#</a> 栈缓存</h3> <p>如果运行时只使用全局变量来分配内存会造成线程间锁竞争,栈内存与线程关系密切,每一个线程缓存<code>runtime.mcache</code>都加入了栈缓存减少锁竞争.</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">type</span> mcache <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	alloc <span class="token punctuation">[</span>numSpanClasses<span class="token punctuation">]</span><span class="token operator">*</span>mspan <span class="token comment">// spans to allocate from, indexed by spanClass</span>
	stackcache <span class="token punctuation">[</span>_NumStackOrders<span class="token punctuation">]</span>stackfreelist
<span class="token punctuation">}</span>
<span class="token keyword">type</span> stackfreelist <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	list gclinkptr <span class="token comment">// linked list of free stacks</span>
	size <span class="token builtin">uintptr</span>   <span class="token comment">// total size of stacks in list</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h2 id="系统监视器"><a href="#系统监视器" class="header-anchor">#</a> 系统监视器</h2> <p>sysmon 线程,即系统监视器,在 GMP 模型中这个线程未连接人和的 P, 这就意味着调度器没有将其考虑在内,因此始终处于运行状态. <code>go tool trace</code>也无法追踪此线程. sysmon 在无事可做时不会消耗资源,运行周期(循环时间)是动态的,初始速度(执行频次)为 20 纳秒.一直在寻求哪里有帮助,经过几个周期如果没有任何操作,两个周期之间休眠将加倍,直到达到 10 毫秒,如果应用程序没有很多系统调用或长时间运行的 goroutine,该线程会退变为 10 毫秒执行频次.</p> <h3 id="作用"><a href="#作用" class="header-anchor">#</a> 作用</h3> <ol><li>由协程创建的 timers : sysmon 协程查看应该在运行却在等待执行时间的计时器,这种情况下,将查看空闲的 M 和 P 列表,尽快执行</li> <li>网络轮训器和系统调用 : 他将运行网络中被阻塞的 goroutine</li> <li>垃圾回收器(如果很长时间没有运行) : 如果 GC 两分钟没有运行,则 sysmon 将强制进行一轮 GC</li> <li>长时间运行的 goroutine 的抢占 : 任何运行超过 10 毫秒的 goroutine 都会被抢占,将运行时间留给其它 goroutine</li></ol> <h3 id="停止运行"><a href="#停止运行" class="header-anchor">#</a> 停止运行</h3> <p>sysmon 能检测其何时不运行,以下两种情况 sysmon 都会休眠,不会有任何资源消耗.</p> <ol><li>垃圾回收即将运行 : sysmon 线程将在垃圾回收结束时恢复</li> <li>所有线程都处于空闲状态,没有任何一个在运行</li></ol> <h3 id="函数"><a href="#函数" class="header-anchor">#</a> 函数</h3> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// runtime/proc.go:sysmon</span>
<span class="token keyword">func</span> <span class="token function">sysmon</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sched<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>
	sched<span class="token punctuation">.</span>nmsys<span class="token operator">++</span>
	<span class="token function">checkdead</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token function">unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sched<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>
	lasttrace <span class="token operator">:=</span> <span class="token function">int64</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
	idle <span class="token operator">:=</span> <span class="token number">0</span> <span class="token comment">// how many cycles in succession we had not wokeup somebody</span>
	delay <span class="token operator">:=</span> <span class="token function">uint32</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> idle <span class="token operator">==</span> <span class="token number">0</span> <span class="token punctuation">{</span> <span class="token comment">// start with 20us sleep...</span>
			delay <span class="token operator">=</span> <span class="token number">20</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> idle <span class="token operator">&gt;</span> <span class="token number">50</span> <span class="token punctuation">{</span> <span class="token comment">// start doubling the sleep after 1ms...</span>
			delay <span class="token operator">*=</span> <span class="token number">2</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> delay <span class="token operator">&gt;</span> <span class="token number">10</span><span class="token operator">*</span><span class="token number">1000</span> <span class="token punctuation">{</span> <span class="token comment">// up to 10ms</span>
			delay <span class="token operator">=</span> <span class="token number">10</span> <span class="token operator">*</span> <span class="token number">1000</span>
		<span class="token punctuation">}</span>
		<span class="token function">usleep</span><span class="token punctuation">(</span>delay<span class="token punctuation">)</span>
		now <span class="token operator">:=</span> <span class="token function">nanotime</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		next<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> <span class="token function">timeSleepUntil</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> debug<span class="token punctuation">.</span>schedtrace <span class="token operator">&lt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>sched<span class="token punctuation">.</span>gcwaiting <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">||</span> atomic<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sched<span class="token punctuation">.</span>npidle<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token function">uint32</span><span class="token punctuation">(</span>gomaxprocs<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token function">lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sched<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>
			<span class="token keyword">if</span> atomic<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sched<span class="token punctuation">.</span>gcwaiting<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">||</span> atomic<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sched<span class="token punctuation">.</span>npidle<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token function">uint32</span><span class="token punctuation">(</span>gomaxprocs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">if</span> next <span class="token operator">&gt;</span> now <span class="token punctuation">{</span>
					atomic<span class="token punctuation">.</span><span class="token function">Store</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sched<span class="token punctuation">.</span>sysmonwait<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
					<span class="token function">unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sched<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>
					sleep <span class="token operator">:=</span> forcegcperiod <span class="token operator">/</span> <span class="token number">2</span>
					<span class="token keyword">if</span> next<span class="token operator">-</span>now <span class="token operator">&lt;</span> sleep <span class="token punctuation">{</span>
						sleep <span class="token operator">=</span> next <span class="token operator">-</span> now
					<span class="token punctuation">}</span>
					shouldRelax <span class="token operator">:=</span> sleep <span class="token operator">&gt;=</span> osRelaxMinNS
					<span class="token keyword">if</span> shouldRelax <span class="token punctuation">{</span>
						<span class="token function">osRelax</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
					<span class="token punctuation">}</span>
					<span class="token function">notetsleep</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sched<span class="token punctuation">.</span>sysmonnote<span class="token punctuation">,</span> sleep<span class="token punctuation">)</span>
					<span class="token keyword">if</span> shouldRelax <span class="token punctuation">{</span>
						<span class="token function">osRelax</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span>
					<span class="token punctuation">}</span>
					now <span class="token operator">=</span> <span class="token function">nanotime</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
					next<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">=</span> <span class="token function">timeSleepUntil</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
					<span class="token function">lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sched<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>
					atomic<span class="token punctuation">.</span><span class="token function">Store</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sched<span class="token punctuation">.</span>sysmonwait<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
					<span class="token function">noteclear</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sched<span class="token punctuation">.</span>sysmonnote<span class="token punctuation">)</span>
				<span class="token punctuation">}</span>
				idle <span class="token operator">=</span> <span class="token number">0</span>
				delay <span class="token operator">=</span> <span class="token number">20</span>
			<span class="token punctuation">}</span>
			<span class="token function">unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sched<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token operator">*</span>cgo_yield <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			<span class="token function">asmcgocall</span><span class="token punctuation">(</span><span class="token operator">*</span>cgo_yield<span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		lastpoll <span class="token operator">:=</span> <span class="token function">int64</span><span class="token punctuation">(</span>atomic<span class="token punctuation">.</span><span class="token function">Load64</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sched<span class="token punctuation">.</span>lastpoll<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">if</span> <span class="token function">netpollinited</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> lastpoll <span class="token operator">!=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> lastpoll<span class="token operator">+</span><span class="token number">10</span><span class="token operator">*</span><span class="token number">1000</span><span class="token operator">*</span><span class="token number">1000</span> <span class="token operator">&lt;</span> now <span class="token punctuation">{</span>
			atomic<span class="token punctuation">.</span><span class="token function">Cas64</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>sched<span class="token punctuation">.</span>lastpoll<span class="token punctuation">,</span> <span class="token function">uint64</span><span class="token punctuation">(</span>lastpoll<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">uint64</span><span class="token punctuation">(</span>now<span class="token punctuation">)</span><span class="token punctuation">)</span>
			list <span class="token operator">:=</span> <span class="token function">netpoll</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token comment">// non-blocking - returns list of goroutines</span>
			<span class="token keyword">if</span> <span class="token operator">!</span>list<span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token function">incidlelocked</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
				<span class="token function">injectglist</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>list<span class="token punctuation">)</span>
				<span class="token function">incidlelocked</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> next <span class="token operator">&lt;</span> now <span class="token punctuation">{</span>
			<span class="token function">startm</span><span class="token punctuation">(</span><span class="token boolean">nil</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> <span class="token function">retake</span><span class="token punctuation">(</span>now<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
			idle <span class="token operator">=</span> <span class="token number">0</span>
		<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
			idle<span class="token operator">++</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> t <span class="token operator">:=</span> <span class="token punctuation">(</span>gcTrigger<span class="token punctuation">{</span>kind<span class="token punctuation">:</span> gcTriggerTime<span class="token punctuation">,</span> now<span class="token punctuation">:</span> now<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> t<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> atomic<span class="token punctuation">.</span><span class="token function">Load</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>forcegc<span class="token punctuation">.</span>idle<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span> <span class="token punctuation">{</span>
			<span class="token function">lock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>forcegc<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>
			forcegc<span class="token punctuation">.</span>idle <span class="token operator">=</span> <span class="token number">0</span>
			<span class="token keyword">var</span> list gList
			list<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>forcegc<span class="token punctuation">.</span>g<span class="token punctuation">)</span>
			<span class="token function">injectglist</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>list<span class="token punctuation">)</span>
			<span class="token function">unlock</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>forcegc<span class="token punctuation">.</span>lock<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span> debug<span class="token punctuation">.</span>schedtrace <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> lasttrace<span class="token operator">+</span><span class="token function">int64</span><span class="token punctuation">(</span>debug<span class="token punctuation">.</span>schedtrace<span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">1000000</span> <span class="token operator">&lt;=</span> now <span class="token punctuation">{</span>
			lasttrace <span class="token operator">=</span> now
			<span class="token function">schedtrace</span><span class="token punctuation">(</span>debug<span class="token punctuation">.</span>scheddetail <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br></div></div><h2 id="协程数"><a href="#协程数" class="header-anchor">#</a> 协程数</h2> <p>go 最多可以创建 1w 个线程.超过 1w 会 panic. 线程数 = GOMAXPROCS + 等待返回的阻塞系统调用.协程数受机器位数和内存大小限制, 32 位处理器上上限约 8w 左右, 64 位处理器基本不受限,限制于内存大小,<code>4k * 100w = 4G内存</code>.</p> <p>g0 是每个 os 线程创建的第一个 goroutine.</p> <h2 id="协程创建"><a href="#协程创建" class="header-anchor">#</a> 协程创建</h2> <p>新协程创建会放在队列最前端,会在当前协程运行后第一个运行,协程被创建并加入到本地队列后直接执行主函数的下一个指令.</p> <h2 id="协程退出"><a href="#协程退出" class="header-anchor">#</a> 协程退出</h2> <p>创建协程时 go 将在程序计数器设置为写出真实调用的函数之前将堆栈设置为 goexit 的函数,这个可以在协程结束时必须调用 goexit 函数,我们也可以调用<code>runtime.Goexit()</code>手动终止协程.</p> <h2 id="channel-阻塞-goroutine-阻塞和唤醒"><a href="#channel-阻塞-goroutine-阻塞和唤醒" class="header-anchor">#</a> channel 阻塞, goroutine 阻塞和唤醒</h2> <ol><li>local 队列</li> <li>global 队列</li> <li>parked goroutines (特殊队列)</li></ol> <div class="language-go line-numbers-mode"><pre class="language-go"><code>ch <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">int</span><span class="token punctuation">)</span>
<span class="token comment">//...</span>
ch <span class="token operator">&lt;-</span> v
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ol><li>当 channel 阻塞时,当前 goroutine 会被停放,即处于等待状态并且不会方在任何 goroutine 队列中</li> <li>g0 会替换 goroutine 进行一轮调度,优先本地队列</li> <li>一旦有接收者读取 channel 中的数据,之前停放的 goroutine 就会解除阻塞状态</li> <li>收到消息的 goroutine 会切换到 g0,并且通过高放入本地队列的方式将 goroutine 从停放状态解除</li></ol> <h2 id="g0"><a href="#g0" class="header-anchor">#</a> g0</h2> <ol><li>goroutine 创建  : 当调用 <code>go func() {...}()</code>或<code>go myFunc()</code>时,go 会把他们放入本地队列前,将 goroutine 创建委托给 g0 去做,新创建的 goroutine 优先运行,并且被放在本地队列顶部</li> <li>defer 分配</li> <li>垃圾收集 : STW、扫描 goroutine 的栈、标记清理操作</li> <li>栈增长 : 当需要的时候, goroutine 栈会增加,这个操作由 g0 的 prolog 函数完成</li></ol> <h2 id="关闭异步抢占"><a href="#关闭异步抢占" class="header-anchor">#</a> 关闭异步抢占</h2> <div class="language-go line-numbers-mode"><pre class="language-go"><code>GODEBUG<span class="token operator">=</span>asyncpreemptoff<span class="token operator">=</span><span class="token number">1</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>当一个协程运行时间超过10ms sysmon 向当前的线程发出一个抢占信号,当信息被信号处理器接收时线程中断当前的操作来处理信号,不会在运行当前 goroutine,go会把一条指令推进程序计数器,看起来运行中的程序调用了运行时的函数,该函数暂停协程并把他交给调度器,调度器之后运行其他协程.</p> <p>当 sysmon (运行在 M 上,且不需要 P) 发现 M 已经运行同一个 G 10ms 以上,会将该 G 的内部参数 preempt 标志设置为 true, 当 G 进行函数调用时 G 会检查自己的 preempt 标识,如果它为 true, 则将自己与 M 分离,并推入全局队列.实现抢占.如果没有函数调用,即时设置了抢占标志也不会进行该标志的检查,抢占标志的检查发生在函数序言中,因此不执行任何操作的死循环不会发生抢占.</p> <p>本地队列存储 P 具有的 G.全局队列存储那些超过本地队列容量(256)的G, 存储由于各种原因而等待的 G,存储由抢占标识而分离的 G.</p> <h3 id="非协作式抢占-异步抢占"><a href="#非协作式抢占-异步抢占" class="header-anchor">#</a> 非协作式抢占(异步抢占)</h3> <p>sysmon 仍然会检测运行 10ms 以上的 G,然后 sysmon 向运行的 P 发送信号(SIGURG). Go 的信号处理程序会调用 P 上的叫做 gsignal 的 goroutine来处理该信号,将其映射到 M 而不是 G,并使其检查该信号 gsignal 看到抢占信号,停止正在运行的 G.由于此机制显示的发送信号,因此无需调用函数就能将运行死循环的 G 切换.</p> <p>GC 执行 stw 会让所有 goroutine 停止,也是抢占,都会调用 preemptone 函数.会向正在运行的 goroutine 所绑定的 M 发送 sigurg 信号.</p> <p>每个 M 在初始化时都会设置信号处理函数.</p> <ol><li>主线程正在执行指令,执行完指令 m接着要执行 m+1 了,此时收到了一个信息</li> <li>内核会接管执行流程,去执行预先设置的信号处理程序,即 sighandler</li> <li>执行流交到线程上继续执行 m+1 指令</li></ol> <h2 id="gsignal"><a href="#gsignal" class="header-anchor">#</a> gsignal</h2></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">最后更新:</span> <span class="time">6/18/2021, 2:43:25 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/m/Go语言之旅/协程池.html" class="prev">
        协程池
      </a></span> <span class="next"><a href="/m/Go语言之旅/垃圾回收.html">
        垃圾回收
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/m/assets/js/app.71fdaff2.js" defer></script><script src="/m/assets/js/2.351ead77.js" defer></script><script src="/m/assets/js/74.e79f4842.js" defer></script>
  </body>
</html>
