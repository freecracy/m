<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>0x08.性能剖析 | 嗯哼人生</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="">
    <meta name="referrer" content="no-referrer">
    
    <link rel="preload" href="/m/assets/css/0.styles.1e386fb6.css" as="style"><link rel="preload" href="/m/assets/js/app.71fdaff2.js" as="script"><link rel="preload" href="/m/assets/js/2.351ead77.js" as="script"><link rel="preload" href="/m/assets/js/32.c5e0d2a0.js" as="script"><link rel="prefetch" href="/m/assets/js/10.98c1e7e0.js"><link rel="prefetch" href="/m/assets/js/100.d7774ae1.js"><link rel="prefetch" href="/m/assets/js/101.0d4dea0d.js"><link rel="prefetch" href="/m/assets/js/102.6867f859.js"><link rel="prefetch" href="/m/assets/js/103.9d24bd08.js"><link rel="prefetch" href="/m/assets/js/104.4d59f256.js"><link rel="prefetch" href="/m/assets/js/105.ff49af8e.js"><link rel="prefetch" href="/m/assets/js/106.b26c7611.js"><link rel="prefetch" href="/m/assets/js/107.da5be320.js"><link rel="prefetch" href="/m/assets/js/108.0c03f842.js"><link rel="prefetch" href="/m/assets/js/109.5587de24.js"><link rel="prefetch" href="/m/assets/js/11.4e6d88d4.js"><link rel="prefetch" href="/m/assets/js/110.40ae6022.js"><link rel="prefetch" href="/m/assets/js/111.0353ccf3.js"><link rel="prefetch" href="/m/assets/js/112.f562c096.js"><link rel="prefetch" href="/m/assets/js/113.7926c003.js"><link rel="prefetch" href="/m/assets/js/114.356035f0.js"><link rel="prefetch" href="/m/assets/js/115.15e5e23e.js"><link rel="prefetch" href="/m/assets/js/116.2db2b1ed.js"><link rel="prefetch" href="/m/assets/js/117.2658e42c.js"><link rel="prefetch" href="/m/assets/js/118.037a8503.js"><link rel="prefetch" href="/m/assets/js/119.21153540.js"><link rel="prefetch" href="/m/assets/js/12.c3dadd73.js"><link rel="prefetch" href="/m/assets/js/120.b8f0644f.js"><link rel="prefetch" href="/m/assets/js/121.4c1c263a.js"><link rel="prefetch" href="/m/assets/js/122.d6ba18dd.js"><link rel="prefetch" href="/m/assets/js/123.ceef4883.js"><link rel="prefetch" href="/m/assets/js/124.9e5f50ca.js"><link rel="prefetch" href="/m/assets/js/125.de1ddc80.js"><link rel="prefetch" href="/m/assets/js/126.ae350aea.js"><link rel="prefetch" href="/m/assets/js/127.4636f6be.js"><link rel="prefetch" href="/m/assets/js/128.13b379ab.js"><link rel="prefetch" href="/m/assets/js/129.e7b0a15f.js"><link rel="prefetch" href="/m/assets/js/13.a52bd89b.js"><link rel="prefetch" href="/m/assets/js/130.147cdf11.js"><link rel="prefetch" href="/m/assets/js/131.c7a07871.js"><link rel="prefetch" href="/m/assets/js/132.faf72eb9.js"><link rel="prefetch" href="/m/assets/js/133.6301923b.js"><link rel="prefetch" href="/m/assets/js/134.4357c6e4.js"><link rel="prefetch" href="/m/assets/js/135.0ea43a3d.js"><link rel="prefetch" href="/m/assets/js/136.5a7c2377.js"><link rel="prefetch" href="/m/assets/js/137.393c998e.js"><link rel="prefetch" href="/m/assets/js/138.dcf958b6.js"><link rel="prefetch" href="/m/assets/js/139.1ccac68b.js"><link rel="prefetch" href="/m/assets/js/14.96fff293.js"><link rel="prefetch" href="/m/assets/js/140.938c314e.js"><link rel="prefetch" href="/m/assets/js/141.03cc2137.js"><link rel="prefetch" href="/m/assets/js/142.db00aba9.js"><link rel="prefetch" href="/m/assets/js/143.6d7b22af.js"><link rel="prefetch" href="/m/assets/js/144.850ed5a9.js"><link rel="prefetch" href="/m/assets/js/145.a1958a5f.js"><link rel="prefetch" href="/m/assets/js/146.1b350d4f.js"><link rel="prefetch" href="/m/assets/js/147.961f3ccd.js"><link rel="prefetch" href="/m/assets/js/148.cb4f8811.js"><link rel="prefetch" href="/m/assets/js/149.45ad7c2c.js"><link rel="prefetch" href="/m/assets/js/15.c507965f.js"><link rel="prefetch" href="/m/assets/js/150.5d952b70.js"><link rel="prefetch" href="/m/assets/js/151.5c794bb0.js"><link rel="prefetch" href="/m/assets/js/152.974e657e.js"><link rel="prefetch" href="/m/assets/js/153.b7cf98f6.js"><link rel="prefetch" href="/m/assets/js/154.be904394.js"><link rel="prefetch" href="/m/assets/js/155.769e3b0d.js"><link rel="prefetch" href="/m/assets/js/156.6107a44f.js"><link rel="prefetch" href="/m/assets/js/157.0bf74a2b.js"><link rel="prefetch" href="/m/assets/js/158.d499f907.js"><link rel="prefetch" href="/m/assets/js/159.6b2acd2c.js"><link rel="prefetch" href="/m/assets/js/16.247520d0.js"><link rel="prefetch" href="/m/assets/js/160.ec909209.js"><link rel="prefetch" href="/m/assets/js/161.4832768d.js"><link rel="prefetch" href="/m/assets/js/162.ae74834a.js"><link rel="prefetch" href="/m/assets/js/163.8af51be9.js"><link rel="prefetch" href="/m/assets/js/164.0d64a1ef.js"><link rel="prefetch" href="/m/assets/js/165.5e5a775c.js"><link rel="prefetch" href="/m/assets/js/166.121987f8.js"><link rel="prefetch" href="/m/assets/js/167.1c270942.js"><link rel="prefetch" href="/m/assets/js/168.200df8c8.js"><link rel="prefetch" href="/m/assets/js/169.84f5e0d7.js"><link rel="prefetch" href="/m/assets/js/17.3cb462b5.js"><link rel="prefetch" href="/m/assets/js/170.57b7eec5.js"><link rel="prefetch" href="/m/assets/js/171.d993d636.js"><link rel="prefetch" href="/m/assets/js/172.820d00a1.js"><link rel="prefetch" href="/m/assets/js/173.cc29ff6e.js"><link rel="prefetch" href="/m/assets/js/174.99d62af7.js"><link rel="prefetch" href="/m/assets/js/175.da874148.js"><link rel="prefetch" href="/m/assets/js/176.d0755bfc.js"><link rel="prefetch" href="/m/assets/js/177.8b00d874.js"><link rel="prefetch" href="/m/assets/js/178.2b0cfda8.js"><link rel="prefetch" href="/m/assets/js/179.780a3873.js"><link rel="prefetch" href="/m/assets/js/18.298da910.js"><link rel="prefetch" href="/m/assets/js/180.7c0ac3dc.js"><link rel="prefetch" href="/m/assets/js/181.507f9073.js"><link rel="prefetch" href="/m/assets/js/182.87f76d4a.js"><link rel="prefetch" href="/m/assets/js/183.1410502e.js"><link rel="prefetch" href="/m/assets/js/184.80666cb3.js"><link rel="prefetch" href="/m/assets/js/185.dc628b97.js"><link rel="prefetch" href="/m/assets/js/186.c2560a3f.js"><link rel="prefetch" href="/m/assets/js/187.6af43ea3.js"><link rel="prefetch" href="/m/assets/js/188.da75b50c.js"><link rel="prefetch" href="/m/assets/js/189.78dd960b.js"><link rel="prefetch" href="/m/assets/js/19.d9eabdf8.js"><link rel="prefetch" href="/m/assets/js/190.017586b9.js"><link rel="prefetch" href="/m/assets/js/191.5fa65eb7.js"><link rel="prefetch" href="/m/assets/js/192.5bb628c7.js"><link rel="prefetch" href="/m/assets/js/193.35707c80.js"><link rel="prefetch" href="/m/assets/js/194.35c3b13b.js"><link rel="prefetch" href="/m/assets/js/195.6dc8874b.js"><link rel="prefetch" href="/m/assets/js/196.01a1e825.js"><link rel="prefetch" href="/m/assets/js/197.5745084a.js"><link rel="prefetch" href="/m/assets/js/198.0455ca12.js"><link rel="prefetch" href="/m/assets/js/199.75129c13.js"><link rel="prefetch" href="/m/assets/js/20.ce14ddb9.js"><link rel="prefetch" href="/m/assets/js/200.a08681d0.js"><link rel="prefetch" href="/m/assets/js/201.a54018b7.js"><link rel="prefetch" href="/m/assets/js/202.2361e839.js"><link rel="prefetch" href="/m/assets/js/203.b92491ee.js"><link rel="prefetch" href="/m/assets/js/204.13742571.js"><link rel="prefetch" href="/m/assets/js/205.b066e447.js"><link rel="prefetch" href="/m/assets/js/206.e2c72f2c.js"><link rel="prefetch" href="/m/assets/js/207.09a83a9a.js"><link rel="prefetch" href="/m/assets/js/208.f4b8d71c.js"><link rel="prefetch" href="/m/assets/js/209.1a4e4d18.js"><link rel="prefetch" href="/m/assets/js/21.0dc0e0bf.js"><link rel="prefetch" href="/m/assets/js/210.9709d46f.js"><link rel="prefetch" href="/m/assets/js/211.3704916b.js"><link rel="prefetch" href="/m/assets/js/212.7c96c99f.js"><link rel="prefetch" href="/m/assets/js/213.b4aedaa1.js"><link rel="prefetch" href="/m/assets/js/214.d0b2586b.js"><link rel="prefetch" href="/m/assets/js/215.2268650a.js"><link rel="prefetch" href="/m/assets/js/216.dcaa6f2f.js"><link rel="prefetch" href="/m/assets/js/217.33aaf649.js"><link rel="prefetch" href="/m/assets/js/218.216d8592.js"><link rel="prefetch" href="/m/assets/js/219.44d35873.js"><link rel="prefetch" href="/m/assets/js/22.ce355d8a.js"><link rel="prefetch" href="/m/assets/js/220.ff06fa11.js"><link rel="prefetch" href="/m/assets/js/221.93379b76.js"><link rel="prefetch" href="/m/assets/js/222.6f0bbeea.js"><link rel="prefetch" href="/m/assets/js/223.4c5e29f0.js"><link rel="prefetch" href="/m/assets/js/224.e7be32e4.js"><link rel="prefetch" href="/m/assets/js/225.4915db8f.js"><link rel="prefetch" href="/m/assets/js/226.60f21d11.js"><link rel="prefetch" href="/m/assets/js/227.0e63cf34.js"><link rel="prefetch" href="/m/assets/js/228.e7b7a543.js"><link rel="prefetch" href="/m/assets/js/229.73bf392a.js"><link rel="prefetch" href="/m/assets/js/23.40c917ac.js"><link rel="prefetch" href="/m/assets/js/230.9f789c55.js"><link rel="prefetch" href="/m/assets/js/231.8fd85bc2.js"><link rel="prefetch" href="/m/assets/js/232.e6c4a62c.js"><link rel="prefetch" href="/m/assets/js/233.45636bf3.js"><link rel="prefetch" href="/m/assets/js/234.5194ce16.js"><link rel="prefetch" href="/m/assets/js/235.15ba019b.js"><link rel="prefetch" href="/m/assets/js/236.ac5768c1.js"><link rel="prefetch" href="/m/assets/js/237.91ec2e5a.js"><link rel="prefetch" href="/m/assets/js/238.af630344.js"><link rel="prefetch" href="/m/assets/js/239.b2b84093.js"><link rel="prefetch" href="/m/assets/js/24.5b681006.js"><link rel="prefetch" href="/m/assets/js/240.9c9b1fba.js"><link rel="prefetch" href="/m/assets/js/241.c26c2147.js"><link rel="prefetch" href="/m/assets/js/242.ce44f37f.js"><link rel="prefetch" href="/m/assets/js/243.aa04b829.js"><link rel="prefetch" href="/m/assets/js/244.ee4c9090.js"><link rel="prefetch" href="/m/assets/js/245.62ebda1d.js"><link rel="prefetch" href="/m/assets/js/246.2fd9ce22.js"><link rel="prefetch" href="/m/assets/js/247.52b3e746.js"><link rel="prefetch" href="/m/assets/js/248.2e432a32.js"><link rel="prefetch" href="/m/assets/js/249.4598fccb.js"><link rel="prefetch" href="/m/assets/js/25.d5d6ba55.js"><link rel="prefetch" href="/m/assets/js/250.7c93bc3e.js"><link rel="prefetch" href="/m/assets/js/251.4d402930.js"><link rel="prefetch" href="/m/assets/js/252.1b3fb775.js"><link rel="prefetch" href="/m/assets/js/253.01a9b4f8.js"><link rel="prefetch" href="/m/assets/js/254.29de4256.js"><link rel="prefetch" href="/m/assets/js/255.4911ce12.js"><link rel="prefetch" href="/m/assets/js/256.0a40f8d2.js"><link rel="prefetch" href="/m/assets/js/257.2111ae5e.js"><link rel="prefetch" href="/m/assets/js/258.0e9b2cd1.js"><link rel="prefetch" href="/m/assets/js/259.43158d35.js"><link rel="prefetch" href="/m/assets/js/26.b1e00e8a.js"><link rel="prefetch" href="/m/assets/js/260.72ea8c45.js"><link rel="prefetch" href="/m/assets/js/261.3f679643.js"><link rel="prefetch" href="/m/assets/js/262.d9ecaed6.js"><link rel="prefetch" href="/m/assets/js/27.556976c4.js"><link rel="prefetch" href="/m/assets/js/28.11027d56.js"><link rel="prefetch" href="/m/assets/js/29.f40ac6f5.js"><link rel="prefetch" href="/m/assets/js/3.a2a1a8e5.js"><link rel="prefetch" href="/m/assets/js/30.3b59bb10.js"><link rel="prefetch" href="/m/assets/js/31.c37142be.js"><link rel="prefetch" href="/m/assets/js/33.4f5f3a8d.js"><link rel="prefetch" href="/m/assets/js/34.4a3a9398.js"><link rel="prefetch" href="/m/assets/js/35.77f89f97.js"><link rel="prefetch" href="/m/assets/js/36.6ea00d3c.js"><link rel="prefetch" href="/m/assets/js/37.b5a3b5b4.js"><link rel="prefetch" href="/m/assets/js/38.24b26621.js"><link rel="prefetch" href="/m/assets/js/39.ab372876.js"><link rel="prefetch" href="/m/assets/js/4.b9f14f77.js"><link rel="prefetch" href="/m/assets/js/40.7a81caac.js"><link rel="prefetch" href="/m/assets/js/41.d23cf8c8.js"><link rel="prefetch" href="/m/assets/js/42.ef938986.js"><link rel="prefetch" href="/m/assets/js/43.708a3cf3.js"><link rel="prefetch" href="/m/assets/js/44.f705f7de.js"><link rel="prefetch" href="/m/assets/js/45.0e6afdb6.js"><link rel="prefetch" href="/m/assets/js/46.9815c7cc.js"><link rel="prefetch" href="/m/assets/js/47.5d1c1dcc.js"><link rel="prefetch" href="/m/assets/js/48.d9d571a6.js"><link rel="prefetch" href="/m/assets/js/49.9cbaa1e9.js"><link rel="prefetch" href="/m/assets/js/5.57dbdc35.js"><link rel="prefetch" href="/m/assets/js/50.265f94f4.js"><link rel="prefetch" href="/m/assets/js/51.094b2e7f.js"><link rel="prefetch" href="/m/assets/js/52.8b7101c0.js"><link rel="prefetch" href="/m/assets/js/53.98f3fc0b.js"><link rel="prefetch" href="/m/assets/js/54.b3d830fd.js"><link rel="prefetch" href="/m/assets/js/55.fb9cd8c7.js"><link rel="prefetch" href="/m/assets/js/56.878cf94b.js"><link rel="prefetch" href="/m/assets/js/57.1c819831.js"><link rel="prefetch" href="/m/assets/js/58.ac3faf70.js"><link rel="prefetch" href="/m/assets/js/59.b0483bf9.js"><link rel="prefetch" href="/m/assets/js/6.a0c51186.js"><link rel="prefetch" href="/m/assets/js/60.48c301e6.js"><link rel="prefetch" href="/m/assets/js/61.4bf4f2e7.js"><link rel="prefetch" href="/m/assets/js/62.d927584b.js"><link rel="prefetch" href="/m/assets/js/63.b72a48f3.js"><link rel="prefetch" href="/m/assets/js/64.6923d7c8.js"><link rel="prefetch" href="/m/assets/js/65.042fc335.js"><link rel="prefetch" href="/m/assets/js/66.1afdb278.js"><link rel="prefetch" href="/m/assets/js/67.04f7b0c7.js"><link rel="prefetch" href="/m/assets/js/68.97789db4.js"><link rel="prefetch" href="/m/assets/js/69.d914e9f8.js"><link rel="prefetch" href="/m/assets/js/7.aef5e50f.js"><link rel="prefetch" href="/m/assets/js/70.84845956.js"><link rel="prefetch" href="/m/assets/js/71.d6e9132a.js"><link rel="prefetch" href="/m/assets/js/72.2c1f5783.js"><link rel="prefetch" href="/m/assets/js/73.789e9372.js"><link rel="prefetch" href="/m/assets/js/74.e79f4842.js"><link rel="prefetch" href="/m/assets/js/75.4a389066.js"><link rel="prefetch" href="/m/assets/js/76.f5721f28.js"><link rel="prefetch" href="/m/assets/js/77.e6ce992d.js"><link rel="prefetch" href="/m/assets/js/78.5c31237a.js"><link rel="prefetch" href="/m/assets/js/79.6a4f09e0.js"><link rel="prefetch" href="/m/assets/js/8.aac4a85a.js"><link rel="prefetch" href="/m/assets/js/80.23b925ca.js"><link rel="prefetch" href="/m/assets/js/81.bc8138cb.js"><link rel="prefetch" href="/m/assets/js/82.4783bc83.js"><link rel="prefetch" href="/m/assets/js/83.1be8f057.js"><link rel="prefetch" href="/m/assets/js/84.3132660e.js"><link rel="prefetch" href="/m/assets/js/85.95c5ab8b.js"><link rel="prefetch" href="/m/assets/js/86.17c9a201.js"><link rel="prefetch" href="/m/assets/js/87.daa0da6b.js"><link rel="prefetch" href="/m/assets/js/88.9409cacc.js"><link rel="prefetch" href="/m/assets/js/89.bf04eaa0.js"><link rel="prefetch" href="/m/assets/js/9.0dd0ff11.js"><link rel="prefetch" href="/m/assets/js/90.5e1e2630.js"><link rel="prefetch" href="/m/assets/js/91.6466b581.js"><link rel="prefetch" href="/m/assets/js/92.0dd7ffc6.js"><link rel="prefetch" href="/m/assets/js/93.045047c7.js"><link rel="prefetch" href="/m/assets/js/94.ce06dedb.js"><link rel="prefetch" href="/m/assets/js/95.f673ef28.js"><link rel="prefetch" href="/m/assets/js/96.1f73d13d.js"><link rel="prefetch" href="/m/assets/js/97.b1800fdc.js"><link rel="prefetch" href="/m/assets/js/98.245eb5e4.js"><link rel="prefetch" href="/m/assets/js/99.2cfc78a1.js">
    <link rel="stylesheet" href="/m/assets/css/0.styles.1e386fb6.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/m/" class="home-link router-link-active"><!----> <span class="site-name">嗯哼人生</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/m/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="https://cn100800.tk" target="_blank" rel="noopener noreferrer" class="nav-link external">
  主站
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="mailto:freecracy1024@gmail.com" class="nav-link external">
  mail
  <!----></a></div><div class="nav-item"><a href="https://google.com.hk" target="_blank" rel="noopener noreferrer" class="nav-link external">
  google
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/m/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="https://cn100800.tk" target="_blank" rel="noopener noreferrer" class="nav-link external">
  主站
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="mailto:freecracy1024@gmail.com" class="nav-link external">
  mail
  <!----></a></div><div class="nav-item"><a href="https://google.com.hk" target="_blank" rel="noopener noreferrer" class="nav-link external">
  google
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Go语言之旅</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/m/Go语言之旅/slice.html" class="sidebar-link">slice</a></li><li><a href="/m/Go语言之旅/0x00.开发环境.html" class="sidebar-link">0x00.开发环境</a></li><li><a href="/m/Go语言之旅/0x04.select.html" class="sidebar-link">0x04.select</a></li><li><a href="/m/Go语言之旅/0x05.编译器.html" class="sidebar-link">0x04.编译器</a></li><li><a href="/m/Go语言之旅/0x05.编译器02.html" class="sidebar-link">0x05.编译器02</a></li><li><a href="/m/Go语言之旅/0x06.数据结构.html" class="sidebar-link">0x06.数据结构</a></li><li><a href="/m/Go语言之旅/0x07.context.html" class="sidebar-link">0x07.context</a></li><li><a href="/m/Go语言之旅/0x08.性能剖析.html" class="active sidebar-link">0x08.性能剖析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/m/Go语言之旅/0x08.性能剖析.html#pprof-trace" class="sidebar-link">pprof + trace</a></li><li class="sidebar-sub-header"><a href="/m/Go语言之旅/0x08.性能剖析.html#godebug-看调度跟踪" class="sidebar-link">godebug 看调度跟踪</a></li><li class="sidebar-sub-header"><a href="/m/Go语言之旅/0x08.性能剖析.html#godebug-看-gc" class="sidebar-link">godebug 看 GC</a></li><li class="sidebar-sub-header"><a href="/m/Go语言之旅/0x08.性能剖析.html#mock" class="sidebar-link">mock</a></li><li class="sidebar-sub-header"><a href="/m/Go语言之旅/0x08.性能剖析.html#pprof" class="sidebar-link">pprof</a></li><li class="sidebar-sub-header"><a href="/m/Go语言之旅/0x08.性能剖析.html#生成火焰图" class="sidebar-link">生成火焰图</a></li><li class="sidebar-sub-header"><a href="/m/Go语言之旅/0x08.性能剖析.html#字节切片转字符串" class="sidebar-link">字节切片转字符串</a></li><li class="sidebar-sub-header"><a href="/m/Go语言之旅/0x08.性能剖析.html#gotraceback" class="sidebar-link">GOTRACEBACK</a></li><li class="sidebar-sub-header"><a href="/m/Go语言之旅/0x08.性能剖析.html#trace" class="sidebar-link">trace</a></li><li class="sidebar-sub-header"><a href="/m/Go语言之旅/0x08.性能剖析.html#mmu" class="sidebar-link">MMU</a></li><li class="sidebar-sub-header"><a href="/m/Go语言之旅/0x08.性能剖析.html#pprof-2" class="sidebar-link">pprof</a></li><li class="sidebar-sub-header"><a href="/m/Go语言之旅/0x08.性能剖析.html#gotool" class="sidebar-link">gotool</a></li><li class="sidebar-sub-header"><a href="/m/Go语言之旅/0x08.性能剖析.html#debug" class="sidebar-link">debug</a></li><li class="sidebar-sub-header"><a href="/m/Go语言之旅/0x08.性能剖析.html#偶尔异常" class="sidebar-link">偶尔异常</a></li><li class="sidebar-sub-header"><a href="/m/Go语言之旅/0x08.性能剖析.html#问题" class="sidebar-link">问题</a></li><li class="sidebar-sub-header"><a href="/m/Go语言之旅/0x08.性能剖析.html#竞态检测" class="sidebar-link">竞态检测</a></li><li class="sidebar-sub-header"><a href="/m/Go语言之旅/0x08.性能剖析.html#gops" class="sidebar-link">gops</a></li><li class="sidebar-sub-header"><a href="/m/Go语言之旅/0x08.性能剖析.html#pprof-4" class="sidebar-link">pprof</a></li><li class="sidebar-sub-header"><a href="/m/Go语言之旅/0x08.性能剖析.html#go-callvis" class="sidebar-link">go-callvis</a></li><li class="sidebar-sub-header"><a href="/m/Go语言之旅/0x08.性能剖析.html#goroutine-泄漏" class="sidebar-link">goroutine 泄漏</a></li><li class="sidebar-sub-header"><a href="/m/Go语言之旅/0x08.性能剖析.html#案例分析" class="sidebar-link">案例分析</a></li><li class="sidebar-sub-header"><a href="/m/Go语言之旅/0x08.性能剖析.html#cpu-profiler" class="sidebar-link">cpu profiler</a></li><li class="sidebar-sub-header"><a href="/m/Go语言之旅/0x08.性能剖析.html#memory-profiler" class="sidebar-link">memory profiler</a></li><li class="sidebar-sub-header"><a href="/m/Go语言之旅/0x08.性能剖析.html#trace-3" class="sidebar-link">trace</a></li><li class="sidebar-sub-header"><a href="/m/Go语言之旅/0x08.性能剖析.html#perf" class="sidebar-link">perf</a></li><li class="sidebar-sub-header"><a href="/m/Go语言之旅/0x08.性能剖析.html#基准测试" class="sidebar-link">基准测试</a></li><li class="sidebar-sub-header"><a href="/m/Go语言之旅/0x08.性能剖析.html#例子" class="sidebar-link">例子</a></li><li class="sidebar-sub-header"><a href="/m/Go语言之旅/0x08.性能剖析.html#常见问题" class="sidebar-link">常见问题</a></li><li class="sidebar-sub-header"><a href="/m/Go语言之旅/0x08.性能剖析.html#逃逸分析" class="sidebar-link">逃逸分析</a></li><li class="sidebar-sub-header"><a href="/m/Go语言之旅/0x08.性能剖析.html#监控" class="sidebar-link">监控</a></li><li class="sidebar-sub-header"><a href="/m/Go语言之旅/0x08.性能剖析.html#runtime-setfinalizer" class="sidebar-link">runtime.SetFinalizer</a></li><li class="sidebar-sub-header"><a href="/m/Go语言之旅/0x08.性能剖析.html#trace-vs-pprof" class="sidebar-link">trace vs pprof</a></li><li class="sidebar-sub-header"><a href="/m/Go语言之旅/0x08.性能剖析.html#优化" class="sidebar-link">优化</a></li><li class="sidebar-sub-header"><a href="/m/Go语言之旅/0x08.性能剖析.html#例子-2" class="sidebar-link">例子</a></li><li class="sidebar-sub-header"><a href="/m/Go语言之旅/0x08.性能剖析.html#逃逸场景" class="sidebar-link">逃逸场景</a></li><li class="sidebar-sub-header"><a href="/m/Go语言之旅/0x08.性能剖析.html#常驻内存对象个数" class="sidebar-link">常驻内存对象个数</a></li><li class="sidebar-sub-header"><a href="/m/Go语言之旅/0x08.性能剖析.html#小结" class="sidebar-link">小结</a></li><li class="sidebar-sub-header"><a href="/m/Go语言之旅/0x08.性能剖析.html#监控自动化" class="sidebar-link">监控自动化</a></li></ul></li><li><a href="/m/Go语言之旅/0x09.reflect.html" class="sidebar-link">0x09.reflect</a></li><li><a href="/m/Go语言之旅/0x12.interface.html" class="sidebar-link">0x12.interface</a></li><li><a href="/m/Go语言之旅/0x13.package.html" class="sidebar-link">0x13.package</a></li><li><a href="/m/Go语言之旅/0x14.问题集.html" class="sidebar-link">0x14.问题集</a></li><li><a href="/m/Go语言之旅/0x15.leet.html" class="sidebar-link">0x15.leet</a></li><li><a href="/m/Go语言之旅/0x16.命令行参数.html" class="sidebar-link">0x16.命令行参数</a></li><li><a href="/m/Go语言之旅/GODEBUG.html" class="sidebar-link">GODEBUG</a></li><li><a href="/m/Go语言之旅/bitmap.html" class="sidebar-link">bitmap</a></li><li><a href="/m/Go语言之旅/channel.html" class="sidebar-link">channel</a></li><li><a href="/m/Go语言之旅/defer.html" class="sidebar-link">defer</a></li><li><a href="/m/Go语言之旅/gmp模型.html" class="sidebar-link">gmp 模型</a></li><li><a href="/m/Go语言之旅/make.html" class="sidebar-link">make</a></li><li><a href="/m/Go语言之旅/map.html" class="sidebar-link">map</a></li><li><a href="/m/Go语言之旅/mock.html" class="sidebar-link">mock</a></li><li><a href="/m/Go语言之旅/0x03.内存模型.html" class="sidebar-link">0x03.内存模型</a></li><li><a href="/m/Go语言之旅/tool.html" class="sidebar-link">tool</a></li><li><a href="/m/Go语言之旅/内存管理.html" class="sidebar-link">第四章 : 内存管理</a></li><li><a href="/m/Go语言之旅/协程池.html" class="sidebar-link">协程池</a></li><li><a href="/m/Go语言之旅/协程调度.html" class="sidebar-link">第三章 : 协程调度</a></li><li><a href="/m/Go语言之旅/垃圾回收.html" class="sidebar-link">垃圾回收</a></li><li><a href="/m/Go语言之旅/基础.html" class="sidebar-link">基础</a></li><li><a href="/m/Go语言之旅/工具集.html" class="sidebar-link">工具集</a></li><li><a href="/m/Go语言之旅/常用数据结构实现原理.html" class="sidebar-link">第一章 : 常用数据结构实现原理</a></li><li><a href="/m/Go语言之旅/常见控制结构实现原理.html" class="sidebar-link">第二章 : 常见控制结构实现原理</a></li><li><a href="/m/Go语言之旅/并发控制.html" class="sidebar-link">第五章 : 并发控制</a></li><li><a href="/m/Go语言之旅/思考题.html" class="sidebar-link">思考题</a></li><li><a href="/m/Go语言之旅/文件操作.html" class="sidebar-link">文件操作</a></li><li><a href="/m/Go语言之旅/框架.html" class="sidebar-link">框架</a></li><li><a href="/m/Go语言之旅/泛型.html" class="sidebar-link">泛型</a></li><li><a href="/m/Go语言之旅/版本更新.html" class="sidebar-link">版本更新</a></li><li><a href="/m/Go语言之旅/调试.html" class="sidebar-link">调试</a></li><li><a href="/m/Go语言之旅/进程线程协程.html" class="sidebar-link">进程线程协程</a></li><li><a href="/m/Go语言之旅/部署.html" class="sidebar-link">部署</a></li><li><a href="/m/Go语言之旅/闭包.html" class="sidebar-link">闭包</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>文章</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>标准库</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>源码</span> <span class="arrow right"></span></p> <!----></section></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Redis</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Deno</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>其他</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>周末闲谈</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>深度好文</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>漫步 Linux</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>算法</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>设计模式</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>鸡汤软文</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="_0x08-性能剖析"><a href="#_0x08-性能剖析" class="header-anchor">#</a> 0x08.性能剖析</h1> <h2 id="pprof-trace"><a href="#pprof-trace" class="header-anchor">#</a> pprof + trace</h2> <h3 id="性能剖析-pprof"><a href="#性能剖析-pprof" class="header-anchor">#</a> 性能剖析 pprof</h3> <p>GOGC 默认 100 使得堆大小到达它初始态的两倍时触发 GC,这个值改成一个更大的数会延缓 GC 的触发,降低 GC 频率.大约配置 2000.</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">go</span> http<span class="token punctuation">.</span><span class="token function">ListenAndServe</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:8080&quot;</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
<span class="token keyword">for</span> <span class="token punctuation">{</span>
	b <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">,</span> <span class="token number">4096</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">len</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		b<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> b<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token number">0xf</span>
	<span class="token punctuation">}</span>
	time<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">.</span>Nanosecond<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><ol><li>web 界面</li> <li>交互模式</li> <li>火焰图</li></ol> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token function">curl</span> <span class="token string">'http://localhost:8080/debug/pprof/allocs?debug=1'</span> <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span>/dev/null <span class="token operator">|</span><span class="token function">grep</span> PauseNs <span class="token comment"># curl查看GC的STW时间</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="性能剖析-trace"><a href="#性能剖析-trace" class="header-anchor">#</a> 性能剖析 trace</h3> <h2 id="godebug-看调度跟踪"><a href="#godebug-看调度跟踪" class="header-anchor">#</a> godebug 看调度跟踪</h2> <h2 id="godebug-看-gc"><a href="#godebug-看-gc" class="header-anchor">#</a> godebug 看 GC</h2> <p><a href="https://book.eddycjy.com/golang/tools/go-tool-pprof.html" target="_blank" rel="noopener noreferrer">godebug<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>尽量自动化一切能够自动化的步骤,让工程师审查真正重要的逻辑和设计</p> <p>goimports:官方,就是等 于 gofmt 加上依赖包管理 代码规范,包管理</p> <p>golint:官方,可定制化较低,静态代码检查</p> <p>更推荐的方法是在基础库或者框架中使用 golint 进行 静态检查(或者同时使用 golint 和 golangci-lint)， 在其他的项目中使用可定制化的 golangci-lint 来进行 静态检查，因为在基础库和框架中施加强限制对于整体 的代码质量有着更大的收益。</p> <p>按照职责垂直拆分的方式在单体服务遇到瓶颈时非 常容易对微服务进行拆分，我们可以直接将一个负 责独立功能的 package 拆出去，对这部分性能热点 单独进行扩容;区别于传统的层级水平拆分(MVC)</p> <p>我们不应该在 init 中做过重的初始化逻辑， 而是做一些简单、轻量的前置条件判断</p> <h2 id="mock"><a href="#mock" class="header-anchor">#</a> mock</h2> <h3 id="接口"><a href="#接口" class="header-anchor">#</a> 接口</h3> <p>golang/gomock</p> <p>mockgen</p> <h3 id="数据库"><a href="#数据库" class="header-anchor">#</a> 数据库</h3> <p>sqlmock</p> <h3 id="http"><a href="#http" class="header-anchor">#</a> HTTP</h3> <p>httpmock</p> <h3 id="任意函数"><a href="#任意函数" class="header-anchor">#</a> 任意函数</h3> <p>bouk/monkey:万能的方法，但是只在万不得已 时使用，类似的代码写起来非常冗长而且 不直观;</p> <p>断言:使用社区的 <a href="https://github.com/stretchr/testify" target="_blank" rel="noopener noreferrer">testify<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 快速验证方法的返回 值;</p> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code><span class="token builtin class-name">echo</span> -e <span class="token string">'HTTP/1.1 200 OK<span class="token entity" title="\n">\n</span>Access-Control-Allow-Origin: *<span class="token entity" title="\n">\n</span>Content-type: text/event-stream<span class="token entity" title="\n">\n</span>'</span> <span class="token operator">&amp;&amp;</span> <span class="token function">tail</span> -f ./iam.log <span class="token operator">|</span> <span class="token function">sed</span> -e <span class="token string">'s/^/data: /;s/$/<span class="token entity" title="\\">\\</span>n/'</span> <span class="token operator">|</span> <span class="token function">nc</span> -l <span class="token number">1234</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-sh line-numbers-mode"><pre class="language-sh"><code>mylxsw/remote-tail
http://taillog.cn
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h2 id="pprof"><a href="#pprof" class="header-anchor">#</a> pprof</h2> <p><a href="https://github.com/google/pprof/blob/master/doc/README.md" target="_blank" rel="noopener noreferrer">pprof<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>可视化性能分析工具</p> <h3 id="采样方式"><a href="#采样方式" class="header-anchor">#</a> 采样方式</h3> <ol><li>runtime/pprof: 采集程序(非 server )指定区块的运行数据进行分析</li> <li>net/http/pprof: 采集 server 运行时数据</li> <li>go test: 通过运行测试用例采集数据</li></ol> <h3 id="使用方法"><a href="#使用方法" class="header-anchor">#</a> 使用方法</h3> <ol><li>生产报告</li> <li>交互终端</li> <li>web 界面</li></ol> <h3 id="web-界面"><a href="#web-界面" class="header-anchor">#</a> web 界面</h3> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="交互终端"><a href="#交互终端" class="header-anchor">#</a> 交互终端</h3> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>go tool pprof http://localhost:8080/debug/pprof/profile?second<span class="token operator">=</span><span class="token number">60</span>
go tool pprof https+insecure://localhost:8080/debug/pprof/profile?second<span class="token operator">=</span><span class="token number">60</span> <span class="token comment"># tls</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h2 id="生成火焰图"><a href="#生成火焰图" class="header-anchor">#</a> 生成火焰图</h2> <ul><li>perf</li> <li>systemtap</li> <li>go-torch</li></ul> <h2 id="字节切片转字符串"><a href="#字节切片转字符串" class="header-anchor">#</a> 字节切片转字符串</h2> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	b <span class="token operator">:=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">{</span><span class="token string">'a'</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">,</span> <span class="token string">'c'</span><span class="token punctuation">}</span>
	a <span class="token operator">:=</span> <span class="token function">string</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><img src="/m/assets/img/memery-slice-string.1e84e072.png" alt="字节切片转字符串内存分配"></p> <h2 id="gotraceback"><a href="#gotraceback" class="header-anchor">#</a> GOTRACEBACK</h2> <p>gotraceback 环境变量控制 core dump 的输出.</p> <table><thead><tr><th>值</th> <th>作用</th></tr></thead> <tbody><tr><td>none</td> <td>不显示任何堆栈跟踪</td></tr> <tr><td>single</td> <td>默认选项,显示当前 goroutine 堆栈跟踪</td></tr> <tr><td>all</td> <td>显示所有用户创建的 goroutine 堆栈跟踪</td></tr> <tr><td>system</td> <td>显示所有堆栈跟踪,甚至运行时的跟踪</td></tr> <tr><td>crash</td> <td>如果没有足够日志或崩溃无法重现,这是个不错的选择</td></tr></tbody></table> <h3 id="delve"><a href="#delve" class="header-anchor">#</a> delve</h3> <p><a href="https://github.com/go-delve/delve" target="_blank" rel="noopener noreferrer">delve<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>dlv <span class="token builtin class-name">exec</span> ./main <span class="token comment"># 调试二进制</span>
dlv attach pid ./main <span class="token comment"># 调试进程</span>
dlv core ./main core.0000 <span class="token comment"># 调试 core 文件</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><table><thead><tr><th>命令</th> <th>作用</th></tr></thead> <tbody><tr><td>call</td> <td>call 函数,会导致程序运行</td></tr> <tr><td>continue</td> <td>继续运行</td></tr> <tr><td>next</td> <td>单步调试</td></tr> <tr><td>restart</td> <td>重启</td></tr> <tr><td>step</td> <td>单步调试,某个函数</td></tr> <tr><td>step-instruction</td> <td>单步调试汇编指令</td></tr> <tr><td>stepout</td> <td>从当前函数跳出</td></tr> <tr><td>break (alias b)</td> <td>设置断点</td></tr> <tr><td>breakpoint (alias bp)</td> <td>打印所有断点信息</td></tr> <tr><td>clear</td> <td>清理断点</td></tr> <tr><td>clearall</td> <td>清理所有断点</td></tr> <tr><td>condition (alias cond)</td> <td>设置条件断点</td></tr> <tr><td>on</td> <td>当断点命中时设置一段命令</td></tr> <tr><td>trace (alias t)</td> <td>设置跟踪点其实是一个只打印信息不中断程序的端点</td></tr> <tr><td>args</td> <td>打印程序的传参</td></tr> <tr><td>examinemem (alias x)</td> <td>解析内存</td></tr> <tr><td>locals</td> <td>打印本地变量</td></tr> <tr><td>print (alias p)</td> <td>打印表达式或变量</td></tr> <tr><td>regs</td> <td>打印寄存器信息</td></tr> <tr><td>set</td> <td>赋值</td></tr> <tr><td>vars</td> <td>打印全局变量</td></tr> <tr><td>whatis</td> <td>打印类型信息</td></tr> <tr><td>goroutine (alias gr)</td> <td>打印协程信息</td></tr> <tr><td>goroutines (alias grs)</td> <td>打印所有协程 <code>-t</code>展开所有堆栈</td></tr> <tr><td>thread (alias tr)</td> <td>切换到某个线程</td></tr> <tr><td>threads</td> <td>打印所有线程信息</td></tr> <tr><td>deferred</td> <td>在 defer 函数上下文执行命令</td></tr> <tr><td>down</td> <td>上堆栈</td></tr> <tr><td>frame</td> <td>跳到某个具体堆栈</td></tr> <tr><td>stack (alias bt)</td> <td>打印堆栈信息</td></tr> <tr><td>up</td> <td>下堆栈</td></tr> <tr><td>config</td> <td>配置变更</td></tr> <tr><td>disassemble (alias disass)</td> <td>反汇编</td></tr> <tr><td>funcs</td> <td>打印所有函数符号</td></tr> <tr><td>libraries</td> <td>打印所有加载的动态库</td></tr> <tr><td>list (alias ls | l)</td> <td>显示源码</td></tr> <tr><td>types</td> <td>打印所有类型信息</td></tr></tbody></table> <h2 id="trace"><a href="#trace" class="header-anchor">#</a> trace</h2> <div class="language-sh line-numbers-mode"><pre class="language-sh"><code>go <span class="token builtin class-name">test</span> -trace trace.out
<span class="token function">curl</span> http://debug/pprof/trace?seconds<span class="token operator">=</span><span class="token number">60</span> <span class="token operator">&gt;</span> trace.out
go tool trace trace.out
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h2 id="mmu"><a href="#mmu" class="header-anchor">#</a> MMU</h2> <h2 id="pprof-2"><a href="#pprof-2" class="header-anchor">#</a> pprof</h2> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// runtime/pprof.go</span>
<span class="token comment">// 堆栈分析</span>
<span class="token keyword">func</span> <span class="token function">WriteHeapProfile</span><span class="token punctuation">(</span>w io<span class="token punctuation">.</span>Writer<span class="token punctuation">)</span> <span class="token builtin">error</span>
<span class="token comment">// cpu分析</span>
<span class="token keyword">func</span> <span class="token function">StartCPUProfile</span><span class="token punctuation">(</span>w io<span class="token punctuation">.</span>Writer<span class="token punctuation">)</span> <span class="token builtin">error</span>
<span class="token keyword">func</span> <span class="token function">StopCPUProfile</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>pprof 是二进制文件,需要需要生成 svg、pdf、png 等格式文件</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>go tool pprof -svg ./pprof
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="gotool"><a href="#gotool" class="header-anchor">#</a> gotool</h2> <h3 id="nm"><a href="#nm" class="header-anchor">#</a> nm</h3> <p>查看符号表,等同于系统 nm 命令,</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>go tool nm main <span class="token comment"># 地址 类型 符号</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="compile"><a href="#compile" class="header-anchor">#</a> compile</h3> <p>查看汇编代码</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>go tool compile -N -l -S main.go
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="objdump"><a href="#objdump" class="header-anchor">#</a> objdump</h3> <p>反汇编的二进制工具,等同于系统 objdump.</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>go tool objdump main.o
go tool objdump -s main main.o <span class="token comment"># 反汇编某个函数</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="pprof-3"><a href="#pprof-3" class="header-anchor">#</a> pprof</h3> <p>如果是 net/http/pprof 方式可以直接在控制台输入,浏览器查看,也可以把信息 dump 到本地,通过 tool 去分析</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">curl</span> -sS <span class="token string">'http://127.0.0.1/debug/pprof/heap?seconds=5'</span> -o heap.pprof <span class="token comment"># dump 内存</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ol><li>cpu 分析 : 采样消耗 cpu 的调用,一般用来定位排查耗费计算资源的地方</li> <li>memroy : 内存分析,一般用来排查内存占用,内存泄漏问题,每 512KB 采样一次内存采样是针对堆栈不是类型.内存采样一定是通过<code>mProf_Malloc,mProf_Free</code>两个函数,如果 cgo 分配的内存,不会调用这两个函数,所以 cgo 导致的内存问题 <code>go tool pprof</code>是分析不出来的</li> <li>Block : 阻塞分析,采样程序阻塞调用</li> <li>Mutex : 互斥锁分析,采样互斥锁竞争情况</li> <li>goroutine 分析: 可以对当前应用程序正在运行的 goroutine 进行堆栈跟踪和分析</li></ol> <blockquote><p><code>?debug=1</code>不带 debug 参数会自动下载对应 profile 文件,部署环境中,为了安全不会对外暴露 pprof 端口,会通过 curl、wget 方式进行 profile 文件间接拉取,debug 有实效性,经常需要及时将当前状态下 profile 文件存储下来进行分析.</p></blockquote> <h3 id="trace-2"><a href="#trace-2" class="header-anchor">#</a> trace</h3> <p>STW 然后 get context(栈信息), goroutine 快照,恢复运行将 trace 信息推送到 trace buffer,trace 允许跟踪采样一段时间的信息,然后 dump 成文件,最后调用<code>go tool trace</code>分析 dump 文件,并以 web 形式打开.w 可以放大时间线.</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>go run main.go <span class="token operator"><span class="token file-descriptor important">2</span>&gt;</span> trace.out
go tool trace trace.out
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ol><li>gc(idle) 是没有工作时标记内存的 goroutine</li> <li>STW 两个停止阶段</li> <li>mark assist 重新执行分配内存重新标记内存的 goroutine</li> <li>GXX runtime.bgweep 内存扫描阶段</li> <li>GXX runtime.gcBgMarkWorker 标记内存专有 goroutine</li> <li>syscall 系统调用</li></ol> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	trace<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>Stderr<span class="token punctuation">)</span>
	<span class="token keyword">defer</span> trace<span class="token punctuation">.</span><span class="token function">Stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	ch <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token keyword">chan</span> <span class="token builtin">string</span><span class="token punctuation">)</span>
	<span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		ch <span class="token operator">&lt;-</span> <span class="token string">&quot;EDDYCJY&quot;</span>
	<span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token operator">&lt;-</span>ch
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><table><thead><tr><th>列</th> <th>描述</th></tr></thead> <tbody><tr><td>view trace</td> <td>查看跟踪</td></tr> <tr><td>goroutine analysis</td> <td>goroutine 分析,每个函数块有多少 goroutine 在跑</td></tr> <tr><td>network blocking profile</td> <td>网络阻塞情况</td></tr> <tr><td>synchronization blocking profile</td> <td>同步阻塞情况</td></tr> <tr><td>syscall blocking profile</td> <td>系统调用情况</td></tr> <tr><td>scheduler latency profile</td> <td>调度延迟情况,可以查看调度过程</td></tr> <tr><td>user defined tasks</td> <td>用户自定义任务</td></tr> <tr><td>user defined regions</td> <td>用户自定义区域</td></tr> <tr><td>mininum mutator utilization</td> <td>最低 mutator 利用</td></tr></tbody></table> <h3 id="test"><a href="#test" class="header-anchor">#</a> test</h3> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>go <span class="token builtin class-name">test</span> -c <span class="token comment"># 编译测试文件,可以一台机器编译,一台机器测试</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="cover"><a href="#cover" class="header-anchor">#</a> cover</h3> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>go <span class="token builtin class-name">test</span> -coverprofile<span class="token operator">=</span>coverage.out <span class="token comment"># 跑单测的时候记录代码覆盖率</span>
go tool cover -func<span class="token operator">=</span>coverage.out <span class="token comment"># 得到覆盖率报告</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h2 id="debug"><a href="#debug" class="header-anchor">#</a> debug</h2> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token assign-left variable">GODEBUG</span><span class="token operator">=</span><span class="token string">&quot;allocfreetrace=1&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="偶尔异常"><a href="#偶尔异常" class="header-anchor">#</a> 偶尔异常</h2> <p>cpu、内存、goroutine 暴涨都可以用数值表示(突然比正常平均值高出百分之 N、超过模块正常情况下最高水位)</p> <ol><li>cpu 抖动 : 模块内触发率低的逻辑</li> <li>内存使用抖动 : 大量请求创建过多对象、也可能 goroutine 泄漏</li> <li>goroutine 数暴涨 : 可能是死锁,可能是生产完了 channel 没关闭</li></ol> <p>请几个周期收集数据,当出现波动时 dump 数据,文件保存下来模块挂了也无所谓.</p> <ol><li>dump 当前 goroutine 栈</li> <li>dump 当前 cpu profile</li> <li>dump 当前 off-cpu profile</li> <li>dump 几秒的 trace (消耗资源,不建议)</li> <li>cpu 内存的采集,物理机 gopsutil, docker cgroup</li></ol> <h2 id="问题"><a href="#问题" class="header-anchor">#</a> 问题</h2> <ol><li>升级最新稳定版</li> <li>pprof cpu(GC)、内存、堆栈采样(大对象分配)</li></ol> <h2 id="竞态检测"><a href="#竞态检测" class="header-anchor">#</a> 竞态检测</h2> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>go <span class="token builtin class-name">test</span> -race
go run -race
bo build -race
go <span class="token function">install</span> -race
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h2 id="gops"><a href="#gops" class="header-anchor">#</a> gops</h2> <p><a href="https://github.com/google/gops" target="_blank" rel="noopener noreferrer">gops<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="pprof-4"><a href="#pprof-4" class="header-anchor">#</a> pprof</h2> <ol><li>heap : 活动对象的内存分配</li> <li>threadcreate : 导致创建新 OS 线程的堆栈跟踪</li> <li>goroutine : 所有当前 goroutine 的堆栈跟踪</li> <li>allocs : 活动对象的内存分配采样</li> <li>Block : 导致阻塞的堆栈跟踪</li> <li>Mutex : 竞争互斥的堆栈跟踪</li></ol> <h2 id="go-callvis"><a href="#go-callvis" class="header-anchor">#</a> go-callvis</h2> <p><a href="https://github.com/ofabry/go-callvis" target="_blank" rel="noopener noreferrer">go-callvis<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="goroutine-泄漏"><a href="#goroutine-泄漏" class="header-anchor">#</a> goroutine 泄漏</h2> <p>常规 pprof dump 两份采样数据,<code>--base</code>比较.</p> <h3 id="主动关闭-resp"><a href="#主动关闭-resp" class="header-anchor">#</a> 主动关闭 resp</h3> <div class="language-go line-numbers-mode"><pre class="language-go"><code>client <span class="token operator">:=</span> <span class="token operator">&amp;</span>http<span class="token punctuation">.</span>Client<span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> client<span class="token punctuation">.</span><span class="token function">Do</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span>
<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
	<span class="token comment">//...</span>
<span class="token punctuation">}</span>
<span class="token keyword">defer</span> resp<span class="token punctuation">.</span>Body<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 不关闭会导致 goroutine 泄漏</span>
<span class="token comment">// net/http/transport.go:dailconn</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>t <span class="token operator">*</span>Transport<span class="token punctuation">)</span> <span class="token function">dialConn</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token operator">...</span>
	<span class="token keyword">go</span> pconn<span class="token punctuation">.</span><span class="token function">readLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">go</span> pconn<span class="token punctuation">.</span><span class="token function">writeLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">return</span> pconn<span class="token punctuation">,</span> <span class="token boolean">nil</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h2 id="案例分析"><a href="#案例分析" class="header-anchor">#</a> 案例分析</h2> <h3 id="案例-1"><a href="#案例-1" class="header-anchor">#</a> 案例 1</h3> <h4 id="问题-2"><a href="#问题-2" class="header-anchor">#</a> 问题</h4> <p>内存疯长</p> <h4 id="排查过程"><a href="#排查过程" class="header-anchor">#</a> 排查过程</h4> <ol><li>引入 pprof : 程序中引入 pprof</li> <li>gotest : 使用 gotest 发起测试请求</li> <li>查看 pprof 的 goroutine : goroutine 滞留导致栈没有被释放、goroutine 没有被释放、goroutine 指向的对象没有被回收</li> <li>原因 channel 阻塞 : channel 阻塞是 goroutine 泄漏的主要发生点,如 rpc、http 请求流未能关闭</li> <li>并发 test 原因 : 客户端作为单例,不是线程安全的,没有并发控制,遇到并发请求时会创建大量客户端</li> <li>代码 : map 清理时没有释放里面的连接、读取配置文件出错没有异常处理没有异常处理,使用默认值(默认值很小)</li></ol> <h2 id="cpu-profiler"><a href="#cpu-profiler" class="header-anchor">#</a> cpu profiler</h2> <p>使用 setitimer 系统调用,操作系统会每秒 100 次向程序发送 SIGPROF 信号.在 GO 进程中会选择随机的信号执行 sigtrampgo 函数.该函数使用 sigprof 或 sigprofNonGo 来记录线程当前的栈.</p> <h3 id="on-cpu-profiler"><a href="#on-cpu-profiler" class="header-anchor">#</a> on-cpu profiler</h3> <p>内置,对于瓶颈在 cpu 消耗的应用.</p> <h3 id="off-cpu-profiler"><a href="#off-cpu-profiler" class="header-anchor">#</a> off-cpu profiler</h3> <p>fgprof,对于 cpu 使用不高,但接口延迟却很大的应用.fgprof 是启动一个后台的 goroutine 每秒启动 99 次,调用 runtime.GoroutineProfile 来采集所有 goroutine 的栈.性能消耗大,只适合在测试环境使用.</p> <h2 id="memory-profiler"><a href="#memory-profiler" class="header-anchor">#</a> memory profiler</h2> <ul><li>inuse_objects : 内存中驻留对象</li> <li>inuse_space : 应用占用 RSS 过大</li> <li>alloc_objects : 历史上大量内存分配行为导致 cpu 或内存大幅上升</li> <li>alloc_space : 历史上发生过内存使用大量上升时</li></ul> <h2 id="trace-3"><a href="#trace-3" class="header-anchor">#</a> trace</h2> <p>一般情况下不需要 trace 来定位性能问题,通过压测 + profile 可以解决大部分问题,当问题与 runtime 有关,采集 trace 对性能影响还是比较大的,开启 gctrace 把日志重定向到文件,因为 gctrace 日志 print 是在 stw 期间做的.</p> <h2 id="perf"><a href="#perf" class="header-anchor">#</a> perf</h2> <p>如果应用没有开启 pprof,线上应急使用可以临时使用 perf</p> <h2 id="基准测试"><a href="#基准测试" class="header-anchor">#</a> 基准测试</h2> <p>benchmark</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>go <span class="token builtin class-name">test</span> -bench<span class="token operator">=</span>.
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="例子"><a href="#例子" class="header-anchor">#</a> 例子</h2> <h3 id="和-fmt"><a href="#和-fmt" class="header-anchor">#</a> + 和 fmt</h3> <p>使用 + 进行字符串拼接不会在堆上产生额外的对象,使用 fmt 系列函数,会造成局部对象逃逸到堆上.导致线上 GC 压力过大.</p> <h3 id="sync-pool"><a href="#sync-pool" class="header-anchor">#</a> sync.Pool</h3> <p>复用堆上对象.</p> <h2 id="常见问题"><a href="#常见问题" class="header-anchor">#</a> 常见问题</h2> <ol><li>调度占用过多 cpu : goroutine 频繁创建和销毁</li> <li>进程占用大量内存</li> <li>锁冲突严重</li></ol> <h2 id="逃逸分析"><a href="#逃逸分析" class="header-anchor">#</a> 逃逸分析</h2> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token comment"># src/cmd/compile/internal/gc/escape.go</span>
go build -gcflags <span class="token string">&quot;-m -l&quot;</span> main.go <span class="token comment"># -m 逃逸分析 -l 禁止内连</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><blockquote><p>切片 append 可能引发逃逸分析,当 cap 附加元素超过 cap 时,运行时会在堆上分配一个更大的空间将原栈上的元素复制过去,后续该切片的元素就存储在堆上,创建 slice 时建议带上预估的 cap,减少堆内存的频繁分配,切片变量未逃逸的情况下,在 cap 容量下所有元素都分配在栈上</p></blockquote> <h3 id="原则"><a href="#原则" class="header-anchor">#</a> 原则</h3> <ol><li>指向栈对象的指针不能存储在堆中</li> <li>指向栈对象的指针不能超过该对象的存活期(指针不能在栈对象销毁后依然存活)</li></ol> <h3 id="实现"><a href="#实现" class="header-anchor">#</a> 实现</h3> <ol><li>构建一个有向加权图,代表由语句和表达式分配的变量,边代表变量之间的赋值,权重代表寻址和取址的次数</li> <li>遍历该有向加权图,在图中 寻找可能违反上述不变量条件的的赋值路径,如果一个变量的地址是存储在堆或其他可能超过它存活期的地方,权重减为负数,那么就会被标记为需要在堆上分配</li> <li>为了支持函数间的分析,记录每个函数的参数到堆以及其结果到数据流,算法将这些信息称为参数标签,这些标签在静态调用时使用,以改善对函数参数的逃逸分析</li></ol> <h3 id="手动强制避免逃逸"><a href="#手动强制避免逃逸" class="header-anchor">#</a> 手动强制避免逃逸</h3> <p>通过 uintptr 做一次转换,将指针转换成数值,切断了逃逸分析的数据流跟踪,避免指针逃逸.</p> <h2 id="监控"><a href="#监控" class="header-anchor">#</a> 监控</h2> <ol><li><a href="https://github.com/shirou/gopsutil" target="_blank" rel="noopener noreferrer">gopsutil<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ol> <h2 id="runtime-setfinalizer"><a href="#runtime-setfinalizer" class="header-anchor">#</a> runtime.SetFinalizer</h2> <p>实现析构函数.</p> <p>net/http/pprof 不使用时不会造成影响</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>go tool pprof --http :8080 <span class="token comment"># 获取远程 profile 文件</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="trace-vs-pprof"><a href="#trace-vs-pprof" class="header-anchor">#</a> trace vs pprof</h2> <ol><li><p>trace : 侧重分析采样时间内系统做了什么,原理是监听调度器事件,记录操作耗时相关信息,为每个 event 打上时间,性能开销较大</p> <p>a. 与 goroutine 调度有关的事件,创建、启动、结束,同步原语(mutex、channel 收发)上的阻塞和解锁</p> <p>b. 与网络有关的事件,goroutine 在网络 io 上的阻塞和解锁</p> <p>c. 与系统调用有关的事件,goroutine 进入系统调用与从系统调用的返回</p> <p>d. 与 gc 有关的事件, GC 开始,停止,并发标记,清扫开始和暂停</p></li> <li><p>pprof : 微秒级采样可以使用 uber 的 pprof++,及 pprof label 的使用</p></li></ol> <h2 id="优化"><a href="#优化" class="header-anchor">#</a> 优化</h2> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// pp 分析具体代码块</span>
pprof<span class="token punctuation">.</span><span class="token function">StartCPUProfile</span><span class="token punctuation">(</span>cpu<span class="token punctuation">.</span>pprof<span class="token punctuation">)</span>
pprof<span class="token punctuation">.</span>StopCPUProfile
<span class="token comment">// 找到性能瓶颈</span>
<span class="token keyword">go</span> tool pprof cpu<span class="token punctuation">.</span>pprof <span class="token operator">&gt;</span> top10
<span class="token comment">// 单测 &amp; 压测 优化</span>
<span class="token keyword">go</span> test
testing<span class="token punctuation">.</span>AllocsPerRun <span class="token comment">// 测试查看内存</span>
<span class="token keyword">go</span> benchmark
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h2 id="例子-2"><a href="#例子-2" class="header-anchor">#</a> 例子</h2> <div class="language-go line-numbers-mode"><pre class="language-go"><code>sync<span class="token punctuation">.</span>pool <span class="token comment">// sync.Pool 处理大对象,因为会直接在堆上分配</span>
<span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">byte</span><span class="token punctuation">)</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 字符串-&gt; 字节切片</span>
<span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token builtin">string</span><span class="token punctuation">)</span><span class="token punctuation">(</span>unsafe<span class="token punctuation">.</span><span class="token function">Pointer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>buf<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 字节切片 -&gt; 字符串 缓存区不能修改,否则会 panic</span>
<span class="token comment">// 重置缓存区</span>
bytes<span class="token punctuation">.</span>Buffer<span class="token punctuation">.</span>Reset
buf <span class="token operator">=</span> buf<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><ol><li>优先选择初始分配大小的数组,而不是不指定大小将其留给增长因子</li></ol> <h2 id="逃逸场景"><a href="#逃逸场景" class="header-anchor">#</a> 逃逸场景</h2> <p>避免 gc 从以下四个方面入手:</p> <ol><li>指针逃逸 : 返回局部变量的指针</li> <li>栈空间不足(空间开辟过大) : 当栈空间不足以存放当前对象时或无法判断当前切片长度时会将对象分配到堆上</li> <li>动态类型逃逸(不确定对象大小)</li> <li>闭包引用对象逃逸</li></ol> <h2 id="常驻内存对象个数"><a href="#常驻内存对象个数" class="header-anchor">#</a> 常驻内存对象个数</h2> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>go tool pprof -inuse_objects http://127.0.0.1:6060/debug/pprof/heap
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="小结"><a href="#小结" class="header-anchor">#</a> 小结</h2> <ul><li><p>cpu、内存、磁盘 io、网络 io、socket fd 文件数量</p></li> <li><p>goroutine</p></li> <li><p>profile (syscall、scanobject 等)</p></li> <li><p>head (降低常驻内存对象可以降低 GC 频率)</p></li> <li><p>默认 512kb 采样<code>runtime.MemProfileRate</code>调整采样频率</p></li></ul> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>heap
<span class="token function">top</span> -cum <span class="token comment"># 将函数调用关系中的数据进行累积</span>
go tool pprof -alloc_space -cum -svg http://127.0.0.1:8080/debug/pprof/heap <span class="token operator">&gt;</span> heap.svg <span class="token comment"># 直接生成 svg 图片</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><ul><li><code>--inuse_space</code> : 来分析程序常驻内存的占用情况,heap 内存</li> <li><code>--alloc_objects</code> : 来分析内存的临时分配情况, 应该是 stack 内存</li></ul> <h3 id="建议"><a href="#建议" class="header-anchor">#</a> 建议</h3> <ul><li>将多个小对象合并成大对象</li> <li>减少不必要指针间接引用,多用 copy 引用</li> <li>局部变量逃逸时聚合</li></ul> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> m <span class="token punctuation">{</span>
    k<span class="token punctuation">,</span> v <span class="token operator">:=</span> k<span class="token punctuation">,</span> v
    <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// use k and v</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">for</span> k<span class="token punctuation">,</span> v <span class="token operator">:=</span> <span class="token keyword">range</span> m <span class="token punctuation">{</span>
    x <span class="token operator">:=</span> <span class="token keyword">struct</span><span class="token punctuation">{</span> k<span class="token punctuation">,</span> v <span class="token builtin">string</span> <span class="token punctuation">}</span><span class="token punctuation">{</span>k<span class="token punctuation">,</span> v<span class="token punctuation">}</span>
    <span class="token keyword">go</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// use x.k and x.v</span>
    <span class="token punctuation">}</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><ul><li>少用 []byte 多用数组</li> <li>sync.Pool 缓存常用对象</li></ul> <h2 id="监控自动化"><a href="#监控自动化" class="header-anchor">#</a> 监控自动化</h2> <p>以 5s 为单位,把进程的 CPU 使用<a href="https://github.com/shirou/gopsutil" target="_blank" rel="noopener noreferrer">gopsutil<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>, RSS <a href="https://github.com/shirou/gopsutil" target="_blank" rel="noopener noreferrer">gopsutil<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>,goroutine 数<code>runtime.NumGoroutine</code>用 10 大小的环形数组保存下来,每次采集到新值与之前多个周期的平均值 diff.</p> <ul><li>若 cpu 抖动,从当前开始采集 cpu profile 5s</li> <li>若 RSS 抖动,将当前进程的 heap profile 记录下来</li> <li>若 goroutine 抖动,将当前进程的 goroutine profile 记录下来</li></ul> <h3 id="开源工具"><a href="#开源工具" class="header-anchor">#</a> 开源工具</h3> <ul><li><a href="https://grafana.com/oss/prometheus/exporters/go-exporter/" target="_blank" rel="noopener noreferrer">go-exporter<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://github.com/divan/expvarmon" target="_blank" rel="noopener noreferrer">expvarmon<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">最后更新:</span> <span class="time">8/24/2021, 4:52:52 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/m/Go语言之旅/0x07.context.html" class="prev">
        0x07.context
      </a></span> <span class="next"><a href="/m/Go语言之旅/0x09.reflect.html">
        0x09.reflect
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/m/assets/js/app.71fdaff2.js" defer></script><script src="/m/assets/js/2.351ead77.js" defer></script><script src="/m/assets/js/32.c5e0d2a0.js" defer></script>
  </body>
</html>
