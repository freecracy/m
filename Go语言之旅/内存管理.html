<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>第四章 : 内存管理 | 嗯哼人生</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="">
    <meta name="referrer" content="no-referrer">
    
    <link rel="preload" href="/m/assets/css/0.styles.1e386fb6.css" as="style"><link rel="preload" href="/m/assets/js/app.71fdaff2.js" as="script"><link rel="preload" href="/m/assets/js/2.351ead77.js" as="script"><link rel="preload" href="/m/assets/js/13.a52bd89b.js" as="script"><link rel="prefetch" href="/m/assets/js/10.98c1e7e0.js"><link rel="prefetch" href="/m/assets/js/100.d7774ae1.js"><link rel="prefetch" href="/m/assets/js/101.0d4dea0d.js"><link rel="prefetch" href="/m/assets/js/102.6867f859.js"><link rel="prefetch" href="/m/assets/js/103.9d24bd08.js"><link rel="prefetch" href="/m/assets/js/104.4d59f256.js"><link rel="prefetch" href="/m/assets/js/105.ff49af8e.js"><link rel="prefetch" href="/m/assets/js/106.b26c7611.js"><link rel="prefetch" href="/m/assets/js/107.da5be320.js"><link rel="prefetch" href="/m/assets/js/108.0c03f842.js"><link rel="prefetch" href="/m/assets/js/109.5587de24.js"><link rel="prefetch" href="/m/assets/js/11.4e6d88d4.js"><link rel="prefetch" href="/m/assets/js/110.40ae6022.js"><link rel="prefetch" href="/m/assets/js/111.0353ccf3.js"><link rel="prefetch" href="/m/assets/js/112.f562c096.js"><link rel="prefetch" href="/m/assets/js/113.7926c003.js"><link rel="prefetch" href="/m/assets/js/114.356035f0.js"><link rel="prefetch" href="/m/assets/js/115.15e5e23e.js"><link rel="prefetch" href="/m/assets/js/116.2db2b1ed.js"><link rel="prefetch" href="/m/assets/js/117.2658e42c.js"><link rel="prefetch" href="/m/assets/js/118.037a8503.js"><link rel="prefetch" href="/m/assets/js/119.21153540.js"><link rel="prefetch" href="/m/assets/js/12.c3dadd73.js"><link rel="prefetch" href="/m/assets/js/120.b8f0644f.js"><link rel="prefetch" href="/m/assets/js/121.4c1c263a.js"><link rel="prefetch" href="/m/assets/js/122.d6ba18dd.js"><link rel="prefetch" href="/m/assets/js/123.ceef4883.js"><link rel="prefetch" href="/m/assets/js/124.9e5f50ca.js"><link rel="prefetch" href="/m/assets/js/125.de1ddc80.js"><link rel="prefetch" href="/m/assets/js/126.ae350aea.js"><link rel="prefetch" href="/m/assets/js/127.4636f6be.js"><link rel="prefetch" href="/m/assets/js/128.13b379ab.js"><link rel="prefetch" href="/m/assets/js/129.e7b0a15f.js"><link rel="prefetch" href="/m/assets/js/130.147cdf11.js"><link rel="prefetch" href="/m/assets/js/131.c7a07871.js"><link rel="prefetch" href="/m/assets/js/132.faf72eb9.js"><link rel="prefetch" href="/m/assets/js/133.6301923b.js"><link rel="prefetch" href="/m/assets/js/134.4357c6e4.js"><link rel="prefetch" href="/m/assets/js/135.0ea43a3d.js"><link rel="prefetch" href="/m/assets/js/136.5a7c2377.js"><link rel="prefetch" href="/m/assets/js/137.393c998e.js"><link rel="prefetch" href="/m/assets/js/138.dcf958b6.js"><link rel="prefetch" href="/m/assets/js/139.1ccac68b.js"><link rel="prefetch" href="/m/assets/js/14.96fff293.js"><link rel="prefetch" href="/m/assets/js/140.938c314e.js"><link rel="prefetch" href="/m/assets/js/141.03cc2137.js"><link rel="prefetch" href="/m/assets/js/142.db00aba9.js"><link rel="prefetch" href="/m/assets/js/143.6d7b22af.js"><link rel="prefetch" href="/m/assets/js/144.850ed5a9.js"><link rel="prefetch" href="/m/assets/js/145.a1958a5f.js"><link rel="prefetch" href="/m/assets/js/146.1b350d4f.js"><link rel="prefetch" href="/m/assets/js/147.961f3ccd.js"><link rel="prefetch" href="/m/assets/js/148.cb4f8811.js"><link rel="prefetch" href="/m/assets/js/149.45ad7c2c.js"><link rel="prefetch" href="/m/assets/js/15.c507965f.js"><link rel="prefetch" href="/m/assets/js/150.5d952b70.js"><link rel="prefetch" href="/m/assets/js/151.5c794bb0.js"><link rel="prefetch" href="/m/assets/js/152.974e657e.js"><link rel="prefetch" href="/m/assets/js/153.b7cf98f6.js"><link rel="prefetch" href="/m/assets/js/154.be904394.js"><link rel="prefetch" href="/m/assets/js/155.769e3b0d.js"><link rel="prefetch" href="/m/assets/js/156.6107a44f.js"><link rel="prefetch" href="/m/assets/js/157.0bf74a2b.js"><link rel="prefetch" href="/m/assets/js/158.d499f907.js"><link rel="prefetch" href="/m/assets/js/159.6b2acd2c.js"><link rel="prefetch" href="/m/assets/js/16.247520d0.js"><link rel="prefetch" href="/m/assets/js/160.ec909209.js"><link rel="prefetch" href="/m/assets/js/161.4832768d.js"><link rel="prefetch" href="/m/assets/js/162.ae74834a.js"><link rel="prefetch" href="/m/assets/js/163.8af51be9.js"><link rel="prefetch" href="/m/assets/js/164.0d64a1ef.js"><link rel="prefetch" href="/m/assets/js/165.5e5a775c.js"><link rel="prefetch" href="/m/assets/js/166.121987f8.js"><link rel="prefetch" href="/m/assets/js/167.1c270942.js"><link rel="prefetch" href="/m/assets/js/168.200df8c8.js"><link rel="prefetch" href="/m/assets/js/169.84f5e0d7.js"><link rel="prefetch" href="/m/assets/js/17.3cb462b5.js"><link rel="prefetch" href="/m/assets/js/170.57b7eec5.js"><link rel="prefetch" href="/m/assets/js/171.d993d636.js"><link rel="prefetch" href="/m/assets/js/172.820d00a1.js"><link rel="prefetch" href="/m/assets/js/173.cc29ff6e.js"><link rel="prefetch" href="/m/assets/js/174.99d62af7.js"><link rel="prefetch" href="/m/assets/js/175.da874148.js"><link rel="prefetch" href="/m/assets/js/176.d0755bfc.js"><link rel="prefetch" href="/m/assets/js/177.8b00d874.js"><link rel="prefetch" href="/m/assets/js/178.2b0cfda8.js"><link rel="prefetch" href="/m/assets/js/179.780a3873.js"><link rel="prefetch" href="/m/assets/js/18.298da910.js"><link rel="prefetch" href="/m/assets/js/180.7c0ac3dc.js"><link rel="prefetch" href="/m/assets/js/181.507f9073.js"><link rel="prefetch" href="/m/assets/js/182.87f76d4a.js"><link rel="prefetch" href="/m/assets/js/183.1410502e.js"><link rel="prefetch" href="/m/assets/js/184.80666cb3.js"><link rel="prefetch" href="/m/assets/js/185.dc628b97.js"><link rel="prefetch" href="/m/assets/js/186.c2560a3f.js"><link rel="prefetch" href="/m/assets/js/187.6af43ea3.js"><link rel="prefetch" href="/m/assets/js/188.da75b50c.js"><link rel="prefetch" href="/m/assets/js/189.78dd960b.js"><link rel="prefetch" href="/m/assets/js/19.d9eabdf8.js"><link rel="prefetch" href="/m/assets/js/190.017586b9.js"><link rel="prefetch" href="/m/assets/js/191.5fa65eb7.js"><link rel="prefetch" href="/m/assets/js/192.5bb628c7.js"><link rel="prefetch" href="/m/assets/js/193.35707c80.js"><link rel="prefetch" href="/m/assets/js/194.35c3b13b.js"><link rel="prefetch" href="/m/assets/js/195.6dc8874b.js"><link rel="prefetch" href="/m/assets/js/196.01a1e825.js"><link rel="prefetch" href="/m/assets/js/197.5745084a.js"><link rel="prefetch" href="/m/assets/js/198.0455ca12.js"><link rel="prefetch" href="/m/assets/js/199.75129c13.js"><link rel="prefetch" href="/m/assets/js/20.ce14ddb9.js"><link rel="prefetch" href="/m/assets/js/200.a08681d0.js"><link rel="prefetch" href="/m/assets/js/201.a54018b7.js"><link rel="prefetch" href="/m/assets/js/202.2361e839.js"><link rel="prefetch" href="/m/assets/js/203.b92491ee.js"><link rel="prefetch" href="/m/assets/js/204.13742571.js"><link rel="prefetch" href="/m/assets/js/205.b066e447.js"><link rel="prefetch" href="/m/assets/js/206.e2c72f2c.js"><link rel="prefetch" href="/m/assets/js/207.09a83a9a.js"><link rel="prefetch" href="/m/assets/js/208.f4b8d71c.js"><link rel="prefetch" href="/m/assets/js/209.1a4e4d18.js"><link rel="prefetch" href="/m/assets/js/21.0dc0e0bf.js"><link rel="prefetch" href="/m/assets/js/210.9709d46f.js"><link rel="prefetch" href="/m/assets/js/211.3704916b.js"><link rel="prefetch" href="/m/assets/js/212.7c96c99f.js"><link rel="prefetch" href="/m/assets/js/213.b4aedaa1.js"><link rel="prefetch" href="/m/assets/js/214.d0b2586b.js"><link rel="prefetch" href="/m/assets/js/215.2268650a.js"><link rel="prefetch" href="/m/assets/js/216.dcaa6f2f.js"><link rel="prefetch" href="/m/assets/js/217.33aaf649.js"><link rel="prefetch" href="/m/assets/js/218.216d8592.js"><link rel="prefetch" href="/m/assets/js/219.44d35873.js"><link rel="prefetch" href="/m/assets/js/22.ce355d8a.js"><link rel="prefetch" href="/m/assets/js/220.ff06fa11.js"><link rel="prefetch" href="/m/assets/js/221.93379b76.js"><link rel="prefetch" href="/m/assets/js/222.6f0bbeea.js"><link rel="prefetch" href="/m/assets/js/223.4c5e29f0.js"><link rel="prefetch" href="/m/assets/js/224.e7be32e4.js"><link rel="prefetch" href="/m/assets/js/225.4915db8f.js"><link rel="prefetch" href="/m/assets/js/226.60f21d11.js"><link rel="prefetch" href="/m/assets/js/227.0e63cf34.js"><link rel="prefetch" href="/m/assets/js/228.e7b7a543.js"><link rel="prefetch" href="/m/assets/js/229.73bf392a.js"><link rel="prefetch" href="/m/assets/js/23.40c917ac.js"><link rel="prefetch" href="/m/assets/js/230.9f789c55.js"><link rel="prefetch" href="/m/assets/js/231.8fd85bc2.js"><link rel="prefetch" href="/m/assets/js/232.e6c4a62c.js"><link rel="prefetch" href="/m/assets/js/233.45636bf3.js"><link rel="prefetch" href="/m/assets/js/234.5194ce16.js"><link rel="prefetch" href="/m/assets/js/235.15ba019b.js"><link rel="prefetch" href="/m/assets/js/236.ac5768c1.js"><link rel="prefetch" href="/m/assets/js/237.91ec2e5a.js"><link rel="prefetch" href="/m/assets/js/238.af630344.js"><link rel="prefetch" href="/m/assets/js/239.b2b84093.js"><link rel="prefetch" href="/m/assets/js/24.5b681006.js"><link rel="prefetch" href="/m/assets/js/240.9c9b1fba.js"><link rel="prefetch" href="/m/assets/js/241.c26c2147.js"><link rel="prefetch" href="/m/assets/js/242.ce44f37f.js"><link rel="prefetch" href="/m/assets/js/243.aa04b829.js"><link rel="prefetch" href="/m/assets/js/244.ee4c9090.js"><link rel="prefetch" href="/m/assets/js/245.62ebda1d.js"><link rel="prefetch" href="/m/assets/js/246.2fd9ce22.js"><link rel="prefetch" href="/m/assets/js/247.52b3e746.js"><link rel="prefetch" href="/m/assets/js/248.2e432a32.js"><link rel="prefetch" href="/m/assets/js/249.4598fccb.js"><link rel="prefetch" href="/m/assets/js/25.d5d6ba55.js"><link rel="prefetch" href="/m/assets/js/250.7c93bc3e.js"><link rel="prefetch" href="/m/assets/js/251.4d402930.js"><link rel="prefetch" href="/m/assets/js/252.1b3fb775.js"><link rel="prefetch" href="/m/assets/js/253.01a9b4f8.js"><link rel="prefetch" href="/m/assets/js/254.29de4256.js"><link rel="prefetch" href="/m/assets/js/255.4911ce12.js"><link rel="prefetch" href="/m/assets/js/256.0a40f8d2.js"><link rel="prefetch" href="/m/assets/js/257.2111ae5e.js"><link rel="prefetch" href="/m/assets/js/258.0e9b2cd1.js"><link rel="prefetch" href="/m/assets/js/259.43158d35.js"><link rel="prefetch" href="/m/assets/js/26.b1e00e8a.js"><link rel="prefetch" href="/m/assets/js/260.72ea8c45.js"><link rel="prefetch" href="/m/assets/js/261.3f679643.js"><link rel="prefetch" href="/m/assets/js/262.d9ecaed6.js"><link rel="prefetch" href="/m/assets/js/27.556976c4.js"><link rel="prefetch" href="/m/assets/js/28.11027d56.js"><link rel="prefetch" href="/m/assets/js/29.f40ac6f5.js"><link rel="prefetch" href="/m/assets/js/3.a2a1a8e5.js"><link rel="prefetch" href="/m/assets/js/30.3b59bb10.js"><link rel="prefetch" href="/m/assets/js/31.c37142be.js"><link rel="prefetch" href="/m/assets/js/32.c5e0d2a0.js"><link rel="prefetch" href="/m/assets/js/33.4f5f3a8d.js"><link rel="prefetch" href="/m/assets/js/34.4a3a9398.js"><link rel="prefetch" href="/m/assets/js/35.77f89f97.js"><link rel="prefetch" href="/m/assets/js/36.6ea00d3c.js"><link rel="prefetch" href="/m/assets/js/37.b5a3b5b4.js"><link rel="prefetch" href="/m/assets/js/38.24b26621.js"><link rel="prefetch" href="/m/assets/js/39.ab372876.js"><link rel="prefetch" href="/m/assets/js/4.b9f14f77.js"><link rel="prefetch" href="/m/assets/js/40.7a81caac.js"><link rel="prefetch" href="/m/assets/js/41.d23cf8c8.js"><link rel="prefetch" href="/m/assets/js/42.ef938986.js"><link rel="prefetch" href="/m/assets/js/43.708a3cf3.js"><link rel="prefetch" href="/m/assets/js/44.f705f7de.js"><link rel="prefetch" href="/m/assets/js/45.0e6afdb6.js"><link rel="prefetch" href="/m/assets/js/46.9815c7cc.js"><link rel="prefetch" href="/m/assets/js/47.5d1c1dcc.js"><link rel="prefetch" href="/m/assets/js/48.d9d571a6.js"><link rel="prefetch" href="/m/assets/js/49.9cbaa1e9.js"><link rel="prefetch" href="/m/assets/js/5.57dbdc35.js"><link rel="prefetch" href="/m/assets/js/50.265f94f4.js"><link rel="prefetch" href="/m/assets/js/51.094b2e7f.js"><link rel="prefetch" href="/m/assets/js/52.8b7101c0.js"><link rel="prefetch" href="/m/assets/js/53.98f3fc0b.js"><link rel="prefetch" href="/m/assets/js/54.b3d830fd.js"><link rel="prefetch" href="/m/assets/js/55.fb9cd8c7.js"><link rel="prefetch" href="/m/assets/js/56.878cf94b.js"><link rel="prefetch" href="/m/assets/js/57.1c819831.js"><link rel="prefetch" href="/m/assets/js/58.ac3faf70.js"><link rel="prefetch" href="/m/assets/js/59.b0483bf9.js"><link rel="prefetch" href="/m/assets/js/6.a0c51186.js"><link rel="prefetch" href="/m/assets/js/60.48c301e6.js"><link rel="prefetch" href="/m/assets/js/61.4bf4f2e7.js"><link rel="prefetch" href="/m/assets/js/62.d927584b.js"><link rel="prefetch" href="/m/assets/js/63.b72a48f3.js"><link rel="prefetch" href="/m/assets/js/64.6923d7c8.js"><link rel="prefetch" href="/m/assets/js/65.042fc335.js"><link rel="prefetch" href="/m/assets/js/66.1afdb278.js"><link rel="prefetch" href="/m/assets/js/67.04f7b0c7.js"><link rel="prefetch" href="/m/assets/js/68.97789db4.js"><link rel="prefetch" href="/m/assets/js/69.d914e9f8.js"><link rel="prefetch" href="/m/assets/js/7.aef5e50f.js"><link rel="prefetch" href="/m/assets/js/70.84845956.js"><link rel="prefetch" href="/m/assets/js/71.d6e9132a.js"><link rel="prefetch" href="/m/assets/js/72.2c1f5783.js"><link rel="prefetch" href="/m/assets/js/73.789e9372.js"><link rel="prefetch" href="/m/assets/js/74.e79f4842.js"><link rel="prefetch" href="/m/assets/js/75.4a389066.js"><link rel="prefetch" href="/m/assets/js/76.f5721f28.js"><link rel="prefetch" href="/m/assets/js/77.e6ce992d.js"><link rel="prefetch" href="/m/assets/js/78.5c31237a.js"><link rel="prefetch" href="/m/assets/js/79.6a4f09e0.js"><link rel="prefetch" href="/m/assets/js/8.aac4a85a.js"><link rel="prefetch" href="/m/assets/js/80.23b925ca.js"><link rel="prefetch" href="/m/assets/js/81.bc8138cb.js"><link rel="prefetch" href="/m/assets/js/82.4783bc83.js"><link rel="prefetch" href="/m/assets/js/83.1be8f057.js"><link rel="prefetch" href="/m/assets/js/84.3132660e.js"><link rel="prefetch" href="/m/assets/js/85.95c5ab8b.js"><link rel="prefetch" href="/m/assets/js/86.17c9a201.js"><link rel="prefetch" href="/m/assets/js/87.daa0da6b.js"><link rel="prefetch" href="/m/assets/js/88.9409cacc.js"><link rel="prefetch" href="/m/assets/js/89.bf04eaa0.js"><link rel="prefetch" href="/m/assets/js/9.0dd0ff11.js"><link rel="prefetch" href="/m/assets/js/90.5e1e2630.js"><link rel="prefetch" href="/m/assets/js/91.6466b581.js"><link rel="prefetch" href="/m/assets/js/92.0dd7ffc6.js"><link rel="prefetch" href="/m/assets/js/93.045047c7.js"><link rel="prefetch" href="/m/assets/js/94.ce06dedb.js"><link rel="prefetch" href="/m/assets/js/95.f673ef28.js"><link rel="prefetch" href="/m/assets/js/96.1f73d13d.js"><link rel="prefetch" href="/m/assets/js/97.b1800fdc.js"><link rel="prefetch" href="/m/assets/js/98.245eb5e4.js"><link rel="prefetch" href="/m/assets/js/99.2cfc78a1.js">
    <link rel="stylesheet" href="/m/assets/css/0.styles.1e386fb6.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/m/" class="home-link router-link-active"><!----> <span class="site-name">嗯哼人生</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/m/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="https://cn100800.tk" target="_blank" rel="noopener noreferrer" class="nav-link external">
  主站
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="mailto:freecracy1024@gmail.com" class="nav-link external">
  mail
  <!----></a></div><div class="nav-item"><a href="https://google.com.hk" target="_blank" rel="noopener noreferrer" class="nav-link external">
  google
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/m/" class="nav-link">
  首页
</a></div><div class="nav-item"><a href="https://cn100800.tk" target="_blank" rel="noopener noreferrer" class="nav-link external">
  主站
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="mailto:freecracy1024@gmail.com" class="nav-link external">
  mail
  <!----></a></div><div class="nav-item"><a href="https://google.com.hk" target="_blank" rel="noopener noreferrer" class="nav-link external">
  google
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Go语言之旅</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/m/Go语言之旅/slice.html" class="sidebar-link">slice</a></li><li><a href="/m/Go语言之旅/0x00.开发环境.html" class="sidebar-link">0x00.开发环境</a></li><li><a href="/m/Go语言之旅/0x04.select.html" class="sidebar-link">0x04.select</a></li><li><a href="/m/Go语言之旅/0x05.编译器.html" class="sidebar-link">0x04.编译器</a></li><li><a href="/m/Go语言之旅/0x05.编译器02.html" class="sidebar-link">0x05.编译器02</a></li><li><a href="/m/Go语言之旅/0x06.数据结构.html" class="sidebar-link">0x06.数据结构</a></li><li><a href="/m/Go语言之旅/0x07.context.html" class="sidebar-link">0x07.context</a></li><li><a href="/m/Go语言之旅/0x08.性能剖析.html" class="sidebar-link">0x08.性能剖析</a></li><li><a href="/m/Go语言之旅/0x09.reflect.html" class="sidebar-link">0x09.reflect</a></li><li><a href="/m/Go语言之旅/0x12.interface.html" class="sidebar-link">0x12.interface</a></li><li><a href="/m/Go语言之旅/0x13.package.html" class="sidebar-link">0x13.package</a></li><li><a href="/m/Go语言之旅/0x14.问题集.html" class="sidebar-link">0x14.问题集</a></li><li><a href="/m/Go语言之旅/0x15.leet.html" class="sidebar-link">0x15.leet</a></li><li><a href="/m/Go语言之旅/0x16.命令行参数.html" class="sidebar-link">0x16.命令行参数</a></li><li><a href="/m/Go语言之旅/GODEBUG.html" class="sidebar-link">GODEBUG</a></li><li><a href="/m/Go语言之旅/bitmap.html" class="sidebar-link">bitmap</a></li><li><a href="/m/Go语言之旅/channel.html" class="sidebar-link">channel</a></li><li><a href="/m/Go语言之旅/defer.html" class="sidebar-link">defer</a></li><li><a href="/m/Go语言之旅/gmp模型.html" class="sidebar-link">gmp 模型</a></li><li><a href="/m/Go语言之旅/make.html" class="sidebar-link">make</a></li><li><a href="/m/Go语言之旅/map.html" class="sidebar-link">map</a></li><li><a href="/m/Go语言之旅/mock.html" class="sidebar-link">mock</a></li><li><a href="/m/Go语言之旅/0x03.内存模型.html" class="sidebar-link">0x03.内存模型</a></li><li><a href="/m/Go语言之旅/tool.html" class="sidebar-link">tool</a></li><li><a href="/m/Go语言之旅/内存管理.html" class="active sidebar-link">第四章 : 内存管理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/m/Go语言之旅/内存管理.html#内存分配原理" class="sidebar-link">内存分配原理</a></li><li class="sidebar-sub-header"><a href="/m/Go语言之旅/内存管理.html#垃圾回收原理" class="sidebar-link">垃圾回收原理</a></li><li class="sidebar-sub-header"><a href="/m/Go语言之旅/内存管理.html#逃逸分析" class="sidebar-link">逃逸分析</a></li><li class="sidebar-sub-header"><a href="/m/Go语言之旅/内存管理.html#内存分配全景图" class="sidebar-link">内存分配全景图</a></li></ul></li><li><a href="/m/Go语言之旅/协程池.html" class="sidebar-link">协程池</a></li><li><a href="/m/Go语言之旅/协程调度.html" class="sidebar-link">第三章 : 协程调度</a></li><li><a href="/m/Go语言之旅/垃圾回收.html" class="sidebar-link">垃圾回收</a></li><li><a href="/m/Go语言之旅/基础.html" class="sidebar-link">基础</a></li><li><a href="/m/Go语言之旅/工具集.html" class="sidebar-link">工具集</a></li><li><a href="/m/Go语言之旅/常用数据结构实现原理.html" class="sidebar-link">第一章 : 常用数据结构实现原理</a></li><li><a href="/m/Go语言之旅/常见控制结构实现原理.html" class="sidebar-link">第二章 : 常见控制结构实现原理</a></li><li><a href="/m/Go语言之旅/并发控制.html" class="sidebar-link">第五章 : 并发控制</a></li><li><a href="/m/Go语言之旅/思考题.html" class="sidebar-link">思考题</a></li><li><a href="/m/Go语言之旅/文件操作.html" class="sidebar-link">文件操作</a></li><li><a href="/m/Go语言之旅/框架.html" class="sidebar-link">框架</a></li><li><a href="/m/Go语言之旅/泛型.html" class="sidebar-link">泛型</a></li><li><a href="/m/Go语言之旅/版本更新.html" class="sidebar-link">版本更新</a></li><li><a href="/m/Go语言之旅/调试.html" class="sidebar-link">调试</a></li><li><a href="/m/Go语言之旅/进程线程协程.html" class="sidebar-link">进程线程协程</a></li><li><a href="/m/Go语言之旅/部署.html" class="sidebar-link">部署</a></li><li><a href="/m/Go语言之旅/闭包.html" class="sidebar-link">闭包</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>文章</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>标准库</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>源码</span> <span class="arrow right"></span></p> <!----></section></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Redis</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Deno</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>其他</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>周末闲谈</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>深度好文</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>漫步 Linux</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>算法</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>设计模式</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>鸡汤软文</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="第四章-内存管理"><a href="#第四章-内存管理" class="header-anchor">#</a> 第四章 : 内存管理</h1> <h2 id="内存分配原理"><a href="#内存分配原理" class="header-anchor">#</a> 内存分配原理</h2> <h3 id="内存分配器"><a href="#内存分配器" class="header-anchor">#</a> 内存分配器</h3> <p>通过 malloc 方法动态分配内存, tcmalloc 和 jemalloc 在避免内存碎片和性能上均比 glibc 有优势,多线程环境下效果更明显.go 实现自己的内存分配器,原理与 tcmalloc 类似.简单来说就是维护一大块全局内存,每个线程(go 中指 p)维护一小块小的私有内存,私有内存不足再从全局申请.</p> <table><thead><tr><th>库</th> <th>分配器</th></tr></thead> <tbody><tr><td>glibc</td> <td>ptmalloc2</td></tr> <tr><td>googlet</td> <td>tcmalloc</td></tr> <tr><td>facebook</td> <td>jemalloc</td></tr></tbody></table> <p>为了方便自主管理内存,先向系统申请一块内存,然后将内存切割成小块,通过一定的内存分配算法管理内存.</p> <p>启动时预申请的内存划分为 spans(512M)、bitmap(16G)、arena(512G) 三部分.</p> <ol><li>arena : 即为所谓的堆区,应用中所用的内存从这里分配,其中 spans 和 bitmap 是为了管理 arena 区存在的.为了方便管理把 arena 区域划分为一个个 page,每个 page 为 8kb,一共有 512GB/8kb 个页</li> <li>spans : 存放 span 的指针每个指针对应一个 page,所以 spans 区域的大小为 512GB / 8KB * 指针大小8byte = 512M</li> <li>bitmap : bitmap 区域大小也是通过 arena 计算出来的,不过主要用于 GC</li></ol> <h3 id="span"><a href="#span" class="header-anchor">#</a> span</h3> <p>span 是管理 arena 区域页的关键数据结构,每个 span 中包含一个或多个连续页,为了满足小对象分配,span 中的一页会划分更小的粒度.而对于大对象,比如超过页大小,则通过多页实现.</p> <h3 id="class"><a href="#class" class="header-anchor">#</a> class</h3> <p>根据页大小划分了一系列 class,每个 class 都代表一个固定大小的对象,以及每个 span 的大小.</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// class  bytes/obj  bytes/span  objects  tail waste  max waste</span>
<span class="token comment">//     1          8        8192     1024           0     87.50%</span>
<span class="token comment">//     2         16        8192      512           0     43.75%</span>
<span class="token comment">//     3         32        8192      256           0     46.88%</span>
<span class="token comment">//     4         48        8192      170          32     31.52%</span>
<span class="token comment">//     5         64        8192      128           0     23.44%</span>
<span class="token comment">//     6         80        8192      102          32     19.07%</span>
<span class="token comment">//     7         96        8192       85          32     15.95%</span>
<span class="token comment">//     8        112        8192       73          16     13.56%</span>
<span class="token comment">//     9        128        8192       64           0     11.72%</span>
<span class="token comment">//    10        144        8192       56         128     11.82%</span>
<span class="token comment">//    11        160        8192       51          32      9.73%</span>
<span class="token comment">//    12        176        8192       46          96      9.59%</span>
<span class="token comment">//    13        192        8192       42         128      9.25%</span>
<span class="token comment">//    14        208        8192       39          80      8.12%</span>
<span class="token comment">//    15        224        8192       36         128      8.15%</span>
<span class="token comment">//    16        240        8192       34          32      6.62%</span>
<span class="token comment">//    17        256        8192       32           0      5.86%</span>
<span class="token comment">//    18        288        8192       28         128     12.16%</span>
<span class="token comment">//    19        320        8192       25         192     11.80%</span>
<span class="token comment">//    20        352        8192       23          96      9.88%</span>
<span class="token comment">//    21        384        8192       21         128      9.51%</span>
<span class="token comment">//    22        416        8192       19         288     10.71%</span>
<span class="token comment">//    23        448        8192       18         128      8.37%</span>
<span class="token comment">//    24        480        8192       17          32      6.82%</span>
<span class="token comment">//    25        512        8192       16           0      6.05%</span>
<span class="token comment">//    26        576        8192       14         128     12.33%</span>
<span class="token comment">//    27        640        8192       12         512     15.48%</span>
<span class="token comment">//    28        704        8192       11         448     13.93%</span>
<span class="token comment">//    29        768        8192       10         512     13.94%</span>
<span class="token comment">//    30        896        8192        9         128     15.52%</span>
<span class="token comment">//    31       1024        8192        8           0     12.40%</span>
<span class="token comment">//    32       1152        8192        7         128     12.41%</span>
<span class="token comment">//    33       1280        8192        6         512     15.55%</span>
<span class="token comment">//    34       1408       16384       11         896     14.00%</span>
<span class="token comment">//    35       1536        8192        5         512     14.00%</span>
<span class="token comment">//    36       1792       16384        9         256     15.57%</span>
<span class="token comment">//    37       2048        8192        4           0     12.45%</span>
<span class="token comment">//    38       2304       16384        7         256     12.46%</span>
<span class="token comment">//    39       2688        8192        3         128     15.59%</span>
<span class="token comment">//    40       3072       24576        8           0     12.47%</span>
<span class="token comment">//    41       3200       16384        5         384      6.22%</span>
<span class="token comment">//    42       3456       24576        7         384      8.83%</span>
<span class="token comment">//    43       4096        8192        2           0     15.60%</span>
<span class="token comment">//    44       4864       24576        5         256     16.65%</span>
<span class="token comment">//    45       5376       16384        3         256     10.92%</span>
<span class="token comment">//    46       6144       24576        4           0     12.48%</span>
<span class="token comment">//    47       6528       32768        5         128      6.23%</span>
<span class="token comment">//    48       6784       40960        6         256      4.36%</span>
<span class="token comment">//    49       6912       49152        7         768      3.37%</span>
<span class="token comment">//    50       8192        8192        1           0     15.61%</span>
<span class="token comment">//    51       9472       57344        6         512     14.28%</span>
<span class="token comment">//    52       9728       49152        5         512      3.64%</span>
<span class="token comment">//    53      10240       40960        4           0      4.99%</span>
<span class="token comment">//    54      10880       32768        3         128      6.24%</span>
<span class="token comment">//    55      12288       24576        2           0     11.45%</span>
<span class="token comment">//    56      13568       40960        3         256      9.99%</span>
<span class="token comment">//    57      14336       57344        4           0      5.35%</span>
<span class="token comment">//    58      16384       16384        1           0     12.49%</span>
<span class="token comment">//    59      18432       73728        4           0     11.11%</span>
<span class="token comment">//    60      19072       57344        3         128      3.57%</span>
<span class="token comment">//    61      20480       40960        2           0      6.87%</span>
<span class="token comment">//    62      21760       65536        3         256      6.25%</span>
<span class="token comment">//    63      24576       24576        1           0     11.45%</span>
<span class="token comment">//    64      27264       81920        3         128     10.00%</span>
<span class="token comment">//    65      28672       57344        2           0      4.91%</span>
<span class="token comment">//    66      32768       32768        1           0     12.50%</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br></div></div><ol><li>class : class id,每个 span 结构中都有一个 class ID,表示该 span 可处理的对象类型</li> <li>bytes/obj : 该 class 代表对象的字节数</li> <li>bytes/span : 每个 span 占用堆堆字节数,即页数 * 页大小</li> <li>objects : 每个 span 可分配的对象个数,即 (bytes/span) / (bytes/obj)</li> <li>waste bytes : 每个 span 产生的内存碎片,即 (bytes/span) % (bytes/obj)</li></ol> <blockquote><p>最大的对象是 32k 大小超过 32k 由特殊的 class 表示,该 class ID 为 0,每个 class 只包含一个对象</p></blockquote> <h3 id="结构体"><a href="#结构体" class="header-anchor">#</a> 结构体</h3> <p>span 是内存管理的基本单位,每个 span 用于管理特定的 class 对象,根据对象大小, span 将一个或多个页拆分成多个块进行管理.</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// runtime/mheap.go:mspan</span>
<span class="token keyword">type</span> mspan <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	next <span class="token operator">*</span>mspan     <span class="token comment">// next span in list, or nil if none</span>
	prev <span class="token operator">*</span>mspan     <span class="token comment">// previous span in list, or nil if none</span>
	list <span class="token operator">*</span>mSpanList <span class="token comment">// For debugging. TODO: Remove.</span>
	startAddr <span class="token builtin">uintptr</span> <span class="token comment">// address of first byte of span aka s.base()</span>
	npages    <span class="token builtin">uintptr</span> <span class="token comment">// number of pages in span</span>
	manualFreeList gclinkptr <span class="token comment">// list of free objects in mSpanManual spans</span>
	freeindex <span class="token builtin">uintptr</span>
	nelems <span class="token builtin">uintptr</span> <span class="token comment">// number of object in the span.</span>
	allocCache <span class="token builtin">uint64</span>
	allocBits  <span class="token operator">*</span>gcBits
	gcmarkBits <span class="token operator">*</span>gcBits
	sweepgen    <span class="token builtin">uint32</span>
	divMul      <span class="token builtin">uint16</span>        <span class="token comment">// for divide by elemsize - divMagic.mul</span>
	baseMask    <span class="token builtin">uint16</span>        <span class="token comment">// if non-0, elemsize is a power of 2, &amp; this will get object allocation base</span>
	allocCount  <span class="token builtin">uint16</span>        <span class="token comment">// number of allocated objects</span>
	spanclass   spanClass     <span class="token comment">// size class and noscan (uint8)</span>
	state       mSpanStateBox <span class="token comment">// mSpanInUse etc; accessed atomically (get/set methods)</span>
	needzero    <span class="token builtin">uint8</span>         <span class="token comment">// needs to be zeroed before allocation</span>
	divShift    <span class="token builtin">uint8</span>         <span class="token comment">// for divide by elemsize - divMagic.shift</span>
	divShift2   <span class="token builtin">uint8</span>         <span class="token comment">// for divide by elemsize - divMagic.shift2</span>
	elemsize    <span class="token builtin">uintptr</span>       <span class="token comment">// computed from sizeclass or from npages</span>
	limit       <span class="token builtin">uintptr</span>       <span class="token comment">// end of data in span</span>
	speciallock mutex         <span class="token comment">// guards specials list</span>
	specials    <span class="token operator">*</span>special      <span class="token comment">// linked list of special records sorted by offset.</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><ol><li>next : 链表的后向指针,用于将 span 连接起来</li> <li>prev : 链表的前向指针,用于将 span 连接起来</li> <li>startAddr : 起始地址,所管理页的地址</li> <li>npages : 管理的页数</li> <li>nelems : 块个数,多少个块可供分配</li> <li>allocBits : 分配位图,每一个位代表一个块是否已分配</li> <li>allocCount : 已分配块的个数</li> <li>spanclass : class ID</li> <li>elemsize : class 表中对象大小,即块大小</li></ol> <h3 id="mcache"><a href="#mcache" class="header-anchor">#</a> mcache</h3> <p>有了管理内存的基本单位,还有个数据结构来管理 span, 即 mcentral,各线程需要内存时从 mcentral 管理的 span 中申请内存,为了避免多线程申请内存时不断加锁,为每个线程分配了 span 的缓存,即 mcache</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// runtime/mcache.go:mcache</span>
<span class="token keyword">type</span> mcache <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	next_sample <span class="token builtin">uintptr</span> <span class="token comment">// trigger heap sample after allocating this many bytes</span>
	local_scan  <span class="token builtin">uintptr</span> <span class="token comment">// bytes of scannable heap allocated</span>
	tiny             <span class="token builtin">uintptr</span>
	tinyoffset       <span class="token builtin">uintptr</span>
	local_tinyallocs <span class="token builtin">uintptr</span> <span class="token comment">// number of tiny allocs not counted in other stats</span>
	alloc <span class="token punctuation">[</span>numSpanClasses<span class="token punctuation">]</span><span class="token operator">*</span>mspan <span class="token comment">// spans to allocate from, indexed by spanClass</span>
	stackcache <span class="token punctuation">[</span>_NumStackOrders<span class="token punctuation">]</span>stackfreelist
	local_largefree  <span class="token builtin">uintptr</span>                  <span class="token comment">// bytes freed for large objects (&gt;maxsmallsize)</span>
	local_nlargefree <span class="token builtin">uintptr</span>                  <span class="token comment">// number of frees for large objects (&gt;maxsmallsize)</span>
	local_nsmallfree <span class="token punctuation">[</span>_NumSizeClasses<span class="token punctuation">]</span><span class="token builtin">uintptr</span> <span class="token comment">// number of frees for small objects (&lt;=maxsmallsize)</span>
	flushGen <span class="token builtin">uint32</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><ol><li>alloc [67 * 2 ]*mspan : 为 mspan 的指针数组,数组大小为 class 大小的 2 倍,数组中每个元素代表一种 class 的 span 列表,每种 class 类型都有两组 span 列表,第一组列表中所表示的对象包含了指针,第二组列表中所包含的对象不包含指针,这样做是为了提高 gc 扫描性能,对于不包含指针的 span 列表,没必要扫描</li> <li>根据对象是否包含指针,将对象分为 noscan 和 scan 两类,其中 nospan 代表没有指针,而 scan 代表有指针,需要 gc 进行扫描</li> <li>mcache 在初始化时没有任何 span 的,在使用过程中会动态的从 mcentral 中获取并缓存下来,根据使用情况,每种 class 的 span 个数页不相同,哪类 class 占的多说明该线程分配的这一大小的对象较多</li></ol> <h3 id="central"><a href="#central" class="header-anchor">#</a> central</h3> <p>cache 作为线程的私有资源为单个线程服务,而 central 则是全局资源,为多个线程服务,当某个线程内存不足时会向 central 申请,当某个线程释放内存时又会回收进 central.</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// runtime/mcentral.go:mcentral</span>
<span class="token keyword">type</span> mcentral <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	lock      mutex
	spanclass spanClass
	nonempty  mSpanList <span class="token comment">// list of spans with a free object, ie a nonempty free list</span>
	empty     mSpanList <span class="token comment">// list of spans with no free objects (or cached in an mcache)</span>
	nmalloc <span class="token builtin">uint64</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><ol><li>lock : 线程之间互斥锁,防止多线程读写冲突</li> <li>spanclass : 每个 mcentral 管理着一组有相同 class 多列表</li> <li>nonempty : 还有空闲块的 span 列表,还有内存可用的 span 列表</li> <li>nonempty : 没有空闲块可用的 span 列表</li> <li>nmalloc : 累计分配的对象个数</li></ol> <h4 id="线程从-central-获取-span"><a href="#线程从-central-获取-span" class="header-anchor">#</a> 线程从 central 获取 span</h4> <ol><li>加锁</li> <li>从 nonempty 列表获取一个可用 span,并将其从链表中删除</li> <li>将取出的 span 放入 empty 链表</li> <li>将 span 返还给线程</li> <li>解锁</li> <li>线程将 span 缓存进 cache</li></ol> <h4 id="线程将-span-归还"><a href="#线程将-span-归还" class="header-anchor">#</a> 线程将 span 归还</h4> <ol><li>加锁</li> <li>将 span 从 empty 链表删除</li> <li>将 span 加入 nonempty 列表</li> <li>解锁</li></ol> <h3 id="heap"><a href="#heap" class="header-anchor">#</a> heap</h3> <p>每个 mcentral 对象只管理特定 class 规格的 span,事实上每种 class 都对应一个 mcentral,这个 mcentral 集合存放在 mheap 中.</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// runtime/mheap.go:mheap</span>
<span class="token keyword">type</span> mheap <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	lock      mutex
	pages     pageAlloc <span class="token comment">// page allocation data structure</span>
	sweepgen  <span class="token builtin">uint32</span>    <span class="token comment">// sweep generation, see comment in mspan; written during STW</span>
	sweepdone <span class="token builtin">uint32</span>    <span class="token comment">// all spans are swept</span>
	sweepers  <span class="token builtin">uint32</span>    <span class="token comment">// number of active sweepone calls</span>
	allspans <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">*</span>mspan <span class="token comment">// all spans out there</span>
	sweepSpans <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span>gcSweepBuf
	pagesInUse         <span class="token builtin">uint64</span>  <span class="token comment">// pages of spans in stats mSpanInUse; updated atomically</span>
	pagesSwept         <span class="token builtin">uint64</span>  <span class="token comment">// pages swept this cycle; updated atomically</span>
	pagesSweptBasis    <span class="token builtin">uint64</span>  <span class="token comment">// pagesSwept to use as the origin of the sweep ratio; updated atomically</span>
	sweepHeapLiveBasis <span class="token builtin">uint64</span>  <span class="token comment">// value of heap_live to use as the origin of sweep ratio; written with lock, read without</span>
	sweepPagesPerByte  <span class="token builtin">float64</span> <span class="token comment">// proportional sweep ratio; written with lock, read without</span>
	scavengeGoal <span class="token builtin">uint64</span>
	reclaimIndex <span class="token builtin">uint64</span>
	reclaimCredit <span class="token builtin">uintptr</span>
	largealloc  <span class="token builtin">uint64</span>                  <span class="token comment">// bytes allocated for large objects</span>
	nlargealloc <span class="token builtin">uint64</span>                  <span class="token comment">// number of large object allocations</span>
	largefree   <span class="token builtin">uint64</span>                  <span class="token comment">// bytes freed for large objects (&gt;maxsmallsize)</span>
	nlargefree  <span class="token builtin">uint64</span>                  <span class="token comment">// number of frees for large objects (&gt;maxsmallsize)</span>
	nsmallfree  <span class="token punctuation">[</span>_NumSizeClasses<span class="token punctuation">]</span><span class="token builtin">uint64</span> <span class="token comment">// number of frees for small objects (&lt;=maxsmallsize)</span>
	arenas <span class="token punctuation">[</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> arenaL1Bits<span class="token punctuation">]</span><span class="token operator">*</span><span class="token punctuation">[</span><span class="token number">1</span> <span class="token operator">&lt;&lt;</span> arenaL2Bits<span class="token punctuation">]</span><span class="token operator">*</span>heapArena
	heapArenaAlloc linearAlloc
	arenaHints <span class="token operator">*</span>arenaHint
	arena linearAlloc
	allArenas <span class="token punctuation">[</span><span class="token punctuation">]</span>arenaIdx
	sweepArenas <span class="token punctuation">[</span><span class="token punctuation">]</span>arenaIdx
	curArena <span class="token keyword">struct</span> <span class="token punctuation">{</span>
		base<span class="token punctuation">,</span> end <span class="token builtin">uintptr</span>
	<span class="token punctuation">}</span>
	<span class="token boolean">_</span> <span class="token builtin">uint32</span> <span class="token comment">// ensure 64-bit alignment of central</span>
	central <span class="token punctuation">[</span>numSpanClasses<span class="token punctuation">]</span><span class="token keyword">struct</span> <span class="token punctuation">{</span>
		mcentral mcentral
		pad      <span class="token punctuation">[</span>cpu<span class="token punctuation">.</span>CacheLinePadSize <span class="token operator">-</span> unsafe<span class="token punctuation">.</span><span class="token function">Sizeof</span><span class="token punctuation">(</span>mcentral<span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token operator">%</span>cpu<span class="token punctuation">.</span>CacheLinePadSize<span class="token punctuation">]</span><span class="token builtin">byte</span>
	<span class="token punctuation">}</span>
	spanalloc             fixalloc <span class="token comment">// allocator for span*</span>
	cachealloc            fixalloc <span class="token comment">// allocator for mcache*</span>
	specialfinalizeralloc fixalloc <span class="token comment">// allocator for specialfinalizer*</span>
	specialprofilealloc   fixalloc <span class="token comment">// allocator for specialprofile*</span>
	speciallock           mutex    <span class="token comment">// lock for special record allocators.</span>
	arenaHintAlloc        fixalloc <span class="token comment">// allocator for arenaHints</span>
	unused <span class="token operator">*</span>specialfinalizer <span class="token comment">// never set, just here to force the specialfinalizer type into DWARF</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br></div></div><ol><li>lock : 互斥锁</li> <li>spans : 指向 spans 区域,用于映射 span 和 page 的关系</li> <li>bitmap : bitmap 的起始地址, bitmap 从高地址向低地址增长</li></ol> <p>mheap 管理着全部内存,实际通过一个 mheap 全局变量进行内存管理的.</p> <h3 id="内存分配过程"><a href="#内存分配过程" class="header-anchor">#</a> 内存分配过程</h3> <p>针对待分配对象大小有不同的分配逻辑</p> <table><thead><tr><th>大小</th> <th>分配</th></tr></thead> <tbody><tr><td>(  0 , 16B ) 且不包含指针的对象</td> <td>tiny 分配</td></tr> <tr><td>(  0 , 16B ) 包含指针对象</td> <td>正常分配</td></tr> <tr><td>[ 16B , 32KB ]</td> <td>正常分配</td></tr> <tr><td>( 32KB , - )</td> <td>大对象分配</td></tr></tbody></table> <ol><li>获取当前线程的私有缓存 cache</li> <li>根据 size 计算出合适的 class 的 ID</li> <li>从 mcache 的 alloc[class] 链表中查询可用的 span</li> <li>如果 mcache 没有可用的 span,则从 mcentral 申请一个新的 span 加入 mcache 中</li> <li>如果 mcentral 也没有可用的 span,则从 mheap 申请一个新的 span 加入 mcentral 中</li> <li>从该 span 中获取到空闲对象地址并返回</li></ol> <h3 id="小结"><a href="#小结" class="header-anchor">#</a> 小结</h3> <ol><li>启动时申请一个大内存划分为 spans、bitmap、arena 区域</li> <li>arena 按页划分成一个个小块</li> <li>span 管理一个或多个页</li> <li>mcentral 管理多个 span 供线程申请使用</li> <li>mcache 作为线程私有资源,资源来源于 mcentral</li></ol> <h2 id="垃圾回收原理"><a href="#垃圾回收原理" class="header-anchor">#</a> 垃圾回收原理</h2> <h3 id="垃圾回收算法"><a href="#垃圾回收算法" class="header-anchor">#</a> 垃圾回收算法</h3> <ol><li>引用计数 : 对每个对象维护一个引用计数,当引用该对象的对象销毁时引用计数减 1,当引用计数为 0 时回收该对象,优点 : 对象可以很快的被回收,不会出现内存耗尽达到某个阀值才回收.缺点 : 不能很好的处理循环引用,而且实时维护引用计数消耗性能</li> <li>标记-清除 : 从根变量开始遍历所有引用的对象引用的对象被标记为被引用,没有被标记的进行回收.优点 : 解决引用计数的缺点. 缺点 : 需要 STW(暂时停掉程序运行)</li> <li>分代收集 : 按照对象生命周期长短,划分不同的代空间,生命周期长的放入老年代,短的放入新生代,不同代有不同回收算法和回收频率.优点 : 回收性能好.缺点 : 算法复杂</li></ol> <h3 id="垃圾回收"><a href="#垃圾回收" class="header-anchor">#</a> 垃圾回收</h3> <p>垃圾回收的目标就是把那些已经分配的但没有对象引用的内存找出来并回收掉.</p> <p><img src="/m/assets/img/go-lajihuishou.890f69f3.png" alt="go-lajihuishou"></p> <h3 id="内存标记"><a href="#内存标记" class="header-anchor">#</a> 内存标记</h3> <p><img src="/m/assets/img/go-gc-mark.bae1baa1.png" alt="go-gc-mark"></p> <p>span 中维护一个个内存块,并用一个位图 allocBits 表示内存块的分配情况,在 span 结构体中还有另一个位图 gcmarkBits 用于标记内存块被引用的情况,标记阶段对每块内存进行标记有对象引用的内存标记为 1,没有引用到的保持默认 0.标记结束就是内存回收,回收时将 allocBits 指向 gcmarkBits,代表标记过的才是存活的, gcmarkBits 会在下次标记时重新分配内存.</p> <h3 id="三色标记法"><a href="#三色标记法" class="header-anchor">#</a> 三色标记法</h3> <p>前面介绍了对象标记状态的存储方式,还需要一个标记队列来存放待标记的对象.可以简单的想象成把对象从标记队列中取出将对象的引用状态标记在 span 的 gcmarkBits,把对象引用到的其它对象再放入到队列中.</p> <table><thead><tr><th>颜色</th> <th>描述</th></tr></thead> <tbody><tr><td>灰色</td> <td>对象还在标记队列中等待</td></tr> <tr><td>黑色</td> <td>对象已被标记, gcmarkBits 对应的位为 1 (该对象不会在本次 gc 中被清理)</td></tr> <tr><td>白色</td> <td>对象未被标记, gcmarkBits 对应的位为 0 (该对象将会在本次 gc 中被清理)</td></tr></tbody></table> <h3 id="垃圾回收优化"><a href="#垃圾回收优化" class="header-anchor">#</a> 垃圾回收优化</h3> <h4 id="写屏障"><a href="#写屏障" class="header-anchor">#</a> 写屏障</h4> <p>stw 防止 gc 扫描时内存变化而停掉 goroutine,而写屏障就是让 goroutine 与 gc 同时运行的手段,虽然写屏障不能完全消除 stw,但可以减少 stw 的时间.写屏障类似一种开关,在 gc 特定时机开启,开启后指针传递时会把指针标记,即本轮不回收下次 gc 时再确定. gc 过程中新分配的内存会被立即标记,用的并不是写屏障技术,即 gc 过程中新分配的内存不会在本轮 gc 中回收.</p> <h4 id="辅助-gc"><a href="#辅助-gc" class="header-anchor">#</a> 辅助 GC</h4> <p>为防止内存分配过快在 gc 执行过程中,如果 goroutine 需要分配内存那么这个 goroutine 会参与参与一部分 gc 工作,即帮助 gc 做一部分工作,这个机制叫做 mutator assist.</p> <h3 id="垃圾回收触发时机"><a href="#垃圾回收触发时机" class="header-anchor">#</a> 垃圾回收触发时机</h3> <h4 id="内存分配量达到阀值触发-gc"><a href="#内存分配量达到阀值触发-gc" class="header-anchor">#</a> 内存分配量达到阀值触发 gc</h4> <p>第一个指标关注堆内存增长.</p> <p>每次内存分配时都会检查当前内存分配量是否已经到达阀值,如果到达阀值则立即启动 gc.</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>阀值 <span class="token operator">=</span> 上次 gc 内存分配量 * 内存增长率
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>内存增长率由环境变量<code>GOGC</code>控制,默认为 100,即每当内存扩大一倍时启动 gc.gc 关注堆的增长,默认情况下在堆大小加倍时运行.</p> <h4 id="定期触发-gc"><a href="#定期触发-gc" class="header-anchor">#</a> 定期触发 gc</h4> <p>第二个指标关注两次 gc 时间间隔.默认情况下最长 2 分钟触发一次 gc.</p> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// runtime/proc.go:forcegcperiod</span>
<span class="token keyword">var</span> forcegcperiod <span class="token builtin">int64</span> <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">1e9</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h4 id="手动触发"><a href="#手动触发" class="header-anchor">#</a> 手动触发</h4> <p>程序代码中可以使用<code>runtime.GC()</code>来手动触发 gc,主要用于 gc 性能测试和统计.</p> <h3 id="gc-性能优化"><a href="#gc-性能优化" class="header-anchor">#</a> gc 性能优化</h3> <p>gc 性能与对象数量负相关,对象越多 gc 性能越差,对程序影响越大.所以 gc 性能优化的思路之一就是减少对象分配个数,比如对象复用或使用大对象组合多个小对象.另外由于内存逃逸现象有些隐式的内存分配也会产生,也有可能成为 gc 的负担.</p> <h3 id="gc"><a href="#gc" class="header-anchor">#</a> gc</h3> <p>被标记为 gc dedicated 的 goroutine 会运行标记,并不会被抢占,标记为 gc idle 的 goroutine 会去工作,因为他们没事情可做,可以被抢占.</p> <h2 id="逃逸分析"><a href="#逃逸分析" class="header-anchor">#</a> 逃逸分析</h2> <h3 id="概述"><a href="#概述" class="header-anchor">#</a> 概述</h3> <p>指由编译器决定内存分配的位置,不需要程序员指定,函数中申请一个新的对象</p> <ol><li>如果分配在栈中,则函数执行结束可自动将内存回收</li> <li>如果分配在堆中,则函数执行结束可交给 gc 处理</li></ol> <p>有了逃逸分析返回函数局部变量成为了可能.通过编译参数<code>-gcflag=-m</code>可以查看编译过程中的逃逸分析.</p> <h3 id="逃逸策略"><a href="#逃逸策略" class="header-anchor">#</a> 逃逸策略</h3> <p>每当函数中申请新的对象,编译器会根据该对象是否被函数外部引用来决定是否逃逸</p> <ol><li>如果函数外部没有引用,则优先放到栈中</li> <li>如果函数外部存在引用,则必定放到堆中</li></ol> <blockquote><p>对于函数外部没有引用的对象,也有可能放大堆中,比如内存过大,超过栈的存储能力</p></blockquote> <h3 id="逃逸场景"><a href="#逃逸场景" class="header-anchor">#</a> 逃逸场景</h3> <h4 id="指针逃逸-返回局部变量指针"><a href="#指针逃逸-返回局部变量指针" class="header-anchor">#</a> 指针逃逸-返回局部变量指针</h4> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">type</span> Student <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	Name <span class="token builtin">string</span>
	Age  <span class="token builtin">int</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">StudentRegister</span><span class="token punctuation">(</span>name <span class="token builtin">string</span><span class="token punctuation">,</span> age <span class="token builtin">int</span><span class="token punctuation">)</span> <span class="token operator">*</span>Student <span class="token punctuation">{</span>
	s <span class="token operator">:=</span> <span class="token function">new</span><span class="token punctuation">(</span>Student<span class="token punctuation">)</span> <span class="token comment">//局部变量s逃逸到堆</span>
	s<span class="token punctuation">.</span>Name <span class="token operator">=</span> name
	s<span class="token punctuation">.</span>Age <span class="token operator">=</span> age
	<span class="token keyword">return</span> s
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">StudentRegister</span><span class="token punctuation">(</span><span class="token string">&quot;Jim&quot;</span><span class="token punctuation">,</span> <span class="token number">18</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h4 id="栈空间不足逃逸"><a href="#栈空间不足逃逸" class="header-anchor">#</a> 栈空间不足逃逸</h4> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">Slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	s <span class="token operator">:=</span> <span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">int</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span> <span class="token comment">// 切片长度扩大 10 会发生逃逸</span>
	<span class="token keyword">for</span> index<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> <span class="token keyword">range</span> s <span class="token punctuation">{</span>
		s<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> index
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">Slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>当栈空间不足以存放当前对象时或无法判断当前切片长度时会将对象分配到堆中.</p> <h4 id="动态类型逃逸"><a href="#动态类型逃逸" class="header-anchor">#</a> 动态类型逃逸</h4> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	s <span class="token operator">:=</span> <span class="token string">&quot;Escape&quot;</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>很多函数参数类型为 interface 类型,比如<code>fmt.Println(a ...interface{})</code>,编译期间很难确定其参数具体类型,也会发生逃逸.</p> <h4 id="闭包引用对象逃逸"><a href="#闭包引用对象逃逸" class="header-anchor">#</a> 闭包引用对象逃逸</h4> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">Fibonacci</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
	a<span class="token punctuation">,</span> b <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span>
	<span class="token keyword">return</span> <span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">int</span> <span class="token punctuation">{</span>
		a<span class="token punctuation">,</span> b <span class="token operator">=</span> b<span class="token punctuation">,</span> a<span class="token operator">+</span>b <span class="token comment">// 原本属于局部变量的 a,b 由于闭包的引用,不得不放在堆上,产生逃逸</span>
		<span class="token keyword">return</span> a
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	f <span class="token operator">:=</span> <span class="token function">Fibonacci</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">for</span> i <span class="token operator">:=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span> <span class="token punctuation">{</span>
		fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;Fibonacci: %d\n&quot;</span><span class="token punctuation">,</span> <span class="token function">f</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h3 id="小结-2"><a href="#小结-2" class="header-anchor">#</a> 小结</h3> <ol><li>栈上分配内存比在堆上分配内存效率高</li> <li>栈上分配内存不需要 gc 处理</li> <li>堆上分配的内存使用完毕会交给 gc 处理</li> <li>逃逸分析是决定内存分配地址是栈上还是堆上</li> <li>逃逸分析在编译阶段完成</li></ol> <h3 id="传递指针效率不一定高"><a href="#传递指针效率不一定高" class="header-anchor">#</a> 传递指针效率不一定高</h3> <p>传递指针可以减少底层值的拷贝,可以提高效率,但是如果拷贝的数量小,由于指针传递会产生逃逸,可能会使用堆而增加 gc 负担,所以传递指针不一定是高效的.</p> <h3 id="例子"><a href="#例子" class="header-anchor">#</a> 例子</h3> <div class="language-go line-numbers-mode"><pre class="language-go"><code><span class="token comment">// go tool compile &quot;-m&quot; main.go 逃逸分析命令</span>
<span class="token comment">// go tool compile -S main.go   获得汇编代码可以明确展示分配细节</span>
<span class="token keyword">type</span> small <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	a<span class="token punctuation">,</span> b <span class="token builtin">int64</span>
	c<span class="token punctuation">,</span> d <span class="token builtin">float64</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">smallAllocation</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 禁止内联 : 避免内联通过移除函数的方式优化代码</span>
<span class="token comment">//go:noinline</span>
<span class="token keyword">func</span> <span class="token function">smallAllocation</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>small <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token operator">&amp;</span>small<span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p><code>runtime.newobject</code>用于新对象分配,以及代理<code>mallocgc</code>的内置函数该函数在堆上管理内存,分两种策略,一种用于小对象内存空间分配,一种用于较大的内存空间分配.</p> <h4 id="较小内存空间分配"><a href="#较小内存空间分配" class="header-anchor">#</a> 较小内存空间分配</h4> <p>对于小于 32kb 的,会从 mcache 本地缓存中尝试获取,这个缓存持有一个 mspan 的内存块(span, 32kb 大小的内存块),mspan 包含可用于分配的内存.每个 M 被分配一个 P,最多处理一个 goroutine,分配内存时,当前 goroutine 会使用当前的 p 的本地缓存,在 span 链表里寻找第一个可用空闲对象,使用这种本地缓存不需要锁操作.</p> <p>span 链表被划分为 8 字节到 32k 字节大小,约 70 个大小等级,每个等级可以存储不同大小的对象.每个 span 链表会存两份,一本链表用于不包含指针的对象,另一个用于包含指针的对象, gc 时可以不扫描不包含指针的 span.如果 span 没有空闲插槽,会从 mcentral 的链表,维护着包含空闲对象 span 和没有空闲对象的 span 的链表 mcentral 的中央双向链表,非空链表可能包含正在使用的内存, 从 mcental 获取新的 span, 新的 span 会从堆上分配,并连接到 mcentral 上.堆会在需要时从系统获取内存.堆会分配一个 arena 大内存块供使用.</p> <h4 id="较大内存空间分配"><a href="#较大内存空间分配" class="header-anchor">#</a> 较大内存空间分配</h4> <p>对于大于 32kb 的会向上取整到页的大小,并直接从堆上分配.</p> <h2 id="内存分配全景图"><a href="#内存分配全景图" class="header-anchor">#</a> 内存分配全景图</h2> <p><img src="/m/assets/img/go-memory.3edd9a6d.png" alt="go-memory"></p> <h4 id="_32-64-位"><a href="#_32-64-位" class="header-anchor">#</a> 32 &amp; 64 位</h4> <p>地址总线宽度为32或64,即可寻址范围,32位可寻址范围是4GB.</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">最后更新:</span> <span class="time">6/25/2021, 3:33:58 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/m/Go语言之旅/tool.html" class="prev">
        tool
      </a></span> <span class="next"><a href="/m/Go语言之旅/协程池.html">
        协程池
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/m/assets/js/app.71fdaff2.js" defer></script><script src="/m/assets/js/2.351ead77.js" defer></script><script src="/m/assets/js/13.a52bd89b.js" defer></script>
  </body>
</html>
